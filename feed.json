{
    "version": "https://jsonfeed.org/version/1",
    "title": "命运转轮",
    "description": "不曾亏欠, 不曾辜负, 如此足矣",
    "home_page_url": "https://arachnid.cc",
    "items": [
        {
            "id": "https://arachnid.cc/use-the-acme-tool/",
            "url": "https://arachnid.cc/use-the-acme-tool/",
            "title": "使用 acme.sh 签发 SSL 证书",
            "date_published": "2025-08-23T01:18:11.151Z",
            "content_html": "<h1 id=\"acmesh\"><a class=\"anchor\" href=\"#acmesh\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL2FjbWUuc2g=\">acme.sh</span> 安装操作</h1>\n<p>安装：</p>\n<pre><code>curl https://get.acme.sh | sh -s email=my@example.com\n\n# or\n\nwget -O -  https://get.acme.sh | sh -s email=my@example.com\n</code></pre>\n<p>普通用户和 root 用户皆可安装使用，命令执行完成后，<span class=\"exturl\" data-url=\"aHR0cDovL2FjbWUuc2g=\">acme.sh</span> 的所有相关脚本和文件都会被统一安装到  <code>~/.acme.sh/</code>  目录下，同时会在  <code>~/.bashrc</code>  环境变量中写入  <code>alias acme.sh=~/.acme.sh/acme.sh</code>  以便执行  <code>acme.sh</code>  脚本。</p>\n<p><strong>安装过程不会污染已有的系统任何功能和文件</strong>，所有的修改都限制在安装目录中:  <code>~/.acme.sh/</code>  ；安装完成后使用  <code>acme.sh -v</code>  测试，如若输出  <code>-bash: acme.sh: command not found</code>  ，则需要手动执行：</p>\n<pre><code>source ~/.bashrc\n</code></pre>\n<p>整个安装流程分为以下几步：</p>\n<ol>\n<li>把 <span class=\"exturl\" data-url=\"aHR0cDovL2FjbWUuc2g=\">acme.sh</span> 安装到你当前用户的 <strong>home</strong> 目录下： <code>~/.acme.sh/</code>  ；</li>\n<li>通过执行  <code>. &quot;~/.acme.sh/acme.sh.env&quot;</code>  载入到当前用户的环境变量并为其 alias；</li>\n<li>自动为你创建 cronjob， 每天 0:00 点自动检测所有的证书，如果快过期了，需要更新，则会自动更新证书。</li>\n</ol>\n<p>note：</p>\n<p>更多高级安装操作可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FjbWVzaC1vZmZpY2lhbC9hY21lLnNoL3dpa2kvSG93LXRvLWluc3RhbGw=\">https://github.com/acmesh-official/acme.sh/wiki/How-to-install</span></p>\n<h1 id=\"ssl-证书签发\"><a class=\"anchor\" href=\"#ssl-证书签发\">#</a> SSL 证书签发</h1>\n<p><strong><span class=\"exturl\" data-url=\"aHR0cDovL2FjbWUuc2g=\">acme.sh</span></strong> 实现了 <strong>acme</strong> 协议支持的所有验证协议；一般有两种方式验证: HTTP 和 DNS 验证签发。</p>\n<h2 id=\"http-验证\"><a class=\"anchor\" href=\"#http-验证\">#</a> HTTP 验证</h2>\n<p>先说明 HTTP 验证不适用于泛域名证书 *.example.com，并需要对服务器的网站根目录（webroot）具有有写入权限。</p>\n<h3 id=\"直接签发\"><a class=\"anchor\" href=\"#直接签发\">#</a> 直接签发</h3>\n<p>只需要指定域名，并指定域名所在的对应的服务器的网站根目录（webroot）， <strong><span class=\"exturl\" data-url=\"aHR0cDovL2FjbWUuc2g=\">acme.sh</span></strong> 会全自动创建生成临时验证文件，待 CA 机构验证该文件的可访问性及验证该域名所有权后，将会颁发证书，并删除验证文件。</p>\n<pre><code>acme.sh --issue -d domain.com -d www.domain.com --webroot /&lt;webroot_path&gt;/\n</code></pre>\n<h3 id=\"独立服务模式\"><a class=\"anchor\" href=\"#独立服务模式\">#</a> 独立服务模式</h3>\n<p>适用场景：服务器上无运行中的 web 服务，80 /tcp 端口处于空闲状态。</p>\n<p>以 root 用户，让 <strong><span class=\"exturl\" data-url=\"aHR0cDovL2FjbWUuc2g=\">acme.sh</span></strong> 开一个 80 端口监听并完成验证：</p>\n<pre><code>acme.sh --issue --standalone -d example.com -d www.example.com\n</code></pre>\n<h2 id=\"dns-验证\"><a class=\"anchor\" href=\"#dns-验证\">#</a> DNS 验证</h2>\n<p>DNS 验证与 HTTP 验证的区别在于：你不需要任何服务器，不需要任何公网 IP，只需要获取到 DNS 的解析记录即可为你的域名完成验证。</p>\n<h3 id=\"手动验证\"><a class=\"anchor\" href=\"#手动验证\">#</a> 手动验证</h3>\n<p><strong>&gt;&gt; 如果有自动更新证书的需求，请使用自动验证 &lt;&lt;</strong></p>\n<p>手动验证跟下面的自动验证操作仅有一步之差，那就是手动验证不需要  <code>export Namesilo_Key=&quot;&lt;key&gt;&quot;</code>  ，但需要你手动在域名上添加一条 TXT 记录，验证域名所有权。</p>\n<p>申请签发：</p>\n<pre><code>acme.sh --issue --dns -d domain.com --keylength 2048\n</code></pre>\n<ul>\n<li><code>--issue</code>  表明该命令执行用于申请发配证书。</li>\n<li><code>--dns</code>  默认不带参数表示手动验证；如果带参数，eg： <code>dns_namesilo</code>  ，则表明使用 Namesilo 的 DNS 插件，需要配置环境变量，看下文 &quot;自动验证&quot; 中的操作。</li>\n<li><code>-d</code>  配置参数表示需要签发的域名，需要申请多个域名，追加  <code>-d example.com</code>  即可。</li>\n<li><code>--keylength</code>  参数用于指明密钥类型及长度，可选操作有：\n<ul>\n<li>RSA： <code>2048</code>  ,  <code>3072</code>  ,  <code>4096</code>  ,  <code>8192</code></li>\n<li>ECC： <code>ec-256</code>  ,  <code>ec-384</code>  ,  <code>ec-521</code></li>\n</ul>\n</li>\n</ul>\n<p>验证签发：</p>\n<pre><code>acme.sh --renew -d domain.com\n</code></pre>\n<p>复制证书：</p>\n<pre><code>acme.sh --install-cert -d domain.com \\\n--key-file       /&lt;path&gt;/SSL/private.key  \\\n--fullchain-file /&lt;path&gt;/SSL/chain.pem \\\n--capath         /&lt;path&gt;/SSL/ca.pem  \\\n</code></pre>\n<h3 id=\"自动验证\"><a class=\"anchor\" href=\"#自动验证\">#</a> 自动验证</h3>\n<p>进入 SSL 证书签发流程（<strong>为了演示不同的操作，这里以泛域名为演示</strong>）：</p>\n<p>1、声明所需变量及设置 CA：</p>\n<pre><code># 导入 Namesilo API Key\nexport Namesilo_Key=&quot;&lt;key&gt;&quot;\n\n# 设置默认 CA 为 Let's Encrypt\nacme.sh --set-default-ca --server letsencrypt\n</code></pre>\n<p>note：</p>\n<ul>\n<li>\n<p><code>export</code>  声明的变量，根据 acme 提供的，使用不同的服务商，所需要的验证不一样，这里以 Namesilo 服务商为参考，具体可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FjbWVzaC1vZmZpY2lhbC9hY21lLnNoL3dpa2kvZG5zYXBpI2Ruc19uYW1lc2lsbw==\">https://github.com/acmesh-official/acme.sh/wiki/dnsapi#dns_namesilo</span></p>\n</li>\n<li>\n<p>参数  <code>&lt;key&gt;</code>  为对应服务商申请提供的 key，不同的服务商可能需要多个 key。</p>\n</li>\n</ul>\n<p>2、签发证书</p>\n<p>因为以 Namesilo 服务商为参考，根据上方链接，填入相应的命令：</p>\n<pre><code># 签发 RSA 证书\nacme.sh --issue --dns dns_namesilo -d '*.domain.com' --keylength 2048 --dnssleep 1800\n</code></pre>\n<p>note：</p>\n<ul>\n<li><code>-d</code>  配置参数表示需要签发的域名，因为这里只用泛域名，所以只有一个  <code>-d '*.domain.com'</code>  ，若需要多个则追加，建议主域放在第一个。</li>\n<li><code>dnssleep 1800</code>  ，原有默认使用 900S 等待，如果使用的是 Namesilo 建议修改成 1500+，若不进行适当的等待，在验证过程中可能会因为 DNS 记录尚未完全传播而导致验证失败，导致后面的证书不能正确申请。</li>\n</ul>\n<p>在申请过程中，期间会自动解析一条名为  <code>_acme-challenge</code>  的 TXT 记录，此时如果你去域名管理页面中查看，，可以看到该 TXT 解析记录，等校验完成后会自动删除，所以建议大家选择 DNS 校验，最后将在指定路径下输出：</p>\n<pre><code>Your cert is in: /&lt;path&gt;/&lt;*.domain.com&gt;/xxx.cer\nYour cert key is in: /&lt;path&gt;/&lt;*.domain.com&gt;/xxx.key\nThe intermediate CA cert is in: /&lt;path&gt;/&lt;*.domain.com&gt;/ca.cer\nAnd the full-chain cert is in: /&lt;path&gt;/&lt;*.domain.com&gt;/fullchain.cer\n</code></pre>\n<p>3、安装证书到指定位置</p>\n<p>当上一步执行完毕并成功签发证书下来，即可执行如下操作：</p>\n<pre><code># 安装 RSA 证书到指定路径\nacme.sh --install-cert -d '*.domain.com' \\\n--key-file       /&lt;path&gt;/SSL/RSA/private.key  \\\n--fullchain-file /&lt;path&gt;/SSL/RSA/chain.pem \\\n--capath         /&lt;path&gt;/SSL/RSA/ca.pem  \\\n--reloadcmd      &quot;service nginx reload&quot;\n</code></pre>\n<ul>\n<li><code>--install-cert</code>  命令用于把证书复制到目标路径文件；请勿直接使用默认生成的  <code>~/.acme.sh/</code>  目录下的证书文件，这里面的文件都是内部使用，而且目录结构将来可能会发生变化。</li>\n</ul>\n<p>若是在 “签发证书” 过程中出现错误，仍执行这一步，会提示缺少证书文件。</p>\n<p>4、ECC 证书签发并安装（如若不需，跳过即可）</p>\n<p>ECC 证书获取跟上面的第二第三点类似，只须把部分参数更改一下即可：</p>\n<ul>\n<li><code>--keylength 2048</code>  参数换成  <code>--keylength ec-256</code>  ；</li>\n<li><code>acme.sh --install-cert</code>  参数上追加成  <code>acme.sh --install-cert --ecc</code>  。</li>\n</ul>\n<p>ECC 签证完整操作：</p>\n<pre><code># 签发 ECC 证书，若不需要，跳过即可\nacme.sh --issue --dns dns_namesilo -d '*.domain.com' --keylength ec-256 --dnssleep 1800\n\n# 安装 ECC 证书到指定路径\nacme.sh --install-cert -d '*.domain.com' --ecc \\\n--key-file       /&lt;path&gt;/SSL/ECC/private.key  \\\n--fullchain-file /&lt;path&gt;/SSL/ECC/chain.pem \\\n--capath         /&lt;path&gt;/SSL/ECC/ca.pem  \\\n--reloadcmd      &quot;service nginx reload&quot;\n</code></pre>\n<p>5、收尾</p>\n<p>最后取消先前的  <code>export &lt;key&gt;</code>  的声明，避免 Key 泄露：</p>\n<pre><code># 取消环境变量\nunset Namesilo_Key\n</code></pre>\n<p>查看已签证证书：</p>\n<pre><code>acme.sh --list\nMain_Domain    KeyLength  SAN_Domains  CA               Created               Renew\n*.domain.com  &quot;2048&quot;     no           LetsEncrypt.org  2025-08-23T15:31:28Z  2025-10-21T15:31:28Z\n*.domain.com  &quot;ec-256&quot;   no           LetsEncrypt.org  2025-08-23T05:06:07Z  2025-10-21T05:06:07Z\n</code></pre>\n<p>查看指定证书的详细信息：</p>\n<pre><code># RSA\nacme.sh --info -d &lt;Main_Domain&gt;\n\n# ECC\nacme.sh --info -d &lt;Main_Domain&gt; --ecc\n\n# note：&lt;Main_Domain&gt; 为执行 'acme.sh --list' 输出给出的参数\n</code></pre>\n<h1 id=\"namesilo-泛域名签发整流程\"><a class=\"anchor\" href=\"#namesilo-泛域名签发整流程\">#</a> Namesilo 泛域名签发整流程</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 下方 &lt;domain_conf_path> 为不同域名申请签发存储的文件路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 下方 &lt;path> 为调用 SSL 证书所存放的证书路径</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 导入 Namesilo API Key</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">Namesilo_Key</span><span class=\"token operator\">=</span><span class=\"token string\">\"&lt;key>\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 设置默认 CA 为 Let's Encrypt</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>acme.sh --config-home /<span class=\"token operator\">&lt;</span>domain_conf_path<span class=\"token operator\">></span>/ --set-default-ca <span class=\"token parameter variable\">--server</span> letsencrypt</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 签发 RSA 证书</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>acme.sh --config-home /<span class=\"token operator\">&lt;</span>domain_conf_path<span class=\"token operator\">></span>/ <span class=\"token parameter variable\">--issue</span> <span class=\"token parameter variable\">--dns</span> dns_namesilo <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'*.domain.com'</span> <span class=\"token parameter variable\">--keylength</span> <span class=\"token number\">2048</span> <span class=\"token parameter variable\">--dnssleep</span> <span class=\"token number\">1800</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 安装 RSA 证书到指定路径</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>acme.sh --config-home /<span class=\"token operator\">&lt;</span>domain_conf_path<span class=\"token operator\">></span>/ <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>--install-cert <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'*.domain.com'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>--key-file       /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/SSL/RSA/private.key  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>--fullchain-file /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/SSL/RSA/chain.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token parameter variable\">--capath</span>         /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/SSL/RSA/ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token parameter variable\">--reloadcmd</span>      <span class=\"token string\">\"service nginx reload\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 签发 ECC 证书，若不需要，跳过即可</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>acme.sh --config-home /<span class=\"token operator\">&lt;</span>domain_conf_path<span class=\"token operator\">></span>/ <span class=\"token parameter variable\">--issue</span> <span class=\"token parameter variable\">--dns</span> dns_namesilo <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'*.domain.com'</span> <span class=\"token parameter variable\">--keylength</span> ec-256 <span class=\"token parameter variable\">--dnssleep</span> <span class=\"token number\">1800</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># 安装 ECC 证书到指定路径</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>acme.sh --config-home /<span class=\"token operator\">&lt;</span>domain_conf_path<span class=\"token operator\">></span>/ <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>--install-cert <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'*.domain.com'</span> <span class=\"token parameter variable\">--ecc</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>--key-file       /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/SSL/ECC/private.key  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>--fullchain-file /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/SSL/ECC/chain.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token parameter variable\">--capath</span>         /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/SSL/ECC/ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token parameter variable\">--reloadcmd</span>      <span class=\"token string\">\"service nginx reload\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># 取消环境变量</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token builtin class-name\">unset</span> Namesilo_Key</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># 查看签证</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>acme.sh --config-home /<span class=\"token operator\">&lt;</span>domain_conf_path<span class=\"token operator\">></span>/ <span class=\"token parameter variable\">--list</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\"># 查看指定证书的详细信息 &lt;Main_Domain> 为执行 \"查看签证\" 输出给出的参数</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>acme.sh --config-home /<span class=\"token operator\">&lt;</span>domain_conf_path<span class=\"token operator\">></span>/ <span class=\"token parameter variable\">--info</span> <span class=\"token parameter variable\">-d</span> <span class=\"token operator\">&lt;</span>Main_Domain<span class=\"token operator\">></span></pre></td></tr></table></figure><h1 id=\"nginx-签证配置\"><a class=\"anchor\" href=\"#nginx-签证配置\">#</a> Nginx 签证配置</h1>\n<p>关于在 Nginx 中使用 SSL 的配置方法放在 <a href=\"https://arachnid.cc/nginx-uses-anti-proxy-and-ssl/\">Nginx 反代理并安装 SSL</a> 文章中，以便整体了解 Nginx 配置操作。</p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hdHB4LmNvbS9ibG9nL2F1dG8tdXBkYXRlLXNzbC13aXRoLWFjbWUv\">使用 acme.sh 自动签发和更新证书</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubW9vbmZseS5uZXQvYXJjaGl2ZXMvMTM4Lmh0bWw=\">使用 acme.sh 进行 SSL 证书的申请和自动更新</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9haW1lci1mYW4uZ2l0aHViLmlvL290aGVycy9hY21lLnNo\">acme.sh 中文文档</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9mb3J1bS5waXdpbmQuY29tL2QvMjItc2hpLXlvbmctYWNtZXNoYmFuLWZhLXRsc3poZW5nLXNodS1iaW5nLWFuLXpodWFuZy1kYW8tbmdpbnhhcGFjaGVzaGkteGlhbi13YW5nLXpoYW4taHR0cHNmYW5nLXdlbg==\">使用 acme.sh 颁发 TLS 证书并安装到 nginx/apache 实现网站 https 访问</span></p>\n",
            "tags": []
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-paperless/",
            "url": "https://arachnid.cc/docker-deployment-of-paperless/",
            "title": "docker 部署之 paperless-ngx 文档归类",
            "date_published": "2025-06-18T14:11:18.000Z",
            "content_html": "<blockquote>\n<p>Version：<a href=\"https://github.com/paperless-ngx/paperless-ngx/tree/v2.16.3\"><strong>Paperless-ngx</strong></a> 2.16.3</p>\n</blockquote>\n<p><img data-src=\"image-20250621174546690.png\" alt=\"paperless-ngx login\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>Paperless-ngx 是一个基于 <strong>Django</strong> 框架的开源文档管理系统。与传统的扫描仪相比，它不仅可以将纸质文件数字化，还支持 <strong>OCR（光学字符识别）</strong>，将文档内容识别为可搜索的文本。</p>\n<p>其核心功能包括：</p>\n<ul>\n<li><strong>文档的组织与索引</strong>：通过标签、对应者、类型等多种方式组织扫描文档。</li>\n<li><strong>OCR 文本识别</strong>：对文档进行光学字符识别，使包含图像的扫描文档也能搜索和选择文本。</li>\n<li><strong>多语言支持</strong>：利用开源的 Tesseract 引擎，支持 100 多种语言。</li>\n<li><strong>长期存储格式</strong>：文档以 PDF/A 格式保存，设计用于长期存储。</li>\n<li><strong>智能标签与分类</strong>：使用机器学习自动添加标签、对应者和文档类型。</li>\n<li><strong>广泛的文件支持</strong>：支持 PDF 文档、图像、纯文本文件、Office 文档等。</li>\n<li><strong>定制化的文件管理</strong>：Paperless-ngx 管理文件名和文件夹，支持不同的配置。</li>\n<li><strong>现代化的网页应用</strong>：定制仪表板、过滤器、批量编辑、拖放上传、自定义视图、共享链接等。</li>\n<li><strong>全文搜索</strong>：自动完成、相关性排序、高亮显示匹配查询的部分。</li>\n<li><strong>电子邮件处理</strong>：从电子邮件账户导入文档，配置多个账户和规则。</li>\n<li><strong>多用户权限系统</strong>：内置健壮的多用户权限系统。</li>\n<li><strong>多核系统优化</strong>：并行处理多个文档。</li>\n</ul>\n<p>官网：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnBhcGVybGVzcy1uZ3guY29tLw==\">https://docs.paperless-ngx.com/</span></p>\n<p><img data-src=\"image-20250621174656418.png\" alt=\"paperless-ngx\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>创建 paperless-ngx 数据文件夹及文档归类存放位置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># $PATH 为你的文档归类存放路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /app/paperless-ngx</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/export /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/consume /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/data /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/media</pre></td></tr></table></figure><p>进入到  <code>/app/paperless-ngx</code>  文件夹后，依次创建如下配置所需文件夹：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:/app/paperless-ngx] #\"></td><td><pre><span class=\"token function\">mkdir</span> redisdata dbdata</pre></td></tr></table></figure><p>添加  <code>docker-compose.yml</code>  配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:/app/paperless-ngx] #\"></td><td><pre><span class=\"token function\">touch</span> docker-compose.yml</pre></td></tr></table></figure><p>写入：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"><span>docker-compose.yml</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># docker compose file for running paperless from the Docker Hub.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># This file contains everything paperless needs to run.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># Paperless supports amd64, arm and arm64 hardware.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># All compose files of paperless configure paperless in the following way:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># - Paperless is (re)started on system boot, if it was running before shutdown.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># - Docker volumes for storing data are managed by Docker.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># - Folders for importing and exporting files are created in the same directory</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#   as this file and mounted to the correct folders inside the container.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># - Paperless listens on port 8000.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># In addition to that, this Docker Compose file adds the following optional</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># configurations:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># - Instead of SQLite (default), MariaDB is used as the database server.</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># - Apache Tika and Gotenberg servers are started with paperless and paperless</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#   is configured to use these services. These provide support for consuming</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#   Office documents (Word, Excel, Power Point and their LibreOffice counter-</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#   parts.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># To install and update paperless with this file, do the following:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># - Copy this file as 'docker-compose.yml' and the files 'docker-compose.env'</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#   and '.env' into a folder.</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># - Run 'docker compose pull'.</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># - Run 'docker compose up -d'.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># For more extensive installation and update instructions, refer to the</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\"># documentation.</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.4\"</span>  <span class=\"token comment\"># 指定使用的 Docker Compose 文件版本</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token key atrule\">broker</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> library/redis<span class=\"token punctuation\">:</span><span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> paperless<span class=\"token punctuation\">-</span>broker</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> paperless<span class=\"token punctuation\">-</span>broker</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token punctuation\">-</span> /home/.app/paperless<span class=\"token punctuation\">-</span>ngx/redisdata<span class=\"token punctuation\">:</span>/data</pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> library/mariadb<span class=\"token punctuation\">:</span>lts</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> paperless<span class=\"token punctuation\">-</span>mariadb</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> paperless<span class=\"token punctuation\">-</span>mariadb</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token punctuation\">-</span> /home/.app/paperless<span class=\"token punctuation\">-</span>ngx/dbdata<span class=\"token punctuation\">:</span>/var/lib/mysql</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token key atrule\">MARIADB_HOST</span><span class=\"token punctuation\">:</span> paperless</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token key atrule\">MARIADB_DATABASE</span><span class=\"token punctuation\">:</span> paperless</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token key atrule\">MARIADB_USER</span><span class=\"token punctuation\">:</span> paperless</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token key atrule\">MARIADB_PASSWORD</span><span class=\"token punctuation\">:</span> paperless</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token key atrule\">MARIADB_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> paperless</pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token key atrule\">webserver</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> paperlessngx/paperless<span class=\"token punctuation\">-</span>ngx<span class=\"token punctuation\">:</span>latest</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> paperless<span class=\"token punctuation\">-</span>ngx</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> paperless<span class=\"token punctuation\">-</span>ngx</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token punctuation\">-</span> db</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      <span class=\"token punctuation\">-</span> broker</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      <span class=\"token punctuation\">-</span> gotenberg</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token punctuation\">-</span> tika</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"28030:8000\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 定义健康检查</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"CMD\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"curl\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-fs\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-S\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"--max-time\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"http://localhost:8000\"</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># 使用 curl 命令检查容器内的服务是否健康</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 30s  <span class=\"token comment\"># 每 30 秒检查一次</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 10s  <span class=\"token comment\"># 超时时间为 10 秒</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>  <span class=\"token comment\"># 连续失败 5 次后认为服务不健康</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 如果不太懂下面路径映射具体作用，可看先下面详细的参数说明</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>      <span class=\"token punctuation\">-</span> /srv/dev<span class=\"token punctuation\">-</span>disk<span class=\"token punctuation\">-</span>by<span class=\"token punctuation\">-</span>uuid<span class=\"token punctuation\">-</span>c2850abb<span class=\"token punctuation\">-</span>0f0a<span class=\"token punctuation\">-</span>4770<span class=\"token punctuation\">-</span>8408<span class=\"token punctuation\">-</span>f4d5f0987175/paperless<span class=\"token punctuation\">-</span>ngx/data<span class=\"token punctuation\">:</span>/usr/src/paperless/data    <span class=\"token comment\"># 挂载数据 (检索的索引，源码数据库、分类模型等等) 目录，即 PAPERLESS_DATA_DIR 字段</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      <span class=\"token punctuation\">-</span> /srv/dev<span class=\"token punctuation\">-</span>disk<span class=\"token punctuation\">-</span>by<span class=\"token punctuation\">-</span>uuid<span class=\"token punctuation\">-</span>c2850abb<span class=\"token punctuation\">-</span>0f0a<span class=\"token punctuation\">-</span>4770<span class=\"token punctuation\">-</span>8408<span class=\"token punctuation\">-</span>f4d5f0987175/paperless<span class=\"token punctuation\">-</span>ngx/media<span class=\"token punctuation\">:</span>/usr/src/paperless/media  <span class=\"token comment\"># 挂载存储文档及缩略图目录，即 PAPERLESS_MEDIA_ROOT 字段</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>      <span class=\"token punctuation\">-</span> /srv/dev<span class=\"token punctuation\">-</span>disk<span class=\"token punctuation\">-</span>by<span class=\"token punctuation\">-</span>uuid<span class=\"token punctuation\">-</span>c2850abb<span class=\"token punctuation\">-</span>0f0a<span class=\"token punctuation\">-</span>4770<span class=\"token punctuation\">-</span>8408<span class=\"token punctuation\">-</span>f4d5f0987175/paperless<span class=\"token punctuation\">-</span>ngx/export<span class=\"token punctuation\">:</span>/usr/src/paperless/export  <span class=\"token comment\"># 挂载导出目录</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      <span class=\"token punctuation\">-</span> /srv/dev<span class=\"token punctuation\">-</span>disk<span class=\"token punctuation\">-</span>by<span class=\"token punctuation\">-</span>uuid<span class=\"token punctuation\">-</span>c2850abb<span class=\"token punctuation\">-</span>0f0a<span class=\"token punctuation\">-</span>4770<span class=\"token punctuation\">-</span>8408<span class=\"token punctuation\">-</span>f4d5f0987175/paperless<span class=\"token punctuation\">-</span>ngx/import<span class=\"token punctuation\">:</span>/usr/src/paperless/consume  <span class=\"token comment\"># 挂载加载导入目录，即 PAPERLESS_CONSUMPTION_DIR 字段</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">-</span>compose.env</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      <span class=\"token key atrule\">PAPERLESS_REDIS</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">:</span>//broker<span class=\"token punctuation\">:</span><span class=\"token number\">6379</span>  <span class=\"token comment\"># 配置 Redis 连接信息</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      <span class=\"token key atrule\">PAPERLESS_DBENGINE</span><span class=\"token punctuation\">:</span> mariadb  <span class=\"token comment\"># 选择 mariadb 数据库</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      <span class=\"token key atrule\">PAPERLESS_DBHOST</span><span class=\"token punctuation\">:</span> db  <span class=\"token comment\"># 配置数据库主机地址</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      <span class=\"token key atrule\">PAPERLESS_DBUSER</span><span class=\"token punctuation\">:</span> paperless <span class=\"token comment\"># only needed if non-default username</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>      <span class=\"token key atrule\">PAPERLESS_DBPASS</span><span class=\"token punctuation\">:</span> paperless <span class=\"token comment\"># only needed if non-default password</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>      <span class=\"token key atrule\">PAPERLESS_DBPORT</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      <span class=\"token key atrule\">PAPERLESS_TIKA_ENABLED</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      <span class=\"token key atrule\">PAPERLESS_TIKA_GOTENBERG_ENDPOINT</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//gotenberg<span class=\"token punctuation\">:</span><span class=\"token number\">3000</span>  <span class=\"token comment\"># 配置 Gotenberg 服务的地址</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      <span class=\"token key atrule\">PAPERLESS_TIKA_ENDPOINT</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//tika<span class=\"token punctuation\">:</span><span class=\"token number\">9998</span>  <span class=\"token comment\"># 配置 Tika 服务的地址</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token key atrule\">dns</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 定义 DNS 服务器</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      <span class=\"token punctuation\">-</span> 8.8.8.8  <span class=\"token comment\"># 使用 Google 的 DNS 服务器</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      <span class=\"token punctuation\">-</span> 114.114.114.114  <span class=\"token comment\"># 使用中国运营的 DNS 服务器</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  <span class=\"token key atrule\">gotenberg</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> gotenberg/gotenberg<span class=\"token punctuation\">:</span>latest</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> paperless<span class=\"token punctuation\">-</span>gotenberg</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> paperless<span class=\"token punctuation\">-</span>gotenberg</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token comment\"># The gotenberg chromium route is used to convert .eml files. We do not</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token comment\"># want to allow external content like tracking pixels or even javascript.</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"gotenberg\"</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"--chromium-disable-javascript=true\"</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"--chromium-allow-list=file:///tmp/.*\"</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token key atrule\">tika</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> apache/tika<span class=\"token punctuation\">:</span>latest</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> paperless<span class=\"token punctuation\">-</span>tika</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> paperless<span class=\"token punctuation\">-</span>tika</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token key atrule\">media</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token key atrule\">dbdata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  redisdata<span class=\"token punctuation\">:</span></pre></td></tr></table></figure><p>根据配置，同样单独添加环境变量文件  <code>docker-compose.env</code>  ：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:/app/paperless-ngx] #\"></td><td><pre><span class=\"token function\">touch</span> docker-compose.env</pre></td></tr></table></figure><p>写入：</p>\n<pre><code class=\"language-test\">###############################################################################\n# Paperless-ngx settings                                                      #\n###############################################################################\n\n# See http://docs.paperless-ngx.com/configuration/ for all available options.\n\n# The UID and GID of the user used to run paperless in the container. Set this\n# to your UID and GID on the host so that you have write access to the\n# consumption directory.\nUSERMAP_UID=0\nUSERMAP_GID=0\n\n# See the documentation linked above for all options. A few commonly adjusted settings\n# are provided below.\n\n# This is required if you will be exposing Paperless-ngx on a public domain\n# (if doing so please consider security measures such as reverse proxy)\n#PAPERLESS_URL=https://paperless.example.com\n\n# Adjust this key if you plan to make paperless available publicly. It should\n# be a very long sequence of random characters. You don't need to remember it.\nPAPERLESS_SECRET_KEY=change-me\n\n# Use this variable to set a timezone for the Paperless Docker containers. Defaults to UTC.\nPAPERLESS_TIME_ZONE=Asia/Shanghai\n\n# The default language to use for OCR. Set this to the language most of your\n# documents are written in.\nPAPERLESS_OCR_LANGUAGE=eng\n\n# Additional languages to install for text recognition, separated by a whitespace.\n# Note that this is different from PAPERLESS_OCR_LANGUAGE (default=eng), which defines\n# the language used for OCR.\n# The container installs English, German, Italian, Spanish and French by default.\n# See https://packages.debian.org/search?keywords=tesseract-ocr-&amp;searchon=names&amp;suite=buster\n# for available languages.\nPAPERLESS_OCR_LANGUAGES=chi-sim chi-tra\n\n# Changes the filenames paperless uses to store documents in the media directory. See File name handling for details.\n# Default is none, which disables this feature.\nPAPERLESS_FILENAME_FORMAT=other/&#123;&#123; original_name &#125;&#125;\n</code></pre>\n<p>修改完成后，使用以下命令进行部署：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:/app/paperless-ngx] #\"></td><td><pre><span class=\"token function\">docker-compose</span> up <span class=\"token parameter variable\">-d</span></pre></td></tr></table></figure><h2 id=\"主要参数说明\"><a class=\"anchor\" href=\"#主要参数说明\">#</a> 主要参数说明</h2>\n<p><strong>关于映射路径：</strong></p>\n<p>在  <code>docker-compose.yml</code>  文件的  <code>webserver</code>  服务配置中，存在四个路径的映射，</p>\n<ul>\n<li><code>/usr/src/paperless/data</code>  ：即  <code>PAPERLESS_DATA_DIR</code>  字段，用于存放数据 (检索的索引，源码数据库、分类模型等等)，如果使用默认的  <code>PAPERLESS_LOGGING_DIR</code>  字段，那么 log 文件也将  <code>PAPERLESS_DATA_DIR/log/</code>  路径下存储。具体说明可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnBhcGVybGVzcy1uZ3guY29tL2NvbmZpZ3VyYXRpb24vI1BBUEVSTEVTU19EQVRBX0RJUg==\">https://docs.paperless-ngx.com/configuration/#PAPERLESS_DATA_DIR</span></li>\n<li><code>/usr/src/paperless/media</code>  ：即  <code>PAPERLESS_MEDIA_ROOT</code>  字段，用于存储上传后的文档及提取的缩略文件，后期在面板上的  <code>保存路径</code>  也是此路径为根目录。具体说明可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnBhcGVybGVzcy1uZ3guY29tL2NvbmZpZ3VyYXRpb24vI1BBUEVSTEVTU19NRURJQV9ST09U\">https://docs.paperless-ngx.com/configuration/#PAPERLESS_MEDIA_ROOT</span></li>\n<li><code>/usr/src/paperless/export</code>  ：如其名，该目录一般用于导出现有的文档所指向的存储路径，可以使用  <code>document_exporter</code>  命令执行。具体说明可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnBhcGVybGVzcy1uZ3guY29tL2FkbWluaXN0cmF0aW9uLyNleHBvcnRlcg==\">https://docs.paperless-ngx.com/administration/#exporter</span></li>\n<li><code>/usr/src/paperless/consume</code>  ：即  <code>PAPERLESS_CONSUMPTION_DIR</code>  字段，用于批量加载导入现有的文档，如果你有大量的需要上传分析的文档，只需把这些文档统统放到目录下即可自动帮你处理归档，值得注意的是该目录下不能解析子目录，只处理当前的一级目录，并不会递归处理底下的子目录。具体说明可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnBhcGVybGVzcy1uZ3guY29tL2NvbmZpZ3VyYXRpb24vI1BBUEVSTEVTU19DT05TVU1QVElPTl9ESVI=\">https://docs.paperless-ngx.com/configuration/#PAPERLESS_CONSUMPTION_DIR</span></li>\n</ul>\n<p><strong>关于环境变量：</strong></p>\n<ul>\n<li><code>PAPERLESS_OCR_LANGUAGE</code>  ：该字段是用于设置文档在解析的时候所调用的 OCR 语言，默认是使用  <code>eng</code>  ，一般来说这是一个使用 3 个字符的代码，所支持的语言可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly90ZXNzZXJhY3Qtb2NyLmdpdGh1Yi5pby90ZXNzZG9jL0RhdGEtRmlsZXMtaW4tZGlmZmVyZW50LXZlcnNpb25zLmh0bWw=\">languages Tesseract supports</span> ；当然它也可以是多语言，可以使用  <code>+</code>  符号来组合，eg：  <code>deu+eng</code>  ；值得注意的是，如果使用多语言组合，需要在 <a href=\"https://docs.paperless-ngx.com/configuration/#PAPERLESS_OCR_LANGUAGES\"> <code>PAPERLESS_OCR_LANGUAGES</code> </a> 字段中添加对应的语言，或者在部署后手动安装对应的语言，如何手动安装可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9vY3JteXBkZi5yZWFkdGhlZG9jcy5pby9lbi9sYXRlc3QvbGFuZ3VhZ2VzLmh0bWw=\">Installing additional language packs</span>  。另外，若如果你的语言包含一个  <code>-</code>  字符，如  <code>chi-sim</code>  中文简体，你必须使用  <code>chi_sim</code>  。具体说明可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnBhcGVybGVzcy1uZ3guY29tL2NvbmZpZ3VyYXRpb24vI1BBUEVSTEVTU19PQ1JfTEFOR1VBR0U=\">https://docs.paperless-ngx.com/configuration/#PAPERLESS_OCR_LANGUAGE</span></li>\n<li><code>PAPERLESS_OCR_LANGUAGES</code>  ：用于安装其它的 OCR 语言。 默认情况下，无需安装的语言有英语、德语、意大利语、西班牙语和法语。 如果你需要的语言不在列表中，请使用此配置选项安装所需的语言。 你需要找到正确的 LangCodes，但需要注意的是，<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYWNrYWdlcy5kZWJpYW4ub3JnL2J1bGxzZXllL2dyYXBoaWNzLw==\">tesseract-ocr-* package</span> 中的名字并不总是与语言代码相对应，例如， <code>chi_tra</code>  应指定为  <code>chi-tra</code>  。而对于使用安装多个语言时，必须利用 space 分离 。具体说明可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnBhcGVybGVzcy1uZ3guY29tL2NvbmZpZ3VyYXRpb24vI1BBUEVSTEVTU19PQ1JfTEFOR1VBR0VT\">https://docs.paperless-ngx.com/configuration/#PAPERLESS_OCR_LANGUAGES</span></li>\n<li><code>PAPERLESS_FILENAME_FORMAT</code>  ：该项用于调整你的文档存储结构及文件命名；如果你想以不同的方式命名并分类存储所上传的文档，那么你可以通过参数调整该属性，当然，你也可以后续通过面板设置的  <code>保存路径</code>  中重新调整路径结构及命名方式。在这里的  <code>other/&#123;&#123; original_name &#125;&#125;</code>  参数，拆解出来就是以  <code>原始命名的方式</code>  存储在  <code>$PAPERLESS_MEDIA_ROOT/other/</code>  路径下，eg： <code>PAPERLESS_MEDIA_ROOT</code>  的映射路径为  <code>/mnt/sda1/documents/</code>  上传一份名为  <code>paperless.pdf</code>  的文件，那么它将存储为  <code>/mnt/sda1/documents/other/paperless.pdf</code>  ；而对于官方默认的情况下，您最终会在媒体目录中得到  <code>/mnt/sda1/documents/0000123.pdf</code>  之类的文件。嘛，具体详细的说明可以观看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnBhcGVybGVzcy1uZ3guY29tL2FkdmFuY2VkX3VzYWdlLyNmaWxlLW5hbWUtaGFuZGxpbmc=\">File name handling</span> ，或者自己尝试验证，这里就不作过多的介绍了。</li>\n</ul>\n<p>note：</p>\n<p>关于其它功能配置可以参看官方  <code>docker-compose</code>  文件：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3BhcGVybGVzcy1uZ3gvcGFwZXJsZXNzLW5neC90cmVlL2Rldi9kb2NrZXIvY29tcG9zZQ==\">https://github.com/paperless-ngx/paperless-ngx/tree/dev/docker/compose</span></p>\n<p>关于配置属性字段可以参看官方说明：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnBhcGVybGVzcy1uZ3guY29tL2NvbmZpZ3VyYXRpb24v\">https://docs.paperless-ngx.com/configuration/</span></p>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>进入 paperless-ngx 容器中的 shell 终端：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> paperless-ngx /bin/sh</pre></td></tr></table></figure><p>输入下面的命令创建超级用户：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"# \"></td><td><pre>python3 manage.py createsuperuser</pre></td></tr></table></figure><p>依次输入：<br />\n <code>username</code> <br />\n <code>email</code> <br />\n <code>password</code></p>\n<p>通过浏览器访问  <code>http://localhost:2430</code>  ，输入刚才设置的账号密码：</p>\n<p><img data-src=\"image-20250618232553494.png\" alt=\"image-20250618232553494\" /></p>\n<h2 id=\"ocr-配置\"><a class=\"anchor\" href=\"#ocr-配置\">#</a> OCR 配置</h2>\n<p>在  <code>配置</code>  -&gt;  <code>OCR 设置</code>  中调整为以下参数：</p>\n<p><img data-src=\"image-20250620210917503.png\" alt=\"image-20250620210917503\" /></p>\n<h2 id=\"路径管理\"><a class=\"anchor\" href=\"#路径管理\">#</a> 路径管理</h2>\n<p>在面板上的  <code>保存路径</code>  中，你可以创建不同的存储路径，该路径皆在  <code>PAPERLESS_MEDIA_ROOT</code>  字段的路径下：</p>\n<p><img data-src=\"image-20250621101331594.png\" alt=\"image-20250621101331594\" /></p>\n<p>同样的，这些路径参数也支持 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnBhcGVybGVzcy1uZ3guY29tL2FkdmFuY2VkX3VzYWdlLyNmaWxlbmFtZS1mb3JtYXQtdmFyaWFibGVz\">Placeholders</span> 的属性参数：</p>\n<p><img data-src=\"image-20250621160921382.png\" alt=\"image-20250621160921382\" /></p>\n<h2 id=\"匹配算法\"><a class=\"anchor\" href=\"#匹配算法\">#</a> 匹配算法</h2>\n<p>在  <code>联系人</code>  、 <code>标签</code>  、 <code>保存路径</code>  等管理中，存在匹配算法这一选项，这是用来自动归类，添加到所属联系人、赋予对应的标签或存到指定路径下：</p>\n<p><img data-src=\"image-20250621162127589.png\" alt=\"image-20250621162127589\" /></p>\n<h1 id=\"安可\"><a class=\"anchor\" href=\"#安可\">#</a> 安可</h1>\n<p>关于 App 客户端，可以使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FzdHViZW5ib3JkL3BhcGVybGVzcy1tb2JpbGU=\">Paperless Mobile</span> 软件：</p>\n<p><img data-src=\"image-20250814203639468.png\" alt=\"image-20250814203639468\" /></p>\n<p><img data-src=\"image-20250814203646699.png\" alt=\"image-20250814203646699\" /></p>\n<p>主要功能都有，唯一遗憾就是目前还不支持中文，不过英文基本也能看懂，问题不大。</p>\n<p>功能特点：</p>\n<p>✔️一目了然地查看文档</p>\n<p>✔️添加，删除或编辑文档</p>\n<p>✔️共享、下载和预览文件</p>\n<p>✔️管理和分配标签</p>\n<p>✔️扫描并上传文件到无纸化</p>\n<p>✔️通过无纸化移动上传其他应用程序中的现有文档</p>\n<p>✔️在专用收件箱中轻松处理和管理新文档</p>\n<p>✔️使用广泛的过滤条件搜索文档</p>\n<p>✔️使用生物特征因子保护您的数据</p>\n<p>✔️支持 TLS 互认证（客户端证书）</p>\n<p>✔️现代，直观的 UI 根据材料设计 3 规范构建</p>\n<p>✔️提供英语，德语，波兰语，法语，加泰罗尼亚语，捷克语和土耳其语，并将提供更多</p>\n",
            "tags": [
                "docker"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-v2raya/",
            "url": "https://arachnid.cc/docker-deployment-of-v2raya/",
            "title": "docker 部署之 v2raya 科学上网",
            "date_published": "2025-04-02T11:34:32.000Z",
            "content_html": "<blockquote>\n<p>Version：<a href=\"https://github.com/v2rayA/v2rayA/releases/tag/v2.2.6.7\"><strong>v2rayA</strong></a> 2.2.6.7</p>\n</blockquote>\n<p><img data-src=\"image-20250621175032528.png\" alt=\"v2raya login\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>v2raya 是一个使用 Web UI 来配置 v2ray 的服务，方便好用，特别适合没有图形界面的 linux server 系统。</p>\n<p>主要功能：</p>\n<ul>\n<li>自动定时从机场订阅地址中获取更新配置</li>\n<li>提供透明代理，系统代理，代理端口</li>\n<li>提供路由服务，自动更新 GFWList</li>\n<li>可视化的配置页面</li>\n<li>几乎所有机场都能支持，完美替代 clash 功能</li>\n<li>支持多节点负载均衡</li>\n</ul>\n<p>项目地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3YycmF5QS92MnJheUE=\">https://github.com/v2rayA/v2rayA</span></p>\n<p><img data-src=\"image-20250621175400593.png\" alt=\"v2raya\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>为你的 v2raya 存放创建数据和配置文件夹：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /app/v2raya</pre></td></tr></table></figure><p>运行 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> pull mzz2017/v2raya:latest</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--name</span> v2raya <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--privileged</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--net</span><span class=\"token operator\">=</span>host <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">V2RAYA_LOG_FILE</span><span class=\"token operator\">=</span>/tmp/v2raya.log <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">V2RAYA_V2RAY_BIN</span><span class=\"token operator\">=</span>/usr/local/bin/v2ray <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">V2RAYA_NFTABLES_SUPPORT</span><span class=\"token operator\">=</span>off <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">IPTABLES_MODE</span><span class=\"token operator\">=</span>legacy <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">V2RAYA_ADDRESS</span><span class=\"token operator\">=</span><span class=\"token number\">0.0</span>.0.0:2017 <span class=\"token punctuation\">\\</span> <span class=\"token comment\"># 监听端口为 2017</span></pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /lib/modules:/lib/modules:ro <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /etc/resolv.conf:/etc/resolv.conf <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /app/v2raya:/etc/v2raya <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--restart</span> always <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"\"></td><td><pre>  mzz2017/v2raya</pre></td></tr></table></figure><p>成功运行后，默认的端口为：2017。</p>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>通过访问  <code>http://localhost:2017</code>  ，初始登录建立管理账号：</p>\n<p><img data-src=\"image-20250615093908346.png\" alt=\"image-20250615093908346\" /></p>\n<p>进入后，现在配置里配置好再添加你的订阅地址，一般按如下配置即可：</p>\n<p><img data-src=\"image-20250615094349529.png\" alt=\"image-20250615094349529\" /></p>\n<h2 id=\"gfwlist-模式\"><a class=\"anchor\" href=\"#gfwlist-模式\">#</a> GFWList 模式</h2>\n<p>如果要使用  <code>GFWList 模式</code>  ，记得更新到最新的资源。</p>\n<p><img data-src=\"image-20250816231852555.png\" alt=\"image-20250816231852555\" /></p>\n<h2 id=\"大陆白名单模式\"><a class=\"anchor\" href=\"#大陆白名单模式\">#</a> 大陆白名单模式</h2>\n<p>如果是用大陆白名单模式，可以通过更新  <code>geosite.dat</code>  和  <code>geoip.dat</code>  文件来适应新的规则，这俩文件的存放路径（定义为  <code>/run/user/&#123;uid&#125;/v2raya</code> ，一般 root 用户的 uid 为 0）可进终端后台查看：</p>\n<p><img data-src=\"image-20250615102136530.png\" alt=\"image-20250615102136530\" /></p>\n<p>由于在 v2raya 中没有找到自动更新这俩文件的入口（估计是跟随版本的），所以可以单独写个脚本自动更新（注意：是在 docker 容器里），更新来源可以参看项目：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0xveWFsc29sZGllci92MnJheS1ydWxlcy1kYXQ=\">https://github.com/Loyalsoldier/v2ray-rules-dat</span></p>\n",
            "tags": [
                "docker"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-jellyfin/",
            "url": "https://arachnid.cc/docker-deployment-of-jellyfin/",
            "title": "docker 部署之 jellyfin 家庭影院",
            "date_published": "2025-03-19T11:11:35.000Z",
            "content_html": "<blockquote>\n<p>Version：<a href=\"https://github.com/paperless-ngx/paperless-ngx/tree/v2.16.3\"><strong>Paperless-ngx</strong></a> 10.10.6</p>\n</blockquote>\n<p><img data-src=\"image-20250814212532995.png\" alt=\"image-20250814212532995\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>目前市面上比较主流的家庭媒体服务器的选择主要有三个：Plex、Emby 和 Jellyfin；其中前两款对于基本使用免费，但对于像通过显卡硬件解码等功能是需付费订阅才能使用；而 Jellyfin 是 Emby 某个版本开源后独立出来的一个影音服务软件，是完全开源和免费的。Jellyfin 在一些大佬改装配置好驱动后能适应不同的显卡硬转，以此达到在外网播放的情况下使用硬件转码流畅播放。</p>\n<p>官网：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9qZWxseWZpbi5vcmcv\">https://jellyfin.org/</span></p>\n<p><img data-src=\"image-20250814210117624.png\" alt=\"image-20250814210117624\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>为你的 jellyfin 存放创建缓存和配置文件夹：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># $PATH 为你的影视存放路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /app/jellyfin</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /app/jellyfin</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> cache config</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/media</pre></td></tr></table></figure><h2 id=\"硬解支持\"><a class=\"anchor\" href=\"#硬解支持\">#</a> 硬解支持</h2>\n<p>要让 jellyfin 的 docker 容器调用核显驱动（即人们常说的开启硬解），要满足两个条件：</p>\n<ol>\n<li>拥有支持视频解码的核心显卡，且核心显卡的<strong>驱动程序</strong>运行正常；</li>\n<li>将核显驱动<strong>直通</strong>给 docker 容器，并赋予 docker 容器调用该驱动的权限。</li>\n</ol>\n<p>对于系统是否满足上述第一个条件，可以输入以下命令进行检验：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> /dev/dri</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>total <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>drwxr-xr-x <span class=\"token number\">2</span> root root         <span class=\"token number\">80</span> Jun <span class=\"token number\">20</span> 02:04 by-path</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>crw-rw---- <span class=\"token number\">1</span> root video  <span class=\"token number\">226</span>,   <span class=\"token number\">0</span> Jun <span class=\"token number\">20</span> 02:04 card0</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>crw-rw---- <span class=\"token number\">1</span> root render <span class=\"token number\">226</span>, <span class=\"token number\">128</span> Jun <span class=\"token number\">20</span> 02:04 renderD128</pre></td></tr></table></figure><p>终端返回的结果有  <code>renderD128</code>  ，那么它即对应你的核显，硬件系统满足视频解码的基本条件。</p>\n<p>接下来为这个核显驱动授予 docker 容器的驱动权限；从上面可以看到  <code>crw-rw---- 1 root render  226</code>  中， <code>root</code>  为管理用户，  <code>render</code>  为所在组，如果你不想麻烦可以在部署的时候直接赋予 root 权限，若是想分组或分用户管理，那就需要分别获取对应的用户 UID 或所属组 GID，通过如下命令获取（不同发行版请根据对应命令获取）：</p>\n<p>获取 UID：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># &lt;GROUP> 为查询的用户</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">id</span> <span class=\"token parameter variable\">-u</span> <span class=\"token operator\">&lt;</span>USER_NAME<span class=\"token operator\">></span></pre></td></tr></table></figure><p>获取 GID：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># &lt;GROUP> 为查询的组名</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre>getent group <span class=\"token operator\">&lt;</span>GROUP_NAME<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token function\">cut</span> -d: <span class=\"token parameter variable\">-f3</span></pre></td></tr></table></figure><p>运行 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> pull nyanmisaka/jellyfin:latest</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>jellyfin <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">PUID</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">PGID</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8096</span>:8096 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /app/jellyfin/config:/config <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /app/jellyfin/cache:/cache <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--mount</span> <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span>bind,source<span class=\"token operator\">=</span>/srv/dev-disk-by-uuid-fb7da335-33b8-4fac-8bbe-24c4cd13ccf7/media,destination<span class=\"token operator\">=</span>/media,ro<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--device</span><span class=\"token operator\">=</span>/dev/dri/renderD128 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--restart</span> always <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>  nyanmisaka/jellyfin</pre></td></tr></table></figure><p>note：如果有需要用到不同的管理用户或管理组，那么在使用硬解的前提，需要获取对应 UID 和 GID 填写到部署上，否则后面使用硬解将会有问题，具体获取看上面。</p>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>通过浏览器访问：  <code>http://localhost:8096</code>  ，按照指示一步步初始化配置：</p>\n<p><img data-src=\"image-20250816144652927.png\" alt=\"image-20250816144652927\" /></p>\n<p>配置你的管理员账号：</p>\n<p><img data-src=\"image-20250816144721170.png\" alt=\"image-20250816144721170\" /></p>\n<p>设置媒体读取路径，这里可以先跳过，后面进入控制台设置：</p>\n<p><img data-src=\"image-20250816144851150.png\" alt=\"image-20250816144851150\" /></p>\n<p>如需云端访问，可开启以下设置：</p>\n<p><img data-src=\"image-20250816145031703.png\" alt=\"image-20250816145031703\" /></p>\n<p>最后完成初始配置后，即可重新登录进入主界面：</p>\n<p><img data-src=\"image-20250816145114308.png\" alt=\"image-20250816145114308\" /></p>\n<p><img data-src=\"image-20250816145443332.png\" alt=\"image-20250816145443332\" /></p>\n<h2 id=\"硬解配置\"><a class=\"anchor\" href=\"#硬解配置\">#</a> 硬解配置</h2>\n<p>点击左上角：</p>\n<p><img data-src=\"image-20250816094625543.png\" alt=\"image-20250816094625543\" /></p>\n<p>进入 &quot;控制台&quot; ：</p>\n<p><img data-src=\"image-20250816094722765.png\" alt=\"image-20250816094722765\" /></p>\n<p>在 jellyfin 容器中的 shell 终端执行：</p>\n<pre><code>ls /dev/dri\n</code></pre>\n<p>确认显卡直通，正常将会显示：</p>\n<p><img data-src=\"image-20250816105816703.png\" alt=\"image-20250816105816703\" /></p>\n<p>记录并配置解码器：</p>\n<p><img data-src=\"image-20250816095148702.png\" alt=\"image-20250816095148702\" /></p>\n<p>note：</p>\n<ol>\n<li>硬件加速这里：下拉选择 &quot;Video Acceleartion API (VAAP)&quot; 或者 &quot;Intel QuickSync (QSV)&quot; ，不是太老的核 / 独显卡，建议选 QSV；</li>\n<li>如果播放失败，则可以尝试关闭 &quot;启用低电压模式的 Intel H.264 硬件编码器&quot; 和 &quot;启用低电压模式的 Intel HEVC 硬件编码器&quot; ;</li>\n<li>如需播放杜比视界，必须关闭 &quot;启用 VPP 色调映射&quot; ;</li>\n<li>如需支持杜比视界格式的 HDR 视频，则必须打开 &quot;首选系统原生的 DXVA 或 VA-API 硬件解码器&quot; ;</li>\n<li>最后根据实际情况选中 &quot;允许实时提取字幕&quot; 和 &quot;限制转码速度&quot; ；</li>\n</ol>\n<p>测试转码：</p>\n<p><img data-src=\"image-20250816105231987.png\" alt=\"image-20250816105231987\" /></p>\n<p><img data-src=\"image-20250816103820476.png\" alt=\"image-20250816103820476\" /></p>\n<p>硬解码资源占用：</p>\n<p><img data-src=\"image-20250816104002038.png\" alt=\"image-20250816104002038\" /></p>\n<p>如果不使用硬解码，那么你将会看到 CPU 占用 95% 以上的使用率，并且对于低性能 CPU 来说，将会播放卡顿：</p>\n<p><img data-src=\"image-20250816104339045.png\" alt=\"image-20250816104339045\" /></p>\n<h2 id=\"添加插件\"><a class=\"anchor\" href=\"#添加插件\">#</a> 添加插件</h2>\n<p><code>控制台</code>  -&gt;  <code>目录</code>  -&gt;  <code>存储库</code>  -&gt; 点击加号进行添加</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># Jellyfin Stable</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>http://fra1.mirror.jellyfin.org/releases/plugin/manifest-stable.json</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre># jellyfin-plugin-metashark</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>https://github.com/cxfksword/jellyfin-plugin-metashark/releases/download/manifest/manifest.json</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre># jellyfin-plugin-metatube</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>https://raw.githubusercontent.com/metatube-community/jellyfin-plugin-metatube/dist/manifest.json</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre># jellyfin-plugin-bangumi</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>https://kookxiang.github.io/jellyfin-plugin-bangumi/repository.json</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre># jellyfin-plugin-manifest</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>https://raw.githubusercontent.com/danieladov/JellyfinPluginManifest/master/manifest.json</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre># jellyfin-plugins-manifest</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>https://www.iamparadox.dev/jellyfin/plugins/manifest.json</pre></td></tr></table></figure><p>如果加载完以上插件后，可以按需安装相应插件，一般用以下插件足矣：</p>\n<p><img data-src=\"image-20250816110312936.png\" alt=\"image-20250816110312936\" /></p>\n<ol>\n<li>File Transformation 和 Media Bar 是用于配置主题的，也即前面看到的电影背景封面及简介显示的轮播滚动。</li>\n<li>SkinManager 同样也是配置主题，目前里面支持九个主题配置。</li>\n<li>Bangumi 主要用于动漫刮削及动漫信息同步。</li>\n<li>MetaShark 和 MetaTube 则是用于电影和 xxx 的信息刮削。</li>\n<li>其余的部分也是用于刮削及资源整理的，具体可测试使用。</li>\n</ol>\n<h1 id=\"安可\"><a class=\"anchor\" href=\"#安可\">#</a> 安可</h1>\n<p>如果不想用网页端观看，而使用客户端，那么关于客户端应用可以在以下链接获取所需应用：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qZWxseWZpbi5vcmcvZG93bmxvYWRz\">https://jellyfin.org/downloads</span></p>\n<p>在这里，你也可以使用第三方的客户端 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2phcm5lZGVtZXVsZW1lZXN0ZXIvZmluZHJvaWQ=\">Findroid</span> ：</p>\n<p><img data-src=\"image-20250816114435404.png\" alt=\"image-20250816114435404\" /></p>\n<p><img data-src=\"image-20250816114441878.png\" alt=\"image-20250816114441878\" /></p>\n<p>目前使用下来，有个致命缺陷，混合类型和音乐类型的合集是无法显示的，只能电影或电视剧。</p>\n",
            "tags": [
                "docker",
                "nas"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-navidrome/",
            "url": "https://arachnid.cc/docker-deployment-of-navidrome/",
            "title": "docker 部署之 navidrome 音乐播放",
            "date_published": "2025-03-19T11:11:35.000Z",
            "content_html": "<blockquote>\n<p>Version：<a href=\"https://github.com/navidrome/navidrome/tree/v0.55.2\"><strong>Navidrome</strong></a> 0.55.2</p>\n</blockquote>\n<p><img data-src=\"image-20250816115804062.png\" alt=\"image-20250816115804062\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>Navidrome 是一款开源的、轻量级的、自托管的音乐服务器，兼容 Subsonic API，可以通过网页或客户端应用访问和播放音乐。</p>\n<p>特点：</p>\n<ul>\n<li>处理超大音乐收藏</li>\n<li>几乎可串流任何音频格式</li>\n<li>读取并使用所有精心策划的元数据</li>\n<li>对合集（Various Artists 专辑）和盒装（多碟专辑）的强大支持</li>\n<li>多用户，每个用户都有自己的播放次数、播放列表、收藏夹等。</li>\n<li>资源使用率极低</li>\n<li>多平台，可在 macOS、Linux 和 Windows 上运行。还提供 Docker 映像</li>\n<li>所有主要平台（包括 Raspberry Pi）的二进制文件均可随时使用</li>\n<li>自动监控资料库变化，导入新文件并重新加载新元数据</li>\n<li>基于 Material UI 的可主题化、现代化和响应式网络界面</li>\n<li>与所有 Subsonic / Madsonic / Airsonic 客户端兼容</li>\n<li>即时转码可按用户 / 播放器设置。支持 Opus 编码</li>\n<li>翻译成各种语言</li>\n</ul>\n<p><img data-src=\"image-20250816143236595.png\" alt=\"image-20250816143236595\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>创建 navidrome 数据文件夹及音乐存放位置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># $PATH 为你的相册存放路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /app/navidrome/data</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/music</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /app/navidrome</pre></td></tr></table></figure><p>添加  <code>docker-compose.yml</code>  配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:/app/navidrome] #\"></td><td><pre><span class=\"token function\">touch</span> docker-compose.yml</pre></td></tr></table></figure><p>写入：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"><span>docker-compose.yml</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">navidrome</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> deluan/navidrome<span class=\"token punctuation\">:</span>latest</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> navidrome</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> navidrome</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">:</span><span class=\"token number\">0</span> <span class=\"token comment\"># should be owner of volumes</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"4533:4533\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">-</span> network</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token comment\"># Optional: put your config options customization here. Examples:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">ND_SCANNER_ENABLED</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token key atrule\">ND_SCANNER_SCHEDULE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"@weekly\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">ND_LOGLEVEL</span><span class=\"token punctuation\">:</span> info</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token key atrule\">ND_SESSIONTIMEOUT</span><span class=\"token punctuation\">:</span> 12h</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token key atrule\">ND_BASEURL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token key atrule\">ND_DEFAULTLANGUAGE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"zh-Hans\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token key atrule\">ND_LASTFM_ENABLED</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token key atrule\">ND_LISTENBRAINZ_ENABLED</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token key atrule\">ND_ENABLEDOWNLOADS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token key atrule\">ND_ENABLEFAVOURITES</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token key atrule\">ND_ENABLESHARING</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token key atrule\">ND_ENABLESTARRATING</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token key atrule\">ND_ENABLETRANSCODINGCONFIG</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token key atrule\">ND_TRANSCODINGCACHESIZE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"400MB\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token key atrule\">ND_IMAGECACHESIZE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"100MB\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token key atrule\">ND_SCANNER_ARTISTJOINER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&amp;\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"/app/navidrome/data:/data\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"/&lt;$PATH>/music:/music:ro\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token key atrule\">network</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> bridge</pre></td></tr></table></figure><p>修改完成后，使用以下命令进行部署：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker-compose</span> up <span class=\"token parameter variable\">-d</span></pre></td></tr></table></figure><h2 id=\"主要参数说明\"><a class=\"anchor\" href=\"#主要参数说明\">#</a> 主要参数说明</h2>\n<p><strong>关于环境变量：</strong></p>\n<ul>\n<li><code>ND_SCANNER_ENABLED</code>  ：该字段用于是否启用计划扫描功能，默认是不开启，如果设为  <code>true</code>  ，那么将根据  <code>ND_SCANNER_SCHEDULE</code>  字段参数进行定时扫描。</li>\n<li><code>ND_SCANNER_SCHEDULE</code>  ：通过 Cron 语法定义自动扫描的时间，可以利用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jcm9udGFiLmd1cnUv\">https://crontab.guru/</span> 生成你所需的计划时间。</li>\n<li><code>ND_LOGLEVEL</code>  ：如其名，用于记录调试信息的等级，支持  <code>error</code> ,  <code>warn</code> ,  <code>info</code> ,  <code>debug</code> ,  <code>trace</code>  。</li>\n<li><code>ND_SESSIONTIMEOUT</code>  ：用于设置 web UI 登录后无操作的退出时间。</li>\n<li><code>ND_BASEURL</code>  ：该字段用于配置 navidrome 的代理地址，不需要则为空。</li>\n<li><code>ND_DEFAULTLANGUAGE</code>  ：设置默认登录 web UI 时所显示的语言文本，支持语言可看 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL25hdmlkcm9tZS9uYXZpZHJvbWUvdHJlZS9tYXN0ZXIvcmVzb3VyY2VzL2kxOG4=\">resources/i18n</span> ；对于中文语言有简体和繁体之分，所以要明确格式，eg：中文简体 -  <code>zh-Hans</code>  ，而中文繁体则为  <code>zh-Hant</code>  。</li>\n<li><code>ND_LASTFM_ENABLED</code>  ：是否需要集成 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGFzdC5mbS8=\">Last.fm</span>，一般用来获取艺人信息，默认打开，如果使用则需要配置  <code>ND_LASTFM_APIKEY</code>  、 <code>ND_LASTFM_SECRET</code>  。由于 <span class=\"exturl\" data-url=\"aHR0cDovL0xhc3QuZm0=\">Last.fm</span> 是在国外架设服务器，国内访问时常抽风，因此建议关闭。</li>\n<li><code>ND_LISTENBRAINZ_ENABLED</code>  ：是否需要集成 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9saXN0ZW5icmFpbnoub3JnLw==\">Listen Brainz</span>，用于补全专辑 / 歌曲信息、封面信息等标签信息，默认打开；可用  <code>ND_LISTENBRAINZ_BASEURL</code>  字段覆盖 Listen Brainz 默认地址，例如使用镜像 Listen Brainz 替代。由于 Listen Brainz 是在国外架设服务器，国内访问时常抽风，因此建议关闭。</li>\n<li><code>ND_ENABLEDOWNLOADS</code>  ：是否允许从 Web 界面下载音乐 / 专辑 / 播放列表，建议关闭，默认打开。</li>\n<li><code>ND_ENABLEFAVOURITES</code>  ：是否允许从 Web 界面星标或收藏 歌曲 / 专辑 / 艺术家。</li>\n<li><code>ND_ENABLESHARING</code>  ：是否允许创建分享链接。</li>\n<li><code>ND_ENABLESTARRATING</code>  ：是否在 Web 界面启用 5 星评分机制。</li>\n<li><code>ND_ENABLETRANSCODINGCONFIG</code>  ：是否允许在 Web 界面修改转码设置。</li>\n<li><code>ND_TRANSCODINGCACHESIZE</code>  ：用于设置转码缓存大小，设为 0 时禁用转码缓存，默认为 100MB。</li>\n<li><code>ND_IMAGECACHESIZE</code>  ：用于设置媒体图像缓存大小，设为 0 时禁用媒体图像缓存，默认为 100MB。</li>\n<li><code>ND_SCANNER_ARTISTJOINER</code>  ：当存在多个艺术家时，用于界分每个艺术家，而分割的字符则由该字段控制。</li>\n</ul>\n<p><strong>关于多个艺术家显示：</strong></p>\n<p>在 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubmF2aWRyb21lLm9yZy9kb2NzL3VzYWdlL2N1c3RvbXRhZ3MvI2NvbmZpZ3VyaW5nLWN1c3RvbS10YWdz\">Configuring custom tags</span> 中有提到：</p>\n<p><img data-src=\"image-20250816225344016.png\" alt=\"image-20250816225344016\" /></p>\n<p>因此，除了上面的  <code>ND_SCANNER_ARTISTJOINER</code>  字段能定义总的艺术家切割字符外，还可以自定义详细的不同分类的切割字符，因此，我们可以在  <code>navidrome.toml</code>  文件中编写需要的信息：</p>\n<pre><code>vim /app/navidrome/data/navidrome.toml\n</code></pre>\n<p>写入：</p>\n<figure class=\"highlight toml\"><figcaption data-lang=\"TOML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key property\">Tags.Artist.Split</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\" / \"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\" feat. \"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"feat.\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\" feat \"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\" ft. \"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\" ft \"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"; \"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&amp;\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key property\">Tags.Roles.Split</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\";\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&amp;\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><ul>\n<li><code>Tags.Artist.Split</code>  ：表示存在多个艺术家 / 专辑艺术家时，所识别分割的匹配字符。</li>\n<li><code>Tags.Roles.Split</code>  ：表示除了  <code>Tags.Artist.Split</code>  定义的艺术家和专辑艺术家以外的，所有剩余的作词家、作曲家以及编曲家等存在多个时，其所匹配分割的字符。</li>\n</ul>\n<p>如果容器启动后找不到  <code>navidrome.toml</code>  文件识别，可以在  <code>ND_CONFIGFILE</code>  字段中指定位置（该字段默认为  <code>&quot;./navidrome.toml&quot;</code> ）。</p>\n<p>note：</p>\n<p>关于其它的变量属性可以参看官方说明：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubmF2aWRyb21lLm9yZy9kb2NzL3VzYWdlL2NvbmZpZ3VyYXRpb24tb3B0aW9ucy8jZW52aXJvbm1lbnQtdmFyaWFibGVz\">https://www.navidrome.org/docs/usage/configuration-options/#environment-variables</span></p>\n<p>关于加载外部配置属性参数可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL25hdmlkcm9tZS9uYXZpZHJvbWUvYmxvYi9tYXN0ZXIvcmVzb3VyY2VzL21hcHBpbmdzLnlhbWw=\">https://github.com/navidrome/navidrome/blob/master/resources/mappings.yaml</span></p>\n<h2 id=\"音乐库分类管理\"><a class=\"anchor\" href=\"#音乐库分类管理\">#</a> 音乐库分类管理</h2>\n<p>通常情况下音乐库的结构分类应该是：</p>\n<pre><code>.\n|-- Artist A\n|   |-- Albums A\n|   |   |-- Music A\n|   |   |-- Music B\n|   |   |-- ......\n|   |   `-- Music n\n|   |-- Albums B\n|   |   |-- Music A\n|   |   |-- Music B\n|   |   |-- ......\n|   |   `-- Music n\n|   |-- ......\n|   `-- Albums n\n|       |-- Music A\n|       |-- Music B\n|       |-- ......\n|       `-- Music n\n|-- Artist B\n|   |-- Albums A\n|   |   |-- Music A\n|   |   |-- Music B\n|   |   |-- ......\n|   |   `-- Music n\n|   |-- Albums B\n|   |   |-- Music A\n|   |   |-- Music B\n|   |   |-- ......\n|   |   `-- Music n\n|   |-- ......\n|   `-- Albums n\n|       |-- Music A\n|       |-- Music B\n|       |-- ......\n|       `-- Music n\n|-- ......\n`-- Artist n\n    |-- Albums A\n    |   |-- Music A\n    |   |-- Music B\n    |   |-- ......\n    |   `-- Music n\n    |-- Albums B\n    |   |-- Music A\n    |   |-- Music B\n    |   |-- ......\n    |   `-- Music n\n    |-- ......\n    `-- Albums n\n        |-- Music A\n        |-- Music B\n        |-- ......\n        `-- Music n\n</code></pre>\n<p>由于在部署 navidrome 的时候没有集成 lastfm, spotify, deezer 组件，因此，在查看艺术家的时候是没有相应的图片的，所以你可以在你的对应艺术家分类目录下放置艺术家图片即可显示，图片命名以  <code>ND_ARTISTARTPRIORITY</code>  字段的参数为匹配项，默认为  <code>&quot;artist.*, album/artist.*, external&quot;</code>  ；</p>\n<p>eg：</p>\n<p>在目录下放置  <code>artist.jpg</code>  艺术家封图：</p>\n<p><img data-src=\"image-20250817120342493.png\" alt=\"image-20250817120342493\" /></p>\n<p>在查看对应 artist 显示，可以看到已经识别导入了（需要完全扫描一次）：</p>\n<p><img data-src=\"image-20250817120526221.png\" alt=\"image-20250817120526221\" /></p>\n<p>而对于 artist 本地传记显示，目前版本还不支持，但已经有需求提出了，具体可看 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL25hdmlkcm9tZS9uYXZpZHJvbWUvaXNzdWVzLzk2MQ==\">https://github.com/navidrome/navidrome/issues/961</span> ；当然，如果对自己网络访问国外服务器有信心的，可以启用  <code>ND_LASTFM_ENABLED</code>  or  <code>ND_SPOTIFY_ID</code>  项，即可实现 artist 封图和简介等相关信息：</p>\n<p><img data-src=\"image-20250817140334532.png\" alt=\"image-20250817140334532\" /></p>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>浏览器访问  <code>http://localhost:4533</code>  ，首次进入需要设置账号密码：</p>\n<p><img data-src=\"image-20250817135949534.png\" alt=\"image-20250817135949534\" /></p>\n<h2 id=\"音乐标签信息\"><a class=\"anchor\" href=\"#音乐标签信息\">#</a> 音乐标签信息</h2>\n<p>对于歌曲的标签信息写入，只要符合常规的 &quot;ID3Tags&quot; 都能读取，像中文这种，推荐使用 &quot;ID3v2.3 UTF-16&quot; 格式。关于 navidrome 中定制的 tag，可以参看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubmF2aWRyb21lLm9yZy9kb2NzL3VzYWdlL3RhZ2dpbmctZ3VpZGVsaW5lcy8=\">https://www.navidrome.org/docs/usage/tagging-guidelines/</span></p>\n<h1 id=\"安可\"><a class=\"anchor\" href=\"#安可\">#</a> 安可</h1>\n<p>Navidrome 除了网页界面，还支持各种第三方客户端：</p>\n<ul>\n<li>iOS: <span class=\"exturl\" data-url=\"aHR0cDovL21pY2hhZWxzYXBwcy5kay9wbGF5c3ViYXBwLw==\">play:Sub</span>, <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdWJzdHJlYW1lcmFwcC5jb20v\">substreamer</span>, <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0JMZWVFWi9hbXBlcmZ5I3JlYWRtZQ==\">Amperfy</span> and <span class=\"exturl\" data-url=\"aHR0cHM6Ly9pc3ViLmFwcC8=\">iSub</span></li>\n<li>Android: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0NhcHBpZWxsb0FudG9uaW8vdGVtcG8=\">Tempo</span>, <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3Nhd3llcmYvQ2FzdGFmaW9yZQ==\">Castafiore</span>, <span class=\"exturl\" data-url=\"aHR0cHM6Ly9wbGF5Lmdvb2dsZS5jb20vc3RvcmUvYXBwcy9kZXRhaWxzP2lkPWdpdGh1Yi5kYW5lcmVuMjAwNS5kc3Vi\">DSub</span>, <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2F1c3RpbnJpZWQvc3VidHJhY2tzI3JlYWRtZQ==\">Subtracks</span>, <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdWJzdHJlYW1lcmFwcC5jb20v\">substreamer</span>, <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3VsdHJhc29uaWMvdWx0cmFzb25pYyNyZWFkbWU=\">Ultrasonic</span>, <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL252bGxzdm0vQXVkaW5hdXQjcmVhZG1l\">Audinaut</span> and <span class=\"exturl\" data-url=\"aHR0cHM6Ly9tdXNpYy5hcXpzY24uY24v\">音流</span></li>\n<li>Web: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3BlZ3Vlcm9zZGMvc3VicGxheWVyI3JlYWRtZQ==\">Subplayer</span>, <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RhbWxhbmQvYWlyc29uaWMtcmVmaXgjcmVhZG1l\">Airsonic Refix</span>, <span class=\"exturl\" data-url=\"aHR0cDovL3NocmltcHphLmdpdGh1Yi5pby9hdXJpYWwv\">Aurial</span>, <span class=\"exturl\" data-url=\"aHR0cDovL2phbXN0YXNoLmNvbS8=\">Jamstash</span> and <span class=\"exturl\" data-url=\"aHR0cDovL3Auc3ViZmlyZXBsYXllci5uZXQv\">Subfire</span></li>\n<li>Desktop: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdWJsaW1lbXVzaWMuYXBwLw==\">Sublime Music</span> (Linux) and <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2plZmZ2bGkvc29uaXhk\">Sonixd</span> (Windows/Linux/macOS)</li>\n<li>CLI: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RyeWZmZWwvamVsbHljbGkjcmVhZG1l\">Jellycli</span> (Windows/Linux) and <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3dpbGRleWVkc2tpZXMvc3RtcCNyZWFkbWU=\">STMP</span> (Linux/macOS)</li>\n<li>Connected Speakers:\n<ul>\n<li>Sonos: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NpbW9qZW5raS9ib25vYiNyZWFkbWU=\">bonob</span></li>\n<li>Alexa: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NyaWNodGVyL2Fza3NvbmljI3JlYWRtZQ==\">AskSonic</span></li>\n</ul>\n</li>\n<li>Other:\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3dhcndpY2toL3BsdWdpbi5hdWRpby5zdWJzb25pYyNyZWFkbWU=\">Subsonic Kodi Plugin</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0JvYkhhc05vU291bC9wbHVnaW4uYXVkaW8ubmF2aWRyb21lI3JlYWRtZQ==\">Navidrome Kodi Plugin</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZhbmdmdWZ1L2h0dHBkaXJmcyNyZWFkbWU=\">HTTPDirFS</span></li>\n</ul>\n</li>\n</ul>\n<p>在这里，安卓手机客户端可以尝试使用 Temop 或 Castafiore，当然还有其它的，具体哪个好用、谁才适合，则看自己的使用需求了。</p>\n<p>下面为 Tempo 的使用界面：</p>\n<p><img data-src=\"image-20250816160120279.png\" alt=\"image-20250816160120279\" /></p>\n<p><img data-src=\"image-20250816160132127.png\" alt=\"image-20250816160132127\" /></p>\n<p><img data-src=\"image-20250816160140991.png\" alt=\"image-20250816160140991\" /></p>\n<p>Castafiore 使用界面：</p>\n<p><img data-src=\"image-20250817151224772.png\" alt=\"image-20250817151224772\" /></p>\n<p><img data-src=\"image-20250817151230932.png\" alt=\"image-20250817151230932\" /></p>\n<p><img data-src=\"image-20250817151240959.png\" alt=\"image-20250817151240959\" /></p>\n",
            "tags": [
                "docker",
                "nas"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-qbittorrent/",
            "url": "https://arachnid.cc/docker-deployment-of-qbittorrent/",
            "title": "docker 部署之 qbittorrent 资源下载",
            "date_published": "2025-03-08T01:54:09.000Z",
            "content_html": "<blockquote>\n<p>Version：<a href=\"https://github.com/linuxserver/docker-qbittorrent\"><strong>qBittorrent</strong></a> v5.0.4</p>\n</blockquote>\n<p><img data-src=\"image-20250621175702013.png\" alt=\"qbittorrent login\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>qBittorrent 是一款免费的开源种子下载工具，作为 µTorrent 的替代品。它在所有平台上都提供相同的功能，包括 Windows、Linux 和 macOS。该应用程序还配备了一个可扩展的搜索引擎以及 Web UI 远端，以最大化你的 torrent 体验。使用 qBittorrent，你可以在多个平台上轻松下载你喜爱的内容。</p>\n<p>官网：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucWJpdHRvcnJlbnQub3JnLw==\">https://www.qbittorrent.org/</span></p>\n<p>项目：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2xpbnV4c2VydmVyL2RvY2tlci1xYml0dG9ycmVudA==\">https://github.com/linuxserver/docker-qbittorrent</span></p>\n<p><img data-src=\"image-20250621180126200.png\" alt=\"qbittorrent\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>创建 qbittorrent 数据文件存放位置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># $PATH 为你的下载存放路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /app/qbittorrent/config /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /app/qbittorrent</pre></td></tr></table></figure><p>添加  <code>docker-compose.yml</code>  配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:/app/navidrome] #\"></td><td><pre><span class=\"token function\">vim</span> docker-compose.yml</pre></td></tr></table></figure><p>写入：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"><span>docker-compose.yml</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">qbittorrent</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> linuxserver/qbittorrent<span class=\"token punctuation\">:</span>latest</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> qbittorrent</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">-</span> PUID=0</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">-</span> PGID=0</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token punctuation\">-</span> TZ=Asia/Shanghai</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token punctuation\">-</span> WEBUI_PORT=9350 <span class=\"token comment\"># Web UI 访问端口</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">-</span> TORRENTING_PORT=18960 <span class=\"token comment\"># 容器的监听端口</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token punctuation\">-</span> /app/qbittorrent/config<span class=\"token punctuation\">:</span>/config</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token punctuation\">-</span> /&lt;$PATH<span class=\"token punctuation\">></span>/downloads<span class=\"token punctuation\">:</span>/downloads <span class=\"token comment\">#optional</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token punctuation\">-</span> 9350<span class=\"token punctuation\">:</span><span class=\"token number\">9350</span> <span class=\"token comment\"># 映射须一致</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token punctuation\">-</span> 18960<span class=\"token punctuation\">:</span><span class=\"token number\">18960</span> <span class=\"token comment\"># TCP 监听端口</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">-</span> 18960<span class=\"token punctuation\">:</span>18960/udp <span class=\"token comment\"># UDP 监听端口</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always</pre></td></tr></table></figure><p>note：</p>\n<p><code>TORRENTING_PORT</code>  最好避免填写  <code>6881</code>  端口，运营商一般屏蔽该端口，选  <code>10000</code>  后的比较好；当改动该项的时候，底下的  <code>TCP 监听端口</code>  和  <code>UDP 监听端口</code>  也要一同改变；如果想通过在 Web UI 上变换端口，则只是当前保存生效，重启容器后会自动变回  <code>TORRENTING_PORT</code>  的配置端口。</p>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>访问  <code>http://localhost:9350</code>  ，初次登录，默认用户名（admin）和密码，通过启动日志获取；可在主机通过终端命令  <code>docker logs qbittorrent</code>  获取：</p>\n<p><img data-src=\"2034870-20231230013241798-192308779.png\" alt=\"img\" /></p>\n<h2 id=\"语言切换\"><a class=\"anchor\" href=\"#语言切换\">#</a> 语言切换</h2>\n<p>在  <code>设置</code>  -&gt;  <code>行为</code>  中找到语言，进行你需要的配置，然后点击保存：</p>\n<p><img data-src=\"image-20250615115000144.png\" alt=\"image-20250615115000144\" /></p>\n<h2 id=\"密码修改\"><a class=\"anchor\" href=\"#密码修改\">#</a> 密码修改</h2>\n<p>由于初始化的账号密码随机性，可以在  <code>设置</code>  -&gt;  <code>WebUI</code>  中的验证更改：</p>\n<p><img data-src=\"image-20250615115248894.png\" alt=\"image-20250615115248894\" /></p>\n<h2 id=\"更改监听端口\"><a class=\"anchor\" href=\"#更改监听端口\">#</a> 更改监听端口</h2>\n<p>如出现默认端口被一般 PT 站点禁用，显示 ‘Port 6881 is blacklisted’ 报错，或者种子下载没速度（非网络问题），则尝试在 qbittorrent 变更监听端口：</p>\n<p><img data-src=\"image-20250615115450536.png\" alt=\"image-20250615115450536\" /></p>\n<h2 id=\"tracker-服务器\"><a class=\"anchor\" href=\"#tracker-服务器\">#</a> tracker 服务器</h2>\n<p>部分冷门资源会导致下载缓慢，这时可以添加 BT 下载所需的 tracker 服务器列表：</p>\n<p><img data-src=\"image-20250615120148452.png\" alt=\"image-20250615120148452\" /></p>\n<h2 id=\"下载路径\"><a class=\"anchor\" href=\"#下载路径\">#</a> 下载路径</h2>\n<p>不管是默认下载路径亦或是手动指定下载路径：</p>\n<p><img data-src=\"image-20250615120359623.png\" alt=\"image-20250615120359623\" /></p>\n<p><img data-src=\"image-20250615120503870.png\" alt=\"image-20250615120503870\" /></p>\n<p>都需要根据 Docker 配置里的  <code>volumes</code>  字段中设置的下载文件夹映射路径配置，可以是底下的子文件夹，但不能更换为其范围以外的路径，eg：可以是  <code>/downloads/movie</code>  或  <code>/downloads/video</code>  等子路径，不能是  <code>/movie</code>  或  <code>/video</code>  这些非配置上的路径。</p>\n",
            "tags": [
                "docker"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-komga/",
            "url": "https://arachnid.cc/docker-deployment-of-komga/",
            "title": "docker 部署之 komga 漫画管理",
            "date_published": "2024-12-17T15:33:29.000Z",
            "content_html": "<blockquote>\n<p>Version：<a href=\"https://github.com/gotson/komga/tree/1.15.1\"><strong>komga</strong></a> v1.15.1</p>\n</blockquote>\n<p><img data-src=\"image-20250621180216042.png\" alt=\"komga login\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>komga 是一个自托管的漫画管理程序，支持常见的 CBZ、CBR、PDF 、EPUB 格式的漫画或文件，可以直接在网页端阅读漫画，并加以修改、编辑漫画的元数据。同时它支持全平台运行，</p>\n<p>官网：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9rb21nYS5vcmcv\">https://komga.org/</span></p>\n<p>项目地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dvdHNvbi9rb21nYS90cmVlLzEuMTUuMQ==\">https://github.com/gotson/komga/tree/1.15.1</span></p>\n<p><img data-src=\"image-20250622151001079.png\" alt=\"komga\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>为你的 komga 存放创建数据和配置文件夹：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># $PATH 为你存储盘的路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/komga/config /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/komga/data</pre></td></tr></table></figure><p>运行 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> pull gotson/komga:latest</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--name</span> komga <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/komga/data:/data <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/komga/config:/config <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">25600</span>:25600 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--restart</span> always <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--user</span> <span class=\"token string\">\"0:0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>  gotson/komga</pre></td></tr></table></figure><p>参数解释：</p>\n<ul>\n<li><code>-v /&lt;$PATH&gt;/komga/data:/data</code>  和  <code>-v /&lt;$PATH&gt;/komga/config:/config</code>  ：将对应存储盘目录下的  <code>/komga/data</code>  和  <code>/komga/config</code>  目录分别映射进容器的  <code>/data</code>  和  <code>/config</code>  路径，用于数据和配置的持久化。</li>\n<li><code>-e TZ=Asia/Shanghai</code>  ：设置容器的环境变量  <code>TZ</code> ，用于指定时区。</li>\n<li><code>--user &quot;0:0&quot;</code>  ：以 root 用户运行容器，这对于某些环境的权限管理是必要的。</li>\n</ul>\n<p>note：用 docker 容器安装的话，在  <code>添加库</code>  时选择的根文件夹填写的是容器内部的路径（即上面的  <code>/data</code>  目录下）。</p>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>浏览器输入访问  <code>http://localhost:25600</code>  ，初次进入提示创建邮箱密码：</p>\n<p><img data-src=\"image-20250622174815622.png\" alt=\"image-20250622174815622\" /></p>\n<h2 id=\"创建漫画库\"><a class=\"anchor\" href=\"#创建漫画库\">#</a> 创建漫画库</h2>\n<p>在左侧栏的  <code>库</code>  旁边有个  <code>+</code>  符号，点击添加：</p>\n<p><img data-src=\"image-20250622175219989.png\" alt=\"image-20250622175219989\" /></p>\n<p>然后弹出窗口，为当前库命名，并选择指向的路径（注意：填写的是容器内部的路径，即  <code>/data</code>  路径及其子路径）：</p>\n<p><img data-src=\"image-20250622175339875.png\" alt=\"image-20250622175339875\" /></p>\n<p>扫描器这里，你可以选择你想要的扫描操作，以及需要支持的扫描类型（漫画书存档即  <code>.cbz</code>   <code>.cbr</code>  格式，其实与  <code>.zip</code>   <code>.rar</code>  格式一样，同时也可以解析  <code>.zip</code>  格式文件）：</p>\n<p><img data-src=\"image-20250622180001458.png\" alt=\"image-20250622180001458\" /></p>\n<p>剩下两项，一般保持默认即可，如有其它需要则自行更改。</p>\n<h2 id=\"元数据编辑\"><a class=\"anchor\" href=\"#元数据编辑\">#</a> 元数据编辑</h2>\n<p>如果漫画文件中存在  <code>ComicInfo.xml</code>  元数据文件，那么会被 Komga 直接识别，就无需手动补齐元数据了。但是一般情况下是没有的，所以需要手动补充。如果手动编辑，分为两种：一种是单本编辑，另一种是整册编辑。</p>\n<ol>\n<li>\n<p>单本编辑</p>\n<p>如果有多层结构，进入到最里层，出现下图在单本中有显示阅读图标的，那么在这里的配置就是单本编辑：</p>\n<p><img data-src=\"image-20250622181358937.png\" alt=\"image-20250622181358937\" /></p>\n<p>单本编辑一般有如下编辑：</p>\n<p><img data-src=\"image-20250622181445324.png\" alt=\"image-20250622181445324\" /></p>\n</li>\n<li>\n<p>整册编辑</p>\n<p>像一般多卷的单行本，存在多个连载本，这时候你可以整册编辑：</p>\n<p><img data-src=\"image-20250622181817974.png\" alt=\"image-20250622181817974\" /></p>\n<p>对于整册编辑，如果单本中与部分属性没有配置保持默认，而整册中却配置了该属性，那么在单本显示会映射出整册的配置属性（即： <code>单本属性</code>  &gt;  <code>整册属性</code>  &gt;  <code>默认属性(null)</code> ）：</p>\n<p><img data-src=\"image-20250622182453623.png\" alt=\"image-20250622182453623\" /></p>\n</li>\n</ol>\n<h2 id=\"漫画归类整理\"><a class=\"anchor\" href=\"#漫画归类整理\">#</a> 漫画归类整理</h2>\n<p>komge 归类首要识别的是内嵌的  <code>ComicInfo.xml</code>  文件，根据其字段信息来帮你归类为某个系列，但一般情况下我们获取的漫画都并非自带  <code>ComicInfo.xml</code>  文件，因此往往需要手动添加修改，或以脚本自动补充；除了用脚本自动补充便捷归类外，常见的方式就是利用文件夹进行整理归类，期间你可以设立多级子文件夹，最后会以存档的上一级文件夹名为默认的系列名，即：</p>\n<pre><code>.\n|-- [敖幼祥] 乌龙院\n|   |-- [敖幼祥] 乌龙院之爆笑系列\n|   |   |-- 第01卷-豆腐罗曼史.zip\n|   |   |-- 第02卷-红烧蔡捕头.zip\n|   |   |-- ......\n|   |   `-- 第10卷-六合大战.zip\n|   |-- [敖幼祥] 乌龙院之黑柠檬\n|   |   |-- 01.zip\n|   |   |-- 02.zip\n|   |   `-- 03.zip\n|   |-- [敖幼祥] 乌龙院之活宝系列\n|   |   |-- 01.zip\n|   |   |-- 02.zip\n|   |   |-- ......\n|   |   `-- 43.zip\n|   |-- [敖幼祥] 乌龙院之名作剧场\n|   |   |-- 七鲜鱼丸.zip\n|   |   `-- 御兽园.zip\n|   |-- [敖幼祥] 乌龙院之前传\n|   |   |-- 01.zip\n|   |   |-- 02.zip\n|   |   |-- ......\n|   |   `-- 78.zip\n|   `-- [敖幼祥] 乌龙院之四格系列\n|       |-- 01.zip\n|       |-- 02.zip\n|       |-- ......\n|       `-- 06.zip\n|-- [北条司] 城市猎人\n|   |-- [Vol_01].zip\n|   |-- [Vol_02].zip\n|   |-- ......\n|   |-- [Vol_35].zip\n|   `-- 全 35 卷.txt\n|-- ......\n`-- [鳥山明] 七龙珠\n    |-- [龍珠完全版][鳥山明][文傳]Vol_01.zip\n    |-- [龍珠完全版][鳥山明][文傳]Vol_02.zip\n    |-- ......\n    |-- [龍珠完全版][鳥山明][文傳]Vol_34.zip\n    |-- [龍珠完全版公式手冊_Dragonball_FOREVER_人造人篇～魔人布歐篇][鳥山明][文傳].zip\n    |-- [龍珠完全版公式手冊_Dragonball_LANDMARK_少年篇～菲利篇][鳥山明][文傳].zip\n    `-- 全 34 卷.txt\n</code></pre>\n<p>像 “乌龙院” 系列，即使有二级结构，但实际出来的还是一个单一系列：</p>\n<p><img data-src=\"image-20250629113512571.png\" alt=\"image-20250629113512571\" /></p>\n<p><img data-src=\"image-20250629114450732.png\" alt=\"image-20250629114450732\" /></p>\n<h2 id=\"漫画导入\"><a class=\"anchor\" href=\"#漫画导入\">#</a> 漫画导入</h2>\n<p>komga 在面板上支持导入，嘛，一般本人是手动在存储文件夹里导入的；不过面板这里的导入可以用来对比替换原有漫画（比如由于漫画质量、缺页、乱页等需要重新收录），不过这个使用起来也挺麻烦的，需要你的漫画信息齐全，或者说部分信息必须要有。。。因此，强烈推荐还是手动比较！</p>\n<p>如果你真的想用这个功能，那么你需要做到以下几步：</p>\n<p>1、为你的导入漫画单独安置一个导入文件夹，然后里面存放需要导入的漫画，可以拥有子目录：</p>\n<p><img data-src=\"image-20250622194057342.png\" alt=\"image-20250622194057342\" /></p>\n<p>2、进入面板的  <code>导入</code>  窗口，选择对应的导入路径，点击扫描：</p>\n<p><img data-src=\"image-20250622194600873.png\" alt=\"image-20250622194600873\" /></p>\n<p>3、扫描出来后，你可以检查校对导入的漫画：</p>\n<p><img data-src=\"image-20250622195033818.png\" alt=\"image-20250622195033818\" /></p>\n<p>4、对于有系列和没系列的区别，如果你没有按照提示选择系列，那么后期执行导入将跳过未设置的漫画：</p>\n<p><img data-src=\"image-20250622195449602.png\" alt=\"image-20250622195449602\" /></p>\n<p>关于系列的设置，是在整册的设置中配置  <code>常规</code>  的  <code>标题</code>  ，或者  <code>副标题</code>  的  <code>标签</code>  属性（注意：它们的配置都必须有锁，否则是在导入中查询不到的）：</p>\n<p><img data-src=\"image-20250622200804478.png\" alt=\"image-20250622200804478\" /></p>\n<p><img data-src=\"image-20250622200003954.png\" alt=\"image-20250622200003954\" /></p>\n<p>因此，如果是替换的话，那么需要你在原有的漫画中配置该属性，而对于新建的，则需要建立一个整册文件夹（实际就是在库目录里建一个为了存放新建漫画的子文件夹），才能搜索到系列：</p>\n<p><img data-src=\"image-20250622201424811.png\" alt=\"image-20250622201424811\" /></p>\n<p>5、重设漫画导入后的名称，如果已经配置了  <code>系列</code>  项，那么你能看到该系列里的列出的所有存在的文件（见下面框选位置）：</p>\n<p><img data-src=\"image-20250622201701331.png\" alt=\"image-20250622201701331\" /></p>\n<p>6、新建与替换的关系：</p>\n<p><img data-src=\"image-20250622214357246.png\" alt=\"image-20250622214357246\" /></p>\n<p>对于你想新建的漫画，在  <code>编号</code>  项中，你可以任意自定义未冲突的号码或者留空；而对于想要替换的漫画，那么你需要在  <code>编号</code>  项中选择你要替换的编号，像在原有的漫画中，可以在单本编辑中查看，或者在整册上看前缀编号：</p>\n<p><img data-src=\"image-20250622215045849.png\" alt=\"image-20250622215045849\" /></p>\n<p>然后如果是替换的漫画，你可以点击  <code>详情</code>  或者  <code>图片查询</code>  按键来对比：</p>\n<p><img data-src=\"image-20250622215326812.png\" alt=\"image-20250622215326812\" /></p>\n<p><img data-src=\"image-20250622215445165.png\" alt=\"image-20250622215445165\" /></p>\n<p>7、确定没问题后，然后点击  <code>导入</code>  ：</p>\n<p><img data-src=\"image-20250622201829617.png\" alt=\"image-20250622201829617\" /></p>\n<p>期间会有提示框：</p>\n<p><img data-src=\"image-20250622215710185.png\" alt=\"image-20250622215710185\" /></p>\n<p>8、待所有任务完成后，在历史记录中查看是否成功：</p>\n<p><img data-src=\"image-20250622215851952.png\" alt=\"image-20250622215851952\" />9、进入整册查看效果：</p>\n<p><img data-src=\"image-20250622220552349.png\" alt=\"image-20250622220552349\" /></p>\n<h1 id=\"安可\"><a class=\"anchor\" href=\"#安可\">#</a> 安可</h1>\n<p>关于 App 客户端，这里可以用官方的推荐的：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9rb21nYS5vcmcvZG9jcy9jYXRlZ29yeS9yZWFkZXJz\">https://komga.org/docs/category/readers</span></p>\n<p>一般常用的有 <strong>Tachiyomi</strong> 、<strong>Mihon</strong> 、<strong>tachiyomiJ2K</strong> ；前者由于版权等一系列问题被迫删库跑路了。。。所以衍生出后面两个，当然也还有其它更多的 forks 版本，这里就不一一说了。</p>\n<p>选择导入插件仓库地址：</p>\n<pre><code>https://raw.githubusercontent.com/keiyoushi/extensions/repo/index.min.json\n</code></pre>\n<p>或者手动下载 komga 插件：</p>\n<pre><code>https://keiyoushi.github.io/extensions/\n</code></pre>\n<p>然后选择搜索 komga：</p>\n<p><img data-src=\"image-20250814203137641.png\" alt=\"image-20250814203137641\" /></p>\n<p>客户端展示：</p>\n<p>1、 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL21paG9uYXBwL21paG9u\">Mihon</span>：</p>\n<p><img data-src=\"image-20250813222752267.png\" alt=\"image-20250813222752267\" /></p>\n<p><img data-src=\"image-20250813223006155.png\" alt=\"image-20250813223006155\" /></p>\n<p><img data-src=\"image-20250813222813431.png\" alt=\"image-20250813222813431\" /></p>\n<p>2、 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0pheXMyS2luZ3MvdGFjaGl5b21pSjJL\">tachiyomiJ2K</span>：</p>\n<p><img data-src=\"image-20250813215259060.png\" alt=\"image-20250813215259060\" /></p>\n<p><img data-src=\"image-20250813215333781.png\" alt=\"image-20250813215333781\" /></p>\n",
            "tags": [
                "docker"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-photoview/",
            "url": "https://arachnid.cc/docker-deployment-of-photoview/",
            "title": "docker 部署之 photoview 图片相册",
            "date_published": "2024-12-17T15:33:29.000Z",
            "content_html": "<blockquote>\n<p>Version：<a href=\"https://github.com/photoview/photoview/tree/v2.4.0\"><strong>photoview</strong></a> 2.4.0</p>\n</blockquote>\n<p><img data-src=\"image-20250621174347104.png\" alt=\"photoview login\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>Photoview 是一个简单且用户友好的照片库，是专为摄影师制作，旨在提供一个简单且快速的方式来导航目录，其中包含数以千计的高分辨率照片。</p>\n<p>您可以将 Photoview 配置为在文件系统的某个目录中查找照片和视频。 扫描仪会自动拾取您的媒体并开始生成缩略图图像，以使浏览速度加快。</p>\n<p>当您的媒体被扫描后，它们会显示在网站上，其组织方式与文件系统相同。</p>\n<p>特点：</p>\n<ul>\n<li>保持与文件系统架构一样的目录显示。</li>\n<li>多用户管理。</li>\n<li>支持公共链接共享，并可选密码保护。</li>\n<li>支持 RAW 文件格式和 EXIF 解析。</li>\n<li>支持多种常见视频格式，并自动针对网络优化。</li>\n<li>自动人脸识别，并按人像分组。</li>\n<li>支持低中高分辨率，优先加载缩略图。</li>\n<li>所有媒体资源受 Cookie 令牌保护，所有密码经过哈希处理，API 采用严格的 CORS 策略。</li>\n</ul>\n<p>项目地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3Bob3Rvdmlldy9waG90b3ZpZXc=\">https://github.com/photoview/photoview</span></p>\n<p><img data-src=\"image-20250621175519441.png\" alt=\"photoview\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>创建 photoview 配置文件夹及相册存放位置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># $PATH 为你的相册存放路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost:/app/photoview] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /app/photoview</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost:/app/photoview] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/pictures</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /app/photoview</pre></td></tr></table></figure><p>根据官方说明，由于配置参数过多，因此采用 docker compose 的方法，添加  <code>docker-compose.yml</code>  配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> docker-compose.yml</pre></td></tr></table></figure><p>写入：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"><span>docker-compose.yml</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">photoview</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> viktorstrate/photoview<span class=\"token punctuation\">:</span>latest</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> photoview</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> photoview</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> root</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">stop_grace_period</span><span class=\"token punctuation\">:</span> 10s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"2430:80\"</span> <span class=\"token comment\">## HTTP port (host:container)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">## This ensures that DB is initialized and ready for connections.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">## Comment out the entire `depends_on` section if PHOTOVIEW_DATABASE_DRIVER is set to `sqlite` in the .env</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token key atrule\">mariadb</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> service_healthy</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">## Security options for some restricted systems</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token key atrule\">security_opt</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token punctuation\">-</span> seccomp<span class=\"token punctuation\">:</span>unconfined</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token punctuation\">-</span> apparmor<span class=\"token punctuation\">:</span>unconfined</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token key atrule\">PHOTOVIEW_DATABASE_DRIVER</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>PHOTOVIEW_DATABASE_DRIVER<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token comment\">## Comment out the next variable in the case PHOTOVIEW_DATABASE_DRIVER is set to `sqlite` or `postgres` in the .env</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token key atrule\">PHOTOVIEW_MYSQL_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;MARIADB_USER&#125;:$&#123;MARIADB_PASSWORD&#125;@tcp(photoview-mariadb)/$&#123;MARIADB_DATABASE&#125;\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token comment\">## Uncomment the next line if PHOTOVIEW_DATABASE_DRIVER is set to `sqlite` in the .env</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token comment\"># PHOTOVIEW_SQLITE_PATH: $&#123;PHOTOVIEW_SQLITE_PATH&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token key atrule\">PHOTOVIEW_LISTEN_IP</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.0.0.0\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token comment\">## Optional: If you are using Samba/CIFS-Share and experience problems with \"directory not found\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token comment\">## Enable the following Godebug</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token comment\"># - GODEBUG=asyncpreemptoff=1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token comment\">## Optional: To enable map related features, you need to create a mapbox token.</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token comment\">## A token can be generated for free here https://account.mapbox.com/access-tokens/</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token comment\">## It's a good idea to limit the scope of the token to your own domain, to prevent others from using it.</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token key atrule\">MAPBOX_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>MAPBOX_TOKEN<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token comment\">## Example:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token comment\">## - \"/host/folder:/container/folder\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"/etc/localtime:/etc/localtime:ro\"</span> <span class=\"token comment\">## use local time from host</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"/etc/timezone:/etc/timezone:ro\"</span>   <span class=\"token comment\">## use timezone from host</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token comment\">## Uncomment the next line if PHOTOVIEW_DATABASE_DRIVER is set to `sqlite` in the .env</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token comment\"># - \"$&#123;HOST_PHOTOVIEW_LOCATION&#125;/database:/home/photoview/database\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"$&#123;HOST_PHOTOVIEW_LOCATION&#125;/storage:/home/photoview/media-cache\"</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token comment\">## Change This in the .env file: to the directory where your photos are located on your server.</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token comment\">## You can mount multiple paths if your photos are spread across multiple directories.</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      <span class=\"token comment\">## The same path as the container path set here, you'll need to provide on the Photoview's init page (the one between the ':' chars).</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token comment\">## If you mount several folders, provide the path to the parent one on the init page.</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token comment\">## If you mount several folders, make sure that there are no direct mappings to the media root folder.</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token comment\">## This means that you need to also modify the container path of the HOST_PHOTOVIEW_MEDIA_ROOT</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token comment\">## to something like '/photos/main'. Note that this new name ('main' in this example) will become an album in Photoview.</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"$&#123;HOST_PHOTOVIEW_MEDIA_ROOT&#125;:/photos:ro\"</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token comment\">## *Additional* media folders can be mounted like this (set the variable in .env file)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token comment\">## Note that a mount cannot be located in a subfolder of another mount.</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token comment\"># - \"$&#123;HOST_PHOTOVIEW_MEDIA_PRIVATE&#125;:/private:ro\"</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token comment\">## Comment out the `mariadb` service if PHOTOVIEW_DATABASE_DRIVER is set to `sqlite` or `postgres` in the .env</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token key atrule\">mariadb</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mariadb<span class=\"token punctuation\">:</span>lts</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> photoview<span class=\"token punctuation\">-</span>mariadb</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> photoview<span class=\"token punctuation\">-</span>mariadb</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token key atrule\">stop_grace_period</span><span class=\"token punctuation\">:</span> 5s</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token comment\">## Optimized MariaDB startup command for better performance and compatibility</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> mariadbd <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>innodb<span class=\"token punctuation\">-</span>buffer<span class=\"token punctuation\">-</span>pool<span class=\"token punctuation\">-</span>size=512M <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>transaction<span class=\"token punctuation\">-</span>isolation=READ<span class=\"token punctuation\">-</span>COMMITTED <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>character<span class=\"token punctuation\">-</span>set<span class=\"token punctuation\">-</span>server=utf8mb4 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>collation<span class=\"token punctuation\">-</span>server=utf8mb4_unicode_ci <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>max<span class=\"token punctuation\">-</span>connections=512 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>innodb<span class=\"token punctuation\">-</span>rollback<span class=\"token punctuation\">-</span>on<span class=\"token punctuation\">-</span>timeout=OFF <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>innodb<span class=\"token punctuation\">-</span>lock<span class=\"token punctuation\">-</span>wait<span class=\"token punctuation\">-</span>timeout=120</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token key atrule\">security_opt</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">## see https://github.com/MariaDB/mariadb-docker/issues/434#issuecomment-1136151239</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token punctuation\">-</span> seccomp<span class=\"token punctuation\">:</span>unconfined</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      <span class=\"token punctuation\">-</span> apparmor<span class=\"token punctuation\">:</span>unconfined</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token key atrule\">MARIADB_AUTO_UPGRADE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token key atrule\">MARIADB_DATABASE</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>MARIADB_DATABASE<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token key atrule\">MARIADB_USER</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>MARIADB_USER<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      <span class=\"token key atrule\">MARIADB_PASSWORD</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>MARIADB_PASSWORD<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      <span class=\"token key atrule\">MARIADB_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>MARIADB_ROOT_PASSWORD<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token comment\">## Example:</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      <span class=\"token comment\">## - \"/host/folder:/container/folder\"</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"/etc/localtime:/etc/localtime:ro\"</span> <span class=\"token comment\">## use local time from host</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"/etc/timezone:/etc/timezone:ro\"</span>   <span class=\"token comment\">## use timezone from host</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"$&#123;HOST_PHOTOVIEW_LOCATION&#125;/database/mariadb:/var/lib/mysql\"</span> <span class=\"token comment\">## DO NOT REMOVE</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> healthcheck.sh <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>connect <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>innodb_initialized</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 1m</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 5s</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      <span class=\"token key atrule\">start_period</span><span class=\"token punctuation\">:</span> 3m</pre></td></tr></table></figure><p>添加  <code>.env</code>  环境变量：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:/app/photoview] #\"></td><td><pre><span class=\"token function\">vim</span> .env</pre></td></tr></table></figure><p>写入：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>##================***================##</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>## These are the environment setup variables.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>## Start setting up your instance from here.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>## Syntax of the .env file is next:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>## VARIABLE_NAME=variable value with everything after the '=' and till the end of the line.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>## The variables with values, set in the docker-compose.yml directly, are for advanced configuration.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>##================***================##</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>##----------Host variables-----------##</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>## This is the current folder, where all Photoview files and folders (except of your media library) are located</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>HOST_PHOTOVIEW_LOCATION=/app/photoview</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>## This is where your original photos and videos located.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>## Provide here the path to single root folder for your media collection.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>HOST_PHOTOVIEW_MEDIA_ROOT=/&lt;$PATH>/pictures</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>## If you'd like to map multiple folders from different locations, create additional variables</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>## here like the next one and modify the docker-compose.yml to match them and use in volume mappings.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre># HOST_PHOTOVIEW_MEDIA_PRIVATE=</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>##-----------------------------------##</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>##-------Photoview variables---------##</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>## PHOTOVIEW_DATABASE_DRIVER could have one of values: `mysql` (default), `sqlite`, `postgres`</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>PHOTOVIEW_DATABASE_DRIVER=mysql</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>## Optional: To enable map related features, you need to create a mapbox token.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>## A token can be generated for free here https://account.mapbox.com/access-tokens/</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>## It's a good idea to limit the scope of the token to your own domain, to prevent others from using it.</pre></td></tr><tr><td data-num=\"28\"></td><td><pre># MAPBOX_TOKEN=yourToken</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>##-----------------------------------##</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>##----------Video variables----------##</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>## Set the hardware acceleration when encoding videos.</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>## Support `qsv`, `vaapi`, `nvenc`.</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>## Only `qsv` is verified with `/dev/dri` devices.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre># PHOTOVIEW_VIDEO_HARDWARE_ACCELERATION=</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>##-----------------------------------##</pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>##--------MariaDB variables----------##</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>## Comment out these variables if PHOTOVIEW_DATABASE_DRIVER is `sqlite` or `postgres`</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>## Use password generator to generate secret values and replace these defaults</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>MARIADB_DATABASE=photoview</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>MARIADB_USER=photoview</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>## Note: If your `MARIADB_PASSWORD` contains special characters (e.g. `@`), make sure to URL-encode them.</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>MARIADB_PASSWORD=photosecret</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>MARIADB_ROOT_PASSWORD=superphotosecret</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>##-----------------------------------##</pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>##---------SQLite variables----------##</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>## Uncomment the next line if PHOTOVIEW_DATABASE_DRIVER is `sqlite`</pre></td></tr><tr><td data-num=\"50\"></td><td><pre># PHOTOVIEW_SQLITE_PATH=/app/photoview/database/photoview.db</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>##-----------------------------------##</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>##-------PostgreSQL variables--------##</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>## Uncomment the next lines if PHOTOVIEW_DATABASE_DRIVER is `postgres`</pre></td></tr><tr><td data-num=\"55\"></td><td><pre># PGSQL_DATABASE=photoview</pre></td></tr><tr><td data-num=\"56\"></td><td><pre># PGSQL_USER=photoview</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>## Note: If your `PGSQL_PASSWORD` contains special characters (e.g. `@`), make sure to URL-encode them.</pre></td></tr><tr><td data-num=\"58\"></td><td><pre># PGSQL_PASSWORD=superphotosecret</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>## See https://www.postgresql.org/docs/current/libpq-ssl.html for possible ssl modes</pre></td></tr><tr><td data-num=\"60\"></td><td><pre># PGSQL_SSL_MODE=prefer</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>##-----------------------------------##</pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>##-------Watchtower variables--------##</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>## The POLL_INTERVAL in sec</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>WATCHTOWER_POLL_INTERVAL=86400</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>WATCHTOWER_TIMEOUT=30s</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>WATCHTOWER_CLEANUP=true</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>##\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\//////////////////##</pre></td></tr></table></figure><p>note：</p>\n<p>一般需要修改的是  <code>Photoview variables</code>  中的内容。</p>\n<p>修改完成后，使用以下命令进行部署：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:/app/photoview] #\"></td><td><pre><span class=\"token function\">docker-compose</span> up <span class=\"token parameter variable\">-d</span></pre></td></tr></table></figure><p>在这里不启用地点功能，如需启用则按照指示进入网站注册获取 token 填写即可开启。</p>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>浏览器访问  <code>http://localhost:2430</code>  ，首次进入需要设置账号密码及路径：</p>\n<p><img data-src=\"modb_20220615_284dfee2-ec9b-11ec-a5f5-fa163eb4f6be.png\" alt=\"img\" /></p>\n<h2 id=\"语言及扫描\"><a class=\"anchor\" href=\"#语言及扫描\">#</a> 语言及扫描</h2>\n<p>登入进来后，在  <code>设置</code>  中可以配置您需要的语言；如果你的图片存放文件夹已经存放有相应的图片，那么首次显示需要扫描才出来：</p>\n<p><img data-src=\"image-20250617223249426.png\" alt=\"image-20250617223249426\" /></p>\n<h2 id=\"多用户管理\"><a class=\"anchor\" href=\"#多用户管理\">#</a> 多用户管理</h2>\n<p>同样是在  <code>设置</code>  中，在  <code>用户</code>  项里你可以管理多个用户，并指定权限，同样的每个用户上也支持多个相册路径，值得注意的是增加的主路径要确保在配置上是存在的，当然，你一可以单一主路径，但为其增设子文件夹：</p>\n<p><img data-src=\"image-20250617224027119.png\" alt=\"image-20250617224027119\" /></p>\n",
            "tags": [
                "docker"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-webdav/",
            "url": "https://arachnid.cc/docker-deployment-of-webdav/",
            "title": "docker 部署之 webdav 文件服务",
            "date_published": "2024-12-01T07:28:53.000Z",
            "content_html": "<blockquote>\n<p>Version：<a href=\"https://github.com/hacdias/webdav/tree/v5.4.1\"><strong>webdav</strong></a> v5.4.1</p>\n</blockquote>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<h2 id=\"nfs-协议\"><a class=\"anchor\" href=\"#nfs-协议\">#</a> NFS 协议</h2>\n<p>NFS（网络文件系统 Network File System）是 TCP/IP 协议集所提供的一种子协议，已然成为 Unix/Linux 类系统的标配。</p>\n<p><strong>优点</strong>：</p>\n<ul>\n<li>在 Unix/Linux 环境中性能优异。</li>\n<li>配置相对简单，集成在大部分类 Unix 系统中。</li>\n<li>支持不同的 NFS 版本，提供向后兼容性。</li>\n</ul>\n<p><strong>缺点</strong>：</p>\n<ul>\n<li>权限管理相对简单，对安全性要求高的场景需额外配置。</li>\n<li>通常依赖于底层网络的稳定性。</li>\n</ul>\n<p><strong>安全性</strong>：</p>\n<ul>\n<li>没有加密授权等功能，仅依靠 IP 地址或主机名来决定用户能否挂载共享目录，对具体目录和文件无法进行 ACL 权限控制（NFSv4 以前）。</li>\n</ul>\n<p><strong>常见用途</strong>：Unix/Linux 系统间的文件共享、分布式文件系统、HPC（高性能计算）环境。</p>\n<h2 id=\"samba-协议\"><a class=\"anchor\" href=\"#samba-协议\">#</a> Samba 协议</h2>\n<p>Samba 是 SMB/CIFS（Server Message Block / Common Internet File System）网络协议的重新实现，可以在局域网不同计算机之间进行文件、打印机等资源共享，和 NFS 功能类似。</p>\n<p><strong>优点</strong>：</p>\n<ul>\n<li>支持丰富的功能，包括文件和打印共享、用户身份验证和授权。</li>\n<li>广泛应用于 Windows 网络环境，集成度高。</li>\n<li>提供详细的权限设置和文件锁定机制，支持并发控制。</li>\n</ul>\n<p><strong>缺点</strong>：</p>\n<ul>\n<li>相对复杂，可能需要较多的配置和管理。</li>\n<li>在大规模网络中，性能可能受限。</li>\n</ul>\n<p><strong>安全性</strong>：</p>\n<ul>\n<li>提供端到端加密、安全性高，配置选项丰富，支持 ACL 并支持多种用户认证模式。</li>\n</ul>\n<p><strong>常见用途</strong>：局域网内的文件共享、打印服务、企业内部网络存储。</p>\n<h2 id=\"webdav-协议\"><a class=\"anchor\" href=\"#webdav-协议\">#</a> WebDAV 协议</h2>\n<p>WebDAV（Web-based Distributed Authoring and Versioning）是基于 HTTP1.1 协议的拓展升级版，可以很方便的跨越网关、防火墙。使得在公网上访问特别简单，并且通过 https 的公网访问拥有非常棒的安全性。</p>\n<p><strong>优点</strong>：</p>\n<ul>\n<li>基于 HTTP 协议，广泛兼容。</li>\n<li>提供文件锁定机制，支持多人协作。</li>\n<li>支持元数据（属性）的存储和管理。</li>\n</ul>\n<p><strong>缺点</strong>：</p>\n<ul>\n<li>性能相比专用文件系统协议稍差。</li>\n<li>安全性依赖于 HTTP 的基础设施（如 SSL/TLS）。</li>\n</ul>\n<p><strong>安全性</strong>：</p>\n<ul>\n<li>协议本身并没有提供加密功能，但可以通过使用 HTTPS 协议来保障数据传输的安全性；另外，支持身份验证和权限控制，可以设置访问权限，从而保障数据的安全性。</li>\n</ul>\n<p><strong>常见用途</strong>：远程文件编辑、网络存储解决方案（如云端存储）。</p>\n<p>因此，在了解了上面常规的文件服务挂载协议后，对于远程数据访问，这里就可以使用 webdav 文件服务，关于该服务的搭建可以使用：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2hhY2RpYXMvd2ViZGF2\">https://github.com/hacdias/webdav</span></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>建立存放路径及生成配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># $WEBDAV_PATH 为你 webdav 部署共享的路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /app/webdav /<span class=\"token operator\">&lt;</span><span class=\"token variable\">$WEBDAV_PATH</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /app/webdav</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> config.yml</pre></td></tr></table></figure><p>添加配置：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"><span>config.yml</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> 0.0.0.0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8081</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># TLS-related settings if you want to enable TLS directly.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">cert</span><span class=\"token punctuation\">:</span> cert.pem</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> key.pem</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># Prefix to apply to the WebDAV path-ing. Default is '/'.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token key atrule\">prefix</span><span class=\"token punctuation\">:</span> /</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># Enable or disable debug logging. Default is 'false'.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key atrule\">debug</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># Disable sniffing the files to detect their content type. Default is 'false'.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token key atrule\">noSniff</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># The directory that will be able to be accessed by the users when connecting.</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># This directory will be used by users unless they have their own 'directory' defined.</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># Default is '.' (current directory).</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token key atrule\">directory</span><span class=\"token punctuation\">:</span> .</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># The default permissions for users. This is a case insensitive option. Possible</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># permissions: C (Create), R (Read), U (Update), D (Delete). You can combine multiple</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\"># permissions. For example, to allow to read and create, set \"RC\". Default is \"R\".</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span> R</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># The default permissions rules for users. Default is none.</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\"># Logging configuration</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token key atrule\">log</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token comment\"># Logging format ('console', 'json'). Default is 'console'.</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token key atrule\">format</span><span class=\"token punctuation\">:</span> console</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token comment\"># Enable or disable colors. Default is 'true'. Only applied if format is 'console'.</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token key atrule\">colors</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token comment\"># Logging outputs. You can have more than one output. Default is only 'stderr'.</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token key atrule\">outputs</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token punctuation\">-</span> stderr</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\"># CORS configuration</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token key atrule\">cors</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token comment\"># Whether or not CORS configuration should be applied. Default is 'false'.</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token key atrule\">credentials</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token key atrule\">allowed_headers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">-</span> Depth</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token key atrule\">allowed_hosts</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">-</span> http<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8081</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token key atrule\">allowed_methods</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">-</span> GET</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token key atrule\">exposed_headers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">-</span> Content<span class=\"token punctuation\">-</span>Length</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">-</span> Content<span class=\"token punctuation\">-</span>Range</pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token comment\"># The list of users. If the list is empty, then there will be no authentication.</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token comment\"># Otherwise, basic authentication will automatically be configured.</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\"># If you're delegating the authentication to a different service, you can proxy</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token comment\"># the username using basic authentication, and then disable webdav's password</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\"># check using the option:</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token comment\"># noPassword: true</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token key atrule\">users</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token comment\"># Example 'john' user with bcrypt encrypted password, with custom directory.</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> john</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&#123;bcrypt&#125;$2y$10$zEP6oofmXFeHaeMfBNLnP.DO8m.H.Mwhd24/TOX2MWLxAExXi4qgi\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token key atrule\">directory</span><span class=\"token punctuation\">:</span> /data</pre></td></tr></table></figure><p>运行 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> pull hacdias/webdav:latest</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--name</span> webdav <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /<span class=\"token operator\">&lt;</span><span class=\"token variable\">$WEBDAV_PATH</span><span class=\"token operator\">></span>/:/data <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /app/webdav/config.yml:/webdav_config.yml:ro <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">6065</span>:8081 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--restart</span> always <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>  ghcr.io/hacdias/webdav <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-c</span> /webdav_config.yml</pre></td></tr></table></figure><p>参数解释：</p>\n<ul>\n<li><code>-v /app/webdav/config.yml:/webdav_config.yml:ro</code>  ：将主机的  <code>config.yml</code>  配置文件映射为容器的  <code>/webdav_config.yml</code>  文件，用于启动参数的获取。</li>\n<li><code>-p 6065:8081</code>  ：将容器的 8081 端口映射到主机的 6065 端口，使得 webdav 的 Web 界面可以通过主机的端口访问。</li>\n<li><code>-c /webdav_config.yml</code>  ：通过传参命令，指定读取（容器内路径）启动参数配置。</li>\n</ul>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>通过专用的 webdav 挂载工具，输入地址加端口，在登录的时候，根据  <code>webdav_config.yml</code>  中的  <code>users:</code>  字段，选择不同的用户登录，则链接到不同的挂载访问路径。</p>\n",
            "tags": [
                "docker"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-gitea/",
            "url": "https://arachnid.cc/docker-deployment-of-gitea/",
            "title": "docker 部署之 gitea 代码管控",
            "date_published": "2024-12-01T07:25:21.000Z",
            "content_html": "<blockquote>\n<p>Version：<a href=\"https://github.com/go-gitea/gitea/tree/v1.22.4\"><strong>Gitea</strong></a> 1.22.4</p>\n</blockquote>\n<p><img data-src=\"image-20250621173610358.png\" alt=\"gitea login\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>作为开发人员，想必正在使用 GitHub 了吧，或者没用过也听说过它的大名；而对于自己的项目，难免避免不了代码管理，如果不想受限于 GitHub 的服务器网络或者想建立一个小团队的 Git 服务，因此能有一个与 GitHub 相仿的工具将大大提高处理效率；而 Gitea 正是这样的工具，它以轻量、极易、快速著称，能够高效而轻松的帮助团队和开发者。</p>\n<p>官网：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmdpdGVhLmNvbS96aC1jbi8=\">https://docs.gitea.com/zh-cn/</span></p>\n<p><img data-src=\"image-20250621173424402.png\" alt=\"gitea\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>为你的 gitea 存放创建数据和配置文件夹：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># $PATH 为你存储盘的路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/gitea/data</pre></td></tr></table></figure><p>运行 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> pull gitea/gitea:latest</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--name</span> gitea <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/gitea/data:/data <span class=\"token punctuation\">\\</span> <span class=\"token comment\"># 是 Gitea 标准容器的数据存储点，包含了 Git 仓库、SQLite 数据库文件、缓存文件等。</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /etc/timezone:/etc/timezone:ro <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /etc/localtime:/etc/localtime:ro <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">3000</span>:3000 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">2220</span>:22 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--restart</span> always <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>  gitea/gitea</pre></td></tr></table></figure><p>在这里，并没有指定 db 数据库，因此按照官方的说明，将使用 sqlite3 作为数据库校验存储；如需更改为其它数据库管理，可参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmdpdGVhLmNvbS96aC1jbi9pbnN0YWxsYXRpb24vaW5zdGFsbC13aXRoLWRvY2tlcg==\">https://docs.gitea.com/zh-cn/installation/install-with-docker</span></p>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>首次安装 Gitea 后，输入  <code>http://localhost:3000/</code>  访问初始化页面，按需设置服务器信息。第一个注册的用户账号为管理账号：</p>\n<p><img data-src=\"2956540-20220927193823094-433532346.png\" alt=\"image\" /></p>\n<p>剩下的功能，已与 GitHub 无异，这里就不一一阐述了。</p>\n",
            "tags": [
                "docker"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-ddns/",
            "url": "https://arachnid.cc/docker-deployment-of-ddns/",
            "title": "docker 部署之 ddns-go 域名解析",
            "date_published": "2024-12-01T07:04:11.000Z",
            "content_html": "<blockquote>\n<p>在使用该项目之前，你必须至少拥有一个可支配的域名，否则下文对您来说仅是一篇不同文章，而非操作笔记。</p>\n</blockquote>\n<blockquote>\n<p>Version：<a href=\"https://github.com/jeessy2/ddns-go/tree/v6.7.6\"><strong>DDNS-GO</strong></a> v6.7.6</p>\n</blockquote>\n<p><img data-src=\"image-20250621174156820.png\" alt=\"ddns-go login\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>ddns-go 是一个简易便捷的自动更新域名解析的工具，支持多平台、多架构、多服务商、多域名。</p>\n<h2 id=\"特性\"><a class=\"anchor\" href=\"#特性\">#</a> 特性</h2>\n<ul>\n<li>支持 Mac、Windows、Linux 系统，支持 ARM、x86 架构</li>\n<li>支持的域名服务商  <code>阿里云</code>   <code>腾讯云</code>   <code>Dnspod</code>   <code>Cloudflare</code>   <code>华为云</code>   <code>Callback</code>   <code>百度云</code>   <code>Porkbun</code>   <code>GoDaddy</code>   <code>Namecheap</code>   <code>NameSilo</code>   <code>Dynadot</code>   <code>DNSLA</code></li>\n<li>支持接口 / 网卡 /<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2plZXNzeTIvZGRucy1nby93aWtpLyVFOSU4MCU5QSVFOCVCRiU4NyVFNSU5MSVCRCVFNCVCQiVBNCVFOCU4RSVCNyVFNSU4RiU5NklQJUU1JThGJTgyJUU4JTgwJTgz\"> 命令</span>获取 IP</li>\n<li>支持以服务的方式运行</li>\n<li>默认间隔 5 分钟同步一次</li>\n<li>支持同时配置多个 DNS 服务商</li>\n<li>支持多个域名同时解析</li>\n<li>支持多级域名</li>\n<li>网页中配置，简单又方便，默认勾选 <code>禁止从公网访问</code></li>\n<li>网页中方便快速查看最近 50 条日志</li>\n<li>支持 Webhook 通知</li>\n<li>支持 TTL</li>\n<li>支持部分 DNS 服务商<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2plZXNzeTIvZGRucy1nby93aWtpLyVFNCVCQyVBMCVFOSU4MCU5MiVFOCU4NyVBQSVFNSVBRSU5QSVFNCVCOSU4OSVFNSU4RiU4MiVFNiU5NSVCMA==\">传递自定义参数</span>，实现地域解析 / 多 IP 等功能</li>\n</ul>\n<p>关于它的更多介绍及使用，可以参看该工程：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2plZXNzeTIvZGRucy1nbw==\">https://github.com/jeessy2/ddns-go</span></p>\n<p><img data-src=\"image-20250621174255920.png\" alt=\"ddns-go\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>建立存放路径：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /app/ddns-go</pre></td></tr></table></figure><p>运行 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> pull jeessy/ddns-go:latest</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--name</span> ddns-go <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--net</span><span class=\"token operator\">=</span>host <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /app/ddns-go:/root <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--restart</span> always <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>  jeessy/ddns-go <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-l</span> :9877 <span class=\"token parameter variable\">-f</span> <span class=\"token number\">600</span></pre></td></tr></table></figure><p>参数解释：</p>\n<ul>\n<li><code>--net=host</code>  ：使用 docker host 模式</li>\n<li><code>-l</code>  ：通过传参命令，指定监听地址</li>\n<li><code>-f</code>  ：通过传参命令，同步间隔时间 (秒)</li>\n</ul>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>通过访问  <code>http://localhost:9877</code>  ，初次进入登录并配置管理账号：</p>\n<p><img data-src=\"image-20250614140959073.png\" alt=\"image-20250614140959073\" /></p>\n<p>登录进来后，选择你对应的域名服务器厂商并进行相应配置，不同的服务商，具体获取的 API Token 也不一样，因此这里就不多做解释了：</p>\n<p><img data-src=\"image-20250614142020388.png\" alt=\"image-20250614142020388\" /></p>\n<h2 id=\"ipv4\"><a class=\"anchor\" href=\"#ipv4\">#</a> ipv4</h2>\n<p>ipv4 目前还是主流的 IP 使用方式，因此可以直接使用网卡获取的方式进行：</p>\n<p><img data-src=\"image-20250614142459126.png\" alt=\"image-20250614142459126\" /></p>\n<p>当然，对于 ipv4 来说，并非每个人都能获取到公网 ipv4，如若没有公网 ipv4，那么则建议你停掉 ipv4 的启用更新。</p>\n<h2 id=\"ipv6\"><a class=\"anchor\" href=\"#ipv6\">#</a> ipv6</h2>\n<p><strong>通过网卡获取：</strong></p>\n<p>需要使用 docker host 模式，如果不能从网卡获取 240 开头的外网 ipv6 地址，那么将会显示 “没有找到可用的网卡” 不可选。</p>\n<p><strong>通过命令获取：</strong></p>\n<p><img data-src=\"image-20250614142930782.png\" alt=\"image-20250614142930782\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token parameter variable\">-6</span> addr show eth0 <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> deprecated <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">'inet6 [^f:]'</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> -F<span class=\"token string\">' '</span> <span class=\"token string\">'&#123;print $2&#125;'</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> -F<span class=\"token string\">'/'</span> <span class=\"token string\">'&#123;print $1&#125;'</span> <span class=\"token operator\">|</span> <span class=\"token function\">tail</span> <span class=\"token parameter variable\">-1</span></pre></td></tr></table></figure><p>然后是步骤拆解：</p>\n<ol>\n<li><code>ip -6 addr show eth0</code> ，显示网卡（eth0）的全部 ipv6 地址</li>\n<li><code>grep -v deprecated</code> ，去除已经失效（deprecated）的地址</li>\n<li><code>grep 'inet6 [^f:]'</code> ，显示有 ipv6 地址的那一行（不包含 f 开头的内网 ipv6 地址）</li>\n<li><code>awk -F' ' '&#123;print $2&#125;'</code> ，根据空格符号分列，打印第二列</li>\n<li><code>awk -F'/' '&#123;print $1&#125;'</code> ，根据斜杠符号 / 分列，打印第一列</li>\n<li><code>tail -1</code> ，显示最后一行</li>\n</ol>\n<p>参看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ydW9oYWkud2FuZy8yMDI0MDQvZGRucy1nby11c2Utc2hlbGwtY29tbWFuZC10by1nZXQtdmFsaWQtaXB2Ni1hZGRyLw==\">DDNS-GO 通过命令获取有效的 IPv6 地址</span></p>\n<h2 id=\"重置密码\"><a class=\"anchor\" href=\"#重置密码\">#</a> 重置密码</h2>\n<p>由于 ddns-go 设置密码必须使用复杂密码，因此如果忘记忘记，可以使用以下命令重置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> ddns-go ./ddns-go <span class=\"token parameter variable\">-resetPassword</span> <span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> restart ddns-go</pre></td></tr></table></figure><p>或者进入容器的控制终端后台：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> ddns-go /bin/sh</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"/app #\"></td><td><pre><span class=\"token function\">ls</span> <span class=\"token parameter variable\">-al</span> /root/</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>total <span class=\"token number\">16</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>drwxr-xr-x    <span class=\"token number\">2</span> root     root          <span class=\"token number\">4096</span> Dec  <span class=\"token number\">1</span> <span class=\"token number\">15</span>:50 <span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>drwxr-xr-x    <span class=\"token number\">1</span> root     root          <span class=\"token number\">4096</span> Dec  <span class=\"token number\">1</span> <span class=\"token number\">15</span>:04 <span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>-rw-------    <span class=\"token number\">1</span> root     root           <span class=\"token number\">180</span> Dec  <span class=\"token number\">1</span> <span class=\"token number\">16</span>:13 .ash_history</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>-rw-------    <span class=\"token number\">1</span> root     root           <span class=\"token number\">958</span> Dec  <span class=\"token number\">1</span> <span class=\"token number\">16</span>:28 .ddns_go_config.yaml</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"/app #\"></td><td><pre><span class=\"token function\">vi</span> /root/.ddns_go_config.yaml</pre></td></tr></table></figure><p>通过编辑  <code>/root/.ddns_go_config.yaml</code>  文件更改账号密码。</p>\n",
            "tags": [
                "docker"
            ]
        },
        {
            "id": "https://arachnid.cc/posix-pthread/",
            "url": "https://arachnid.cc/posix-pthread/",
            "title": "POSIX 线程设计应用",
            "date_published": "2024-09-02T13:32:05.844Z",
            "content_html": "<h1 id=\"线程管理\"><a class=\"anchor\" href=\"#线程管理\">#</a> 线程管理</h1>\n<h2 id=\"基本操作\"><a class=\"anchor\" href=\"#基本操作\">#</a> 基本操作</h2>\n<h3 id=\"pthread_create\"><a class=\"anchor\" href=\"#pthread_create\">#</a> pthread_create</h3>\n<p>创建一个线程</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_t</span> <span class=\"token operator\">*</span>restrict thread<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                   <span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                   <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>start_routine<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                   <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>restrict arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>thread --- 返回一个唯一的线程 ID</li>\n<li>attr --- 可以指定线程属性对象，或者以 NULL 为缺省值</li>\n<li>start_routine --- 线程执行函数</li>\n<li>arg --- 为  <code>start_routine</code>  传递的参数，NULL 为缺省值</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EAGAIN --- 资源不足或超出创建线程数，无法创建</li>\n<li>EINVAL --- 无效  <code>attr</code>  参数属性</li>\n<li>EPERM --- 没有权限设置调度策略和  <code>attr</code>  中的参数</li>\n</ul>\n<p>note：当  <code>attr</code>  属性为缺省 NULL 时，此线程默认为  <code>joinable</code>  属性。</p>\n<h3 id=\"pthread_self\"><a class=\"anchor\" href=\"#pthread_self\">#</a> pthread_self</h3>\n<p>获取调用线程的 ID；可以查看一个线程自己的线程 ID，需要知道的是线程也有 ID 的，且具有唯一的线程 ID</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">pthread_t</span> <span class=\"token function\">pthread_self</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Return：</p>\n<ul>\n<li>此函数始终成功，返回调用线程的 ID</li>\n</ul>\n<h3 id=\"pthread_equal\"><a class=\"anchor\" href=\"#pthread_equal\">#</a> pthread_equal</h3>\n<p>比较俩个线程 ID，当线程 ID 相同时返回非 0，不同时返回 0</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_equal</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_t</span> t1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">pthread_t</span> t2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>t1 and t2：线程的 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>nonzero --- 俩线程 ID 相等</li>\n<li>zero --- 俩线程 ID 不同</li>\n</ul>\n<h3 id=\"pthread_join\"><a class=\"anchor\" href=\"#pthread_join\">#</a> pthread_join</h3>\n<p>线程可以是 joinable 或 detached 的。 如果一个线程是 joinable，那么另一个线程可以调用  <code>pthread_join()</code>  等待该线程终止（挂起当前线程，阻塞式等待线程结束，如果线程已结束则立即返回）</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_join</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_t</span> thread<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>retval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>thread --- 需要终止的线程 ID</li>\n<li>retval --- 退出的状态返回值，用于提供给  <code>pthread_exit()</code></li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EDEADLK --- 检测到死锁或自身调用</li>\n<li>EINVAL --- 该线程非 joinable 线程或另一个线程已经在等待加入这个线程</li>\n<li>ESRCH --- 传入的  <code>thread</code>  参数是不存在的线程 ID</li>\n</ul>\n<h3 id=\"pthread_detach\"><a class=\"anchor\" href=\"#pthread_detach\">#</a> pthread_detach</h3>\n<p>用于把 joinable 线程转变为 detached 线程，一旦把 joinable 线程被设置为 detached 的，那么这个线程就不能被  <code>pthread_join()</code>  调用</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_detach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_t</span> thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>thread --- 需要修改的线程 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EINVAL --- 该线程非 joinable 线程</li>\n<li>ESRCH --- 传入的  <code>thread</code>  参数是不存在的线程 ID</li>\n</ul>\n<h3 id=\"pthread_exit\"><a class=\"anchor\" href=\"#pthread_exit\">#</a> pthread_exit</h3>\n<p>终止线程，也就是终止自己的执行</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">pthread_exit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>retval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>retval --- 由  <code>pthread_join()</code>  提供参数，或以 NULL 为缺省值自身调用结束</li>\n</ul>\n<h2 id=\"参数配置\"><a class=\"anchor\" href=\"#参数配置\">#</a> 参数配置</h2>\n<h3 id=\"pthread_attr_t\"><a class=\"anchor\" href=\"#pthread_attr_t\">#</a> pthread_attr_t</h3>\n<p><code>pthread_attr_t</code>  数据类型，以下函数都调用该结构属性：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>       <span class=\"token keyword\">int</span>                       detachstate<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 线程的分离状态</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>       <span class=\"token keyword\">int</span>                       schedpolicy<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 线程的调度策略</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>       structsched_param         schedparam<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 线程的优先级</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>       <span class=\"token keyword\">int</span>                       inheritsched<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 线程的继承性</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>       <span class=\"token keyword\">int</span>                       scope<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// 线程的作用域</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>       <span class=\"token class-name\">size_t</span>                    guardsize<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 线程栈的警戒缓冲区大小</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>       <span class=\"token keyword\">int</span>                       stackaddr_set<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 线程的栈设置</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>       <span class=\"token keyword\">void</span><span class=\"token operator\">*</span>                     stackaddr<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 线程栈的地址</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>       <span class=\"token class-name\">size_t</span>                    stacksize<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 线程栈的大小</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token class-name\">pthread_attr_t</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>\n<p>detachstate：表示新线程是否与进程中其他线程脱离同步， 如果设置为  <code>PTHREAD_CREATE_DETACHED</code>  则新线程不能用  <code>pthread_join()</code>  来同步，且在退出时自行释放所占用的资源；缺省为  <code>PTHREAD_CREATE_JOINABLE</code>  状态。</p>\n<p>这个属性也可以在线程创建并运行以后用  <code>pthread_detach()</code>  来设置，而一旦设置为  <code>PTHREAD_CREATE_DETACH</code>  状态（不论是创建时设置还是运行时设置）则不能再恢复到  <code>PTHREAD_CREATE_JOINABLE</code>  状态。</p>\n</li>\n<li>\n<p>schedpolicy：表示新线程的调度策略，主要包括  <code>SCHED_OTHER</code> （正常、非实时）、 <code>SCHED_RR</code> （实时、轮转法）和  <code>SCHED_FIFO</code> （实时、先入先出）三种，缺省为  <code>SCHED_OTHER</code> ，后两种调度策略仅对超级用户有效；运行时可以用过  <code>pthread_setschedparam()</code>  来改变。</p>\n</li>\n<li>\n<p>schedparam：一个  <code>struct sched_param</code>  结构，目前仅有一个  <code>sched_priority</code>  整型变量表示线程的运行优先级。这个参数仅当调度策略为实时（即  <code>SCHED_RR</code>  或  <code>SCHED_FIFO</code>  ）时才有效，并可以在运行时通过  <code>pthread_setschedparam()</code>  函数来改变，缺省为 0。</p>\n</li>\n<li>\n<p>inheritsched：有两种值可供选择： <code>PTHREAD_EXPLICIT_SCHED</code>  和  <code>PTHREAD_INHERIT_SCHED</code>  ，前者表示新线程使用显式指定调度策略和调度参数（即由  <code>schedpolicy</code>  和  <code>schedparam</code>  属性确定），而后者表示继承调用者线程的调度策略和调度参数。缺省为  <code>PTHREAD_EXPLICIT_SCHED</code>  。</p>\n</li>\n<li>\n<p>scope：表示线程间竞争 CPU 的范围，也就是说线程优先级的有效范围。POSIX 的标准中定义了两个值： <code>PTHREAD_SCOPE_SYSTEM</code>  和  <code>PTHREAD_SCOPE_PROCESS</code>  ，前者表示与系统中所有线程一起竞争资源（CPU 等），后者表示仅与同一进程中的线程竞争资源（CPU 等）。目前 LinuxThreads 仅实现了  <code>PTHREAD_SCOPE_SYSTEM</code>  值。</p>\n</li>\n<li>\n<p>guardsize：控制着线程栈保护区大小，以避免栈溢出，默认设置为系统的页大小。</p>\n<p>可以把  <code>guardsize</code>  线程属性设为 0，从而不允许属性的这种特征行为发生：在这种情况下不会提供警戒缓存区。同样地，如果对线程属性  <code>stackaddr</code>  作了修改，系统就会假设我们会自己管理栈，并使警戒栈缓冲区机制无效，等同于把  <code>guardsize</code>  线程属性设为 0。</p>\n<p>如果  <code>guardsize</code>  大于零，则会为每个使用 attr 创建的线程提供大小至少为  <code>guardsize</code>  字节的溢出保护区。</p>\n</li>\n<li>\n<p>stackaddr_set：</p>\n</li>\n<li>\n<p>stackaddr：该属性设置新线程所用栈的栈地址。</p>\n</li>\n<li>\n<p>stacksize：该属性设置新线程所用栈的栈大小。</p>\n</li>\n</ul>\n<h3 id=\"pthread_attr_init\"><a class=\"anchor\" href=\"#pthread_attr_init\">#</a> pthread_attr_init</h3>\n<p>线程属性初始化</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pthread_attr_destroy\"><a class=\"anchor\" href=\"#pthread_attr_destroy\">#</a> pthread_attr_destroy</h3>\n<p>销毁线程属性对象</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_destroy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的分离状态\"><a class=\"anchor\" href=\"#设置-获取线程的分离状态\">#</a> 设置 / 获取线程的分离状态</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// detachstate：PTHREAD_CREATE_DETACHED or PTHREAD_CREATE_JOINABLE</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setdetachstate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                <span class=\"token keyword\">int</span> detachstate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getdetachstate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>detachstate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的调度策略\"><a class=\"anchor\" href=\"#设置-获取线程的调度策略\">#</a> 设置 / 获取线程的调度策略</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// policy：SCHED_FIFO, SCHED_RR or SCHED_OTHER</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setschedpolicy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                <span class=\"token keyword\">int</span> policy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getschedpolicy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>restrict policy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的优先级\"><a class=\"anchor\" href=\"#设置-获取线程的优先级\">#</a> 设置 / 获取线程的优先级</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setschedparam</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                               <span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sched_param</span> <span class=\"token operator\">*</span>restrict param<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getschedparam</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                               <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sched_param</span> <span class=\"token operator\">*</span>restrict param<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>所用系统支持的优先级最大最小值可以使用如下函数查询：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sched.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sched_get_priority_max</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> policy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sched_get_priority_min</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> policy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>note：</strong></p>\n<p>该属性值仅当调度策略为实时（即 SCHED_RR 或 SCHED_FIFO ）时才有效，因此一般使用以下函数设置优先级：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sched_param</span> sched<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>sched<span class=\"token punctuation\">.</span>sched_priority <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">pthread_t</span> pidtake<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>pidtake<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> thread_take<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">pthread_setschedparam</span><span class=\"token punctuation\">(</span>pidtake<span class=\"token punctuation\">,</span> SCHED_RR<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>sched<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的继承性\"><a class=\"anchor\" href=\"#设置-获取线程的继承性\">#</a> 设置 / 获取线程的继承性</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// inheritsched：PTHREAD_INHERIT_SCHED or PTHREAD_EXPLICIT_SCHED</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setinheritsched</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                 <span class=\"token keyword\">int</span> inheritsched<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getinheritsched</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                 <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>restrict inheritsched<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的作用域\"><a class=\"anchor\" href=\"#设置-获取线程的作用域\">#</a> 设置 / 获取线程的作用域</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// scope：PTHREAD_SCOPE_SYSTEM or PTHREAD_SCOPE_PROCESS</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setscope</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                          <span class=\"token keyword\">int</span> scope<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getscope</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                          <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>restrict scope<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程栈保护区大小\"><a class=\"anchor\" href=\"#设置-获取线程栈保护区大小\">#</a> 设置 / 获取线程栈保护区大小</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setguardsize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                              <span class=\"token class-name\">size_t</span> guardsize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getguardsize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                              <span class=\"token class-name\">size_t</span> <span class=\"token operator\">*</span>restrict guardsize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的内存区域\"><a class=\"anchor\" href=\"#设置-获取线程的内存区域\">#</a> 设置 / 获取线程的内存区域</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setstackaddr</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                              <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>stackaddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getstackaddr</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                              <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>restrict stackaddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的栈大小\"><a class=\"anchor\" href=\"#设置-获取线程的栈大小\">#</a> 设置 / 获取线程的栈大小</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setstacksize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                              <span class=\"token class-name\">size_t</span> stacksize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getstacksize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                              <span class=\"token class-name\">size_t</span> <span class=\"token operator\">*</span>restrict stacksize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"信号量\"><a class=\"anchor\" href=\"#信号量\">#</a> 信号量</h1>\n<h2 id=\"sem_init\"><a class=\"anchor\" href=\"#sem_init\">#</a> sem_init</h2>\n<p>初始化一个匿名信号量</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> pshared<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>sem --- 返回一个信号量</li>\n<li>pshared --- 为 0 表示该信号量在某个进程中的多个线程之间共享，该信号量应当能够被所有的线程访问，例如是一个全局变量或者是在堆上动态分配的变量；若不为 0 ，表示在进程间共享，那么该信号量应该位于共享内存的区域中</li>\n<li>value --- 指定信号量的初始值</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero（-1） --- error</li>\n</ul>\n<h2 id=\"sem_wait-sem_trywait-sem_timedwait\"><a class=\"anchor\" href=\"#sem_wait-sem_trywait-sem_timedwait\">#</a> sem_wait / sem_trywait / sem_timedwait</h2>\n<p>锁定给定的信号量</p>\n<p>对于  <code>sem_wait</code>  ，如果信号量的值  <code>sval</code>  大于 0 ， <code>sem_wait</code>  会对  <code>sval</code>  减 1 ，函数立即返回。如果  <code>sval</code>  为 0 ， <code>sem_wait</code>  将阻塞调用者（某个进程或线程），直到  <code>sval</code>  重新大于 0 或者调用者被 Linux 系统中的系统调用  <code>signal()</code>  函数中断 。</p>\n<p>对于  <code>sem_trywait</code>  ，如果对  <code>sval</code>  的减 1 操作不能完成， <code>sem_trywait</code>  不会阻塞调用者，而是返回一个  <code>error</code> ，并设置  <code>errno</code>  为  <code>EAGAIN</code>  。</p>\n<p>对于  <code>sem_timedwait</code>  ，如果  <code>sval</code>  为 0，则阻塞等待，当阻塞时长超过  <code>abs_timeout</code>  返回失败（  <code>errno</code>  设置为  <code>ETIMEDOUT</code>  ） 。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">timespec</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">time_t</span> tv_sec<span class=\"token punctuation\">;</span>      <span class=\"token comment\">/* Seconds */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">long</span>   tv_nsec<span class=\"token punctuation\">;</span>     <span class=\"token comment\">/* Nanoseconds [0 .. 999999999] */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_wait</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_trywait</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_timedwait</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>restrict sem<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                  <span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">timespec</span> <span class=\"token operator\">*</span>restrict abs_timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>sem --- 需加锁的信号量</li>\n<li>abs_timeout ---  <code>struct timespec</code>  结构的超时时间值</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero（-1） --- error</li>\n</ul>\n<h2 id=\"sem_post\"><a class=\"anchor\" href=\"#sem_post\">#</a> sem_post</h2>\n<p>释放给定的信号量，对信号量的值  <code>sem_val</code>  进行加 1 操作，如果该信号量的值最终大于 0 ，则唤醒被  <code>semwait()</code>  阻塞的另一个进程或线程，并重新锁定该信号量</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_post</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>sem --- 需解锁的信号量</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero（-1） --- error</li>\n</ul>\n<h2 id=\"sem_getvalue\"><a class=\"anchor\" href=\"#sem_getvalue\">#</a> sem_getvalue</h2>\n<p>获取给定信号量的值</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_getvalue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>restrict sem<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>restrict sval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>sem --- 需获取的信号量</li>\n<li>sval --- 返回的当前信号量的值</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero（-1） --- error</li>\n</ul>\n<h2 id=\"sem_destroy\"><a class=\"anchor\" href=\"#sem_destroy\">#</a> sem_destroy</h2>\n<p>销毁一个匿名信号量</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_destroy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>sem --- 需销毁的信号量</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero（-1） --- error</li>\n</ul>\n<h1 id=\"互斥锁\"><a class=\"anchor\" href=\"#互斥锁\">#</a> 互斥锁</h1>\n<p>在多线程编程中，引入了对象互斥锁的概念，来保证共享数据操作的完整性。 每个对象都对应于一个可称为 &quot;互斥锁&quot; 的标记，这个标记用来保证在任一时刻， 只能有一个线程访问该对象。<strong>互斥锁也可以叫线程锁</strong>。</p>\n<h2 id=\"基本操作-2\"><a class=\"anchor\" href=\"#基本操作-2\">#</a> 基本操作</h2>\n<h3 id=\"pthread_mutex_initializer\"><a class=\"anchor\" href=\"#pthread_mutex_initializer\">#</a> PTHREAD_MUTEX_INITIALIZER</h3>\n<p>静态初始化互斥锁</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PTHREAD_MUTEX_INITIALIZER</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token expression\"><span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></span></span></pre></td></tr></table></figure><p>eg：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">pthread_mutex_t</span> s_mutex <span class=\"token operator\">=</span> PTHREAD_MUTEX_INITIALIZER<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pthread_mutex_init\"><a class=\"anchor\" href=\"#pthread_mutex_init\">#</a> pthread_mutex_init</h3>\n<p>动态初始化互斥锁</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutex_init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutex_t</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                       <span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_mutexattr_t</span> <span class=\"token operator\">*</span>mutexattr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>mutex --- 返回一个唯一的互斥锁 ID</li>\n<li>mutexattr --- 可以指定互斥锁属性对象，或者以 NULL 为缺省值</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- 此函数始终成功</li>\n</ul>\n<h3 id=\"pthread_mutex_lock\"><a class=\"anchor\" href=\"#pthread_mutex_lock\">#</a> pthread_mutex_lock</h3>\n<p>锁定给定的互斥锁，阻塞调用。如果这个互斥锁此时正在被其它线程占用， 那么  <code>pthread_mutex_lock()</code>  调用会进入到这个互斥锁的等待队列中，并会进入阻塞状态， 直到拿到该锁之后才会返回。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutex_t</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>mutex --- 需加锁的互斥锁 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EINVAL --- 未正确初始化</li>\n<li>EDEADLK --- 互斥锁已经被调用线程锁定（仅  <code>PTHREAD_MUTEX_ERRORCHECK</code>  类型互斥锁）</li>\n</ul>\n<h3 id=\"pthread_mutex_trylock\"><a class=\"anchor\" href=\"#pthread_mutex_trylock\">#</a> pthread_mutex_trylock</h3>\n<p>锁定给定的互斥锁，<strong>非</strong>阻塞调用。当请求的锁正在被占用的时候， 不会进入阻塞状态，而是立刻返回，并返回一个错误代码  <code>EBUSY</code> ，意思是说， 有其它线程正在使用这个锁。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutex_trylock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutex_t</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>mutex --- 需加锁的互斥锁 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>\n<p>EBUSY --- 互斥锁无法获取，因为目前已被锁定占用</p>\n</li>\n<li>\n<p>EINVAL --- 未正确初始化</p>\n</li>\n</ul>\n<h3 id=\"pthread_mutex_unlock\"><a class=\"anchor\" href=\"#pthread_mutex_unlock\">#</a> pthread_mutex_unlock</h3>\n<p>释放给定的互斥锁</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutex_t</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>mutex --- 需解锁的互斥锁 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EINVAL --- 未正确初始化</li>\n<li>EPERM --- 调用线程未拥有互斥锁（仅  <code>PTHREAD_MUTEX_ERRORCHECK</code>  类型互斥锁）</li>\n</ul>\n<h3 id=\"pthread_mutex_destroy\"><a class=\"anchor\" href=\"#pthread_mutex_destroy\">#</a> pthread_mutex_destroy</h3>\n<p>销毁由  <code>pthread_mutex_init</code>  动态初始化的互斥锁，释放它可能持有的资源</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutex_destroy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutex_t</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>mutex --- 需销毁的互斥锁 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EBUSY --- 互斥锁目前已被锁定占用，无法进行销毁</li>\n</ul>\n<h2 id=\"参数配置-2\"><a class=\"anchor\" href=\"#参数配置-2\">#</a> 参数配置</h2>\n<h3 id=\"pthread_mutexattr_t\"><a class=\"anchor\" href=\"#pthread_mutexattr_t\">#</a> pthread_mutexattr_t</h3>\n<p><code>pthread_mutexattr_t</code>  数据类型，以下函数都调用该结构属性：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Data structures for mutex handling.  The structure of the attribute</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   type is not exposed on purpose.  */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">__pthread_mutex_s</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">int</span> __lock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> __count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">int</span> __owner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">__WORDSIZE <span class=\"token operator\">==</span> <span class=\"token number\">64</span></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> __nusers<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">/* KIND must stay at this position in the structure to maintain</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>           binary compatibility.  */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">int</span> __kind<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">__WORDSIZE <span class=\"token operator\">==</span> <span class=\"token number\">64</span></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">int</span> __spins<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        __pthread_list_t __list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__PTHREAD_MUTEX_HAVE_PREV</span>  <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> __nusers<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        __extension__ <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">int</span> __spins<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            __pthread_slist_t __list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> __data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">char</span> __size<span class=\"token punctuation\">[</span>__SIZEOF_PTHREAD_MUTEX_T<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token keyword\">int</span> __align<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token class-name\">pthread_mutex_t</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pthread_mutexattr_init\"><a class=\"anchor\" href=\"#pthread_mutexattr_init\">#</a> pthread_mutexattr_init</h3>\n<p>互斥锁属性初始化</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutexattr_init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutexattr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pthread_mutexattr_destroy\"><a class=\"anchor\" href=\"#pthread_mutexattr_destroy\">#</a> pthread_mutexattr_destroy</h3>\n<p>销毁互斥锁属性对象</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutexattr_destroy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutexattr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pthread_mutexattr_settype\"><a class=\"anchor\" href=\"#pthread_mutexattr_settype\">#</a> pthread_mutexattr_settype</h3>\n<p>设置互斥锁类型属性</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutexattr_settype</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutexattr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>如果互斥锁类型为  <code>PTHREAD_MUTEX_NORMAL</code> ，则不提供死锁检测。尝试重新锁定互斥锁会导致死锁。如果某个线程尝试解除锁定的互斥锁不是由该线程锁定或未锁定，则将产生不确定的行为。</p>\n<p>如果互斥锁类型为  <code>PTHREAD_MUTEX_ERRORCHECK</code> ，则会提供错误检查。如果某个线程尝试重新锁定的互斥锁已经由该线程锁定，则将返回错误。如果某个线程尝试解除锁定的互斥锁不是由该线程锁定或者未锁定，则将返回错误。</p>\n<p>如果互斥锁类型为  <code>PTHREAD_MUTEX_RECURSIVE</code> ，则该互斥锁会保留锁定计数这一概念。线程首次成功获取互斥锁时，锁定计数会设置为 1。线程每重新锁定该互斥锁一次，锁定计数就增加 1。线程每解除锁定该互斥锁一次，锁定计数就减小 1。 锁定计数达到 0 时，该互斥锁即可供其他线程获取。如果某个线程尝试解除锁定的互斥锁不是由该线程锁定或者未锁定，则将返回错误。</p>\n<p>如果互斥锁类型是  <code>PTHREAD_MUTEX_DEFAULT</code> ，则尝试以递归方式锁定该互斥锁将产生不确定的行为。对于不是由调用线程锁定的互斥锁，如果尝试解除对它的锁定，则会产生不确定的行为。如果尝试解除锁定尚未锁定的互斥锁，则会产生不确定的行为。</p>\n<h1 id=\"条件变量\"><a class=\"anchor\" href=\"#条件变量\">#</a> 条件变量</h1>\n<h1 id=\"读写锁\"><a class=\"anchor\" href=\"#读写锁\">#</a> 读写锁</h1>\n<h1 id=\"自旋锁\"><a class=\"anchor\" href=\"#自旋锁\">#</a> 自旋锁</h1>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/linux-device-common-operation/",
            "url": "https://arachnid.cc/linux-device-common-operation/",
            "title": "Linux 设备常用操作",
            "date_published": "2024-09-01T06:18:07.000Z",
            "content_html": "<h1 id=\"串口测试\"><a class=\"anchor\" href=\"#串口测试\">#</a> 串口测试</h1>\n<p>1、获取串口号</p>\n<p>一般串口都是以  <code>/dev/ttyS#</code>  的格式显示，所以第一个连接的串口就是  <code>/dev/ttyS0</code> ，第二个连接的串口就是  <code>/dev/ttyS1</code>  … 以此类推。</p>\n<p>USB 转串口适配，没有额外驱动，它们会显示为  <code>/dev/ttyUSB#</code> ，如  <code>/dev/ttyUSB0</code>  。</p>\n<p>可以通过如下命令获取：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> /dev/ttyS*</pre></td></tr></table></figure><p>note：</p>\n<p>一般来说，通过  <code>ls -l /dev/ttyS*</code>  获取出来的串口是包含虚拟串口和存在但未连接的串口，这时候可以通过  <code>cat /proc/tty/driver/serial</code>  来获取真实连接的串口，或者使用  <code>dmesg | grep ttyS*</code>  来查看， eg：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@debian:/<span class=\"token comment\"># ls -l /dev/ttyS*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>crw-rw---- <span class=\"token number\">1</span> root dialout <span class=\"token number\">4</span>, <span class=\"token number\">64</span> Oct <span class=\"token number\">25</span> <span class=\"token number\">19</span>:29 /dev/ttyS0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>crw-rw---- <span class=\"token number\">1</span> root dialout <span class=\"token number\">4</span>, <span class=\"token number\">65</span> Oct <span class=\"token number\">25</span> <span class=\"token number\">19</span>:29 /dev/ttyS1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>crw-rw---- <span class=\"token number\">1</span> root dialout <span class=\"token number\">4</span>, <span class=\"token number\">66</span> Oct <span class=\"token number\">25</span> <span class=\"token number\">19</span>:29 /dev/ttyS2</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>crw-rw---- <span class=\"token number\">1</span> root dialout <span class=\"token number\">4</span>, <span class=\"token number\">67</span> Oct <span class=\"token number\">25</span> <span class=\"token number\">19</span>:29 /dev/ttyS3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>root@debian:/<span class=\"token comment\"># cat /proc/tty/driver/serial</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>serinfo:1.0 driver revision:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">0</span>: uart:16550A port:000003F8 irq:4 tx:0 rx:0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">1</span>: uart:unknown port:000002F8 irq:3</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">2</span>: uart:unknown port:000003E8 irq:4</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">3</span>: uart:unknown port:000002E8 irq:3</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>root@debian:/<span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>root@debian:/<span class=\"token comment\"># dmesg | grep ttyS*</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>    <span class=\"token number\">0.095756</span><span class=\"token punctuation\">]</span> printk: console <span class=\"token punctuation\">[</span>tty0<span class=\"token punctuation\">]</span> enabled</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>    <span class=\"token number\">2.520985</span><span class=\"token punctuation\">]</span> 00:01: ttyS0 at I/O 0x3f8 <span class=\"token punctuation\">(</span>irq <span class=\"token operator\">=</span> <span class=\"token number\">4</span>, base_baud <span class=\"token operator\">=</span> <span class=\"token number\">115200</span><span class=\"token punctuation\">)</span> is a 16550A</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>   <span class=\"token number\">11.074576</span><span class=\"token punctuation\">]</span> systemd<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>: Created slice system-getty.slice.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>root@debian:/<span class=\"token comment\">#</span></pre></td></tr></table></figure><p>串口 0 的 uart 值时 16550A，tx 值为 0，rx 值也为 0，因此我们断定本机只有一个串口，是串口 0，即 ttyS0。</p>\n<p>2、配置属性</p>\n<p>使用  <code>stty</code>  命令来更改配置串口属性（详情查看  <code>man stty</code> ），比如我们设置串口  <code>/dev/ttyS0</code>  波特率为  <code>115200</code>  和  <code>odd parity</code> ，命令如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>stty <span class=\"token parameter variable\">-F</span> /dev/ttyS0 <span class=\"token number\">115200</span> parodd</pre></td></tr></table></figure><p>3、读写操作</p>\n<p>使用  <code>echo</code>  向串口发送数据，如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">echo</span> “command” <span class=\"token operator\">></span> /dev/ttyS0</pre></td></tr></table></figure><p>利用  <code>cat</code>  来监听串口中的数据，如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> /dev/ttyS0</pre></td></tr></table></figure><p>监听数据并保存到 txt 文本中，如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> /dev/ttyS0 <span class=\"token operator\">></span> file.txt</pre></td></tr></table></figure><p>note：接受信息的时候，对方发送需要加入换行符才能真正收到，否则只是存在接收缓冲区中而并未显示。</p>\n<h1 id=\"can-测试\"><a class=\"anchor\" href=\"#can-测试\">#</a> CAN 测试</h1>\n<p>1、获取 CAN 设备</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> a</pre></td></tr></table></figure><p>通常 CAN 设备以  <code>can#</code>  的格式显示，eg： <code>can0</code>  。</p>\n<p>2、配置属性</p>\n<p>使用  <code>ip link set</code>  对 CAN 设备进行配置，这里设置  <code>can0</code>  波特率为  <code>500Kbps</code>  ，自动重启时间为  <code>10ms</code>  ，其中  <code>up</code>  表示打开该端口。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token function\">link</span> <span class=\"token builtin class-name\">set</span> can0 up <span class=\"token builtin class-name\">type</span> can bitrate <span class=\"token number\">500000</span> restart-ms <span class=\"token number\">10</span></pre></td></tr></table></figure><p>常见可选：</p>\n<p><code>triple-sampling on</code>  ：表示打开 3 次采样，在较低波特率下，建议使用该参数。 如果波特率较高，例如高达到 500Kbps 以上，建议将其关闭。</p>\n<p><code>restart-ms</code>  ：自动重启的频率。</p>\n<p>note：</p>\n<p>使用  <code>ip -details link show can#</code>  可以获取详细的参数。</p>\n<p>3、读写操作</p>\n<p>使用  <code>cansend</code>  发送数据，如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cansend can0 <span class=\"token number\">123</span><span class=\"token comment\">#1122334455667788</span></pre></td></tr></table></figure><p>其中， <code>can0</code>  表示要使用的 CAN 接口， <code>123</code>  表示 CAN ID， <code>#</code>  后面的数字表示发送的数据，这里是 16 进制格式的数据。</p>\n<p>利用  <code>candump</code>  来监听 CAN 总线上的数据，如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>candump can0</pre></td></tr></table></figure><p>4、自动使能 CAN 总线</p>\n<p>Linux 上 CAN 总线接口总是以网络设备形式呈现的，默认系统启动时 CAN 总线处于 down 模式，需要手动使用  <code>ip</code>  命令等配置并使能  <code>up</code>  。但也可以使用系统 network 的 interfaces 文件来实现 CAN 总线自动化配置和激活：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>auto can0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>iface can0 inet manual</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        pre-up /sbin/ip link set $IFACE type can bitrate 500000 restart-ms 10</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        up /sbin/ip link set $IFACE up</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        down /sbin/ip link set $IFACE down</pre></td></tr></table></figure><h1 id=\"无线连接\"><a class=\"anchor\" href=\"#无线连接\">#</a> 无线连接</h1>\n<p>1、获取无线网卡</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iw dev</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># or</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">ip</span> a</pre></td></tr></table></figure><p>通常无线设备名字以  <code>wl#</code>  开头的格式显示，eg： <code>wlan0</code>  。</p>\n<p>2、检查网卡状态</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token function\">link</span> show wlan0</pre></td></tr></table></figure><p>如果在 &lt;&gt; 中没有  <code>UP</code>  的字样，表示网卡没有激活；可以尝试启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token function\">link</span> <span class=\"token builtin class-name\">set</span> wlan0 up</pre></td></tr></table></figure><p>3、检查无线连接状态</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iw wlan0 <span class=\"token function\">link</span></pre></td></tr></table></figure><p>如果没有连接会显示  <code>Not connected</code>  。</p>\n<p>4、扫描可连接的无线网络</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iw wlan0 scan <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> SSID</pre></td></tr></table></figure><p>找到你需要的连接的无线网络名  <code>&lt;wifi_name&gt;</code>  。</p>\n<p>5、无线连接</p>\n<p>一般有两种连接方式：</p>\n<ul>\n<li>\n<p>对于没有密码的连接最为简单，直接连接即可：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iw dev wlan0 connect <span class=\"token operator\">&lt;</span>wifi_name<span class=\"token operator\">></span></pre></td></tr></table></figure></li>\n<li>\n<p>而如果网络是有密码，使用的是 WPA 或 WPA2 协议的话，连接就稍微复杂点，需要用到  <code>wpa_supplicant</code>  工具：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># &lt;wifi_name> 即需要连接的无线网络名</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># &lt;password> 即 WPA 或 WPA2 协议的验证密码</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>wpa_supplicant <span class=\"token parameter variable\">-B</span> <span class=\"token parameter variable\">-i</span> wlan0 -c<span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span>wpa_passphrase <span class=\"token string\">\"&lt;wifi_name>\"</span> <span class=\"token string\">\"&lt;password>\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure></li>\n</ul>\n<p>6、为无线网卡分配 IP 地址</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>dhclient wlan0</pre></td></tr></table></figure><p>note：</p>\n<p>如果之前为该网卡分配过 IP，可能会出现错误，只需要把 dhclient 信息后面 () 里的进程杀掉，再重新执行即可。</p>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/nginx-uses-anti-proxy-and-ssl/",
            "url": "https://arachnid.cc/nginx-uses-anti-proxy-and-ssl/",
            "title": "Nginx 反代理并安装 SSL",
            "date_published": "2024-08-23T01:18:11.000Z",
            "content_html": "<h1 id=\"反代理\"><a class=\"anchor\" href=\"#反代理\">#</a> 反代理</h1>\n<p>一般实现不同域名直连，也即表示你不带端口实现访问部署在不同端口的多服务，那么你需要腾出 80、443、81 端口，以便反代理工具接管这些端口数据流向；因此在使用 Nginx 反代理实现统一端口路由多服务时，必须为 Nginx 服务至少腾出 80、443 端口，然后让 Nginx 通过监听 80、443 端口，当外部统一通过 80 端口访问服务时，根据 URL 路径前缀转发到部署在不同端口的服务上。</p>\n<h2 id=\"nginx-的处理顺序\"><a class=\"anchor\" href=\"#nginx-的处理顺序\">#</a> Nginx 的处理顺序</h2>\n<p>当请求到达时，Nginx 会：</p>\n<ol>\n<li>匹配  <code>server_name</code>  完全相同的配置</li>\n<li>如果没有完全匹配，匹配通配符配置</li>\n<li>如果没有通配符匹配，使用  <code>default_server</code></li>\n<li>如果没有  <code>default_server</code> ，使用第一个定义的 server 块</li>\n</ol>\n<p>查看  <code>default_server</code>  是否存在：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-r</span> <span class=\"token string\">\"default_server\"</span> /etc/nginx/</pre></td></tr></table></figure><p>如若没有，在配置文件夹里（一般在  <code>/etc/nginx/conf.d/</code>  目录）编写  <code>other.conf</code>  ，防止其它不匹配的  <code>server_name</code>  非法跳转访问：</p>\n<pre><code class=\"language-conf\">server &#123;\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    return 444; # 关闭连接\n&#125;\n</code></pre>\n<h2 id=\"主机安装使用\"><a class=\"anchor\" href=\"#主机安装使用\">#</a> 主机安装使用</h2>\n<p>由于本人是在 Openmediavault 服务器中操作，因此它是默认安装了 Nginx 服务的，如果是其它 Linux 平台，并没有 Nginx 服务，可以如下 &quot;安装运行&quot; 开启 Nginx 服务，若不清楚是否存在 Nginx 服务，可用  <code>nginx -v</code>  命令查看。</p>\n<h3 id=\"安装运行\"><a class=\"anchor\" href=\"#安装运行\">#</a> 安装运行</h3>\n<p>以 debian 平台为示例，更新安装 Nginx：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> nginx</pre></td></tr></table></figure><p>启动并启用 Nginx：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> systemctl start nginx    <span class=\"token comment\"># 启动服务</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> nginx   <span class=\"token comment\"># 设置开机自启</span></pre></td></tr></table></figure><h3 id=\"编写-nginx-配置\"><a class=\"anchor\" href=\"#编写-nginx-配置\">#</a> 编写 Nginx 配置</h3>\n<p>创建该服务的配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/nginx/conf.d/app1_service.conf</pre></td></tr></table></figure><p>在这里选择最通用  <code>/etc/nginx/conf.d/</code>  目录存放自定义配置，避免不同平台存在差异。</p>\n<p>note：</p>\n<ul>\n<li><strong> <code>/etc/nginx/conf.d/</code> </strong>\n<ul>\n<li><strong>这是放置自定义配置最推荐、最通用的目录</strong>。</li>\n<li>你可以在里面创建任意名称的  <code>.conf</code>  文件（例如  <code>my-website.conf</code> ,  <code>reverse-proxy.conf</code> ），Nginx 会自动加载它们。</li>\n<li>例如： <code>/etc/nginx/conf.d/reverse-proxy.conf</code></li>\n</ul>\n</li>\n<li><strong> <code>/etc/nginx/sites-available/</code>  和  <code>/etc/nginx/sites-enabled/</code> </strong> (常见于 Debian / Ubuntu)\n<ul>\n<li><strong> <code>sites-available/</code> </strong>：存放所有可用的服务器块（虚拟主机）配置文件。这是一个 “仓库”。</li>\n<li><strong> <code>sites-enabled/</code> </strong>：存放当前已启用的服务器块配置文件的<strong>符号链接</strong>（快捷方式）。</li>\n<li>这种设计允许你轻松启用 / 禁用站点。</li>\n<li>管理命令： <code>sudo ln -s /etc/nginx/sites-available/my-site /etc/nginx/sites-enabled/</code>  (启用)</li>\n</ul>\n</li>\n</ul>\n<p>假设给  <code>app1.domain.com</code>  域名访问绑定至  <code>8081</code>  端口，写入如下信息：</p>\n<pre><code class=\"language-conf\">server &#123;\n    listen    80;\n    listen    [::]:80;\n    server_name app1.domain.com;\n\n    #access_log  /var/log/nginx/app1.access.log;\n\n    # proxy the app1 scripts to Nginx listening on 127.0.0.1:8081\n\n    location / &#123;\n        proxy_set_header Host $proxy_host;\n        proxy_set_header X-Real_IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-Forwarded-Host $host;\n        proxy_set_header X-Forwarded-Port $server_port;\n        proxy_buffering off;\n\n        proxy_pass   http://localhost:8081;\n    &#125;\n&#125;\n</code></pre>\n<p>使用下面的命令检查一下修改后的配置文件是否有错：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nginx <span class=\"token parameter variable\">-t</span></pre></td></tr></table></figure><p>使其生效：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nginx <span class=\"token parameter variable\">-s</span> reload</pre></td></tr></table></figure><p>至此，一个简单的域名访问服务的操作就完成了，同理你可以配置更多不同的域名绑至不同的端口服务。</p>\n<h2 id=\"docker-部署使用\"><a class=\"anchor\" href=\"#docker-部署使用\">#</a> Docker 部署使用</h2>\n<p>同样的，若是需要域名直连访问不同端口服务，需要预留监听 80、443 的端口给到  Nginx docker 服务。</p>\n<h3 id=\"安装运行-2\"><a class=\"anchor\" href=\"#安装运行-2\">#</a> 安装运行</h3>\n<p>先临时启动一个 Nginx docker 提取主要配置文件，当然你也可以复制一份已有的配置映射到容器中。</p>\n<p>执行以下命令，临时创建 Nginx docker 服务：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> nginx <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 nginx</pre></td></tr></table></figure><p>提取里面的配置文件到主机中，以便编辑配置，你说为什么不直接在容器中操作？拜托，里面可是连个默认的文本编辑器都没有，只有最小系统及 Nginx 服务；而至于为啥不直接把里面的文件反映射到主机？是因为一旦映射后，容器里面的文件夹将根据主机内容变化，即主机上需映射的文件夹如果是空，一旦映射到容器里，容器上的文件夹跟着变空；因此需要先提取出来再映射：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/nginx/config/conf.d</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">docker</span> <span class=\"token function\">cp</span> nginx:/etc/nginx/conf.d/default.conf /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/nginx/config/conf.d</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">docker</span> <span class=\"token function\">cp</span> nginx:/etc/nginx/nginx.conf /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/nginx/config</pre></td></tr></table></figure><p>停止 Nginx docker 服务，此时由于  <code>--rm</code>  参数将自动删除该容器：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> stop nginx</pre></td></tr></table></figure><p>正式启动 Nginx docker 容器：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>     <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>nginx <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">PUID</span><span class=\"token operator\">=</span><span class=\"token number\">1000</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">PGID</span><span class=\"token operator\">=</span><span class=\"token number\">993</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     <span class=\"token parameter variable\">-p</span> <span class=\"token number\">81</span>:81 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     <span class=\"token parameter variable\">-p</span> <span class=\"token number\">443</span>:443 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     <span class=\"token parameter variable\">-v</span> /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/nginx/config/nginx.conf:/etc/nginx/nginx.conf <span class=\"token punctuation\">\\</span>    <span class=\"token comment\"># 主配置文件</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     <span class=\"token parameter variable\">-v</span> /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/nginx/config/conf.d:/etc/nginx/conf.d <span class=\"token punctuation\">\\</span>    <span class=\"token comment\"># 附加配置文件目录</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     <span class=\"token parameter variable\">-v</span> /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/nginx/data:/usr/share/nginx/html:ro <span class=\"token punctuation\">\\</span>    <span class=\"token comment\"># 默认网站根目录</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     <span class=\"token parameter variable\">-v</span> /<span class=\"token operator\">&lt;</span>path<span class=\"token operator\">></span>/SSL:/usr/share/ssl:ro <span class=\"token punctuation\">\\</span>    <span class=\"token comment\"># SSL 证书目录</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     --health-cmd<span class=\"token operator\">=</span><span class=\"token string\">\"curl -fs -S --max-time 3 http://localhost || exit 1\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     --health-interval<span class=\"token operator\">=</span>30s <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     --health-timeout<span class=\"token operator\">=</span>10s <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>     --health-retries<span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>     --health-start-period<span class=\"token operator\">=</span>5s <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     --add-host host.docker.internal:host-gateway <span class=\"token punctuation\">\\</span>    <span class=\"token comment\"># 用于解析链接到宿主机中的服务</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     <span class=\"token parameter variable\">--restart</span> always <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     nginx:latest</pre></td></tr></table></figure><p>note：</p>\n<p><code>--add-host host.docker.internal:host-gateway</code>  该参数选项非常重要，后于后面配置 Nginx 配置时，使得在 docker 里面能访问到主机上的服务及其它 docker 容器服务（哪怕所有容器不在同一网络）；而它的大概意思也就是容器内部访问这个域名  <code>host.docker.internal</code>  时，就会访问到对应的主机上的  <code>host-gateway</code>  地址。</p>\n<h3 id=\"编写-nginx-配置-2\"><a class=\"anchor\" href=\"#编写-nginx-配置-2\">#</a> 编写 Nginx 配置</h3>\n<p>docker 上的配置文件编写跟上面主机编写的 Nginx 配置变化不大，唯一需要更改的是  <code>proxy_pass</code>  字段中的参数，由于当前 Nginx 是在容器中，因此需要把网络转发到宿主机上面，再通过宿主机的本机路由再转给相应的端口服务：</p>\n<pre><code class=\"language-conf\">server &#123;\n    listen    80;\n    listen    [::]:80;\n    server_name app1.domain.com;\n\n    #access_log  /var/log/nginx/app1.access.log;\n\n    # proxy the app1 scripts to Nginx listening on 127.0.0.1:8081\n\n    location / &#123;\n        proxy_set_header Host $proxy_host;\n        proxy_set_header X-Real_IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-Forwarded-Host $host;\n        proxy_set_header X-Forwarded-Port $server_port;\n        proxy_buffering off;\n\n        proxy_pass   http://host.docker.internal:8081;\n    &#125;\n&#125;\n</code></pre>\n<h1 id=\"安装-ssl\"><a class=\"anchor\" href=\"#安装-ssl\">#</a> 安装 SSL</h1>\n<p>在以上配置中，如果你通过访问可以知道当前页面是 HTTP 页面，同时第一次访问配置好的服务，会提示当前非 HTTPS 页面的警告，那么为了安全及消除这样的警告，你需要为你的服务安装 SSL 认证，使其启用 HTTPS 访问。</p>\n<p>根据 <a href=\"https://arachnid.cc/use-the-acme-tool/\">使用 acme.sh 签发 SSL 证书</a> 文章中成功获取签发的证书后，即可为相应的域名绑定服务并安装 SSL 证书了：</p>\n<pre><code class=\"language-conf\"># HTTP 重定向到 HTTPS\nserver &#123;\n    listen 80;\n    listen [::]:80;\n    server_name app1.domain.com;\n    return 301 https://$server_name$request_uri;\n&#125;\n\n# HTTPS 服务器\nserver &#123;\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n    server_name app1.domain.com;\n\n    # SSL 证书路径\n    #RSA\n    ssl_certificate /&lt;path&gt;/SSL/RSA/chain.crt;\n    ssl_certificate_key /&lt;path&gt;/SSL/RSA/private.key;\n\n    #ECC\n    ssl_certificate /&lt;path&gt;/SSL/ECC/chain.crt;\n    ssl_certificate_key /&lt;path&gt;/SSL/ECC/private.key;\n\n    # 基本 SSL 配置\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;\n    ssl_prefer_server_ciphers off;\n\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n    ssl_session_tickets on;\n\n    # 代理设置\n    location / &#123;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-Forwarded-Host $host;\n        proxy_set_header X-Forwarded-Port $server_port;\n        proxy_buffering off;\n        \n        proxy_connect_timeout 30s;\n        proxy_send_timeout 30s;\n        proxy_read_timeout 30s;\n        \n        proxy_pass http://localhost:8081; # 如果是 docker 需要更换为 host.docker.internal\n    &#125;\n\n    # 记录\n    access_log /var/log/nginx/app1.access.log;\n    error_log /var/log/nginx/app1.error.log;\n&#125;\n</code></pre>\n<p>测试：</p>\n<pre><code>curl -IL http://app1.domain.com\n</code></pre>\n",
            "tags": []
        },
        {
            "id": "https://arachnid.cc/gcc-compiler-summary/",
            "url": "https://arachnid.cc/gcc-compiler-summary/",
            "title": "GCC 应用总结",
            "date_published": "2024-07-07T12:45:26.000Z",
            "content_html": "<h1 id=\"关键字\"><a class=\"anchor\" href=\"#关键字\">#</a> 关键字</h1>\n<h2 id=\"weak-关键字\"><a class=\"anchor\" href=\"#weak-关键字\">#</a> weak 关键字</h2>\n<p>一般用法： <code>__attribute__((weak))</code>  ，用于定义或声明对应的函数是一个 weak 属性。</p>\n<p>在 Linux 开发环境中，有强符号和弱符号，符号简单来说就是函数、变量的名字，对于全局（非局部、非 <code>static</code> ）的函数和变量，能不能重名是有一定规矩的，强、弱符号就是针对这些全局函数和变量来说的。</p>\n<table>\n<thead>\n<tr>\n<th>符号类型</th>\n<th>对象</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>强</td>\n<td>函数名，赋初值的全局变量</td>\n</tr>\n<tr>\n<td>弱</td>\n<td>未初始化的全局变量</td>\n</tr>\n</tbody>\n</table>\n<p>当代码中同时存在多个强或弱的全局变量时，要遵守如下规则：</p>\n<ul>\n<li>强符号只能定义一次，否则编译错误；</li>\n<li>强弱符号同时存在，以强符号为准；</li>\n<li>没有强符号，则从多个弱符号中任选一个，用  <code>–fno-common</code>  编译选项可以在这种情况下输出 warning 提示。</li>\n</ul>\n<h2 id=\"constructor-和-destructor-关键字\"><a class=\"anchor\" href=\"#constructor-和-destructor-关键字\">#</a> constructor 和 destructor 关键字</h2>\n<p><code>__attribute__((constructor))</code>  与  <code>__attribute__((destructor))</code>  的用法。</p>\n<p><code>__attribute__((constructor))</code>  与  <code>__attribute__((destructor))</code>  是 GCC 中用来修饰函数的，constructor 可以使被修饰的函数在 main () 执行前被调用，destructor 可以使被修饰的函数在 main () 执行结束或 exit () 调用结束后被执行。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>constructor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">constructor_func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>destructor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">destructor_func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>一个程序中可以存在多个 constructor 和 destructor，使用优先级区分执行顺序，数字越小表示优先级越高（100 以内的优先级为保留数字不能设置）。constructor 中优先级越高越靠前执行，destructor 中优先级越高越靠后执行。不加优先级参数相当于最低优先级。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>priority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">constructor_func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">destructor</span><span class=\"token punctuation\">(</span>priority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">destructor_func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"unused-关键字\"><a class=\"anchor\" href=\"#unused-关键字\">#</a> unused 关键字</h2>\n<p><code>__attribute__((used))</code> ，表示对于这个函数可能不会调用它、可能用不到它，编译器不用进行 warning 提示。<br />\n而在嵌入式中 中断函数都是由内部的中断处理机制通过中断向量做跳转调用的，不是开发人员 “显式” 去调用的，因此在一些规则检查比较严格的编译器上编译时，就会出现类似于上面的警告，为了视野干净我们就添加这个属性。</p>\n<h1 id=\"option\"><a class=\"anchor\" href=\"#option\">#</a> option</h1>\n<h2 id=\"nanospecs-选项\"><a class=\"anchor\" href=\"#nanospecs-选项\">#</a> nano.specs 选项</h2>\n<p><code>nano.specs</code>  是一个特殊的 specs 文件，它是为了在资源受限的环境中使用而优化的，比如在嵌入式系统或微控制器中。当你使用  <code>--specs=nano.specs</code>  选项时，编译器会使用 “nano” 版本的 C 库，而这个版本的库被设计为比标准的 GNU C 库 (glibc) 更小，占用更少的 ROM 和 RAM。</p>\n<p><strong>主要特点</strong>:</p>\n<ul>\n<li><strong>体积小</strong>：nano 版本的库被优化以减小体积，适合那些对存储空间有严格限制的系统。</li>\n<li><strong>资源使用低</strong>：这些库在设计时考虑到了内存使用，以尽可能减少动态内存分配。</li>\n<li><strong>功能减少</strong>：为了减小体积，某些不常用的功能可能被移除或替换为更简单的实现。</li>\n</ul>\n<p>在  <code>Makefile</code>  上加上 option ：</p>\n<figure class=\"highlight makefile\"><figcaption data-lang=\"makefile\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CLIBS <span class=\"token operator\">=</span> -specs<span class=\"token operator\">=</span>nano.specs</pre></td></tr></table></figure><h2 id=\"-wrap-选项\"><a class=\"anchor\" href=\"#-wrap-选项\">#</a> -wrap 选项</h2>\n<p><code>-wrap</code>  选项可以使 GCC 在编译链接的时候，转而调用  <code>__wrap_symbol</code>  的定义，另外还有一个相关函数  <code>__real_symbol</code> ，对于只声明不定义的 symbol，会对其调用到真正的 symbol 符号。</p>\n<p>以下是 GCC linker option  <code>–wrap</code>  的描述：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Use a wrapper function for symbol. Any undefined reference to symbol will be resolved to</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>__wrap_symbol. Any undefined reference to __real_symbol will be resolved to symbol. This </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>can be used to provide a wrapper for a system function. The wrapper function should be </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>called __wrap_symbol. If it wishes to call the system function, it should call __real_symbol.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Here is a trivial example:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>void *</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>__wrap_malloc (int c)</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>&#123;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    printf (\"malloc called with %ld\\n\", c);</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    return __real_malloc (c);</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>&#125;</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>If you link other code with this file using --wrap malloc, then all calls to malloc will</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>call the function __wrap_malloc instead. The call to __real_malloc in __wrap_malloc will</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>call the real malloc function. You may wish to provide a __real_malloc function as well, </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>so that links without the --wrap option will succeed. If you do this, you should not put </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>the definition of __real_malloc in the same file as __wrap_malloc; if you do, the assembler </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>may resolve the call before the linker has a chance to wrap it to malloc.</pre></td></tr></table></figure><p>像一般对 malloc、free、printf 进行调换：</p>\n<p>在  <code>Makefile</code>  上加上 option ：</p>\n<figure class=\"highlight makefile\"><figcaption data-lang=\"makefile\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>WRAP <span class=\"token operator\">=</span> -Wl,-wrap,malloc -Wl,-wrap,free</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>WRAP <span class=\"token operator\">+=</span> -Wl,-wrap,printf</pre></td></tr></table></figure><p>在函数里：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>weak<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token function\">__wrap_malloc</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> sz<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"__wrap_malloc: size = %d\\n\"</span><span class=\"token punctuation\">,</span> sz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">pvPortMalloc</span><span class=\"token punctuation\">(</span>sz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>weak<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">__wrap_free</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>ptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"__wrap_free: addr = %p\\n\"</span><span class=\"token punctuation\">,</span> ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">vPortFree</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">__real_printf</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>format<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">__wrap_printf</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>format<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">__real_printf</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>上面实现了对  <code>malloc</code>  的引用转换成调用  <code>__wrap_malloc</code>  函数了，同样的  <code>__wrap_free</code>  和  <code>__wrap_printf</code>  也一样；但是有区别的是， <code>__wrap_printf</code>  里面调用了  <code>__real_printf</code> ，因此，可以理解对  <code>printf</code>  的引用其实是不变的；而由于  <code>__wrap_malloc</code>  和  <code>__wrap_free</code>  分别实现打印和调用  <code>pvPortMalloc</code>  及  <code>vPortFree</code>  新的接口，所以在对  <code>malloc</code>  和  <code>free</code>  引用的时候，是有打印输出并转而执行新的函数接口。</p>\n<p><strong>note：</strong></p>\n<p>在针对所有 “undefined reference to symbol” 中引用 symbol 的源文件里面不能有 symbol 的定义，否则汇编器在处理源文件的时候就会解析这个 symbol，链接器也就没有机会 wrap 这个 symbol 了；嘛简单点说就是需要 wrap 的函数不要跟原函数同时定义在一个源文件。</p>\n<h2 id=\"-wunused-选项\"><a class=\"anchor\" href=\"#-wunused-选项\">#</a> -Wunused 选项</h2>\n<p>在 GCC 中，如果你想要检查程序中未使用的变量，函数或标签，可以使用以下编译参数：</p>\n<p><code>-Wunused-variable</code>  ：此选项会让 GCC 发出警告，如果你的代码中定义了一个变量，但从未使用过它。</p>\n<p><code>-Wunused-function</code>  ：此选项会让 GCC 发出警告，如果你的代码中定义了一个静态函数，但从未使用过它。</p>\n<p><code>-Wunused-label</code> ：此选项会让 GCC 发出警告，如果你的代码中定义了一个标签，但从未使用过它。</p>\n<p>你也可以使用  <code>-Wunused</code>  参数来启用所有未使用相关的警告，这相当于  <code>-Wunused-variable -Wunused-function -Wunused-label</code>  。</p>\n<p><strong>note：</strong></p>\n<p>如果说  <code>unused</code>  关键字是作用于指定的函数，那么  <code>-Wunused</code>  的这些选项就是作用于整个编译范围。</p>\n<h1 id=\"预处理命令\"><a class=\"anchor\" href=\"#预处理命令\">#</a> 预处理命令</h1>\n<h2 id=\"error\"><a class=\"anchor\" href=\"#error\">#</a> #error</h2>\n<p>在编译遇到  <code>#error</code>  指令时，它会停止编译过程，并显示一个错误消息，同时包含该指令的文件名和行号；这通常用于当编译器检查到不满足特定条件时，强制编译失败。</p>\n<h2 id=\"warning\"><a class=\"anchor\" href=\"#warning\">#</a> #warning</h2>\n<p>在编译遇到  <code>#warning</code>  指令时，它会继续编译，但会在编译输出中显示一个警告消息，同时包含该指令的文件名和行号。</p>\n<h1 id=\"预定义宏\"><a class=\"anchor\" href=\"#预定义宏\">#</a> 预定义宏</h1>\n<p><code>__LINE__</code>  和  <code>__FILE__</code>  分别用来显示当前的行号和文件名。</p>\n",
            "tags": [
                "gcc"
            ]
        },
        {
            "id": "https://arachnid.cc/linux_c-exit-and-return/",
            "url": "https://arachnid.cc/linux_c-exit-and-return/",
            "title": "Linux c exit 与 return 区别",
            "date_published": "2024-07-07T09:14:39.000Z",
            "content_html": "<h1 id=\"功能\"><a class=\"anchor\" href=\"#功能\">#</a> 功能</h1>\n<ul>\n<li>_exit () ：退出程序。</li>\n<li>exit（0）：运行正常退出程序；</li>\n<li>exit（1）：运行异常退出程序；</li>\n<li>return（）：返回函数，若在主函数中，则会退出函数并返回值。</li>\n</ul>\n<h1 id=\"_exit-和-exit-区别\"><a class=\"anchor\" href=\"#_exit-和-exit-区别\">#</a> _exit () 和 exit () 区别</h1>\n<ul>\n<li>\n<p>exit () 会将缓冲区的数据写完再结束进程到内核中去（退出进程会清理 I/O 缓冲区）。</p>\n</li>\n<li>\n<p>_exit () 直接结束进程进入到内核中。</p>\n</li>\n<li>\n<p>exit () 函数定义在 stdlib.h 中，_exit () 定义在 unistd.h 中。</p>\n</li>\n<li>\n<p>图示：</p>\n<p><img data-src=\"91748e224d81a92ab21cf272b5244e21.png\" alt=\"img\" /></p>\n</li>\n</ul>\n<p>示例：</p>\n<p><strong>_exit()</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OK\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">_exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>输出结果：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hello</pre></td></tr></table></figure><p><strong>exit()</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OK\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>输出结果：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hello</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>OK</pre></td></tr></table></figure><p><strong>原因：</strong></p>\n<p>printf 函数使用的是缓冲 I/O 的方式，该函数在遇到  <code>\\n</code>  换行符时自动的从缓冲区中将记录读出。</p>\n<p>exit () 将缓冲区的数据写完后才能退出来，所以调用 exit () 函数后程序并不会马上退出，会把 OK 也输出出来。</p>\n<p>_exit () 是直接退出进入到内核中了。</p>\n<h1 id=\"exit0-和-exit1-区别\"><a class=\"anchor\" href=\"#exit0-和-exit1-区别\">#</a> exit (0) 和 exit (1) 区别</h1>\n<ul>\n<li>exit (0)：运行正常退出程序。</li>\n<li>exit (1)：运行异常退出程序，返回值 1 是返回给操作系统的。</li>\n</ul>\n<h1 id=\"return-和-exit-区别\"><a class=\"anchor\" href=\"#return-和-exit-区别\">#</a> return 和 exit () 区别</h1>\n<ul>\n<li>return 是关键字；exit () 是函数。</li>\n<li>return 是语言级别的，表示调用堆栈的返回；而 exit () 是系统调用级别的，表示进程的结束。</li>\n<li>return 是退出（返回）函数，将控制权移交给递归的前一级；exit () 是直接退出进程。</li>\n<li>在最初调用的 main 函数中调用 return 和 exit 的现象很模糊，非主函数中调用 return 和 exit 效果很明显。</li>\n</ul>\n",
            "tags": [
                "Linux",
                "linux_c"
            ]
        },
        {
            "id": "https://arachnid.cc/vmware-space-recycling/",
            "url": "https://arachnid.cc/vmware-space-recycling/",
            "title": "VMware 下 ubuntu 空间回收",
            "date_published": "2024-07-07T07:02:28.000Z",
            "content_html": "<p>方法一：</p>\n<p>通过在  <code>虚拟机设置</code>  中的  <code>硬盘</code>  项，进行  <code>碎片整理</code>  和  <code>压缩</code>  处理。</p>\n<p>方法二：</p>\n<p>清空虚拟机系统的回收站</p>\n<p>在 Ubuntu 下，删除了某些文件，而当准备清空回收站的时候，却发现无法清空，打开回收站，在里面进行文件删除时提示 “Failed to delete the item from the trash”。</p>\n<p>解决方法如下：</p>\n<ol>\n<li>\n<p>打开桌面的主文件夹，按组合键 Ctrl+H（显示隐藏文件），找到以下路径： <code>/home/user/.local/share/Trash</code>  （注：user 是用户名，根据你的用户名而变）。</p>\n</li>\n<li>\n<p>在上面的路径下点击鼠标右键，选择 “在终端中打开”。</p>\n</li>\n<li>\n<p>运行命令  <code>sudo rm -rf *</code>  这时，便可以删除那些平时无法删除的文件。</p>\n</li>\n</ol>\n<p>方法三：</p>\n<p>删除  <code>.cache</code>  等配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看 365 天以上的配置文件：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">find</span> ~/.cache/ <span class=\"token parameter variable\">-depth</span> <span class=\"token parameter variable\">-type</span> f <span class=\"token parameter variable\">-atime</span> +365</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 确认后可删除</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">find</span> ~/.cache/ <span class=\"token parameter variable\">-type</span> f <span class=\"token parameter variable\">-atime</span> +365 <span class=\"token parameter variable\">-delete</span></pre></td></tr></table></figure><p>方法四：</p>\n<p>清除快照，通过进入  <code>快照管理器</code>  把所有快照删除掉。</p>\n<p><strong>note：</strong></p>\n<p>有时候在删除快照的时候点了取消，这时候会存在残留的情况，可以在关机的情况下，拍摄快照，然后再进行删除，这样系统就会把残留的快照重新整合删除，以达到全部删除的效果。</p>\n<p>方法五：</p>\n<p>在 VMware Workstation 的安装目录下，有一个  <code>vmware-vdiskmanager.exe</code>  程序，在该目录下打开终端，输入：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>vmware-vdiskmanager.exe <span class=\"token parameter variable\">-k</span> <span class=\"token string\">\"vmdk 文件路径\"</span></pre></td></tr></table></figure><p>如果安装虚拟机时选择的是将磁盘存储为多个文件，而非存储为单个文件，则只需选择名为： <code>虚拟机名.vmdk</code>  的那个 vmdk 文件 （文件名不带 s 的那种）</p>\n<p>这样就可以使用  <code>vmware-vdiskmanager.exe</code>  程序对 VM 磁盘文件 vmdk 进行压缩</p>\n<p>执行过程会显示压缩进度，完成后会提示：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Shrink: <span class=\"token number\">100</span>% done.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Shrink completed successfully.</pre></td></tr></table></figure><p><strong>note：</strong></p>\n<p>虚拟机不能有快照，否则会显示：“为该虚拟机禁用了磁盘压缩。”</p>\n<p>方法六：</p>\n<p>在虚拟机中利用命令来释放磁盘空间。</p>\n<p>搜索查看磁盘挂载点：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> vmware-toolbox-cmd disk list</pre></td></tr></table></figure><p>对  <code>/</code>  分区所在的虚拟硬盘进行清理， <code>/</code>  表示你的磁盘挂载点，可以从上一步 list 列表中取值，不清楚的用户可以直接执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> /usr/bin/vmware-toolbox-cmd disk wipe /</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> /usr/bin/vmware-toolbox-cmd disk shrink /</pre></td></tr></table></figure><p>也可以使用如下脚本来收缩所有的挂载磁盘：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#! /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">LOG_FILE</span><span class=\"token operator\">=~</span>/vmdiskshrink.log</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">DISK_LIST</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">sudo</span> /usr/bin/vmware-toolbox-cmd disk list<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"will shrink disk: <span class=\"token entity\" title=\"\\n\">\\n</span>############<span class=\"token entity\" title=\"\\n\">\\n</span><span class=\"token variable\">$&#123;DISK_LIST&#125;</span><span class=\"token entity\" title=\"\\n\">\\n</span>############\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">mydisk</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;DISK_LIST&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-d</span> <span class=\"token variable\">$&#123;mydisk&#125;</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span><span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token builtin class-name\">continue</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token builtin class-name\">read</span> <span class=\"token parameter variable\">-t</span> <span class=\"token number\">10</span> <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"shrink <span class=\"token variable\">$&#123;mydisk&#125;</span> ?&lt;Y/n>\"</span> myselect</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;myselect<span class=\"token operator\">,,</span>&#125;</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"n\"</span> <span class=\"token punctuation\">]</span> <span class=\"token punctuation\">;</span><span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token builtin class-name\">continue</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"start wipe <span class=\"token variable\">$&#123;mydisk&#125;</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">sudo</span> /usr/bin/vmware-toolbox-cmd disk wipe <span class=\"token variable\">$&#123;mydisk&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"start shrink <span class=\"token variable\">$&#123;mydisk&#125;</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token function\">sudo</span> /usr/bin/vmware-toolbox-cmd disk shrink <span class=\"token variable\">$&#123;mydisk&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr></table></figure><p><strong>note：</strong></p>\n<p>虚拟机不能有快照，否则会显示：“为该虚拟机禁用了磁盘压缩。”</p>\n",
            "tags": [
                "Ubuntu"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-gitea/",
            "url": "https://arachnid.cc/docker-deployment-of-gitea/",
            "title": "docker 部署之 calibre-web 图书馆藏",
            "date_published": "2024-06-30T17:21:45.000Z",
            "content_html": "<blockquote>\n<p>Version：<a href=\"https://github.com/janeczku/calibre-web/tree/0.6.23\"><strong>Calibre Web</strong></a> 0.6.23</p>\n</blockquote>\n<p><img data-src=\"image-20250621174057431.png\" alt=\"calibre-web login\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>calibre-web 是基于著名开源电子书管理工具 calibre 的 calibre-server 内容服务器提供的接口，开发了 calibre 的 Web 端 calibre-web，并提供了 Docker 安装包，使得 calibre 和 calibre-web 实现本地图书管理和在线访问。</p>\n<p>项目：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2phbmVjemt1L2NhbGlicmUtd2Vi\">https://github.com/janeczku/calibre-web</span></p>\n<p><img data-src=\"image-20250621174024378.png\" alt=\"calibre-web\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>为你的 calibre-web 存放创建数据和配置文件夹：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># $PATH 为你存储盘的路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/calibre/config /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/calibre/book</pre></td></tr></table></figure><p>运行 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> pull ghcr.io/gshang2017/calibre-web:latest</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>calibre-web <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">PUID</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">PGID</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">DOCKER_MODS</span><span class=\"token operator\">=</span>linuxserver/calibre-web:calibre <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8083</span>:8083 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/calibre/config:/config <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">$PATH</span><span class=\"token operator\">></span>/calibre/library:/books <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--restart</span> always <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>  ghcr.io/gshang2017/calibre-web</pre></td></tr></table></figure><h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>浏览器访问  <code>http://localhost:8083</code>  ，这时候默认使用英文，登录界面默认账号  <code>admin</code> ，密码  <code>admin123</code>  ：</p>\n<p><img data-src=\"image-20250615230359751.png\" alt=\"image-20250615230359751\" /></p>\n<h2 id=\"数据库管理\"><a class=\"anchor\" href=\"#数据库管理\">#</a> 数据库管理</h2>\n<p>登入后会看到 Database Configuration 提示，要求指定 calibre 数据库路径：</p>\n<p><img data-src=\"16971183045685.jpg\" alt=\"calibre-web\" /></p>\n<p>实际上就是要找  <code>metadata.db</code>  所在的位置，而在此步骤正确设置完成之前，其他任何操作均无法进行。</p>\n<p>那么  <code>metadata.db</code>  所在何处？  <code>metadata.db</code>  是一个 calibre 客户端上的数据库，因此在 calibre-web 中并不存在，所以要么在电脑上安装了 calibre 的 PC 客户端上，在安装目录中找到  <code>metadata.db</code>  文件；要么就从 calibre-web 项目中下载一个默认的 <a href=\"https://github.com/janeczku/calibre-web/raw/master/library/metadata.db\"> <code>metadata.db</code> </a> 文件；当然，最好还是选择第二种获取空白模板的比较好。</p>\n<h2 id=\"密码修改及语言配置\"><a class=\"anchor\" href=\"#密码修改及语言配置\">#</a> 密码修改及语言配置</h2>\n<p>点击页面右上角  <code>admin</code> ，在  <code>Password</code>  中填入新的密码，然后点击  <code>Language</code>  选择你需要的语言，然后点击  <code>Save</code>  ：</p>\n<p><img data-src=\"image-20250616200451371.png\" alt=\"image-20250616200451371\" /></p>\n<h2 id=\"上传功能\"><a class=\"anchor\" href=\"#上传功能\">#</a> 上传功能</h2>\n<p>点击页面右上角  <code>管理权限</code>  -&gt;  <code>编辑基本配置</code>  -&gt;  <code>功能配置</code>  -&gt;  <code>启用上传</code>  -&gt;  <code>保存</code>  ：</p>\n<p><img data-src=\"image-20250616201224175.png\" alt=\"image-20250616201224175\" /></p>\n<p>上面是开启整个上传功能，并且根据提示还需要确认用户上的上传功能，因此在  <code>管理权限</code>  -&gt;  <code>管理用户</code>  中配置确认，为你所需的账号开启上传：</p>\n<p><img data-src=\"image-20250616201525076.png\" alt=\"image-20250616201525076\" /></p>\n<h2 id=\"格式转换功能\"><a class=\"anchor\" href=\"#格式转换功能\">#</a> 格式转换功能</h2>\n<p>点击页面右上角  <code>管理权限</code>  -&gt;  <code>编辑基本配置</code>  -&gt;  <code>扩展程序配置</code>  ，进行以下修改后点击  <code>保存</code>  ：</p>\n<p>Calibre 电子书转换器路径： <code>/usr/bin/</code></p>\n<p>KEpubify 电子书转换器路径： <code>/usr/local/bin/kepubify</code></p>\n<p><img data-src=\"image-20250616203834590.png\" alt=\"image-20250616203834590\" /></p>\n<p>这个配置是官方给的固定写法，所以不做解释，有兴趣的请翻阅官方文档：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9yZWdpc3RyeS5odWIuZG9ja2VyLmNvbS9yL2xpbnV4c2VydmVyL2NhbGlicmUtd2ViLw==\">https://registry.hub.docker.com/r/linuxserver/calibre-web/</span></p>\n<h1 id=\"安可\"><a class=\"anchor\" href=\"#安可\">#</a> 安可</h1>\n<p>关于 App 客户端，这里使用 “<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dlZG9vci9sZWdhZG8=\">阅读</span>” App：</p>\n<p><img data-src=\"image-20250616225105928.png\" alt=\"image-20250616225105928\" /></p>\n<p>主要功能：</p>\n<ol>\n<li>自定义书源，自己设置规则，抓取网页数据，规则简单易懂，软件内有规则说明。</li>\n<li>列表书架，网格书架自由切换。</li>\n<li>书源规则支持搜索及发现，所有找书看书功能全部自定义，找书更方便。</li>\n<li>订阅内容，可以订阅想看的任何内容，看你想看</li>\n<li>支持替换净化，去除广告替换内容很方便。</li>\n<li>支持本地 TXT、EPUB 阅读，手动浏览，智能扫描。</li>\n<li>支持高度自定义阅读界面，切换字体、颜色、背景、行距、段距、加粗、简繁转换等。</li>\n<li>支持多种翻页模式，覆盖、仿真、滑动、滚动等。</li>\n<li>软件开源，持续优化，无广告。</li>\n</ol>\n<p>然后搭配 webdav 服务，即可链接下载 calibre-web 服务端上面的书籍了。关于如何搭建 webdav 服务，可以参看：<a href=\"https://arachnid.cc/docker-deployment-of-webdav/\">docker 部署之 webdav 文件服务</a> 。</p>\n",
            "tags": [
                "docker"
            ]
        },
        {
            "id": "https://arachnid.cc/docker-deployment-of-portainer/",
            "url": "https://arachnid.cc/docker-deployment-of-portainer/",
            "title": "docker 部署之 portainer 管理面板",
            "date_published": "2024-06-15T12:32:02.000Z",
            "content_html": "<blockquote>\n<p>如果你喜欢敲命令来操作 Docker，那么这点你可以跳过了，否则可以安装 portainer 对 Docker 进行页面管理。</p>\n</blockquote>\n<blockquote>\n<p>Version：<a href=\"https://github.com/eysp/portainer-ce/tree/2.19.5\"><strong>portainer-ce</strong></a> 社区版 2.19.5</p>\n</blockquote>\n<p><img data-src=\"image-20250621173729084.png\" alt=\"portainer login\" /></p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>portainer 管理面板是一个简洁的 dockers 容器可视化操作界面，它把常规的命令操作搬到了显示面板上，提供状态显示面板、应用模板快速部署、容器镜像网络数据卷的基本操作（包括上传下载镜像，创建容器等操作）、事件日志显示、容器控制台操作、Swarm 集群和服务等集中管理和操作、登录用户管理和控制等功能。</p>\n<p>具体介绍可以参看官网：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucG9ydGFpbmVyLmlvLw==\">Kubernetes and Docker Container Management Software</span></p>\n<p><img data-src=\"image-20250621173226937.png\" alt=\"portainer\" /></p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>运行 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 拉取汉化版镜像</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> pull <span class=\"token number\">6053537</span>/portainer-ce:latest</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 启动容器</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--name</span> portainer <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">9000</span>:9000 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /app/portainer_data:/data <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--privileged</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token parameter variable\">--restart</span> always <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>  <span class=\"token number\">6053537</span>/portainer-ce</pre></td></tr></table></figure><p>参数解释：</p>\n<ul>\n<li><code>-d</code>  ：以后台模式运行容器。</li>\n<li><code>--name portainer</code>  ：设置容器的名称为  <code>portainer</code> 。</li>\n<li><code>-p 9000:9000</code>  ：将容器的 9000 端口映射到主机的 9000 端口，使得 portainer 的 Web 界面可以通过主机的端口访问。</li>\n<li><code>-v /var/run/docker.sock:/var/run/docker.sock</code>  和  <code>-v /app/portainer_data:/data</code>  ：将主机  <code>/var/run/</code>  目录下的  <code>docker.sock</code>  和  <code>/app/portainer_data</code>  目录下的  <code>portainer_data</code>  分别映射进容器的  <code>/var/run/docker.sock</code>  和  <code>/data</code>  路径。</li>\n<li><code>--restart always</code>  ：确保容器在退出时自动重启。</li>\n<li><code>6053537/portainer-ce</code> ：指定使用的 Docker 镜像。</li>\n</ul>\n<p>note：在  <code>docker run</code>  执行后面加入  <code>--restart=always</code>  可以使开机后会自动启动面板，否则还要自己手动设备启动。</p>\n<p>最后通过访问  <code>http://localhost:9000</code>  来访问 portainer 的 Web 界面。</p>\n<h1 id=\"使用\"><a class=\"anchor\" href=\"#使用\">#</a> 使用</h1>\n<p>初次访问 portainer 的 Web 界面，会提示你建立一个 admin 的管理账号：</p>\n<p><img data-src=\"994129-20230409002217893-356786116.png\" alt=\"\" /></p>\n<p>并根据向导初始创建环境，这里选择本地环境：</p>\n<p><img data-src=\"cd8b52c8bcb1da00995d18d485af4e02.png\" alt=\"\" /></p>\n<p>完成后你就可以管理你的所有 Docker 容器了：</p>\n<p><img data-src=\"image-20250614120131550.png\" alt=\"image-20250614120131550\" /></p>\n<h1 id=\"安可\"><a class=\"anchor\" href=\"#安可\">#</a> 安可</h1>\n<p>关于 App 客户端，可以使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2xvbGxpcG9wa2l0L2ZsdXR0ZXJfc2VydmVyX2JveA==\">ServerBox</span> 服务器工具箱：</p>\n<ul>\n<li>状态图表（CPU、传感器、GPU 等）, SSH 终端，SFTP, Docker &amp; 进程 &amp; Systemd 管理，S.M.A.R.T ...</li>\n<li>特殊支持：生物认证、推送、桌面小部件、watchOS App、跟随系统颜色 ...</li>\n</ul>\n<p>图示：</p>\n<p><img data-src=\"Screenshot_20250814_204352_ServerBox.jpg\" alt=\"Screenshot_20250814_204352_ServerBox\" /></p>\n<p><img data-src=\"Screenshot_20250814_204705_ServerBox.jpg\" alt=\"Screenshot_20250814_204705_ServerBox\" /></p>\n<p><img data-src=\"Screenshot_20250814_204526_ServerBox.jpg\" alt=\"Screenshot_20250814_204526_ServerBox\" /></p>\n",
            "tags": [
                "docker"
            ]
        },
        {
            "id": "https://arachnid.cc/zlist/",
            "url": "https://arachnid.cc/zlist/",
            "title": "zlist 链表分析",
            "date_published": "2024-06-06T12:51:29.000Z",
            "content_html": "<h1 id=\"数据结构定义\"><a class=\"anchor\" href=\"#数据结构定义\">#</a> 数据结构定义</h1>\n<h2 id=\"比较函数指针\"><a class=\"anchor\" href=\"#比较函数指针\">#</a> 比较函数指针</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">int</span> <span class=\"token punctuation\">(</span>zlist_compare_fn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>item1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>item2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"析构函数指针\"><a class=\"anchor\" href=\"#析构函数指针\">#</a> 析构函数指针</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span>zlist_free_fn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"节点\"><a class=\"anchor\" href=\"#节点\">#</a> 节点</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_node_t</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_node_t</span> <span class=\"token operator\">*</span>next<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 指向下一个节点</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>item<span class=\"token punctuation\">;</span>             <span class=\"token comment\">// 节点当中的元素</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    zlist_free_fn <span class=\"token operator\">*</span>free_fn<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 元素对应的析构函数</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token class-name\">node_t</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"链表\"><a class=\"anchor\" href=\"#链表\">#</a> 链表</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">_zlist_t</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>head<span class=\"token punctuation\">;</span>                   <span class=\"token comment\">// 头节点</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>tail<span class=\"token punctuation\">;</span>                   <span class=\"token comment\">// 尾节点</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>cursor<span class=\"token punctuation\">;</span>                 <span class=\"token comment\">// 当前访问节点</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">size_t</span> size<span class=\"token punctuation\">;</span>                    <span class=\"token comment\">// 元素数量</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    bool autofree<span class=\"token punctuation\">;</span>                  <span class=\"token comment\">// 如果为真，使用默认析构元素，否则使用节点自带的析构</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    zlist_compare_fn <span class=\"token operator\">*</span>compare_fn<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 自定义的比较函数回调，用来比较两个元素</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"函数定义\"><a class=\"anchor\" href=\"#函数定义\">#</a> 函数定义</h1>\n<h2 id=\"创建链表对象\"><a class=\"anchor\" href=\"#创建链表对象\">#</a> 创建链表对象</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* List constructor. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">zlist_new</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token function\">zmalloc</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"销毁链表对象\"><a class=\"anchor\" href=\"#销毁链表对象\">#</a> 销毁链表对象</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* List destructor. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">zlist_destroy</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>self_p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>self_p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>self_p<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>self_p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token function\">zlist_purge</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token function\">freen</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token operator\">*</span>self_p <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"访问链表第一个元素\"><a class=\"anchor\" href=\"#访问链表第一个元素\">#</a> 访问链表第一个元素</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Return the item at the head of list. If the list is empty, returns NULL.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   Leaves cursor pointing at the head item, or NULL if the list is empty. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">zlist_first</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 将游标移动到链首位置</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    self<span class=\"token operator\">-></span>cursor <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// 返回链首元素</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>cursor<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token operator\">-></span>cursor<span class=\"token operator\">-></span>item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"访问链表下一个元素\"><a class=\"anchor\" href=\"#访问链表下一个元素\">#</a> 访问链表下一个元素</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Return the next item. If the list is empty, returns NULL. To move to</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   the start of the list call zlist_first (). Advances the cursor. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">zlist_next</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 将游标移动到下一个，如果是首次访问，那么设置为首节点</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>cursor<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token operator\">-></span>cursor <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>cursor<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        self<span class=\"token operator\">-></span>cursor <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// 如果当前游标非空，那么返回里面的元素</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>cursor<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token operator\">-></span>cursor<span class=\"token operator\">-></span>item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"访问链表最后一个元素\"><a class=\"anchor\" href=\"#访问链表最后一个元素\">#</a> 访问链表最后一个元素</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Return the item at the tail of list. If the list is empty, returns NULL.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   Leaves cursor pointing at the tail item, or NULL if the list is empty. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">zlist_last</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 将游标移动到链尾位置</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    self<span class=\"token operator\">-></span>cursor <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>tail<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// 返回链尾元素</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>cursor<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token operator\">-></span>cursor<span class=\"token operator\">-></span>item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"访问链表当前元素\"><a class=\"anchor\" href=\"#访问链表当前元素\">#</a> 访问链表当前元素</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Return current item in the list. If the list is empty, or the cursor</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   passed the end of the list, returns NULL. Does not change the cursor. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">zlist_item</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 访问当前游标的元素</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>cursor<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token operator\">-></span>cursor<span class=\"token operator\">-></span>item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"添加链尾元素\"><a class=\"anchor\" href=\"#添加链尾元素\">#</a> 添加链尾元素</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Append an item to the end of the list, return 0 if OK or -1 if this</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   failed for some reason. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">zlist_append</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>item<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>item<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// 构造节点</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>node <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token function\">zmalloc</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">node_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// 如果支持自动回收，那么按字符串的形式申请内存并拷贝一份</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>autofree<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        item <span class=\"token operator\">=</span> <span class=\"token function\">strdup</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// 新节点中保存元素</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    node<span class=\"token operator\">-></span>item <span class=\"token operator\">=</span> item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">// 当前链尾与新节点进行链接</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>tail<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        self<span class=\"token operator\">-></span>tail<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// 链尾是空说明是首次操作，链头指向节点</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        self<span class=\"token operator\">-></span>head <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// 新节点设为链尾</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    self<span class=\"token operator\">-></span>tail <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    node<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// 链尾大小 + 1</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    self<span class=\"token operator\">-></span>size<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">// 游标重置为空</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    self<span class=\"token operator\">-></span>cursor <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"添加链首元素\"><a class=\"anchor\" href=\"#添加链首元素\">#</a> 添加链首元素</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Push an item to the start of the list, return 0 if OK or -1 if this</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   failed for some reason. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">zlist_push</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>item<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>item<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>node <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token function\">zmalloc</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">node_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// 如果支持自动回收，那么按字符串的形式申请内存并拷贝一份</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>autofree<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        item <span class=\"token operator\">=</span> <span class=\"token function\">strdup</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    node<span class=\"token operator\">-></span>item <span class=\"token operator\">=</span> item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// 设置新节点的下 1 个节点是链首节点</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    node<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">// 链首属性设置为新节点</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    self<span class=\"token operator\">-></span>head <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// 如果链尾属性是空，说明是首次操作，设置为新节点</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>tail <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        self<span class=\"token operator\">-></span>tail <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    self<span class=\"token operator\">-></span>size<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    self<span class=\"token operator\">-></span>cursor <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"删除链首元素\"><a class=\"anchor\" href=\"#删除链首元素\">#</a> 删除链首元素</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Remove item from the beginning of the list, returns NULL if none. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">zlist_pop</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>node <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>item <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token comment\">// 获得链首元素引用</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        item <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// 链首指向下 1 个节点（这时节点已从链表中删除）</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        self<span class=\"token operator\">-></span>head <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// 若链表里只有 1 个节点，那么链尾也置空</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>tail <span class=\"token operator\">==</span> node<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            self<span class=\"token operator\">-></span>tail <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// 释放已删除的节点</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token function\">freen</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// 链表大小 - 1</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        self<span class=\"token operator\">-></span>size<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">// 当前游标置空</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    self<span class=\"token operator\">-></span>cursor <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// 返回元素</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">return</span> item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"判断元素是否存在\"><a class=\"anchor\" href=\"#判断元素是否存在\">#</a> 判断元素是否存在</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Checks if an item already is present. Uses compare method to determine if</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   items are equal. If the compare method is NULL the check will only compare</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   pointers. Returns true if item is present else false. */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>bool</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">zlist_exists</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>item<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>node <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// 链表有自定义比较函数，那就用它来比较</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>compare_fn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>self<span class=\"token operator\">-></span>compare_fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>item<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// 否则直接用双等号比较</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>item <span class=\"token operator\">==</span> item<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token comment\">// 取下 1 个节点比较</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        node <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"查找并删除元素\"><a class=\"anchor\" href=\"#查找并删除元素\">#</a> 查找并删除元素</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Remove the item from the list, if present. Safe to call on items that</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   are not in the list. */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">zlist_remove</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>item<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>node<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>prev <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// 首先，我们通过遍历把这个节点找到</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span> node <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span> node <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>compare_fn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>self<span class=\"token operator\">-></span>compare_fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>item<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// 找到了就跳出替换</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>item <span class=\"token operator\">==</span> item<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">// 每次保存遍历的节点，当下次找到，这个节点就是前节点</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        prev <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// 将删的节点已找到</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">// 前节点指向节点的下 1 个节点</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prev<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            prev<span class=\"token operator\">-></span>next <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// 这里说明链表只有 1 个节点，链头设置为空</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            self<span class=\"token operator\">-></span>head <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token comment\">// 这里说明节点在链尾</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>next <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token comment\">// 前节点设置成链尾</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            self<span class=\"token operator\">-></span>tail <span class=\"token operator\">=</span> prev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\">// 游标刚好指向节点</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>cursor <span class=\"token operator\">==</span> node<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token comment\">// 游标设置成前节点</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            self<span class=\"token operator\">-></span>cursor <span class=\"token operator\">=</span> prev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token comment\">// 自动删除标志为真</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>autofree<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token comment\">// 释放当前节点的元素的内存空间</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token function\">freen</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token comment\">// 不为真就用节点析构函数（如果有）</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>free_fn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>free_fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token comment\">// 释放节点本身的内存空间</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token function\">freen</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token comment\">// 元素总数减 1</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        self<span class=\"token operator\">-></span>size<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"复制链表对象\"><a class=\"anchor\" href=\"#复制链表对象\">#</a> 复制链表对象</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Make a copy of list. If the list has autofree set, the copied list will</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   duplicate all items, which must be strings. Otherwise, the list will hold</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   pointers back to the items in the original list. If list is null, returns</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   NULL. */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">zlist_dup</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>copy <span class=\"token operator\">=</span> <span class=\"token function\">zlist_new</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>copy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>autofree<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function\">zlist_autofree</span><span class=\"token punctuation\">(</span>copy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    copy<span class=\"token operator\">-></span>compare_fn <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>compare_fn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span> node<span class=\"token punctuation\">;</span> node <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">zlist_append</span> <span class=\"token punctuation\">(</span>copy<span class=\"token punctuation\">,</span> node<span class=\"token operator\">-></span>item<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token function\">zlist_destroy</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>copy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">return</span> copy<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"清理链表所有元素\"><a class=\"anchor\" href=\"#清理链表所有元素\">#</a> 清理链表所有元素</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Purge all items from list. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">zlist_purge</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>node <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>next <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span>autofree<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token function\">freen</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>free_fn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>free_fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function\">freen</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        node <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    self<span class=\"token operator\">-></span>head <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    self<span class=\"token operator\">-></span>tail <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    self<span class=\"token operator\">-></span>cursor <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    self<span class=\"token operator\">-></span>size <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"获得链表大小\"><a class=\"anchor\" href=\"#获得链表大小\">#</a> 获得链表大小</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Return the number of items in the list. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">size_t</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">zlist_size</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> self<span class=\"token operator\">-></span>size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"链表排序\"><a class=\"anchor\" href=\"#链表排序\">#</a> 链表排序</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Sort the list. If the compare function is null, sorts the list by</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   ascending key value using a straight ASCII comparison. If you specify</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   a compare function, this decides how items are sorted. The sort is not</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   stable, so may reorder items with the same keys. The algorithm used is</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   combsort, a compromise between performance and simplicity. */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">zlist_sort</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">,</span> zlist_compare_fn compare_fn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    zlist_compare_fn <span class=\"token operator\">*</span>compare <span class=\"token operator\">=</span> compare_fn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>compare<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        compare <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>compare_fn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>compare<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            compare <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>zlist_compare_fn <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> strcmp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// 梳排序算法:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// 1. 算法从两个游标同时开始遍历</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// 2. 两个游标之间存在间隔 (gap)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// 3. 第 1 个游标是链头，第 2 个游标按间隔计算</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// 4. 两个游标遍历的同时会交换元素</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">// 5. 每一轮至少需要交换 1 次</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">// 6. 间隔每 1 轮按递减率 1.3 进行缩短</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// 7. 当间隔小于等于 1 或者交换 0 次时算法终止</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token class-name\">size_t</span> gap <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    bool swapped <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>gap <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token operator\">||</span> swapped<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>gap <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            gap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span> gap <span class=\"token operator\">/</span> <span class=\"token number\">1.3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>base <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>test <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token class-name\">size_t</span> jump <span class=\"token operator\">=</span> gap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>jump<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            test <span class=\"token operator\">=</span> test<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        swapped <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>base <span class=\"token operator\">&amp;&amp;</span> test<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>compare<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>base<span class=\"token operator\">-></span>item<span class=\"token punctuation\">,</span> test<span class=\"token operator\">-></span>item<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token comment\">// 依据比较函数进行元素交换</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>item <span class=\"token operator\">=</span> base<span class=\"token operator\">-></span>item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                base<span class=\"token operator\">-></span>item <span class=\"token operator\">=</span> test<span class=\"token operator\">-></span>item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                test<span class=\"token operator\">-></span>item <span class=\"token operator\">=</span> item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                swapped <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            base <span class=\"token operator\">=</span> base<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            test <span class=\"token operator\">=</span> test<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"设置比较函数\"><a class=\"anchor\" href=\"#设置比较函数\">#</a> 设置比较函数</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Sets a compare function for this list. The function compares two items.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   It returns an integer less than, equal to, or greater than zero if the</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   first item is found, respectively, to be less than, to match, or be</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   greater than the second item.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   This function is used for sorting, removal and exists checking. */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">zlist_comparefn</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">,</span> zlist_compare_fn fn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    self<span class=\"token operator\">-></span>compare_fn <span class=\"token operator\">=</span> fn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"设置元素销毁函数\"><a class=\"anchor\" href=\"#设置元素销毁函数\">#</a> 设置元素销毁函数</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Set a free function for the specified list item. When the item is</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   destroyed, the free function, if any, is called on that item.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   Use this when list items are dynamically allocated, to ensure that</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   you don't have memory leaks. You can pass 'free' or NULL as a free_fn.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   Returns the item, or NULL if there is no such item. */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">zlist_freefn</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>item<span class=\"token punctuation\">,</span> zlist_free_fn fn<span class=\"token punctuation\">,</span> bool at_tail<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">node_t</span> <span class=\"token operator\">*</span>node <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// 给链尾设置析构函数，这个标志是为了提高算法效率</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>at_tail<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        node <span class=\"token operator\">=</span> self<span class=\"token operator\">-></span>tail<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// 根据元素值遍历找节点并设置析构函数</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token operator\">-></span>item <span class=\"token operator\">==</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            node<span class=\"token operator\">-></span>free_fn <span class=\"token operator\">=</span> fn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">return</span> item<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        node <span class=\"token operator\">=</span> node<span class=\"token operator\">-></span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"设置自动销毁状态\"><a class=\"anchor\" href=\"#设置自动销毁状态\">#</a> 设置自动销毁状态</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Set list for automatic item destruction; item values MUST be strings.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   By default a list item refers to a value held elsewhere. When you set</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   this, each time you append or push a list item, zlist will take a copy</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   of the string value. Then, when you destroy the list, it will free all</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   item values automatically. If you use any other technique to allocate</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   list values, you must free them explicitly before destroying the list.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   The usual technique is to pop list items and destroy them, until the</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   list is empty. */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">void</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">zlist_autofree</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">zlist_t</span> <span class=\"token operator\">*</span>self<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">assert</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    self<span class=\"token operator\">-></span>autofree <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": []
        }
    ]
}