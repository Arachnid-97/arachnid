{
    "version": "https://jsonfeed.org/version/1",
    "title": "命运转轮 • All posts by \"linux\" tag",
    "description": "不曾亏欠, 不曾辜负, 如此足矣",
    "home_page_url": "https://arachnid.cc",
    "items": [
        {
            "id": "https://arachnid.cc/posix-pthread/",
            "url": "https://arachnid.cc/posix-pthread/",
            "title": "POSIX 线程设计应用",
            "date_published": "2024-09-02T13:32:05.844Z",
            "content_html": "<h1 id=\"线程管理\"><a class=\"anchor\" href=\"#线程管理\">#</a> 线程管理</h1>\n<h2 id=\"基本操作\"><a class=\"anchor\" href=\"#基本操作\">#</a> 基本操作</h2>\n<h3 id=\"pthread_create\"><a class=\"anchor\" href=\"#pthread_create\">#</a> pthread_create</h3>\n<p>创建一个线程</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_t</span> <span class=\"token operator\">*</span>restrict thread<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                   <span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                   <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>start_routine<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                   <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>restrict arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>thread --- 返回一个唯一的线程 ID</li>\n<li>attr --- 可以指定线程属性对象，或者以 NULL 为缺省值</li>\n<li>start_routine --- 线程执行函数</li>\n<li>arg --- 为  <code>start_routine</code>  传递的参数，NULL 为缺省值</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EAGAIN --- 资源不足或超出创建线程数，无法创建</li>\n<li>EINVAL --- 无效  <code>attr</code>  参数属性</li>\n<li>EPERM --- 没有权限设置调度策略和  <code>attr</code>  中的参数</li>\n</ul>\n<p>note：当  <code>attr</code>  属性为缺省 NULL 时，此线程默认为  <code>joinable</code>  属性。</p>\n<h3 id=\"pthread_self\"><a class=\"anchor\" href=\"#pthread_self\">#</a> pthread_self</h3>\n<p>获取调用线程的 ID；可以查看一个线程自己的线程 ID，需要知道的是线程也有 ID 的，且具有唯一的线程 ID</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">pthread_t</span> <span class=\"token function\">pthread_self</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Return：</p>\n<ul>\n<li>此函数始终成功，返回调用线程的 ID</li>\n</ul>\n<h3 id=\"pthread_equal\"><a class=\"anchor\" href=\"#pthread_equal\">#</a> pthread_equal</h3>\n<p>比较俩个线程 ID，当线程 ID 相同时返回非 0，不同时返回 0</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_equal</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_t</span> t1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">pthread_t</span> t2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>t1 and t2：线程的 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>nonzero --- 俩线程 ID 相等</li>\n<li>zero --- 俩线程 ID 不同</li>\n</ul>\n<h3 id=\"pthread_join\"><a class=\"anchor\" href=\"#pthread_join\">#</a> pthread_join</h3>\n<p>线程可以是 joinable 或 detached 的。 如果一个线程是 joinable，那么另一个线程可以调用  <code>pthread_join()</code>  等待该线程终止（挂起当前线程，阻塞式等待线程结束，如果线程已结束则立即返回）</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_join</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_t</span> thread<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>retval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>thread --- 需要终止的线程 ID</li>\n<li>retval --- 退出的状态返回值，用于提供给  <code>pthread_exit()</code></li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EDEADLK --- 检测到死锁或自身调用</li>\n<li>EINVAL --- 该线程非 joinable 线程或另一个线程已经在等待加入这个线程</li>\n<li>ESRCH --- 传入的  <code>thread</code>  参数是不存在的线程 ID</li>\n</ul>\n<h3 id=\"pthread_detach\"><a class=\"anchor\" href=\"#pthread_detach\">#</a> pthread_detach</h3>\n<p>用于把 joinable 线程转变为 detached 线程，一旦把 joinable 线程被设置为 detached 的，那么这个线程就不能被  <code>pthread_join()</code>  调用</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_detach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_t</span> thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>thread --- 需要修改的线程 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EINVAL --- 该线程非 joinable 线程</li>\n<li>ESRCH --- 传入的  <code>thread</code>  参数是不存在的线程 ID</li>\n</ul>\n<h3 id=\"pthread_exit\"><a class=\"anchor\" href=\"#pthread_exit\">#</a> pthread_exit</h3>\n<p>终止线程，也就是终止自己的执行</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">pthread_exit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>retval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>retval --- 由  <code>pthread_join()</code>  提供参数，或以 NULL 为缺省值自身调用结束</li>\n</ul>\n<h2 id=\"参数配置\"><a class=\"anchor\" href=\"#参数配置\">#</a> 参数配置</h2>\n<h3 id=\"pthread_attr_t\"><a class=\"anchor\" href=\"#pthread_attr_t\">#</a> pthread_attr_t</h3>\n<p><code>pthread_attr_t</code>  数据类型，以下函数都调用该结构属性：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>       <span class=\"token keyword\">int</span>                       detachstate<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 线程的分离状态</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>       <span class=\"token keyword\">int</span>                       schedpolicy<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 线程的调度策略</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>       structsched_param         schedparam<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 线程的优先级</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>       <span class=\"token keyword\">int</span>                       inheritsched<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 线程的继承性</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>       <span class=\"token keyword\">int</span>                       scope<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// 线程的作用域</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>       <span class=\"token class-name\">size_t</span>                    guardsize<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 线程栈的警戒缓冲区大小</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>       <span class=\"token keyword\">int</span>                       stackaddr_set<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 线程的栈设置</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>       <span class=\"token keyword\">void</span><span class=\"token operator\">*</span>                     stackaddr<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 线程栈的地址</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>       <span class=\"token class-name\">size_t</span>                    stacksize<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 线程栈的大小</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token class-name\">pthread_attr_t</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>\n<p>detachstate：表示新线程是否与进程中其他线程脱离同步， 如果设置为  <code>PTHREAD_CREATE_DETACHED</code>  则新线程不能用  <code>pthread_join()</code>  来同步，且在退出时自行释放所占用的资源；缺省为  <code>PTHREAD_CREATE_JOINABLE</code>  状态。</p>\n<p>这个属性也可以在线程创建并运行以后用  <code>pthread_detach()</code>  来设置，而一旦设置为  <code>PTHREAD_CREATE_DETACH</code>  状态（不论是创建时设置还是运行时设置）则不能再恢复到  <code>PTHREAD_CREATE_JOINABLE</code>  状态。</p>\n</li>\n<li>\n<p>schedpolicy：表示新线程的调度策略，主要包括  <code>SCHED_OTHER</code> （正常、非实时）、 <code>SCHED_RR</code> （实时、轮转法）和  <code>SCHED_FIFO</code> （实时、先入先出）三种，缺省为  <code>SCHED_OTHER</code> ，后两种调度策略仅对超级用户有效；运行时可以用过  <code>pthread_setschedparam()</code>  来改变。</p>\n</li>\n<li>\n<p>schedparam：一个  <code>struct sched_param</code>  结构，目前仅有一个  <code>sched_priority</code>  整型变量表示线程的运行优先级。这个参数仅当调度策略为实时（即  <code>SCHED_RR</code>  或  <code>SCHED_FIFO</code>  ）时才有效，并可以在运行时通过  <code>pthread_setschedparam()</code>  函数来改变，缺省为 0。</p>\n</li>\n<li>\n<p>inheritsched：有两种值可供选择： <code>PTHREAD_EXPLICIT_SCHED</code>  和  <code>PTHREAD_INHERIT_SCHED</code>  ，前者表示新线程使用显式指定调度策略和调度参数（即由  <code>schedpolicy</code>  和  <code>schedparam</code>  属性确定），而后者表示继承调用者线程的调度策略和调度参数。缺省为  <code>PTHREAD_EXPLICIT_SCHED</code>  。</p>\n</li>\n<li>\n<p>scope：表示线程间竞争 CPU 的范围，也就是说线程优先级的有效范围。POSIX 的标准中定义了两个值： <code>PTHREAD_SCOPE_SYSTEM</code>  和  <code>PTHREAD_SCOPE_PROCESS</code>  ，前者表示与系统中所有线程一起竞争资源（CPU 等），后者表示仅与同一进程中的线程竞争资源（CPU 等）。目前 LinuxThreads 仅实现了  <code>PTHREAD_SCOPE_SYSTEM</code>  值。</p>\n</li>\n<li>\n<p>guardsize：控制着线程栈保护区大小，以避免栈溢出，默认设置为系统的页大小。</p>\n<p>可以把  <code>guardsize</code>  线程属性设为 0，从而不允许属性的这种特征行为发生：在这种情况下不会提供警戒缓存区。同样地，如果对线程属性  <code>stackaddr</code>  作了修改，系统就会假设我们会自己管理栈，并使警戒栈缓冲区机制无效，等同于把  <code>guardsize</code>  线程属性设为 0。</p>\n<p>如果  <code>guardsize</code>  大于零，则会为每个使用 attr 创建的线程提供大小至少为  <code>guardsize</code>  字节的溢出保护区。</p>\n</li>\n<li>\n<p>stackaddr_set：</p>\n</li>\n<li>\n<p>stackaddr：该属性设置新线程所用栈的栈地址。</p>\n</li>\n<li>\n<p>stacksize：该属性设置新线程所用栈的栈大小。</p>\n</li>\n</ul>\n<h3 id=\"pthread_attr_init\"><a class=\"anchor\" href=\"#pthread_attr_init\">#</a> pthread_attr_init</h3>\n<p>线程属性初始化</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pthread_attr_destroy\"><a class=\"anchor\" href=\"#pthread_attr_destroy\">#</a> pthread_attr_destroy</h3>\n<p>销毁线程属性对象</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_destroy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的分离状态\"><a class=\"anchor\" href=\"#设置-获取线程的分离状态\">#</a> 设置 / 获取线程的分离状态</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// detachstate：PTHREAD_CREATE_DETACHED or PTHREAD_CREATE_JOINABLE</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setdetachstate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                <span class=\"token keyword\">int</span> detachstate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getdetachstate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>detachstate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的调度策略\"><a class=\"anchor\" href=\"#设置-获取线程的调度策略\">#</a> 设置 / 获取线程的调度策略</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// policy：SCHED_FIFO, SCHED_RR or SCHED_OTHER</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setschedpolicy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                <span class=\"token keyword\">int</span> policy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getschedpolicy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>restrict policy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的优先级\"><a class=\"anchor\" href=\"#设置-获取线程的优先级\">#</a> 设置 / 获取线程的优先级</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setschedparam</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                               <span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sched_param</span> <span class=\"token operator\">*</span>restrict param<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getschedparam</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                               <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sched_param</span> <span class=\"token operator\">*</span>restrict param<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>所用系统支持的优先级最大最小值可以使用如下函数查询：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sched.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sched_get_priority_max</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> policy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sched_get_priority_min</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> policy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>note：</strong></p>\n<p>该属性值仅当调度策略为实时（即 SCHED_RR 或 SCHED_FIFO ）时才有效，因此一般使用以下函数设置优先级：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sched_param</span> sched<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>sched<span class=\"token punctuation\">.</span>sched_priority <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">pthread_t</span> pidtake<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>pidtake<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> thread_take<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">pthread_setschedparam</span><span class=\"token punctuation\">(</span>pidtake<span class=\"token punctuation\">,</span> SCHED_RR<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>sched<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的继承性\"><a class=\"anchor\" href=\"#设置-获取线程的继承性\">#</a> 设置 / 获取线程的继承性</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// inheritsched：PTHREAD_INHERIT_SCHED or PTHREAD_EXPLICIT_SCHED</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setinheritsched</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                 <span class=\"token keyword\">int</span> inheritsched<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getinheritsched</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                 <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>restrict inheritsched<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的作用域\"><a class=\"anchor\" href=\"#设置-获取线程的作用域\">#</a> 设置 / 获取线程的作用域</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// scope：PTHREAD_SCOPE_SYSTEM or PTHREAD_SCOPE_PROCESS</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setscope</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                          <span class=\"token keyword\">int</span> scope<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getscope</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                          <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>restrict scope<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程栈保护区大小\"><a class=\"anchor\" href=\"#设置-获取线程栈保护区大小\">#</a> 设置 / 获取线程栈保护区大小</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setguardsize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                              <span class=\"token class-name\">size_t</span> guardsize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getguardsize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                              <span class=\"token class-name\">size_t</span> <span class=\"token operator\">*</span>restrict guardsize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的内存区域\"><a class=\"anchor\" href=\"#设置-获取线程的内存区域\">#</a> 设置 / 获取线程的内存区域</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setstackaddr</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                              <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>stackaddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getstackaddr</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                              <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>restrict stackaddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"设置-获取线程的栈大小\"><a class=\"anchor\" href=\"#设置-获取线程的栈大小\">#</a> 设置 / 获取线程的栈大小</h3>\n<p>该属性值设置及获取由如下两个函数进行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_setstacksize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                              <span class=\"token class-name\">size_t</span> stacksize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_attr_getstacksize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_attr_t</span> <span class=\"token operator\">*</span>restrict attr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                              <span class=\"token class-name\">size_t</span> <span class=\"token operator\">*</span>restrict stacksize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"信号量\"><a class=\"anchor\" href=\"#信号量\">#</a> 信号量</h1>\n<h2 id=\"sem_init\"><a class=\"anchor\" href=\"#sem_init\">#</a> sem_init</h2>\n<p>初始化一个匿名信号量</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> pshared<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>sem --- 返回一个信号量</li>\n<li>pshared --- 为 0 表示该信号量在某个进程中的多个线程之间共享，该信号量应当能够被所有的线程访问，例如是一个全局变量或者是在堆上动态分配的变量；若不为 0 ，表示在进程间共享，那么该信号量应该位于共享内存的区域中</li>\n<li>value --- 指定信号量的初始值</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero（-1） --- error</li>\n</ul>\n<h2 id=\"sem_wait-sem_trywait-sem_timedwait\"><a class=\"anchor\" href=\"#sem_wait-sem_trywait-sem_timedwait\">#</a> sem_wait / sem_trywait / sem_timedwait</h2>\n<p>锁定给定的信号量</p>\n<p>对于  <code>sem_wait</code>  ，如果信号量的值  <code>sval</code>  大于 0 ， <code>sem_wait</code>  会对  <code>sval</code>  减 1 ，函数立即返回。如果  <code>sval</code>  为 0 ， <code>sem_wait</code>  将阻塞调用者（某个进程或线程），直到  <code>sval</code>  重新大于 0 或者调用者被 Linux 系统中的系统调用  <code>signal()</code>  函数中断 。</p>\n<p>对于  <code>sem_trywait</code>  ，如果对  <code>sval</code>  的减 1 操作不能完成， <code>sem_trywait</code>  不会阻塞调用者，而是返回一个  <code>error</code> ，并设置  <code>errno</code>  为  <code>EAGAIN</code>  。</p>\n<p>对于  <code>sem_timedwait</code>  ，如果  <code>sval</code>  为 0，则阻塞等待，当阻塞时长超过  <code>abs_timeout</code>  返回失败（  <code>errno</code>  设置为  <code>ETIMEDOUT</code>  ） 。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">timespec</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">time_t</span> tv_sec<span class=\"token punctuation\">;</span>      <span class=\"token comment\">/* Seconds */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">long</span>   tv_nsec<span class=\"token punctuation\">;</span>     <span class=\"token comment\">/* Nanoseconds [0 .. 999999999] */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_wait</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_trywait</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_timedwait</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>restrict sem<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                  <span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">timespec</span> <span class=\"token operator\">*</span>restrict abs_timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>sem --- 需加锁的信号量</li>\n<li>abs_timeout ---  <code>struct timespec</code>  结构的超时时间值</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero（-1） --- error</li>\n</ul>\n<h2 id=\"sem_post\"><a class=\"anchor\" href=\"#sem_post\">#</a> sem_post</h2>\n<p>释放给定的信号量，对信号量的值  <code>sem_val</code>  进行加 1 操作，如果该信号量的值最终大于 0 ，则唤醒被  <code>semwait()</code>  阻塞的另一个进程或线程，并重新锁定该信号量</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_post</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>sem --- 需解锁的信号量</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero（-1） --- error</li>\n</ul>\n<h2 id=\"sem_getvalue\"><a class=\"anchor\" href=\"#sem_getvalue\">#</a> sem_getvalue</h2>\n<p>获取给定信号量的值</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_getvalue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>restrict sem<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>restrict sval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>sem --- 需获取的信号量</li>\n<li>sval --- 返回的当前信号量的值</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero（-1） --- error</li>\n</ul>\n<h2 id=\"sem_destroy\"><a class=\"anchor\" href=\"#sem_destroy\">#</a> sem_destroy</h2>\n<p>销毁一个匿名信号量</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">sem_destroy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>sem --- 需销毁的信号量</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero（-1） --- error</li>\n</ul>\n<h1 id=\"互斥锁\"><a class=\"anchor\" href=\"#互斥锁\">#</a> 互斥锁</h1>\n<p>在多线程编程中，引入了对象互斥锁的概念，来保证共享数据操作的完整性。 每个对象都对应于一个可称为 &quot;互斥锁&quot; 的标记，这个标记用来保证在任一时刻， 只能有一个线程访问该对象。<strong>互斥锁也可以叫线程锁</strong>。</p>\n<h2 id=\"基本操作-2\"><a class=\"anchor\" href=\"#基本操作-2\">#</a> 基本操作</h2>\n<h3 id=\"pthread_mutex_initializer\"><a class=\"anchor\" href=\"#pthread_mutex_initializer\">#</a> PTHREAD_MUTEX_INITIALIZER</h3>\n<p>静态初始化互斥锁</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PTHREAD_MUTEX_INITIALIZER</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token expression\"><span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></span></span></pre></td></tr></table></figure><p>eg：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">pthread_mutex_t</span> s_mutex <span class=\"token operator\">=</span> PTHREAD_MUTEX_INITIALIZER<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pthread_mutex_init\"><a class=\"anchor\" href=\"#pthread_mutex_init\">#</a> pthread_mutex_init</h3>\n<p>动态初始化互斥锁</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutex_init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutex_t</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                       <span class=\"token keyword\">const</span> <span class=\"token class-name\">pthread_mutexattr_t</span> <span class=\"token operator\">*</span>mutexattr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>mutex --- 返回一个唯一的互斥锁 ID</li>\n<li>mutexattr --- 可以指定互斥锁属性对象，或者以 NULL 为缺省值</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- 此函数始终成功</li>\n</ul>\n<h3 id=\"pthread_mutex_lock\"><a class=\"anchor\" href=\"#pthread_mutex_lock\">#</a> pthread_mutex_lock</h3>\n<p>锁定给定的互斥锁，阻塞调用。如果这个互斥锁此时正在被其它线程占用， 那么  <code>pthread_mutex_lock()</code>  调用会进入到这个互斥锁的等待队列中，并会进入阻塞状态， 直到拿到该锁之后才会返回。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutex_t</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>mutex --- 需加锁的互斥锁 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EINVAL --- 未正确初始化</li>\n<li>EDEADLK --- 互斥锁已经被调用线程锁定（仅  <code>PTHREAD_MUTEX_ERRORCHECK</code>  类型互斥锁）</li>\n</ul>\n<h3 id=\"pthread_mutex_trylock\"><a class=\"anchor\" href=\"#pthread_mutex_trylock\">#</a> pthread_mutex_trylock</h3>\n<p>锁定给定的互斥锁，<strong>非</strong>阻塞调用。当请求的锁正在被占用的时候， 不会进入阻塞状态，而是立刻返回，并返回一个错误代码  <code>EBUSY</code> ，意思是说， 有其它线程正在使用这个锁。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutex_trylock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutex_t</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>mutex --- 需加锁的互斥锁 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>\n<p>EBUSY --- 互斥锁无法获取，因为目前已被锁定占用</p>\n</li>\n<li>\n<p>EINVAL --- 未正确初始化</p>\n</li>\n</ul>\n<h3 id=\"pthread_mutex_unlock\"><a class=\"anchor\" href=\"#pthread_mutex_unlock\">#</a> pthread_mutex_unlock</h3>\n<p>释放给定的互斥锁</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutex_t</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>mutex --- 需解锁的互斥锁 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EINVAL --- 未正确初始化</li>\n<li>EPERM --- 调用线程未拥有互斥锁（仅  <code>PTHREAD_MUTEX_ERRORCHECK</code>  类型互斥锁）</li>\n</ul>\n<h3 id=\"pthread_mutex_destroy\"><a class=\"anchor\" href=\"#pthread_mutex_destroy\">#</a> pthread_mutex_destroy</h3>\n<p>销毁由  <code>pthread_mutex_init</code>  动态初始化的互斥锁，释放它可能持有的资源</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutex_destroy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutex_t</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Parameter：</p>\n<ul>\n<li>mutex --- 需销毁的互斥锁 ID</li>\n</ul>\n<p>Return：</p>\n<ul>\n<li>zero --- success</li>\n<li>nonzero --- error code on Errors</li>\n</ul>\n<p>Errors：</p>\n<ul>\n<li>EBUSY --- 互斥锁目前已被锁定占用，无法进行销毁</li>\n</ul>\n<h2 id=\"参数配置-2\"><a class=\"anchor\" href=\"#参数配置-2\">#</a> 参数配置</h2>\n<h3 id=\"pthread_mutexattr_t\"><a class=\"anchor\" href=\"#pthread_mutexattr_t\">#</a> pthread_mutexattr_t</h3>\n<p><code>pthread_mutexattr_t</code>  数据类型，以下函数都调用该结构属性：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Data structures for mutex handling.  The structure of the attribute</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   type is not exposed on purpose.  */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">__pthread_mutex_s</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">int</span> __lock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> __count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">int</span> __owner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">__WORDSIZE <span class=\"token operator\">==</span> <span class=\"token number\">64</span></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> __nusers<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">/* KIND must stay at this position in the structure to maintain</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>           binary compatibility.  */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">int</span> __kind<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">__WORDSIZE <span class=\"token operator\">==</span> <span class=\"token number\">64</span></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">int</span> __spins<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        __pthread_list_t __list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__PTHREAD_MUTEX_HAVE_PREV</span>  <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> __nusers<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        __extension__ <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">int</span> __spins<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            __pthread_slist_t __list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> __data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">char</span> __size<span class=\"token punctuation\">[</span>__SIZEOF_PTHREAD_MUTEX_T<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token keyword\">int</span> __align<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token class-name\">pthread_mutex_t</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pthread_mutexattr_init\"><a class=\"anchor\" href=\"#pthread_mutexattr_init\">#</a> pthread_mutexattr_init</h3>\n<p>互斥锁属性初始化</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutexattr_init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutexattr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pthread_mutexattr_destroy\"><a class=\"anchor\" href=\"#pthread_mutexattr_destroy\">#</a> pthread_mutexattr_destroy</h3>\n<p>销毁互斥锁属性对象</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutexattr_destroy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutexattr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"pthread_mutexattr_settype\"><a class=\"anchor\" href=\"#pthread_mutexattr_settype\">#</a> pthread_mutexattr_settype</h3>\n<p>设置互斥锁类型属性</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;pthread.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">pthread_mutexattr_settype</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">pthread_mutexattr_t</span> <span class=\"token operator\">*</span>attr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>如果互斥锁类型为  <code>PTHREAD_MUTEX_NORMAL</code> ，则不提供死锁检测。尝试重新锁定互斥锁会导致死锁。如果某个线程尝试解除锁定的互斥锁不是由该线程锁定或未锁定，则将产生不确定的行为。</p>\n<p>如果互斥锁类型为  <code>PTHREAD_MUTEX_ERRORCHECK</code> ，则会提供错误检查。如果某个线程尝试重新锁定的互斥锁已经由该线程锁定，则将返回错误。如果某个线程尝试解除锁定的互斥锁不是由该线程锁定或者未锁定，则将返回错误。</p>\n<p>如果互斥锁类型为  <code>PTHREAD_MUTEX_RECURSIVE</code> ，则该互斥锁会保留锁定计数这一概念。线程首次成功获取互斥锁时，锁定计数会设置为 1。线程每重新锁定该互斥锁一次，锁定计数就增加 1。线程每解除锁定该互斥锁一次，锁定计数就减小 1。 锁定计数达到 0 时，该互斥锁即可供其他线程获取。如果某个线程尝试解除锁定的互斥锁不是由该线程锁定或者未锁定，则将返回错误。</p>\n<p>如果互斥锁类型是  <code>PTHREAD_MUTEX_DEFAULT</code> ，则尝试以递归方式锁定该互斥锁将产生不确定的行为。对于不是由调用线程锁定的互斥锁，如果尝试解除对它的锁定，则会产生不确定的行为。如果尝试解除锁定尚未锁定的互斥锁，则会产生不确定的行为。</p>\n<h1 id=\"条件变量\"><a class=\"anchor\" href=\"#条件变量\">#</a> 条件变量</h1>\n<h1 id=\"读写锁\"><a class=\"anchor\" href=\"#读写锁\">#</a> 读写锁</h1>\n<h1 id=\"自旋锁\"><a class=\"anchor\" href=\"#自旋锁\">#</a> 自旋锁</h1>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/linux-device-common-operation/",
            "url": "https://arachnid.cc/linux-device-common-operation/",
            "title": "Linux 设备常用操作",
            "date_published": "2024-09-01T06:18:07.000Z",
            "content_html": "<h1 id=\"串口测试\"><a class=\"anchor\" href=\"#串口测试\">#</a> 串口测试</h1>\n<p>1、获取串口号</p>\n<p>一般串口都是以  <code>/dev/ttyS#</code>  的格式显示，所以第一个连接的串口就是  <code>/dev/ttyS0</code> ，第二个连接的串口就是  <code>/dev/ttyS1</code>  … 以此类推。</p>\n<p>USB 转串口适配，没有额外驱动，它们会显示为  <code>/dev/ttyUSB#</code> ，如  <code>/dev/ttyUSB0</code>  。</p>\n<p>可以通过如下命令获取：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> /dev/ttyS*</pre></td></tr></table></figure><p>note：</p>\n<p>一般来说，通过  <code>ls -l /dev/ttyS*</code>  获取出来的串口是包含虚拟串口和存在但未连接的串口，这时候可以通过  <code>cat /proc/tty/driver/serial</code>  来获取真实连接的串口，或者使用  <code>dmesg | grep ttyS*</code>  来查看， eg：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@debian:/<span class=\"token comment\"># ls -l /dev/ttyS*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>crw-rw---- <span class=\"token number\">1</span> root dialout <span class=\"token number\">4</span>, <span class=\"token number\">64</span> Oct <span class=\"token number\">25</span> <span class=\"token number\">19</span>:29 /dev/ttyS0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>crw-rw---- <span class=\"token number\">1</span> root dialout <span class=\"token number\">4</span>, <span class=\"token number\">65</span> Oct <span class=\"token number\">25</span> <span class=\"token number\">19</span>:29 /dev/ttyS1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>crw-rw---- <span class=\"token number\">1</span> root dialout <span class=\"token number\">4</span>, <span class=\"token number\">66</span> Oct <span class=\"token number\">25</span> <span class=\"token number\">19</span>:29 /dev/ttyS2</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>crw-rw---- <span class=\"token number\">1</span> root dialout <span class=\"token number\">4</span>, <span class=\"token number\">67</span> Oct <span class=\"token number\">25</span> <span class=\"token number\">19</span>:29 /dev/ttyS3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>root@debian:/<span class=\"token comment\"># cat /proc/tty/driver/serial</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>serinfo:1.0 driver revision:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">0</span>: uart:16550A port:000003F8 irq:4 tx:0 rx:0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">1</span>: uart:unknown port:000002F8 irq:3</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">2</span>: uart:unknown port:000003E8 irq:4</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">3</span>: uart:unknown port:000002E8 irq:3</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>root@debian:/<span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>root@debian:/<span class=\"token comment\"># dmesg | grep ttyS*</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>    <span class=\"token number\">0.095756</span><span class=\"token punctuation\">]</span> printk: console <span class=\"token punctuation\">[</span>tty0<span class=\"token punctuation\">]</span> enabled</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>    <span class=\"token number\">2.520985</span><span class=\"token punctuation\">]</span> 00:01: ttyS0 at I/O 0x3f8 <span class=\"token punctuation\">(</span>irq <span class=\"token operator\">=</span> <span class=\"token number\">4</span>, base_baud <span class=\"token operator\">=</span> <span class=\"token number\">115200</span><span class=\"token punctuation\">)</span> is a 16550A</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>   <span class=\"token number\">11.074576</span><span class=\"token punctuation\">]</span> systemd<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>: Created slice system-getty.slice.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>root@debian:/<span class=\"token comment\">#</span></pre></td></tr></table></figure><p>串口 0 的 uart 值时 16550A，tx 值为 0，rx 值也为 0，因此我们断定本机只有一个串口，是串口 0，即 ttyS0。</p>\n<p>2、配置属性</p>\n<p>使用  <code>stty</code>  命令来更改配置串口属性（详情查看  <code>man stty</code> ），比如我们设置串口  <code>/dev/ttyS0</code>  波特率为  <code>115200</code>  和  <code>odd parity</code> ，命令如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>stty <span class=\"token parameter variable\">-F</span> /dev/ttyS0 <span class=\"token number\">115200</span> parodd</pre></td></tr></table></figure><p>3、读写操作</p>\n<p>使用  <code>echo</code>  向串口发送数据，如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">echo</span> “command” <span class=\"token operator\">></span> /dev/ttyS0</pre></td></tr></table></figure><p>利用  <code>cat</code>  来监听串口中的数据，如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> /dev/ttyS0</pre></td></tr></table></figure><p>监听数据并保存到 txt 文本中，如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> /dev/ttyS0 <span class=\"token operator\">></span> file.txt</pre></td></tr></table></figure><p>note：接受信息的时候，对方发送需要加入换行符才能真正收到，否则只是存在接收缓冲区中而并未显示。</p>\n<h1 id=\"can-测试\"><a class=\"anchor\" href=\"#can-测试\">#</a> CAN 测试</h1>\n<p>1、获取 CAN 设备</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> a</pre></td></tr></table></figure><p>通常 CAN 设备以  <code>can#</code>  的格式显示，eg： <code>can0</code>  。</p>\n<p>2、配置属性</p>\n<p>使用  <code>ip link set</code>  对 CAN 设备进行配置，这里设置  <code>can0</code>  波特率为  <code>500Kbps</code>  ，自动重启时间为  <code>10ms</code>  ，其中  <code>up</code>  表示打开该端口。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token function\">link</span> <span class=\"token builtin class-name\">set</span> can0 up <span class=\"token builtin class-name\">type</span> can bitrate <span class=\"token number\">500000</span> restart-ms <span class=\"token number\">10</span></pre></td></tr></table></figure><p>常见可选：</p>\n<p><code>triple-sampling on</code>  ：表示打开 3 次采样，在较低波特率下，建议使用该参数。 如果波特率较高，例如高达到 500Kbps 以上，建议将其关闭。</p>\n<p><code>restart-ms</code>  ：自动重启的频率。</p>\n<p>note：</p>\n<p>使用  <code>ip -details link show can#</code>  可以获取详细的参数。</p>\n<p>3、读写操作</p>\n<p>使用  <code>cansend</code>  发送数据，如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cansend can0 <span class=\"token number\">123</span><span class=\"token comment\">#1122334455667788</span></pre></td></tr></table></figure><p>其中， <code>can0</code>  表示要使用的 CAN 接口， <code>123</code>  表示 CAN ID， <code>#</code>  后面的数字表示发送的数据，这里是 16 进制格式的数据。</p>\n<p>利用  <code>candump</code>  来监听 CAN 总线上的数据，如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>candump can0</pre></td></tr></table></figure><p>4、自动使能 CAN 总线</p>\n<p>Linux 上 CAN 总线接口总是以网络设备形式呈现的，默认系统启动时 CAN 总线处于 down 模式，需要手动使用  <code>ip</code>  命令等配置并使能  <code>up</code>  。但也可以使用系统 network 的 interfaces 文件来实现 CAN 总线自动化配置和激活：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>auto can0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>iface can0 inet manual</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        pre-up /sbin/ip link set $IFACE type can bitrate 500000 restart-ms 10</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        up /sbin/ip link set $IFACE up</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        down /sbin/ip link set $IFACE down</pre></td></tr></table></figure><h1 id=\"无线连接\"><a class=\"anchor\" href=\"#无线连接\">#</a> 无线连接</h1>\n<p>1、获取无线网卡</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iw dev</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># or</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">ip</span> a</pre></td></tr></table></figure><p>通常无线设备名字以  <code>wl#</code>  开头的格式显示，eg： <code>wlan0</code>  。</p>\n<p>2、检查网卡状态</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token function\">link</span> show wlan0</pre></td></tr></table></figure><p>如果在 &lt;&gt; 中没有  <code>UP</code>  的字样，表示网卡没有激活；可以尝试启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token function\">link</span> <span class=\"token builtin class-name\">set</span> wlan0 up</pre></td></tr></table></figure><p>3、检查无线连接状态</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iw wlan0 <span class=\"token function\">link</span></pre></td></tr></table></figure><p>如果没有连接会显示  <code>Not connected</code>  。</p>\n<p>4、扫描可连接的无线网络</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iw wlan0 scan <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> SSID</pre></td></tr></table></figure><p>找到你需要的连接的无线网络名  <code>&lt;wifi_name&gt;</code>  。</p>\n<p>5、无线连接</p>\n<p>一般有两种连接方式：</p>\n<ul>\n<li>\n<p>对于没有密码的连接最为简单，直接连接即可：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iw dev wlan0 connect <span class=\"token operator\">&lt;</span>wifi_name<span class=\"token operator\">></span></pre></td></tr></table></figure></li>\n<li>\n<p>而如果网络是有密码，使用的是 WPA 或 WPA2 协议的话，连接就稍微复杂点，需要用到  <code>wpa_supplicant</code>  工具：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># &lt;wifi_name> 即需要连接的无线网络名</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># &lt;password> 即 WPA 或 WPA2 协议的验证密码</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>wpa_supplicant <span class=\"token parameter variable\">-B</span> <span class=\"token parameter variable\">-i</span> wlan0 -c<span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span>wpa_passphrase <span class=\"token string\">\"&lt;wifi_name>\"</span> <span class=\"token string\">\"&lt;password>\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure></li>\n</ul>\n<p>6、为无线网卡分配 IP 地址</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>dhclient wlan0</pre></td></tr></table></figure><p>note：</p>\n<p>如果之前为该网卡分配过 IP，可能会出现错误，只需要把 dhclient 信息后面 () 里的进程杀掉，再重新执行即可。</p>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/linux_c-exit-and-return/",
            "url": "https://arachnid.cc/linux_c-exit-and-return/",
            "title": "Linux c exit 与 return 区别",
            "date_published": "2024-07-07T09:14:39.000Z",
            "content_html": "<h1 id=\"功能\"><a class=\"anchor\" href=\"#功能\">#</a> 功能</h1>\n<ul>\n<li>_exit () ：退出程序。</li>\n<li>exit（0）：运行正常退出程序；</li>\n<li>exit（1）：运行异常退出程序；</li>\n<li>return（）：返回函数，若在主函数中，则会退出函数并返回值。</li>\n</ul>\n<h1 id=\"_exit-和-exit-区别\"><a class=\"anchor\" href=\"#_exit-和-exit-区别\">#</a> _exit () 和 exit () 区别</h1>\n<ul>\n<li>\n<p>exit () 会将缓冲区的数据写完再结束进程到内核中去（退出进程会清理 I/O 缓冲区）。</p>\n</li>\n<li>\n<p>_exit () 直接结束进程进入到内核中。</p>\n</li>\n<li>\n<p>exit () 函数定义在 stdlib.h 中，_exit () 定义在 unistd.h 中。</p>\n</li>\n<li>\n<p>图示：</p>\n<p><img data-src=\"91748e224d81a92ab21cf272b5244e21.png\" alt=\"img\" /></p>\n</li>\n</ul>\n<p>示例：</p>\n<p><strong>_exit()</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OK\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">_exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>输出结果：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hello</pre></td></tr></table></figure><p><strong>exit()</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OK\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>输出结果：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hello</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>OK</pre></td></tr></table></figure><p><strong>原因：</strong></p>\n<p>printf 函数使用的是缓冲 I/O 的方式，该函数在遇到  <code>\\n</code>  换行符时自动的从缓冲区中将记录读出。</p>\n<p>exit () 将缓冲区的数据写完后才能退出来，所以调用 exit () 函数后程序并不会马上退出，会把 OK 也输出出来。</p>\n<p>_exit () 是直接退出进入到内核中了。</p>\n<h1 id=\"exit0-和-exit1-区别\"><a class=\"anchor\" href=\"#exit0-和-exit1-区别\">#</a> exit (0) 和 exit (1) 区别</h1>\n<ul>\n<li>exit (0)：运行正常退出程序。</li>\n<li>exit (1)：运行异常退出程序，返回值 1 是返回给操作系统的。</li>\n</ul>\n<h1 id=\"return-和-exit-区别\"><a class=\"anchor\" href=\"#return-和-exit-区别\">#</a> return 和 exit () 区别</h1>\n<ul>\n<li>return 是关键字；exit () 是函数。</li>\n<li>return 是语言级别的，表示调用堆栈的返回；而 exit () 是系统调用级别的，表示进程的结束。</li>\n<li>return 是退出（返回）函数，将控制权移交给递归的前一级；exit () 是直接退出进程。</li>\n<li>在最初调用的 main 函数中调用 return 和 exit 的现象很模糊，非主函数中调用 return 和 exit 效果很明显。</li>\n</ul>\n",
            "tags": [
                "Linux",
                "linux_c"
            ]
        },
        {
            "id": "https://arachnid.cc/net-tools-vs-proute2/",
            "url": "https://arachnid.cc/net-tools-vs-proute2/",
            "title": "Linux 网络管理套件",
            "date_published": "2024-03-19T11:51:15.783Z",
            "content_html": "<h1 id=\"简述\"><a class=\"anchor\" href=\"#简述\">#</a> 简述</h1>\n<ul>\n<li>\n<p>net-tools 起源于 BSD 的 TCP/IP 工具箱，后来成为老版本 Linux 内核中配置网络功能的工具。但自 2001 年起，Linux 社区已经对其停止维护，甚至一些 Linux 发行版比如 Arch Linux 和 CentOS/RHEL 7 则已经完全抛弃了 net-tools，只支持 iproute2。</p>\n</li>\n<li>\n<p>iproute2 的出现旨在从功能上取代 net-tools，是目前主流 Linux 所配带的网络套件，同时提供 net-tools 下 ifconfig 和 route 命令所不具备的高级特性。</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>net-tools</th>\n<th>iproute2</th>\n<th>note</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ifconfig</td>\n<td>ip link</td>\n<td>Listing interfaces</td>\n</tr>\n<tr>\n<td>ifconfig -a</td>\n<td>ip addr</td>\n<td>Show addresses</td>\n</tr>\n<tr>\n<td>route</td>\n<td>ip route</td>\n<td>Routing tables</td>\n</tr>\n<tr>\n<td>arp</td>\n<td>ip neigh</td>\n<td>Neighbors</td>\n</tr>\n<tr>\n<td>iptunnel</td>\n<td>ip tunnel</td>\n<td>Tunnels</td>\n</tr>\n<tr>\n<td>nameif, ifrename</td>\n<td>ip link set name</td>\n<td>Rename network interfaces</td>\n</tr>\n<tr>\n<td>ipmaddr</td>\n<td>ip maddr</td>\n<td>Multicast</td>\n</tr>\n<tr>\n<td>netstat</td>\n<td>ss</td>\n<td>Show various networking statistics</td>\n</tr>\n<tr>\n<td>brctl</td>\n<td>bridge</td>\n<td>Handle bridge addresses and devices</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"基本对照\"><a class=\"anchor\" href=\"#基本对照\">#</a> 基本对照</h1>\n<h2 id=\"列出-active-网卡接口信息\"><a class=\"anchor\" href=\"#列出-active-网卡接口信息\">#</a> 列出 active 网卡接口信息</h2>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ifconfig</span></pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token function\">link</span> show up</pre></td></tr></table></figure><h2 id=\"显示网络接口-ip-地址\"><a class=\"anchor\" href=\"#显示网络接口-ip-地址\">#</a> 显示网络接口 ip 地址</h2>\n<p>显示所有接口或指定接口（eg：eth0）的 ip 地址</p>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ifconfig</span> <span class=\"token parameter variable\">-a</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">ifconfig</span> eht0</pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> a</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">ip</span> addr show dev eth0</pre></td></tr></table></figure><h2 id=\"激活或禁止网络接口\"><a class=\"anchor\" href=\"#激活或禁止网络接口\">#</a> 激活或禁止网络接口</h2>\n<p>启动或关闭某个接口（eg：eth0）</p>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ifconfig</span> eth0 up/down</pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token function\">link</span> <span class=\"token builtin class-name\">set</span> up/down eth0</pre></td></tr></table></figure><h2 id=\"分配-ipv4ipv6-地址\"><a class=\"anchor\" href=\"#分配-ipv4ipv6-地址\">#</a> 分配 ipv4/ipv6 地址</h2>\n<p>给某个接口（eg：eth0）临时配置 ipv4/ipv6 地址，并加上子掩码</p>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ifconfig</span> eth0 <span class=\"token number\">192.168</span>.1.56 netmask <span class=\"token number\">255.255</span>.255.0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">ifconfig</span> eth0 inet6 <span class=\"token function\">add</span> <span class=\"token number\">2002</span>:0db5:0:f102::1/64</pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> addr <span class=\"token function\">add</span> <span class=\"token number\">192.168</span>.1.56/24 dev eth0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token parameter variable\">-6</span> addr <span class=\"token function\">add</span> <span class=\"token number\">2002</span>:0db5:0:f102::1/64 dev eth0</pre></td></tr></table></figure><h2 id=\"删除-ipv4ipv6-地址\"><a class=\"anchor\" href=\"#删除-ipv4ipv6-地址\">#</a> 删除 ipv4/ipv6 地址</h2>\n<p>就 ip 地址的移除而言，除了给接口分配全 0 地址外，net-tools 没有提供任何合适的方法来移除网络接口的 ipv4 地址。</p>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ifconfig</span> eth0 <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">ifconfig</span> eth0 inet6 del <span class=\"token number\">2002</span>:0db5:0:f102::1/64</pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> addr del <span class=\"token number\">192.168</span>.1.56/24 dev eth0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token parameter variable\">-6</span> addr del <span class=\"token number\">2002</span>:0db5:0:f102::1/64 dev eth0</pre></td></tr></table></figure><h2 id=\"修改-mac-地址\"><a class=\"anchor\" href=\"#修改-mac-地址\">#</a> 修改 MAC 地址</h2>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ifconfig</span> eth0 hw ether 00:AA:BB:CC:DD:EE</pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token function\">link</span> <span class=\"token builtin class-name\">set</span> dev eth0 address 00:AA:BB:CC:DD:EE</pre></td></tr></table></figure><h2 id=\"查看套接字统计信息\"><a class=\"anchor\" href=\"#查看套接字统计信息\">#</a> 查看套接字统计信息</h2>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">netstat</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">netstat</span> <span class=\"token parameter variable\">-l</span></pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ss</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ss <span class=\"token parameter variable\">-l</span></pre></td></tr></table></figure><h2 id=\"查看-arp-表\"><a class=\"anchor\" href=\"#查看-arp-表\">#</a> 查看 ARP 表</h2>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>arp <span class=\"token parameter variable\">-an</span></pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> n</pre></td></tr></table></figure><h2 id=\"添加-删除或查看多播地址\"><a class=\"anchor\" href=\"#添加-删除或查看多播地址\">#</a> 添加、删除或查看多播地址</h2>\n<p>对某个接口（eg：eth0）临时操作多播地址及查看</p>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ipmaddr <span class=\"token function\">add</span> <span class=\"token number\">33</span>:44:00:00:00:01 dev eth0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ipmaddr del <span class=\"token number\">33</span>:44:00:00:00:01 dev eth0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ipmaddr show dev eth0</pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> maddr <span class=\"token function\">add</span> <span class=\"token number\">33</span>:44:00:00:00:01 dev eth0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ip</span> maddr del <span class=\"token number\">33</span>:44:00:00:00:01 dev eth0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">ip</span> maddr list dev eth0</pre></td></tr></table></figure><h2 id=\"查看-ip-路由表\"><a class=\"anchor\" href=\"#查看-ip-路由表\">#</a> 查看 ip 路由表</h2>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>route <span class=\"token parameter variable\">-n</span></pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> route</pre></td></tr></table></figure><h2 id=\"添加或修改默认路由\"><a class=\"anchor\" href=\"#添加或修改默认路由\">#</a> 添加或修改默认路由</h2>\n<p>对某个接口（eg：eth0）添加或修改默认路由</p>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>route add/del default gw <span class=\"token number\">192.168</span>.10.1 eth0</pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> route add/del default via <span class=\"token number\">192.168</span>.10.1 dev eth0</pre></td></tr></table></figure><h2 id=\"添加或删除静态路由\"><a class=\"anchor\" href=\"#添加或删除静态路由\">#</a> 添加或删除静态路由</h2>\n<p>对某个接口（eg：eth0）添加或删除静态路由</p>\n<ul>\n<li>net-tools</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>route <span class=\"token function\">add</span> <span class=\"token parameter variable\">-net</span> <span class=\"token number\">172.14</span>.32.0/24 gw <span class=\"token number\">192.168</span>.1.1 dev eth0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>route del <span class=\"token parameter variable\">-net</span> <span class=\"token number\">172.14</span>.32.0/24</pre></td></tr></table></figure><ul>\n<li>iproute2</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> route <span class=\"token function\">add</span> <span class=\"token number\">172.14</span>.32.0/24 via <span class=\"token number\">192.168</span>.1.1 dev eth0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">ip</span> route del <span class=\"token number\">172.14</span>.32.0/24</pre></td></tr></table></figure><h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb3Vndml0YWxlLndvcmRwcmVzcy5jb20vMjAxMS8xMi8yMS9kZXByZWNhdGVkLWxpbnV4LW5ldHdvcmtpbmctY29tbWFuZHMtYW5kLXRoZWlyLXJlcGxhY2VtZW50cy8=\">https://dougvitale.wordpress.com/2011/12/21/deprecated-linux-networking-commands-and-their-replacements/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmF0dXJpbi5vcmcvZG9jcy9pcHJvdXRlMi8=\">https://www.baturin.org/docs/iproute2/</span></p>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/linux-network-config-tool/",
            "url": "https://arachnid.cc/linux-network-config-tool/",
            "title": "Linux 网络一探究竟",
            "date_published": "2024-03-06T12:46:05.793Z",
            "content_html": "<h1 id=\"常见网络配置工具包\"><a class=\"anchor\" href=\"#常见网络配置工具包\">#</a> 常见网络配置工具包</h1>\n<p>配置「Linux 操作系统」的网络有以下几款主流的配置工具可供选择：</p>\n<table>\n<thead>\n<tr>\n<th>配置工具</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYW5wYWdlcy5kZWJpYW4ub3JnL2J1c3Rlci9pZnVwZG93bi9pbnRlcmZhY2VzLjUuZW4uaHRtbA==\">ifupdown</span></td>\n<td>用来启动 / 关闭网络的标准工具（Debian 及部分衍生版本特有），配置文件在  <code>/etc/network/interfaces</code> 。</td>\n</tr>\n<tr>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvU3lzdGVtZC1uZXR3b3JrZA==\">systemd-networkd</span></td>\n<td>systemd 是许多发行版默认的 kernel 程序，其中 systemd-networkd 组件可用于网络配置管理，配置文件在  <code>/etc/systemd/network/</code> 。</td>\n</tr>\n<tr>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTmV0d29ya01hbmFnZXI=\">NetworkManager</span></td>\n<td>一个为桌面版提供的图形化前端工具，也可以使用内嵌的  <code>nmcli</code>  和  <code>nmtui</code>  进行配置。</td>\n</tr>\n<tr>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly9uZXRwbGFuLmlvLw==\">netplan</span></td>\n<td>通过 YAML 文件管理网络配置，支持 systemd-networkd 和 NetworkManager 作为后端程序，配置文件在  <code>/etc/netplan/*.yaml</code> 。</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"ifupdown\"><a class=\"anchor\" href=\"#ifupdown\">#</a> ifupdown</h1>\n<p><code>ifupdown</code>  网络管理器一直以来都是 Debian 默认使用的网络管理器。大多数教程描述的配置  <code>/etc/network/interfaces</code>  文件就是来自于对  <code>ifupdown</code>  网络的管理。</p>\n<p>与早期版本的 Red Hat 发行版类似，Debian 把网络配置写在一个文件内，并从文件内加载配置。</p>\n<p>但与 Red Hat 系发行版不同的是，Red Hat 发行版将不同的网卡配置文件保存在  <code>/etc/sysconfig/network-scripts/</code>  文件夹中，而 Debian 则将网卡配置统一写在  <code>/etc/network/interfaces</code>  文件中。</p>\n<p>同样的，像 Debian 的衍生版本也会延续将网络配置文件统一写在  <code>/etc/network/interfaces</code>  文件中，例如早期的 Ubuntu 系统，而在 Ubuntu 18.04 LTS 后将使用  <code>netplan</code>  命令和基于  <code>/etc/netplan/*.yaml</code>  文件的配置方法；如果在 Ubuntu 18 上打开  <code>/etc/network/interfaces</code>  文件将会看到提示，而 Ubuntu 20 上则已经完全移除了  <code>/etc/network/interfaces</code>  文件。</p>\n<p>对于  <code>ifupdown</code>  的文件配置，虽然系统默认的网络配置文件是在  <code>/etc/network/interfaces</code>  文件中，但 Debian 给出的最佳实现是将网络配置保存到  <code>/etc/network/interface.d/</code>  下；一些常规的配置如下：</p>\n<ul>\n<li>\n<p>使用 DHCP 自动配置接口</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>auto eth0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>allow-hotplug eth0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>iface eth0 inet dhcp\t# ipv4 DHCP 模式</pre></td></tr><tr><td data-num=\"4\"></td><td><pre># iface eth0 inet6 dhcp/auto\t# ipv6 DHCP 或 Auto 模式</pre></td></tr></table></figure></li>\n<li>\n<p>使用静态 IP 配置接口</p>\n<p>ipv4：</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>auto eth0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>iface eth0 inet static</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\taddress 192.0.2.7/24</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tnetmask 255.255.255.0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tgateway 192.0.2.254</pre></td></tr></table></figure><p>ipv6：</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>auto eth0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>iface eth0 inet6 static</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\taddress 2001:db8::c0ca:1eaf/64</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tnetmask 64</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tgateway 2001:db8::1ead:ed:beef</pre></td></tr></table></figure></li>\n<li>\n<p>设置 DNS</p>\n<p>如果你要直接 ping 域名就需要开启 DNS 服务，在这里有两种方法：</p>\n<p>一种是修改  <code>/etc/resolv.conf</code>  文件，添加需要配置的 DNS，例如添加两个 DNS 服务：</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nameserver 8.8.8.8</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nameserver 114.114.114.114</pre></td></tr></table></figure><p>另一种是直接编辑  <code>/etc/network/interfaces</code>  文件，但这种需要  <code>resolvconf</code>  程序的支持：</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>auto eth0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>iface eth0 inet static</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\taddress 192.0.2.7/24</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tnetmask 255.255.255.0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tgateway 192.0.2.254</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tdns-nameservers 8.8.8.8 114.114.114.114\t# 此行便是用作 DNS 解析，对于多个解析地址，应共用一行并用空格区分</pre></td></tr></table></figure><p>note：这两种方法各有缺点， <code>/etc/resolv.conf</code>  中的 DNS 配置将会被 C 库或其它解析器库所查找并解析 DNS 服务，同时该文件还会被 resolvconf、network-manager 及 DHCP 客户端修改所覆盖；而在  <code>/etc/network/interfaces</code>  上编辑，则需要提供  <code>resolvconf</code>  程序，可以使用  <code>which resolvconf</code>  命令查看是否存在，否者将要进行下载才可使用。</p>\n</li>\n<li>\n<p>网络接口生效</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>systemctl restart networking</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">ifdown</span> eth0 <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ifup</span> eth0</pre></td></tr></table></figure></li>\n</ul>\n<p>tips：</p>\n<p>在  <code>/etc/network/interfaces</code>  文件中一般用  <code>auto</code>  或者  <code>allow-hotplug</code>  来定义接口的启动行为。</p>\n<ul>\n<li>auto：在系统启动的时候启动网络接口，无论网络接口有无连接（插入网线）；如果该接口配置了 DHCP，则无论有无网线，系统都会去执行 DHCP，如果没有插入网线，则等该接口超时后才会继续。</li>\n<li>allow-hotplug：只有当内核从该接口检测到热插拔事件后才启动该接口。如果系统开机时该接口没有插入网线，则系统不会启动该接口，系统启动后，如果插入网线，系统会自动启动该接口（也就是将网络接口设置为热插拔模式），但是值得注意的是，重启  <code>networking</code>  之后网卡不能自动重启。</li>\n</ul>\n<h1 id=\"systemd-networkd\"><a class=\"anchor\" href=\"#systemd-networkd\">#</a> systemd-networkd</h1>\n<p><code>systemd-networkd</code>  网络管理器是  <code>systemd</code>  软件包其中的一个组件，目前一些主流的 Linux 系统都内置着  <code>systemd</code>  包，像 Arch、Debian、Ubuntu 等。</p>\n<ul>\n<li>\n<p>静态 IP 配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 启动 \"ens37\" 接口并配置一个静态地址。 此处设置的网关将被用作默认路由。</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">></span> /etc/systemd/network/10-static-ens37.network <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>[Match]</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>Name=ens37</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>[Network]</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>Address=192.168.0.2/24</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>Gateway=192.168.0.1</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>DNS=192.168.0.1</pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>EOF</span></pre></td></tr></table></figure></li>\n<li>\n<p>DHCP 配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 在所有名字以 \"en\" 开头的接口 (也就是以太网接口) 上开启 DHCPv4 与 DHCPv6</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">></span> /etc/systemd/network/10-dhcp-en.network <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>[Match]</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>Name=en*</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>[Network]</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>DHCP=yes</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>EOF</span></pre></td></tr></table></figure></li>\n<li>\n<p>服务启动</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>systemctl start systemd-networkd</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> systemd-networkd</pre></td></tr></table></figure></li>\n</ul>\n<p>剩下的这里就不详细阐述了，说一下值得注意的点吧：</p>\n<ul>\n<li>如果 <em>.network</em> 文件中指定了 DNS 条目，则 <em>systemd-resolved</em> 服务是必需的， <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvc3lzdGVtZC1yZXNvbHZlZA==\">systemd-resolved</span> 是可选的，它是一个为本地应用程序提供网络名称（DNS）解析服务。</li>\n<li>配置文件位于  <code>/usr/lib/systemd/network</code> ，非持久化的运行时网络配置目录位于  <code>/run/systemd/network</code>  ，本地管理网络配置位于  <code>/etc/systemd/network</code> 。 <code>/etc/systemd/network</code>  中的配置文件具有最高优先级。</li>\n<li>如果某个网络接口既没有配置静态 IPv6 地址、也没有启用 DHCPv6 或 IPv6LL 的话， 将会被视为禁用 IPv6 支持。同时，systemd 将会自动向  <code>/proc/sys/net/ipv6/conf/if_name/disable_ipv6</code>  中写入 &quot;1&quot;，以彻底禁用此接口上的 IPv6 支持。</li>\n</ul>\n<p>ref：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eGNuLm9yZy93aWtpL1N5c3RlbWQtbmV0d29ya2Q=\">https://wiki.archlinuxcn.org/wiki/Systemd-networkd</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmRlYmlhbi5vcmcvU3lzdGVtZE5ldHdvcmtk\">https://wiki.debian.org/SystemdNetworkd</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamluYnVndW8uY29tL3N5c3RlbWQvc3lzdGVtZC5uZXR3b3JrLmh0bWw=\">https://www.jinbuguo.com/systemd/systemd.network.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saXNvbmdtaW4uZ2l0aHViLmlvL29zLXN5c3RlbWQtbmV0d29ya2Qv\">https://lisongmin.github.io/os-systemd-networkd/</span></p>\n<h1 id=\"networkmanager\"><a class=\"anchor\" href=\"#networkmanager\">#</a> NetworkManager</h1>\n<p><code>NetworkManager</code>  是一个为系统提供检测和配置功能以便自动连接到网络的程序。 <code>NetworkManager</code>  的功能对无线和有线网络都很有用。其有两个组件：</p>\n<ol>\n<li>一个以超级用户运行的守护进程（network-manager）；</li>\n<li>一个前端管理程序（network-manager-gnome、network-manager-kde 或者 cnetworkmanager）。</li>\n</ol>\n<p><strong>默认情况下， <code>NetworkManager</code>  不接管任何  <code>/etc/network/interfaces</code>  里配置的网络接口，而对于已经在  <code>/etc/network/interfaces</code>  中声明过的网络接口，在 Desktop 环境上你会看到  <code>NetworkManager</code>  菜单中相应的网络接口显示 “device not managed”，但如果使用  <code>NetworkManager</code>  的  <code>nmcli</code>  或  <code>nmtui</code>  工具去配置  <code>/etc/network/interfaces</code>  中声明过的网络接口，可能会对该网卡造成冲突（包括其它的网络配置服务共存也将导致冲突）。</strong></p>\n<p>如果希望  <code>NetworkManager</code>  接管在  <code>/etc/network/interfaces</code>  配置了的网络接口，则进行以下操作：</p>\n<ol>\n<li>\n<p>在  <code>/etc/NetworkManager/NetworkManager.conf</code>  里把  <code>[ifupdown]</code>  中的  <code>managed</code>  属性修改为此设置  <code>managed=true</code> ；如果有手动改过  <code>/etc/network/interfaces</code> ，那么  <code>NetworkManager</code>  会自行把这行改成： <code>managed=false</code> ；</p>\n</li>\n<li>\n<p>以 root 形式重新启动  <code>NetworkManager</code>  服务： <code>sudo systemctl restart NetworkManager</code> 。</p>\n</li>\n</ol>\n<p><code>NetworkManager</code>  除了给 Desktop 环境带来图形操作，还内置提供了一个命令行界面（nmcli）和一个基于 curses 的界面（nmtui）这两个工具：</p>\n<ul>\n<li>nmcli</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 查看 nmcli 使用说明</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>nmcli <span class=\"token parameter variable\">--help</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>Usage: nmcli <span class=\"token punctuation\">[</span>OPTIONS<span class=\"token punctuation\">]</span> OBJECT <span class=\"token punctuation\">&#123;</span> COMMAND <span class=\"token operator\">|</span> <span class=\"token builtin class-name\">help</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>OPTIONS</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>  -a, <span class=\"token parameter variable\">--ask</span>                                ask <span class=\"token keyword\">for</span> missing parameters</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>  -c, <span class=\"token parameter variable\">--colors</span> auto<span class=\"token operator\">|</span><span class=\"token function\">yes</span><span class=\"token operator\">|</span>no                 whether to use colors <span class=\"token keyword\">in</span> output</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>  -e, <span class=\"token parameter variable\">--escape</span> <span class=\"token function\">yes</span><span class=\"token operator\">|</span>no                      escape columns separators <span class=\"token keyword\">in</span> values</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>  -f, <span class=\"token parameter variable\">--fields</span> <span class=\"token operator\">&lt;</span>field,<span class=\"token punctuation\">..</span>.<span class=\"token operator\">>|</span>all<span class=\"token operator\">|</span>common      specify fields to output</pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>  -g, --get-values <span class=\"token operator\">&lt;</span>field,<span class=\"token punctuation\">..</span>.<span class=\"token operator\">>|</span>all<span class=\"token operator\">|</span>common  shortcut <span class=\"token keyword\">for</span> <span class=\"token parameter variable\">-m</span> tabular <span class=\"token parameter variable\">-t</span> <span class=\"token parameter variable\">-f</span></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>  -h, <span class=\"token parameter variable\">--help</span>                               print this <span class=\"token builtin class-name\">help</span></pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>  -m, <span class=\"token parameter variable\">--mode</span> tabular<span class=\"token operator\">|</span>multiline             output mode</pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>  -o, <span class=\"token parameter variable\">--overview</span>                           overview mode</pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>  -p, <span class=\"token parameter variable\">--pretty</span>                             pretty output</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre>  -s, --show-secrets                       allow displaying passwords</pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre>  -t, <span class=\"token parameter variable\">--terse</span>                              terse output</pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"\"></td><td><pre>  -v, <span class=\"token parameter variable\">--version</span>                            show program version</pre></td></tr><tr><td data-num=\"18\"></td><td data-command=\"\"></td><td><pre>  -w, <span class=\"token parameter variable\">--wait</span> <span class=\"token operator\">&lt;</span>seconds<span class=\"token operator\">></span>                     <span class=\"token builtin class-name\">set</span> <span class=\"token function\">timeout</span> waiting <span class=\"token keyword\">for</span> finishing operations</pre></td></tr><tr><td data-num=\"19\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td data-command=\"\"></td><td><pre>OBJECT</pre></td></tr><tr><td data-num=\"21\"></td><td data-command=\"\"></td><td><pre>  g<span class=\"token punctuation\">[</span>eneral<span class=\"token punctuation\">]</span>       NetworkManager<span class=\"token string\">'s general status and operations</pre></td></tr><tr><td data-num=\"22\"></td><td data-command=\"\"></td><td><pre>  n[etworking]    overall networking control</pre></td></tr><tr><td data-num=\"23\"></td><td data-command=\"\"></td><td><pre>  r[adio]         NetworkManager radio switches</pre></td></tr><tr><td data-num=\"24\"></td><td data-command=\"\"></td><td><pre>  c[onnection]    NetworkManager'</span>s connections</pre></td></tr><tr><td data-num=\"25\"></td><td data-command=\"\"></td><td><pre>  d<span class=\"token punctuation\">[</span>evice<span class=\"token punctuation\">]</span>        devices managed by NetworkManager</pre></td></tr><tr><td data-num=\"26\"></td><td data-command=\"\"></td><td><pre>  a<span class=\"token punctuation\">[</span>gent<span class=\"token punctuation\">]</span>         NetworkManager secret agent or polkit agent</pre></td></tr><tr><td data-num=\"27\"></td><td data-command=\"\"></td><td><pre>  m<span class=\"token punctuation\">[</span>onitor<span class=\"token punctuation\">]</span>       monitor NetworkManager changes</pre></td></tr></table></figure><ul>\n<li>nmtui</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 查看 NetworkManager 是否启动</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>nmcli networking</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>enabled</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 调出伪图形界面，然后根据选项编辑网络配置，最后启用网络连接。</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>nmtui</pre></td></tr></table></figure><p><img data-src=\"FQ0$U9UCJOL_LF_H%7B5%7D3Z41-1709729923652.jpg\" alt=\"img\" /></p>\n<p>note：</p>\n<p>一些  <code>NetworkManager</code>  网络命令处理：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 重启服务</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>systemctl restart NetworkManager</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 查看开机自启是否启用</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>systemctl list-unit-files <span class=\"token parameter variable\">--type</span> <span class=\"token function\">service</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> NetworkManager</pre></td></tr></table></figure><p>附：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmRlYmlhbi5vcmcvemhfQ04vTmV0d29ya01hbmFnZXI=\">https://wiki.debian.org/zh_CN/NetworkManager</span></p>\n<h1 id=\"netplan\"><a class=\"anchor\" href=\"#netplan\">#</a> netplan</h1>\n<p>netplan 是 Canonical (Ubuntu) 开发的，作为某些 Linux 发行版（主力为 ubuntu Linux 发行版）上默认的网络配置命令行工具。netplan 使用 YAML 描述文件来配置网络，然后，通过这些描述为任何给定的底层呈现工具（主要就是  <code>systemd-networkd</code>  和  <code>networkmanager</code>  二种工具）生成必要的配置选项。在 Ubuntu 17.10 引入 netplan 作为 network 的替代品，Ubuntu 20.04 正式使用 netplan 作为网络配置工具。</p>\n<p><img data-src=\"a1a80854-netplan_design_overview.svg\" alt=\"img\" /></p>\n<p>A、指定 NetworkManager 接管网络</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">cat</span> /etc/systemd/network/xxx.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># Let NetworkManager manage all devices on this system</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>network:</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>  version: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>  renderer: NetworkManager</pre></td></tr></table></figure><p>最后就可以使用可视化界面配置网络了，一般像在桌面上使用无线连接就会很方便，而不用使用  <code>iw</code>  等命令搜索 WiFi 然后指定 SSID 这么麻烦。</p>\n<p>B、指定 systemd-networkd 接管网络</p>\n<ul>\n<li>\n<p>ipv4 DHCP</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">network</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">renderer</span><span class=\"token punctuation\">:</span> networkd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">ethernets</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">ens33</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">dhcp4</span><span class=\"token punctuation\">:</span> yes</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token key atrule\">dhcp4-overrides</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token key atrule\">route-metric</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span></pre></td></tr></table></figure></li>\n<li>\n<p>单网卡多网段</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">network</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">renderer</span><span class=\"token punctuation\">:</span> networkd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">ethernets</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">ens33</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">addresses</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">-</span> 192.168.1.20/24</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token punctuation\">-</span> 192.168.50.20/24</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     <span class=\"token key atrule\">nameservers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>       <span class=\"token key atrule\">addresses</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>8.8.8.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     <span class=\"token key atrule\">routes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">to</span><span class=\"token punctuation\">:</span> 0.0.0.0/0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token key atrule\">via</span><span class=\"token punctuation\">:</span> 192.168.1.1</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">metric</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">to</span><span class=\"token punctuation\">:</span> 0.0.0.0/0</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token key atrule\">via</span><span class=\"token punctuation\">:</span> 192.168.50.1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token key atrule\">metric</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span></pre></td></tr></table></figure></li>\n<li>\n<p>桥接</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">network</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">renderer</span><span class=\"token punctuation\">:</span> networkd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">ethernets</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">enp3s0</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token key atrule\">dhcp4</span><span class=\"token punctuation\">:</span> yes</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">bridges</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">br0</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token key atrule\">interfaces</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>enp3s0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">dhcp4</span><span class=\"token punctuation\">:</span> no</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token key atrule\">addresses</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">-</span> 192.168.1.20/24</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">routes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>       <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">to</span><span class=\"token punctuation\">:</span> 0.0.0.0/0</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>         <span class=\"token key atrule\">via</span><span class=\"token punctuation\">:</span> 192.168.1.1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>         <span class=\"token key atrule\">metric</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token key atrule\">nameservers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">addresses</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>8.8.8.8<span class=\"token punctuation\">]</span></pre></td></tr></table></figure></li>\n</ul>\n<p>命令：</p>\n<ul>\n<li>\n<p>netplan generate</p>\n<p>将  <code>yaml</code>  文件中的设置转换为适合正在使用的渲染器的配置，但不应用它们。</p>\n</li>\n<li>\n<p>netplan apply<br />\n 应用配置，使配置生效；会自动调用  <code>netplan generate</code> 。</p>\n</li>\n<li>\n<p>netplan try<br />\n 测试配置，然后等待用户的确认；如果取消确认或超时退出则自动恢复配置，注意不是恢复配置文件。</p>\n</li>\n</ul>\n<p>note：</p>\n<p><strong>注意在  <code>/etc/netplan</code>  目录下，有多个  <code>yaml</code>  文件存在时，netplan 是根据字母表排序，挨个生效的，后面的  <code>yaml</code>  指定的配置会覆盖前面的  <code>yaml</code>  指定的配置。</strong></p>\n<p><strong> <code>netplan</code>  会一次从以下 3 个位置读取配置文件，并且按照优先级，仅有一个位置的配置文件生效：</strong></p>\n<ul>\n<li><strong> <code>/run/netplan</code>  优先级最高</strong></li>\n<li><strong> <code>/etc/netplan</code>  次优先级</strong></li>\n<li><strong> <code>/lib/netplan</code>  最低优先级</strong></li>\n</ul>\n<p>ref：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC1hdGxhcy5yZWFkdGhlZG9jcy5pby96aC1jbi9sYXRlc3QvbGludXgvdWJ1bnR1X2xpbnV4L25ldHdvcmsvbmV0cGxhbi5odG1s\">https://cloud-atlas.readthedocs.io/zh-cn/latest/linux/ubuntu_linux/network/netplan.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudmljc3lzLmNvbS50dy96aC1oYW5zL3RlY2gvdWIvdWItbmV0d29yay5odG1s\">https://www.vicsys.com.tw/zh-hans/tech/ub/ub-network.html</span></p>\n<h1 id=\"other\"><a class=\"anchor\" href=\"#other\">#</a> other</h1>\n<p>其他包含网络配置的重要文件，但我们在这里不会碰到他们：</p>\n<ul>\n<li><code>/etc/hosts</code>  - 操作系统中使用的计算机文件，用于将主机名映射到 IP 地址。 <code>hosts</code>  文件是一个纯文本文件，通常按照惯例命名为  <code>hosts</code> 。</li>\n<li><code>/etc/hostname</code>  - 分配给连接到计算机网络的设备的标签，并用于识别各种形式的电子通信设备。</li>\n<li><code>/etc/resolv.conf</code>  - 各种操作系统中的计算机文件，用于配置域名系统（DNS）解析器库。该文件是纯文本文件，通常由网络管理员或管理系统配置任务的应用创建。因此  <code>/etc/resolv.conf</code>  是依据网络管理产生，修改  <code>resolv.conf</code>  只在本次有作用，重启服务将会重置。</li>\n</ul>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>桌面环境建议使用 NetworkManager；在服务器上建议使用默认的配置工具 network，或者切换到 systemd-networkd；但是只能选取其一。除了 network 不支持无线配置，其余三个都支持。</p>\n<h2 id=\"关于-networkmanager-与-systemd-networkd-之间的切换\"><a class=\"anchor\" href=\"#关于-networkmanager-与-systemd-networkd-之间的切换\">#</a> 关于 NetworkManager 与 systemd-networkd 之间的切换</h2>\n<p>A、停用 Network Manager 并激活 systemd-networkd</p>\n<ul>\n<li>\n<p>停止并禁用 NetworkManager：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> systemctl stop NetworkManager</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> systemctl disable NetworkManager</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> systemctl mask NetworkManager</pre></td></tr></table></figure></li>\n<li>\n<p>启动和激活 systemd-networkd：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> systemctl unmask systemd-networkd</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> systemd-networkd</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> systemctl start systemd-networkd</pre></td></tr></table></figure></li>\n</ul>\n<p>B、激活 NetworkManager 关闭 systemd-networkd</p>\n<ul>\n<li>\n<p>停止并禁用 systemd-networkd：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> systemctl disable systemd-networkd</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> systemctl mask systemd-networkd</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> systemctl stop systemd-networkd</pre></td></tr></table></figure></li>\n<li>\n<p>启动和激活 NetworkManager：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> systemctl unmask NetworkManager</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> NetworkManager</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> systemctl start NetworkManager</pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"关于-netplan-指定-renderer\"><a class=\"anchor\" href=\"#关于-netplan-指定-renderer\">#</a> 关于 netplan 指定 renderer</h2>\n<p>在  <code>/etc/netplan</code>  目录下将配置文件  <code>.yaml</code>  中的  <code>renderer</code>  字段更改为需要的后端工具：</p>\n<ul>\n<li>\n<p>NetworkManager</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">network</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">renderer</span><span class=\"token punctuation\">:</span> NetworkManager</pre></td></tr></table></figure></li>\n<li>\n<p>systemd-networkd</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">network</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">renderer</span><span class=\"token punctuation\">:</span> networkd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">ethernets</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    enxx：</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">...</span></pre></td></tr></table></figure></li>\n</ul>\n<p>最后执行： <code>netplan apply</code> ；如果使用  <code>NetworkManager</code>  则不需要编写后面的  <code>ethernets</code>  字段了，完全交由 GUI 界面操作；而如果  <code>renderer</code>  指定  <code>networkd</code>  ，则为  <code>ethernets</code>  编写对应的网卡配置信息，以使  <code>netplan</code>  配置到  <code>systemd-networkd</code>  工具上。</p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTmV0d29ya19jb25maWd1cmF0aW9u\">https://wiki.archlinux.org/title/Network_configuration</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmRlYmlhbi5vcmcvTmV0d29ya0NvbmZpZ3VyYXRpb24=\">https://wiki.debian.org/NetworkConfiguration</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYW4teGlhby5naXRib29rLmlvL2RlYmlhbi9jb25maWcvbmV0d29yaw==\">https://pan-xiao.gitbook.io/debian/config/network</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9pdGJvb24uZ2l0aHViLmlvL2xpbnV4LTIwL25ldHdvcmsvY29uZmlndXJhdGlvbi8=\">https://itboon.github.io/linux-20/network/configuration/</span></p>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/linux-environment-variables/",
            "url": "https://arachnid.cc/linux-environment-variables/",
            "title": "Linux 环境变量的增删改",
            "date_published": "2024-03-01T12:54:01.000Z",
            "content_html": "<h1 id=\"shell-和-bash\"><a class=\"anchor\" href=\"#shell-和-bash\">#</a> shell 和 bash</h1>\n<p>在计算机科学中，shell 俗称壳（用来区别于核，核是指 “内核”），shell 是指 “提供使用者使用界面” 的软件（命令解析器）。它类似于  <code>DOS</code>  下的  <code>command.com</code>  和后来的  <code>cmd.exe</code> 。它接收用户命令，然后调用相应的应用程序。</p>\n<p>在很多并不正式的场合，这两个名词表达的意思相同，即命令解释器。但从严格的意义上讲，命令行是指供用户输入命令的界面，其本身只是接受输入，然后把命令传递给命令解释器，后者就是 shell，从本质上讲，shell 是一个程序，它在用户和操作系统之间提供了一个面向行的可交互接口，用户在命令行中输入命令，运行在后台的 shell 把命令转换成指令代码发送给操作系统。shell 并非只有命令行这一种形式，例如 GNOME、KDE 等图形界面也是 shell，不过它们是 GUI shell，都是为了解决人机交互的问题。</p>\n<p>目前在 Linux 环境下有几种不同类型的 shell，常用的有 Bourne Shell（sh）、Bourne Again Shell（bash）、Z Shell（zsh）、C Shell（csh）、tcsh（csh 的扩展）、Korn Shell（ksh）、pdksh（ksh 的扩展）。不同的 Shell 提供不同的语法和特性。</p>\n<p>bash 相当于 shell 中的某个，shell 的范围更广。bash 的全称是 Bourne Again Shell。</p>\n<h1 id=\"获取当前环境变量\"><a class=\"anchor\" href=\"#获取当前环境变量\">#</a> 获取当前环境变量</h1>\n<ul>\n<li>\n<p><code>echo $varname</code>  命令输出当前指定的环境变量的值</p>\n<p>使用  <code>echo</code>  命令可以输出指定的环境变量的值，例如： <code>echo $PATH</code> ，该命令会输出当前用户的  <code>PATH</code>  环境变量值。如果你想查看其他环境变量，只需要将上述命令中的  <code>PATH</code>  替换为其他环境变量即可。</p>\n</li>\n<li>\n<p><code>export</code>  命令显示当前系统定义的所有环境变量</p>\n</li>\n<li>\n<p><code>printenv</code>  /  <code>env</code>  命令查看所有已定义环境变量或指定的环境变量</p>\n<p><code>printenv</code>  或  <code>env</code>  都可以输出所有已定义的环境变量及其对应的值。 <code>printenv</code>  命令也可以单独输出当前指定的环境变量的值，例如： <code>printenv SHELL</code> ，该命令会输出已定义的  <code>SHELL</code>  环境变量值。而  <code>env</code>  命令，可以使用  <code>env | grep VARIABLE_NAME</code> ，查看对应的  <code>VARIABLE_NAME</code>  环境变量值。</p>\n</li>\n</ul>\n<p>note： <code>PATH</code>  变量定义了运行命令的查找路径，以冒号  <code>:</code>  分割不同的路径，使用  <code>export</code>  定义的时候可加双引号也可不加。</p>\n<h1 id=\"设置环境变量\"><a class=\"anchor\" href=\"#设置环境变量\">#</a> 设置环境变量</h1>\n<h2 id=\"临时环境变量\"><a class=\"anchor\" href=\"#临时环境变量\">#</a> 临时环境变量</h2>\n<h3 id=\"export-命令\"><a class=\"anchor\" href=\"#export-命令\">#</a> export 命令</h3>\n<p><code>export</code>  命令也可用于设置环境变量。</p>\n<p>在 shell 中执行程序时，shell 会提供一组环境变量。 <code>export</code>  可新增，修改或删除环境变量，供后续执行的程序使用。 <code>export</code>  的效力仅限于该次登陆操作。</p>\n<h3 id=\"set-命令\"><a class=\"anchor\" href=\"#set-命令\">#</a> set 命令</h3>\n<p><code>set</code>  命令作用主要是显示系统中已经存在的 shell 变量，以及设置 shell 变量的新变量值。使用  <code>set</code>  更改 shell 特性时，符号 &quot;+&quot; 和 &quot;-&quot; 的作用分别是打开和关闭指定的模式。 <code>set</code>  命令不能够定义新的 shell 变量。</p>\n<p>具体可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZ251Lm9yZy9zb2Z0d2FyZS9iYXNoL21hbnVhbC9odG1sX25vZGUvVGhlLVNldC1CdWlsdGluLmh0bWw=\">https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html</span></p>\n<h2 id=\"永久环境变量\"><a class=\"anchor\" href=\"#永久环境变量\">#</a> 永久环境变量</h2>\n<h3 id=\"系统级\"><a class=\"anchor\" href=\"#系统级\">#</a> 系统级</h3>\n<ol>\n<li>\n<p><code>/etc/environment</code>  ：系统在登录时读取的第一个文件，用于为所有进程设置环境变量。系统使用此文件时并不是执行此文件中的命令，而是根据  <code>KEY=VALUE</code>  模式的代码，对  <code>KEY</code>  赋值以  <code>VALUE</code> ，因此文件中如果要定义  <code>PATH</code>  环境变量，只需加入类似如  <code>PATH=$PATH:/xxx/bin</code>  的代码即可。</p>\n</li>\n<li>\n<p><code>/etc/profile</code>  ：是系统登录时执行的第二个文件，可以用于设定针对全系统所有用户的环境变量，并从  <code>/etc/profile.d</code>  目录的配置文件中搜集 shell 的设置；这个文件，是任何用户登陆操作系统以后都会读取的文件（如果用户的 shell 是 csh 、tcsh 、zsh ，则不会读取此文件）。该文件一般是调用  <code>/etc/bash.bashrc</code>  文件。</p>\n</li>\n<li>\n<p><code>/etc/bash.bashrc</code>  ：系统级的  <code>bashrc</code>  文件，为每一个运行 bash shell 的用户执行此文件。此文件会在用户每次打开 bash shell 时执行一次；因此，如果你想让每个使用 bash 的用户每新开一个 bash 和每次登陆都执行某些操作，或者给他们定义一些新的环境变量，就可以在这个里面设置。</p>\n</li>\n</ol>\n<p>note：</p>\n<ul>\n<li>\n<p>生效时间：使用相同的用户打开新的终端时生效，或者手动更新环境变量生效（见更新环境变量）</p>\n</li>\n<li>\n<p>生效期限：永久有效</p>\n</li>\n<li>\n<p>生效范围：<mark>所有用户</mark></p>\n</li>\n</ul>\n<h3 id=\"用户级\"><a class=\"anchor\" href=\"#用户级\">#</a> 用户级</h3>\n<ol>\n<li>\n<p>~/.profile: 是对应当前登录用户的  <code>profile</code>  文件，用于定制当前用户的个人工作环境。每个用户都可使用该文件输入专用于自己使用的 shell 信息，当用户登录时，该文件仅仅执行一次。默认情况下，会设置一些环境变量，执行用户的  <code>.bashrc</code>  文件。</p>\n</li>\n<li>\n<p>~/.bashrc: 是对应当前登录用户的 bash 初始化文件，当用户每次打开 bash shell 时，系统都会执行此文件一次。通常设置环境变量修改这个文件。</p>\n</li>\n</ol>\n<p>note：</p>\n<ul>\n<li>生效时间：使用相同的用户打开新的终端时生效，或者手动更新环境变量生效（见更新环境变量）</li>\n<li>生效期限：永久有效</li>\n<li>生效范围：<mark>仅对当前用户有效</mark></li>\n</ul>\n<p><strong>总结：</strong></p>\n<p>环境变量的分类可以简单的分成用户级别的环境变量以及系统级别的环境变量。</p>\n<p>系统级别环境变量定义文件： <code>/etc/bash.bashrc</code> （部分系统为： <code>/etc/bashrc</code> ）、 <code>/etc/profile</code> （部分系统为： <code>/etc/bash_profile</code> ）、 <code>/etc/environment</code></p>\n<p>用户级别环境变量定义文件： <code>~/.bashrc</code> 、 <code>~/.profile</code> （部分系统为： <code>~/.bash_profile</code> ）</p>\n<p>另外在用户环境变量中，系统会首先读取  <code>~/.profile</code> （或者  <code>~/.bash_profile</code> ）文件，如果没有该文件则读取  <code>~/.bash_login</code> ，根据这些文件中内容再去读取  <code>~/.bashrc</code> 。</p>\n<p>环境变量加载顺序：</p>\n<p><code>/etc/enviroment</code>  –&gt;  <code>/etc/profile</code>  –&gt;  <code>/etc/bash.bashrc</code>  –&gt;  <code>~/.profile</code>  –&gt;  <code>~/.bashrc</code></p>\n<p><strong>tips：</strong></p>\n<p>一般在  <code>/etc/profile.d/</code>  目录下创建一个自定义脚本会是修改环境变量的更好方法，这样无论你在一个终端中如何切换用户，环境变量依然存在。eg：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">></span> /etc/profile.d/test.sh <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>export PATH=<span class=\"token environment constant\">$PATH</span>:/home/arachnid/mysql/bin</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>EOF</span></pre></td></tr></table></figure><h1 id=\"删除环境变量\"><a class=\"anchor\" href=\"#删除环境变量\">#</a> 删除环境变量</h1>\n<p>如果是临时环境变量，或者是要临时删除一下环境变量，可以使用  <code>unset</code>  命令： <code>unset VARIABLE_NAME</code> ；如果是要永久删除配置文件中的环境变量，需要去相应的配置文件中移除相关的配置项。</p>\n<h1 id=\"更新环境变量\"><a class=\"anchor\" href=\"#更新环境变量\">#</a> 更新环境变量</h1>\n<p>eg：更新  <code>/etc/profile</code>  文件的环境变量</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token builtin class-name\">source</span> /etc/profile</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># or</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token builtin class-name\">.</span> /etc/profile</pre></td></tr></table></figure><h1 id=\"常用环境变量\"><a class=\"anchor\" href=\"#常用环境变量\">#</a> 常用环境变量</h1>\n<table>\n<thead>\n<tr>\n<th>变量</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DISPLAY</td>\n<td>如果你正在运行图形界面环境，那么这个变量就是你显示器的名字。通常，它是 “:0”， 意思是由 X 产生的第一个显示器。</td>\n</tr>\n<tr>\n<td>EDITOR</td>\n<td>文本编辑器的名字。</td>\n</tr>\n<tr>\n<td>SHELL</td>\n<td>shell 程序的名字。</td>\n</tr>\n<tr>\n<td>HOME</td>\n<td>用户家目录。</td>\n</tr>\n<tr>\n<td>LANG</td>\n<td>定义了字符集以及语言编码方式。</td>\n</tr>\n<tr>\n<td>OLD_PWD</td>\n<td>先前的工作目录。</td>\n</tr>\n<tr>\n<td>PAGER</td>\n<td>页输出程序的名字。这经常设置为 /usr/bin/less。</td>\n</tr>\n<tr>\n<td>PATH</td>\n<td>由冒号分开的目录列表，当你输入可执行程序名后，会搜索这个目录列表。</td>\n</tr>\n<tr>\n<td>PS1</td>\n<td>Prompt String 1. 这个定义了你的 shell 提示符的内容。随后我们可以看到，这个变量内容可以全面地定制。</td>\n</tr>\n<tr>\n<td>PWD</td>\n<td>当前工作目录。</td>\n</tr>\n<tr>\n<td>TERM</td>\n<td>终端类型名。类 Unix 的系统支持许多终端协议；这个变量设置你的终端仿真器所用的协议。</td>\n</tr>\n<tr>\n<td>TZ</td>\n<td>指定你所在的时区。大多数类 Unix 的系统按照协调时间时 (UTC) 来维护计算机内部的时钟 ，然后应用一个由这个变量指定的偏差来显示本地时间。</td>\n</tr>\n<tr>\n<td>USER</td>\n<td>你的用户名</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvRW52aXJvbm1lbnRfdmFyaWFibGVz\">https://wiki.archlinux.org/title/Environment_variables</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veW91eW91aS9wLzEwNjgwMzI5Lmh0bWw=\">https://www.cnblogs.com/youyoui/p/10680329.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3J2ZHNkLnRvcC8yMDE4LzA0LzI4L0xpbnV4L0xpbnV4JUU3JThFJUFGJUU1JUEyJTgzJUU1JThGJTk4JUU5JTg3JThGLw==\">http://rvdsd.top/2018/04/28/Linux/Linux 环境变量 /</span></p>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/omv6-install/",
            "url": "https://arachnid.cc/omv6-install/",
            "title": "debian 11 桌面安装 OMV 6",
            "date_published": "2024-01-13T13:04:04.775Z",
            "content_html": "<h1 id=\"debian-安装\"><a class=\"anchor\" href=\"#debian-安装\">#</a> Debian 安装</h1>\n<p>需要注意的几个点是：</p>\n<ol>\n<li>安装语言的时候选择英文安装，否者会造成部分乱码，至于后面想要使用中文，安装完成后再配置就好了。</li>\n<li>配置软件包不需要选择网络镜像，后期再配置镜像源。</li>\n<li>勾选 ssh 服务，以方便远程操作；至于是否选择图形界面，随个人喜好。</li>\n</ol>\n<h2 id=\"基本配置\"><a class=\"anchor\" href=\"#基本配置\">#</a> 基本配置</h2>\n<h3 id=\"添加-sudo-管理组\"><a class=\"anchor\" href=\"#添加-sudo-管理组\">#</a> 添加 sudo 管理组</h3>\n<p><code>your_name is not in the sudoers file. This incident will be reported.</code></p>\n<p>出现这种情况一般是你用普通用户键入  <code>sudo</code>  命令，但这个用户又没有加入  <code>sudo</code>  组上面，导致权限不够。</p>\n<p>解决（以下操作皆在 root 下执行）：</p>\n<p>通过追加到 sudo 组的形式，使用命令：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 追加（append）用户到指定组（Group）</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">usermod</span> <span class=\"token parameter variable\">-a</span> <span class=\"token parameter variable\">-G</span> <span class=\"token function\">sudo</span> your_name</pre></td></tr></table></figure><p>又或者，以修改  <code>/etc/sudoers</code>  文件的形式：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>visudo</pre></td></tr></table></figure><p>然后移动光标，在  <code># User privilege specification</code>  下面添加  <code>your_name ALL=(ALL:ALL) ALL</code>  ，根据提示  <code>写入 ^O</code>  ， <code>回车 Enter</code>  确认保存，  <code>退出 ^X</code>   ，得到：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cat</span> /etc/sudoers</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span>#</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span># This <span class=\"token function\">file</span> MUST be edited with the <span class=\"token string\">'visudo'</span> <span class=\"token builtin class-name\">command</span> as root.</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span>#</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span># Please consider adding <span class=\"token builtin class-name\">local</span> content <span class=\"token keyword\">in</span> /etc/sudoers.d/ instead of</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span># directly modifying this file.</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span>#</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span># See the <span class=\"token function\">man</span> page <span class=\"token keyword\">for</span> details on how to <span class=\"token function\">write</span> a sudoers file.</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span>#</pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>Defaults\tenv_reset</pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>Defaults\tmail_badpass</pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>Defaults\t<span class=\"token assign-left variable\">secure_path</span><span class=\"token operator\">=</span><span class=\"token string\">\"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span># Host <span class=\"token builtin class-name\">alias</span> specification</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span># User <span class=\"token builtin class-name\">alias</span> specification</pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span># Cmnd <span class=\"token builtin class-name\">alias</span> specification</pre></td></tr><tr><td data-num=\"19\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span># User privilege specification</pre></td></tr><tr><td data-num=\"21\"></td><td data-command=\"\"></td><td><pre>root\t<span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL:ALL<span class=\"token punctuation\">)</span> ALL</pre></td></tr><tr><td data-num=\"22\"></td><td data-command=\"\"></td><td><pre>your_name\t<span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL:ALL<span class=\"token punctuation\">)</span> ALL</pre></td></tr><tr><td data-num=\"23\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span># Allow members of group <span class=\"token function\">sudo</span> to execute any <span class=\"token builtin class-name\">command</span></pre></td></tr><tr><td data-num=\"25\"></td><td data-command=\"\"></td><td><pre>%sudo\t <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL:ALL<span class=\"token punctuation\">)</span> ALL</pre></td></tr><tr><td data-num=\"26\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">\\</span># See sudoers<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> <span class=\"token function\">more</span> information on <span class=\"token string\">\"@include\"</span> directives:</pre></td></tr><tr><td data-num=\"28\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td data-command=\"\"></td><td><pre>@includedir /etc/sudoers.d</pre></td></tr></table></figure><p>note：</p>\n<p><code>su</code>  带有  <code>-</code>  ，这和  <code>su</code>  是不同的，在用命令  <code>su</code>  的时候只是切换到 root，但没有把 root 的环境变量传过去，还是当前用户的环境变量，用  <code>su -</code>  命令会将环境变量也一起带过去，就像和  <code>root</code>  登录一样。关于  <code>su -</code>  的分析可参看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZGJvb2wuY29tL2Rwa2ctcmVjb25maWd1cmUtYmFzaC1jb21tYW5kLW5vdC1mb3VuZC5odG1s\">dpkg-reconfigure 命令找不到问题解决</span></p>\n<h3 id=\"避免提示光盘安装软件包\"><a class=\"anchor\" href=\"#避免提示光盘安装软件包\">#</a> 避免提示光盘安装软件包</h3>\n<p><code>Media change: please insert the disc labeled 'Debian GNU/Linux xxx DVD' Media change: please insert the disc labeled.</code></p>\n<p>在 Debian 系统中，如果您碰巧使用 DVD 安装，当你调用  <code>apt</code>  时，会抛出一个错误消息，表示存储库 cdrom 没有发布文件，并要求插入 Debian 光盘来离线安装软件包，这时候我们需要绕过去掉提示，以便使用网络安装。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">nano</span> /etc/apt/sources.list</pre></td></tr></table></figure><p>得到：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>sources.list</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre># deb cdrom:[Debian GNU/Linux 11.8.0 _Bullseye_ - Official amd64 DVD Binary-1 20231007-14:05]/ bullseye contrib main</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>deb cdrom:[Debian GNU/Linux 11.8.0 _Bullseye_ - Official amd64 DVD Binary-1 20231007-14:05]/ bullseye contrib main</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre># Line commented out by installer because it failed to verify:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>#deb http://security.debian.org/debian-security bullseye-security main contrib</pre></td></tr><tr><td data-num=\"7\"></td><td><pre># Line commented out by installer because it failed to verify:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>#deb-src http://security.debian.org/debian-security bullseye-security main contrib</pre></td></tr></table></figure><p>可以看到，默认是先通过  <code>deb cdrom:...</code>  安装软件的。所以在前面加一个  <code>#</code>  把这行注释掉即可；最后  <code>写入 ^O</code>  ， <code>回车 Enter</code>  确认保存，  <code>退出 ^X</code>  。</p>\n<h3 id=\"更换软件包镜像源\"><a class=\"anchor\" href=\"#更换软件包镜像源\">#</a> 更换软件包镜像源</h3>\n<p><code>E: Package 'xxx' has no installation candidate.</code></p>\n<p>这种情况一般是软件包获取不到，可能是网络问题，也可能是因为源的问题，换个好一点的镜像源就行了。</p>\n<p>例如：更换为 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXJyb3JzLnR1bmEudHNpbmdodWEuZWR1LmNuL2hlbHAvZGViaWFuLw==\">清华源地址</span></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> /etc/apt/sources.<span class=\"token punctuation\">&#123;</span>list,list.back<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">nano</span> /etc/apt/sources.list</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr></table></figure><p>note：</p>\n<p>先找到镜像源文件并备份，然后使用  <code>nano</code>  编辑，把获取到的镜像源地址全部覆盖替换原有的文本，最后再执行  <code>apt update</code>  更新软件包，至此就可以安装原本装失败的软件了。如果用不习惯  <code>nano</code>  编辑器，可以安装  <code>vim</code>  。</p>\n<h3 id=\"内核编译工具\"><a class=\"anchor\" href=\"#内核编译工具\">#</a> 内核编译工具</h3>\n<p><code>make[n]: *** /lib/modules/kernel_version-amd64/build: No such file or directory.</code></p>\n<p>在编译部署内核模块的时候，如果报这个错误，是因为没有  <code>linux-headers</code>  导致。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> linux-headers-<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">uname</span> <span class=\"token parameter variable\">-r</span><span class=\"token variable\">)</span></span>-amd64</pre></td></tr></table></figure><p>note：</p>\n<p>命令  <code>uname -r</code>  就是用来获取当前内核版本的。</p>\n<p>一般编译驱动会用到  <code>sudo apt-get install build-essential linux-headers-$(uname -r)-amd64</code></p>\n<h3 id=\"网卡驱动添加\"><a class=\"anchor\" href=\"#网卡驱动添加\">#</a> 网卡驱动添加</h3>\n<p>获取网卡型号：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre>lspci <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-i</span> net</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>02:00.0 Network controller: Realtek Semiconductor Co., Ltd. RTL8723BE PCIe Wireless Network Adapter</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>03:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller <span class=\"token punctuation\">(</span>rev <span class=\"token number\">15</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>其中  <code>Ethernet controller</code>  后面的表示以太网有线网卡，这里是 RTL8111/8168/8411；  <code>Network controller</code>  后面表示无线网卡，这里则是 RTL8723BE。</p>\n<ul>\n<li>\n<p>有线网卡</p>\n<p>一般主板上的有线网卡都是自带驱动的，但不排除驱动不管用或者另类没有，这个时候就需要自己找驱动，当然，如果有现成编译好打好包的驱动，那么只需要用 U 盘 copy 到系统然后进行安装即可，如果没有，那么就需要自己编译驱动了，这是一个很麻烦的事，特别是你完全没网的时候，光是安装一堆依赖都得一个个找。。。</p>\n<p>当然你也可以找个联网的虚拟机，安装一样的系统，编译好再 copy 过去；或者利用  <code>apt-cache depends package_name</code>  获取安装依赖，然后一个个安装；对于  <code>.deb</code>  文件，可以用  <code>dpkg --info path_deb_file</code>  查看。</p>\n</li>\n<li>\n<p>无线网卡</p>\n<p>在 Debian 最小安装中，是不存在无线网卡驱动的，只能自己安装：</p>\n<ul>\n<li>\n<p>intel 的无线网卡驱动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt</span> <span class=\"token function\">install</span> firmware-iwlwifi</pre></td></tr></table></figure><p>支持型号：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYWNrYWdlcy5kZWJpYW4ub3JnL2J1bGxzZXllL2Zpcm13YXJlLWl3bHdpZmk=\">https://packages.debian.org/bullseye/firmware-iwlwifi</span></p>\n</li>\n<li>\n<p>realtek（小螃蟹）的无线网卡驱动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt</span> <span class=\"token function\">install</span> firmware-realtek</pre></td></tr></table></figure><p>支持型号：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYWNrYWdlcy5kZWJpYW4ub3JnL2J1bGxzZXllL2Zpcm13YXJlLXJlYWx0ZWs=\">https://packages.debian.org/bullseye/firmware-realtek</span></p>\n</li>\n<li>\n<p>高通的无线网卡驱动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt</span> <span class=\"token function\">install</span> firmware-atheros</pre></td></tr></table></figure><p>支持型号：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYWNrYWdlcy5kZWJpYW4ub3JnL2J1bGxzZXllL2Zpcm13YXJlLWF0aGVyb3M=\">https://packages.debian.org/bullseye/firmware-atheros</span></p>\n</li>\n<li>\n<p>other：</p>\n<p>当然，如果你像一劳永逸，可以直接安装  <code>firmware-nonfree</code>  整个大包，或者在里面找相应的型号子包安装：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYWNrYWdlcy5kZWJpYW4ub3JnL3NvdXJjZS9idWxsc2V5ZS9maXJtd2FyZS1ub25mcmVlJUVGJUJDJTlCJUU4JTgwJThDJUU1JUFGJUI5JUU0JUJBJThFJUU1JTg1JUI2JUU1JUFFJTgzJUU2JUFGJTk0JUU4JUJFJTgzJUU2JTk2JUIwJUU3JTlBJTg0JUU4JUFFJUJFJUU1JUE0JTg3JUU2JTg4JTk2JUU4JTgwJTg1JUU0JUI4JThEJUU1JTlDJUE4JUU2JUI4JTg1JUU1JThEJTk1JUU0JUI4JThBJUU3JTlBJTg0JUU4JUFFJUJFJUU1JUE0JTg3JUVGJUJDJThDJUU1JThGJUFGJUU0JUJCJUE1JUU1JThFJUJCJUU1JUFFJTk4JUU3JUJEJTkxJUU2JTg4JTk2JUU4JTgwJTg1JUU1JUJDJTgwJUU2JUJBJTkwJUU1JUI5JUJGJUU1JTlDJUJBJUU0JUI4JThBJUU2JTg5JUJFJUVGJUJDJThDJUU0JUJEJTg2JUU1JUE0JUE3JUU5JTgzJUE4JUU1JTg4JTg2JUU5JTlDJTgwJUU4JUE2JTgxJUU4JTg3JUFBJUU1JUI3JUIxJUU3JUJDJTk2JUU4JUFGJTkxJUU5JUE5JUIxJUU1JThBJUE4JUUzJTgwJTgy\">https://packages.debian.org/source/bullseye/firmware-nonfree；而对于其它比较新的设备或者不在清单上的设备，可以去官网或者开源广场上找，但大部分需要自己编译驱动。</span></p>\n</li>\n</ul>\n</li>\n</ul>\n<p>关于网卡驱动安装完后，可以  <code>reboot</code>  重启，然后执行  <code>dmesg -l err</code>  查看日志，看驱动是否生效，如果没有，将会出现 error，然后排查解决就好了。</p>\n<h3 id=\"引导时间修改\"><a class=\"anchor\" href=\"#引导时间修改\">#</a> 引导时间修改</h3>\n<p>如果你是单系统，可以更改引导时间缩短跳转启动系统的时间。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">nano</span> /etc/default/grub</pre></td></tr></table></figure><p>更改  <code>GRUB_TIMEOUT</code>  数值为 1，这里建议不要改成 0，留出 1s 的时间，防止以后有用到。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cat</span> /etc/default/grub</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># If you change this file, run 'update-grub' afterwards to update</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># /boot/grub/grub.cfg.</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># For full documentation of the options in this file, see:</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\">#   info -f grub -n 'Simple configuration'</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre><span class=\"token assign-left variable\">GRUB_DEFAULT</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre><span class=\"token assign-left variable\">GRUB_TIMEOUT</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre><span class=\"token assign-left variable\">GRUB_DISTRIBUTOR</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span>lsb_release <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-s</span> <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span> /dev/null <span class=\"token operator\">||</span> <span class=\"token builtin class-name\">echo</span> Debian<span class=\"token variable\">`</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre><span class=\"token assign-left variable\">GRUB_CMDLINE_LINUX_DEFAULT</span><span class=\"token operator\">=</span><span class=\"token string\">\"quiet\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre><span class=\"token assign-left variable\">GRUB_CMDLINE_LINUX</span><span class=\"token operator\">=</span><span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># Uncomment to enable BadRAM filtering, modify to suit your needs</span></pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># This works with Linux (no patch required) and with any kernel that obtains</span></pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># the memory map information from GRUB (GNU Mach, kernel of FreeBSD ...)</span></pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\">#GRUB_BADRAM=\"0x01234567,0xfefefefe,0x89abcdef,0xefefefef\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># Uncomment to disable graphical terminal (grub-pc only)</span></pre></td></tr><tr><td data-num=\"19\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\">#GRUB_TERMINAL=console</span></pre></td></tr><tr><td data-num=\"20\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># The resolution used on graphical terminal</span></pre></td></tr><tr><td data-num=\"22\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># note that you can use only modes which your graphic card supports via VBE</span></pre></td></tr><tr><td data-num=\"23\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># you can see them in real GRUB with the command `vbeinfo'</span></pre></td></tr><tr><td data-num=\"24\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\">#GRUB_GFXMODE=640x480</span></pre></td></tr><tr><td data-num=\"25\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># Uncomment if you don't want GRUB to pass \"root=UUID=xxx\" parameter to Linux</span></pre></td></tr><tr><td data-num=\"27\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\">#GRUB_DISABLE_LINUX_UUID=true</span></pre></td></tr><tr><td data-num=\"28\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># Uncomment to disable generation of recovery mode menu entries</span></pre></td></tr><tr><td data-num=\"30\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\">#GRUB_DISABLE_RECOVERY=\"true\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># Uncomment to get a beep at grub start</span></pre></td></tr><tr><td data-num=\"33\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\">#GRUB_INIT_TUNE=\"480 440 1\"</span></pre></td></tr></table></figure><p>最后更新 Grub：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">update-grub</span></pre></td></tr></table></figure><p>note：</p>\n<p>可以通过  <code>systemd-analyze time</code>  查看开机时间，通过  <code>systemd-analyze blame</code>  查看开机服务占用时间。</p>\n<h3 id=\"ssh-配置\"><a class=\"anchor\" href=\"#ssh-配置\">#</a> ssh 配置</h3>\n<p>在安装的时候有勾选 ssh 服务的话，那么只需要配置一下文件即可，否则就需要自己去下载。（当然，这里只是前置使用，后期安装 OMV 后，将由 OMV 接管）</p>\n<h3 id=\"安装中文输入法\"><a class=\"anchor\" href=\"#安装中文输入法\">#</a> 安装中文输入法</h3>\n<p>在 linux 系统中，常见的两大输入法框架：ibus 和 fcitx，而这里使用 Fcitx5，是用来接替 Fcitx 的。</p>\n<blockquote>\n<p>注意： fcitx5 包仅提供基本框架，且仅支持英文。如果要输入其他语言（例如中文或日文），则需要安装输入法引擎（IME）。</p>\n</blockquote>\n<p>Fcitx5 输入法引擎有以下几种：</p>\n<p><strong>中文</strong></p>\n<ul>\n<li>\n<p>fcitx5-chewing 包：是流行的繁体中文注音输入引擎，它基于 libchewing 包。</p>\n</li>\n<li>\n<p>fcitx5-chinese-addons 包：包含与中文相关的 addon，例如拼音、双拼和五笔。</p>\n</li>\n<li>\n<p>fcitx5-rime 包：使用 Rime 引擎。</p>\n</li>\n</ul>\n<p><strong>日文</strong></p>\n<ul>\n<li>\n<p>fcitx5-anthy 包：是流行的日文输入引擎。但是，它已不再受到积极开发。</p>\n</li>\n<li>\n<p>fcitx5-kkc 包：是日文假名输入引擎，它基于 libkkc 包。</p>\n</li>\n<li>\n<p>fcitx5-mozc 包：基于 Mozc（Google 日文输入法的开源版本）。</p>\n</li>\n<li>\n<p>fcitx5-skk 包：是日文假名输入引擎，它基于 libskk 包。</p>\n</li>\n</ul>\n<p><strong>其他语言</strong></p>\n<ul>\n<li>fcitx5-hangul 包：用于输入韩文，基于 libhangul 包。</li>\n<li>fcitx5-unikey 包：可用于输入越南语字符。</li>\n<li>fcitx5-m17n 包：可用于各种语言。</li>\n</ul>\n<p>1、卸载旧版及其余输入法</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt</span> purge fcitx* ibus*</pre></td></tr></table></figure><p>2、安装 Fcitx5 简体中文输入</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt</span> <span class=\"token function\">install</span> fcitx5 fcitx5-chinese-addons</pre></td></tr></table></figure><p>3、重启配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr></table></figure><p>开机后查看 fcitx5 是否随桌面环境自动启动，如无，则添加开机自启：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"~/.config/autostart/\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre> <span class=\"token function\">mkdir</span>  ~/.config/autostart/</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> /usr/share/applications/org.fcitx.Fcitx5.desktop ~/.config/autostart/</pre></td></tr></table></figure><p>4、添加拼音输入</p>\n<p>在应用中打开 Fcitx5 配置，然后在输入法中添加中文拼音，同时在全局选项中配置输入法切换快捷键（默认是  <code>Ctrl + 空格键</code>  切换）。</p>\n<p>5、修改全局变量</p>\n<ul>\n<li>使用  <code>im-config</code>  组件配置</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt</span> <span class=\"token function\">install</span> im-config</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>im-config</pre></td></tr></table></figure><p>进入图形界面选择 Fcitx5 输入法。</p>\n<ul>\n<li>编辑  <code>/etc/environment</code></li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> /etc/environment</pre></td></tr></table></figure><p>添加如下全局配置：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>/etc/environment</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>GTK_IM_MODULE=fcitx</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>QT_IM_MODULE=fcitx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>XMODIFIERS=@im=fcitx</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>SDL_IM_MODULE=fcitx</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>INPUT_METHOD=fcitx</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>GLFW_IM_MODULE=ibus</pre></td></tr></table></figure><p>资料：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eGNuLm9yZy93aWtpL0ZjaXR4NQ==\">https://wiki.archlinuxcn.org/wiki/Fcitx5</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmRlYmlhbi5vcmcvemhfQ04vSTE4bi9GY2l0eDU=\">https://wiki.debian.org/zh_CN/I18n/Fcitx5</span></p>\n<h2 id=\"节电处理\"><a class=\"anchor\" href=\"#节电处理\">#</a> 节电处理</h2>\n<h3 id=\"无线\"><a class=\"anchor\" href=\"#无线\">#</a> 无线</h3>\n<p>软件关闭蓝牙功能：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>rfkill block bluetooth</pre></td></tr></table></figure><p>软件关闭 wifi 功能：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>rfkill block wifi</pre></td></tr></table></figure><h3 id=\"usb\"><a class=\"anchor\" href=\"#usb\">#</a> USB</h3>\n<p>添加 USB 空闲自动挂起处理，空闲等待时间为 2S， <code>reboot</code>  重启生效：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'ACTION==\"add\", SUBSYSTEM==\"usb\",  ATTR&#123;power/control&#125;=\"auto\", ATTR&#123;power/autosuspend_delay_ms&#125;=\"2000\"'</span> <span class=\"token operator\">></span> /etc/udev/rules.d/50-usb_power_save.rules</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr></table></figure><p>其它控制：</p>\n<p><code>ATTR&#123;power/control&#125;=&quot;on&quot;</code>  or  <code>ATTR&#123;power/autosuspend_delay_ms&#125;=&quot;-1&quot;</code> ，表示禁用挂起； <code>ATTR&#123;power/wakeup&#125;=&quot;enable&quot;</code> ，表示使能 usb 唤醒，写入  <code>disable</code>  则关闭。</p>\n<p>如果想要单独设置，可以如下查看 usb 设备对应的 udev 字段，eg：查看 Logitech 鼠标：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>lsusb</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>Bus 002 Device 001: ID 1d6b:0003 Linux Foundation <span class=\"token number\">3.0</span> root hub</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>Bus 001 Device 003: ID 0bda:b728 Realtek Semiconductor Corp. RTL8723B Bluetooth</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>Bus 001 Device 002: ID 046d:c52b Logitech, Inc. Unifying Receiver</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>Bus 001 Device 001: ID 1d6b:0002 Linux Foundation <span class=\"token number\">2.0</span> root hub</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>lsusb <span class=\"token parameter variable\">-tvv</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>/:  Bus 02.Port <span class=\"token number\">1</span>: Dev <span class=\"token number\">1</span>, <span class=\"token assign-left variable\">Class</span><span class=\"token operator\">=</span>root_hub, <span class=\"token assign-left variable\">Driver</span><span class=\"token operator\">=</span>xhci_hcd/7p, 5000M</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>    ID 1d6b:0003 Linux Foundation <span class=\"token number\">3.0</span> root hub</pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>    /sys/bus/usb/devices/usb2  /dev/bus/usb/002/001</pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>/:  Bus 01.Port <span class=\"token number\">1</span>: Dev <span class=\"token number\">1</span>, <span class=\"token assign-left variable\">Class</span><span class=\"token operator\">=</span>root_hub, <span class=\"token assign-left variable\">Driver</span><span class=\"token operator\">=</span>xhci_hcd/9p, 480M</pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>    ID 1d6b:0002 Linux Foundation <span class=\"token number\">2.0</span> root hub</pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>    /sys/bus/usb/devices/usb1  /dev/bus/usb/001/001</pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token operator\">|</span>__ Port <span class=\"token number\">4</span>: Dev <span class=\"token number\">2</span>, If <span class=\"token number\">1</span>, <span class=\"token assign-left variable\">Class</span><span class=\"token operator\">=</span>Human Interface Device, <span class=\"token assign-left variable\">Driver</span><span class=\"token operator\">=</span>usbhid, 12M</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre>        ID 046d:c52b Logitech, Inc. Unifying Receiver</pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre>        /sys/bus/usb/devices/1-4  /dev/bus/usb/001/002</pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token operator\">|</span>__ Port <span class=\"token number\">4</span>: Dev <span class=\"token number\">2</span>, If <span class=\"token number\">2</span>, <span class=\"token assign-left variable\">Class</span><span class=\"token operator\">=</span>Human Interface Device, <span class=\"token assign-left variable\">Driver</span><span class=\"token operator\">=</span>usbhid, 12M</pre></td></tr><tr><td data-num=\"18\"></td><td data-command=\"\"></td><td><pre>        ID 046d:c52b Logitech, Inc. Unifying Receiver</pre></td></tr><tr><td data-num=\"19\"></td><td data-command=\"\"></td><td><pre>        /sys/bus/usb/devices/1-4  /dev/bus/usb/001/002</pre></td></tr><tr><td data-num=\"20\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token operator\">|</span>__ Port <span class=\"token number\">4</span>: Dev <span class=\"token number\">2</span>, If <span class=\"token number\">0</span>, <span class=\"token assign-left variable\">Class</span><span class=\"token operator\">=</span>Human Interface Device, <span class=\"token assign-left variable\">Driver</span><span class=\"token operator\">=</span>usbhid, 12M</pre></td></tr><tr><td data-num=\"21\"></td><td data-command=\"\"></td><td><pre>        ID 046d:c52b Logitech, Inc. Unifying Receiver</pre></td></tr><tr><td data-num=\"22\"></td><td data-command=\"\"></td><td><pre>        /sys/bus/usb/devices/1-4  /dev/bus/usb/001/002</pre></td></tr><tr><td data-num=\"23\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token operator\">|</span>__ Port <span class=\"token number\">8</span>: Dev <span class=\"token number\">3</span>, If <span class=\"token number\">0</span>, <span class=\"token assign-left variable\">Class</span><span class=\"token operator\">=</span>Wireless, <span class=\"token assign-left variable\">Driver</span><span class=\"token operator\">=</span>btusb, 12M</pre></td></tr><tr><td data-num=\"24\"></td><td data-command=\"\"></td><td><pre>        ID 0bda:b728 Realtek Semiconductor Corp. RTL8723B Bluetooth</pre></td></tr><tr><td data-num=\"25\"></td><td data-command=\"\"></td><td><pre>        /sys/bus/usb/devices/1-8  /dev/bus/usb/001/003</pre></td></tr><tr><td data-num=\"26\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token operator\">|</span>__ Port <span class=\"token number\">8</span>: Dev <span class=\"token number\">3</span>, If <span class=\"token number\">1</span>, <span class=\"token assign-left variable\">Class</span><span class=\"token operator\">=</span>Wireless, <span class=\"token assign-left variable\">Driver</span><span class=\"token operator\">=</span>btusb, 12M</pre></td></tr><tr><td data-num=\"27\"></td><td data-command=\"\"></td><td><pre>        ID 0bda:b728 Realtek Semiconductor Corp. RTL8723B Bluetooth</pre></td></tr><tr><td data-num=\"28\"></td><td data-command=\"\"></td><td><pre>        /sys/bus/usb/devices/1-8  /dev/bus/usb/001/003</pre></td></tr><tr><td data-num=\"29\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td data-command=\"\"></td><td><pre>udevadm info <span class=\"token parameter variable\">-a</span> /dev/bus/usb/001/002</pre></td></tr><tr><td data-num=\"31\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td data-command=\"\"></td><td><pre>Udevadm info starts with the device specified by the devpath and <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"33\"></td><td data-command=\"\"></td><td><pre>walks up the chain of parent devices. It prints <span class=\"token keyword\">for</span> every device</pre></td></tr><tr><td data-num=\"34\"></td><td data-command=\"\"></td><td><pre>found, all possible attributes <span class=\"token keyword\">in</span> the udev rules key format.</pre></td></tr><tr><td data-num=\"35\"></td><td data-command=\"\"></td><td><pre>A rule to match, can be composed by the attributes of the device</pre></td></tr><tr><td data-num=\"36\"></td><td data-command=\"\"></td><td><pre>and the attributes from one single parent device.</pre></td></tr><tr><td data-num=\"37\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td data-command=\"\"></td><td><pre>  looking at device <span class=\"token string\">'/devices/pci0000:00/0000:00:15.0/usb1/1-4'</span><span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token assign-left variable\">KERNEL</span><span class=\"token operator\">==</span><span class=\"token string\">\"1-4\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token assign-left variable\">SUBSYSTEM</span><span class=\"token operator\">==</span><span class=\"token string\">\"usb\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token assign-left variable\">DRIVER</span><span class=\"token operator\">==</span><span class=\"token string\">\"usb\"</span></pre></td></tr><tr><td data-num=\"42\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>authorized<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>avoid_reset_quirk<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"44\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>bConfigurationValue<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"45\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>bDeviceClass<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"00\"</span></pre></td></tr><tr><td data-num=\"46\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>bDeviceProtocol<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"00\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>bDeviceSubClass<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"00\"</span></pre></td></tr><tr><td data-num=\"48\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>bMaxPacketSize0<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"8\"</span></pre></td></tr><tr><td data-num=\"49\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>bMaxPower<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"98mA\"</span></pre></td></tr><tr><td data-num=\"50\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>bNumConfigurations<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"51\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>bNumInterfaces<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\" 3\"</span></pre></td></tr><tr><td data-num=\"52\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>bcdDevice<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"1211\"</span></pre></td></tr><tr><td data-num=\"53\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>bmAttributes<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"a0\"</span></pre></td></tr><tr><td data-num=\"54\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>busnum<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"55\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>configuration<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"RQR12.11_B0032\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>devnum<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"2\"</span></pre></td></tr><tr><td data-num=\"57\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>devpath<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"4\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>idProduct<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"c52b\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>idVendor<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"046d\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>ltm_capable<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"no\"</span></pre></td></tr><tr><td data-num=\"61\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>manufacturer<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"Logitech\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>maxchild<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/active_duration<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"5486884\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/async<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"enabled\"</span></pre></td></tr><tr><td data-num=\"65\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/autosuspend<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"2\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/autosuspend_delay_ms<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"2000\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/connected_duration<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"5486884\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/control<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"on\"</span></pre></td></tr><tr><td data-num=\"69\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/level<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"on\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/persist<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/runtime_active_kids<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"72\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/runtime_active_time<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"5486602\"</span></pre></td></tr><tr><td data-num=\"73\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/runtime_enabled<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"forbidden\"</span></pre></td></tr><tr><td data-num=\"74\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/runtime_status<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"active\"</span></pre></td></tr><tr><td data-num=\"75\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/runtime_suspended_time<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/runtime_usage<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"77\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/wakeup<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"enabled\"</span></pre></td></tr><tr><td data-num=\"78\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/wakeup_abort_count<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"79\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/wakeup_active<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/wakeup_active_count<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"81\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/wakeup_count<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/wakeup_expire_count<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"83\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/wakeup_last_time_ms<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"84\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/wakeup_max_time_ms<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"85\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>power/wakeup_total_time_ms<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"86\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>product<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"USB Receiver\"</span></pre></td></tr><tr><td data-num=\"87\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>quirks<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"0x0\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>removable<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"removable\"</span></pre></td></tr><tr><td data-num=\"89\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>rx_lanes<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"90\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>speed<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"12\"</span></pre></td></tr><tr><td data-num=\"91\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>tx_lanes<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>urbnum<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\"34\"</span></pre></td></tr><tr><td data-num=\"93\"></td><td data-command=\"\"></td><td><pre>    ATTR<span class=\"token punctuation\">&#123;</span>version<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">==</span><span class=\"token string\">\" 2.00\"</span></pre></td></tr><tr><td data-num=\"94\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p><strong>参看：</strong></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmtlcm5lbC5vcmcvZHJpdmVyLWFwaS91c2IvcG93ZXItbWFuYWdlbWVudC5odG1s\">https://docs.kernel.org/driver-api/usb/power-management.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvVWRldiNXYWtpbmdfZnJvbV9zdXNwZW5kX3dpdGhfVVNCX2RldmljZQ==\">https://wiki.archlinux.org/title/Udev#Waking_from_suspend_with_USB_device</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5yZWFjdGl2YXRlZC5uZXQvd3JpdGluZ191ZGV2X3J1bGVzLmh0bWwjZXhhbXBsZS1wcmludGVy\">http://www.reactivated.net/writing_udev_rules.html#example-printer</span></p>\n<h3 id=\"cpu-调度\"><a class=\"anchor\" href=\"#cpu-调度\">#</a> cpu 调度</h3>\n<p>一般支持以下几种策略，旧内核可能不支持  <code>schedutil</code>  ：</p>\n<table>\n<thead>\n<tr>\n<th>Governor</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>performance</td>\n<td>Run the CPU at the maximum frequency, obtained from  <code>/sys/devices/system/cpu/cpuX/cpufreq/scaling_max_freq</code> .</td>\n</tr>\n<tr>\n<td>powersave</td>\n<td>Run the CPU at the minimum frequency, obtained from  <code>/sys/devices/system/cpu/cpuX/cpufreq/scaling_min_freq</code> .</td>\n</tr>\n<tr>\n<td>userspace</td>\n<td>Run the CPU at user specified frequencies, configurable via  <code>/sys/devices/system/cpu/cpuX/cpufreq/scaling_setspeed</code> .</td>\n</tr>\n<tr>\n<td>ondemand</td>\n<td>Scales the frequency dynamically according to current load. Jumps to the highest frequency and then possibly back off as the idle time increases.</td>\n</tr>\n<tr>\n<td>conservative</td>\n<td>Scales the frequency dynamically according to current load. Scales the frequency more gradually than ondemand.</td>\n</tr>\n<tr>\n<td>schedutil</td>\n<td>Scheduler-driven CPU frequency selection.</td>\n</tr>\n</tbody>\n</table>\n<p>关于  <code>schedutil</code>  的原理可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZWVwaW5vdXQuY29tL2FuZHJvaWQtc3lzdGVtLWFuYWx5c2lzL2FuZHJvaWQtY3B1LXJlbGF0ZWQvcHJpbmNpcGxlLWFuYWx5c2lzLW9mLWNwdS1nb3Zlcm5vci1zY2hlZHV0aWwuaHRtbA==\">https://deepinout.com/android-system-analysis/android-cpu-related/principle-analysis-of-cpu-governor-schedutil.html</span></p>\n<p>查看 cpu 支持的调度策略及当前使用的模式：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cat</span> /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>conservative ondemand performance schedutil</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cat</span> /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>schedutil</pre></td></tr></table></figure><p>修改所有 cpu 的策略：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">echo</span> governor <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>governor</pre></td></tr></table></figure><p>note： <code>governor</code>  为支持的策略之一，选你需要更改的就好了。</p>\n<p><strong>注意，该操作只在当前生效，任何复位或重启后，都将恢复默认操作，因此如果要让每次生效，那么需要编写开机脚本或写入内核。</strong></p>\n<p>查看各 cpu 频率：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cat</span> /proc/cpuinfo <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-E</span> <span class=\"token string\">'^model name|^cpu MHz'</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>model name      <span class=\"token builtin class-name\">:</span> Intel<span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">)</span> Pentium<span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">)</span> Silver J5040 CPU @ <span class=\"token number\">2</span>.00GHz</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>cpu MHz         <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1029.564</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>model name      <span class=\"token builtin class-name\">:</span> Intel<span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">)</span> Pentium<span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">)</span> Silver J5040 CPU @ <span class=\"token number\">2</span>.00GHz</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>cpu MHz         <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1168.290</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>model name      <span class=\"token builtin class-name\">:</span> Intel<span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">)</span> Pentium<span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">)</span> Silver J5040 CPU @ <span class=\"token number\">2</span>.00GHz</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>cpu MHz         <span class=\"token builtin class-name\">:</span> <span class=\"token number\">818.342</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>model name      <span class=\"token builtin class-name\">:</span> Intel<span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">)</span> Pentium<span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">)</span> Silver J5040 CPU @ <span class=\"token number\">2</span>.00GHz</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>cpu MHz         <span class=\"token builtin class-name\">:</span> <span class=\"token number\">960.974</span></pre></td></tr></table></figure><p>资料：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvQ1BVX2ZyZXF1ZW5jeV9zY2FsaW5nI1NjYWxpbmdfZ292ZXJub3Jz\">https://wiki.archlinux.org/title/CPU_frequency_scaling#Scaling_governors</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmtlbHUub3JnL3RlY2gvMjAyMS8wNS8xMy9iaW9zLWNvbmZpZy1yZW1hcmsuaHRtbA==\">https://blog.kelu.org/tech/2021/05/13/bios-config-remark.html</span></p>\n<h3 id=\"睡眠与休眠\"><a class=\"anchor\" href=\"#睡眠与休眠\">#</a> 睡眠与休眠</h3>\n<p>关于 Suspend，Linux 内核提供了四种电源模式，如下表：</p>\n<table>\n<thead>\n<tr>\n<th>模式</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>freeze</td>\n<td>冻结 I/O 设备，将它们置于低功耗状态，使处理器进入空闲状态，唤醒最快，耗电比其它 standby, mem, disk 方式高。</td>\n</tr>\n<tr>\n<td>standby</td>\n<td>除了冻结 I/O 设备外，还会暂停系统，唤醒较快，耗电比其它 mem, disk 方式高。</td>\n</tr>\n<tr>\n<td>mem</td>\n<td>将运行状态数据存到内存，并关闭外设，进入等待模式，唤醒较慢，耗电比 disk 方式高。（实际由  <code>/sys/power/mem_sleep</code>  抉择）</td>\n</tr>\n<tr>\n<td>disk</td>\n<td>将运行状态数据存到硬盘，然后关机，唤醒最慢；对于嵌入式系统，由于没有硬盘，所以一般不支持。（实际由  <code>/sys/power/disk</code>  抉择）</td>\n</tr>\n</tbody>\n</table>\n<p>然，虽然 linux 内核支持，但实际上不同的平台，对应的支持也是不一样的；可以使用以下命令查看对 Suspend 支持：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cat</span> /sys/power/state</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>freeze mem disk</pre></td></tr></table></figure><p>在这里，就只支持 3 种： <code>freeze</code>  、  <code>mem</code>  、  <code>disk</code>  。</p>\n<p>在 linux 中，有两个比较特殊的 Suspend 管理，那就是  <code>mem</code>  和  <code>disk</code>  ，分别是 <strong>Suspend to RAM（挂起到内存，通称睡眠）</strong> 和 <strong>Suspend to disk（挂起到硬盘，通称休眠）</strong> 这两种电源管理模式，它们默认使用的 ACPI 定义如下：</p>\n<ul>\n<li>\n<p>Suspend to RAM（挂起到内存，通称睡眠）</p>\n<p>ACPI 定义的 <strong>S3</strong> 睡眠状态。通过将机器中大多数和 RAM 不相关的部件断电来工作，RAM 是恢复机器状态所必需的。由于可以节省大量电力，建议笔记本电脑在使用电池运行且盖子关闭时（或用户在一段时间内处于非活动状态）自动进入此模式。</p>\n</li>\n<li>\n<p>Suspend to disk（挂起到硬盘，通称休眠）</p>\n<p>ACPI 定义的 <strong>S4</strong> 睡眠状态。将机器状态保存到交换空间并关闭机器。再次开机后，恢复状态。直到开机前，机器都不会有任何待机功耗。</p>\n</li>\n</ul>\n<p>note：实际上，  <code>mem</code>  和  <code>disk</code>  是由它们对应的配置文件决定的，但一般默认会使用上面的 ACPI 状态。</p>\n<p>对于  <code>mem</code>  和  <code>disk</code>  的控制：</p>\n<p><code>mem</code>  模式的操作由  <code>/sys/power/mem_sleep</code>  抉择，常见以下几种睡眠处理：</p>\n<ul>\n<li>deep：Suspend-To-RAM，对应 ACPI 为 S3；</li>\n<li>shallow：Power-On Suspend，对应 ACPI 为 S1；</li>\n<li>s2idle：Suspend-To-Idle，对应 ACPI 为 S0；</li>\n</ul>\n<p><code>disk</code>  模式的操作则由  <code>/sys/power/disk</code>  抉择，常见以下几种休眠处理：</p>\n<ul>\n<li>platform：使用平台（BIOS 支持）提供的方法将把系统置于超低功耗状态（如 ACPI S4），使得额外的唤醒选项可用，并且让平台固件在唤醒之后可能允许做一个简简的初始化；</li>\n<li>shutdown：顾名思义就是关闭系统设备断电；</li>\n<li>reboot：这个。。。不用说了吧；</li>\n<li>suspend：系统混合挂起，是的没错，可以将睡眠和休眠混合，可以通过在   <code>/etc/systemd/sleep.conf</code>  文件进行配置以达到效果，可参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eGNuLm9yZy93aWtpLyVFNyU5NCVCNSVFNiVCQSU5MCVFNyVBRSVBMSVFNyU5MCU4NiMlRTYlOEMlODIlRTglQjUlQjclRTYlODglOTYlRTQlQkMlOTElRTclOUMlQTAlRTglQUYlQjclRTYlQjElODIlRTYlOTclQjYlRTclOUElODQlRTYlQjclQjclRTUlOTAlODglRTclOUQlQTElRTclOUMlQTA=\">挂起或休眠请求时的混合睡眠</span> ；</li>\n<li>test_resume：诊断操作。先是加载镜像（就好像系统刚从休眠中醒来，当前运行的内核实例是还原内核），然后再恢复整个系统。</li>\n</ul>\n<p>查看支持：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cat</span> /sys/power/mem_sleep</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>s2idle <span class=\"token punctuation\">[</span>deep<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cat</span> /sys/power/disk</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">[</span>platform<span class=\"token punctuation\">]</span> <span class=\"token function\">shutdown</span> <span class=\"token function\">reboot</span> <span class=\"token function\">suspend</span> test_resume</pre></td></tr></table></figure><p>如果想要切换相应的控制，只需往写入你要的处理模式就好了；当然，这只是在下一次中生效，当执行完一次后将会恢复；若要设成永久处理，那么可以通过修改内核属性来达到效果。</p>\n<p><strong>自动休眠：</strong></p>\n<p>一般作为服务器，是不需要自动休眠的，但对于一周也用不了多少次的，可能使用自动休眠会省电一点，配合唤醒功能即可达到快速恢复工作环境的效果。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> /etc/default/grub</pre></td></tr></table></figure><p>然后添加  <code>GRUB_CMDLINE_LINUX=&quot;mem_sleep_default=deep&quot;</code>  ，然后重新生成  <code>grub.cfg</code>  文件，重启生效：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">grub-mkconfig</span> <span class=\"token parameter variable\">-o</span> /boot/grub/grub.cfg</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr></table></figure><p>资料：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvUG93ZXJfbWFuYWdlbWVudC9TdXNwZW5kX2FuZF9oaWJlcm5hdGU=\">https://wiki.archlinux.org/title/Power_management/Suspend_and_hibernate</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYW4uYXJjaGxpbnV4Lm9yZy9tYW4vc2xlZXAuY29uZi5kLjU=\">https://man.archlinux.org/man/sleep.conf.d.5</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvUG93ZXJfbWFuYWdlbWVudCNTdXNwZW5kX2FuZF9oaWJlcm5hdGU=\">https://wiki.archlinux.org/title/Power_management#Suspend_and_hibernate</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudW5peHR1dG9yaWFsLm9yZy9kaXNhYmxlLXNsZWVwLW9uLXVidW50dS1zZXJ2ZXIv\">https://www.unixtutorial.org/disable-sleep-on-ubuntu-server/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cua2VybmVsLm9yZy9kb2MvaHRtbC9sYXRlc3QvYWRtaW4tZ3VpZGUvcG0vc2xlZXAtc3RhdGVzLmh0bWw=\">https://www.kernel.org/doc/html/latest/admin-guide/pm/sleep-states.html</span></p>\n<p>更多电源管理：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvUG93ZXJfbWFuYWdlbWVudCNQb3dlcl9zYXZpbmc=\">https://wiki.archlinux.org/title/Power_management#Power_saving</span></p>\n<p>Kernel 参数：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cua2VybmVsLm9yZy9kb2MvRG9jdW1lbnRhdGlvbi9hZG1pbi1ndWlkZS9rZXJuZWwtcGFyYW1ldGVycy50eHQ=\">https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt</span></p>\n<h2 id=\"图形环境切换\"><a class=\"anchor\" href=\"#图形环境切换\">#</a> 图形环境切换</h2>\n<p>前提：系统已经安装了桌面环境，需要禁止桌面环境，以纯命令行启动，以节约性能。</p>\n<p>获取当前系统运行的界面模式：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>systemctl get-default</pre></td></tr></table></figure><p>纯命令行启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>systemctl set-default multi-user.target</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr></table></figure><p>note：如果想从命令行中启动桌面，可以通过相应的图形界面启动命令来启动，例如启动 xfce4 的桌面： <code>startxfce4</code>  .</p>\n<p>桌面环境启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>systemctl set-default graphical.target</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr></table></figure><p>对于多桌面，可以使用下面命令，然后选择对应的桌面系统，输入序号确认：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>update-alternatives <span class=\"token parameter variable\">--config</span> x-session-manager</pre></td></tr></table></figure><p>如果要删除  <code>x-session-manager</code>  的某个选项，可以先通过以下方式列出其路径，然后通过删除选项（eg：gnome-session）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>update-alternatives <span class=\"token parameter variable\">--list</span> x-session-manager</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>update-alternatives <span class=\"token parameter variable\">--remove</span> x-session-manager /usr/bin/gnome-session</pre></td></tr></table></figure><p>参考：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly91bml4LnN0YWNrZXhjaGFuZ2UuY29tL3F1ZXN0aW9ucy8zNjcyOTQvaG93LWRvLWktY2hhbmdlLW15LWRlZmF1bHQtc2Vzc2lvbg==\">https://unix.stackexchange.com/questions/367294/how-do-i-change-my-default-session</span></p>\n<h2 id=\"远程唤醒\"><a class=\"anchor\" href=\"#远程唤醒\">#</a> 远程唤醒</h2>\n<p>首先，查看系统主板 BIOS 是否支持 Wake-On-LAN ，要是支持的话，必须先启动它，因为它被默认设禁用。</p>\n<p>然后，需要一个支持 Wake-On-LAN 的网卡；<mark>无线网卡并不支持</mark>。你需要运行  <code>ethtool</code>  命令查看网卡是否支持 Wake-On-LAN ：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token function\">ethtool</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">ethtool</span> eno1 <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> Wake-on</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>        Supports Wake-on: pumbg</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>        Wake-on: d</pre></td></tr></table></figure><p>这条命令输出的  <code>Supports Wake-on</code>  字段会告诉你你的网卡支持哪些功能，同时  <code>Wake-on</code>  指示着当前配置的模式，一般有以下几种选项：</p>\n<ul>\n<li>d -- 禁用（disable）</li>\n<li>p -- 物理活动唤醒（Wake on PHY activity）</li>\n<li>u -- 单播消息唤醒（Wake on unicast activity）</li>\n<li>m -- 多播（组播）消息唤醒（Wake on multicast activity）</li>\n<li>b -- 广播消息唤醒（Wake on broadcast activity）</li>\n<li>a -- ARP 唤醒（Wake on ARP activity）</li>\n<li>g -- 特定数据包唤醒（magic packet activity）</li>\n</ul>\n<p>修改 wol 功能：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">ethtool</span> <span class=\"token parameter variable\">-s</span> eno1 wol g</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">ethtool</span> eno1 <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> Wake-on</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>        Supports Wake-on: pumbg</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>        Wake-on: g</pre></td></tr></table></figure><p>此刻已经开启 magic packet 唤醒了，然后执行  <code>ip a</code>  查看网卡的 mac 地址和 ip 并记录，再写入  <code>echo mem &gt; /sys/power/state</code>  ，让系统进入休眠，再在另一台主机测试网络唤醒。</p>\n<ul>\n<li>\n<p>Windows</p>\n<p>可以选择该工具使用：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZGVwaWN1cy5jb20vd2FrZS1vbi1sYW4vd2FrZS1vbi1sYW4tY21k\">Wake On Lan Command Line</span> 。</p>\n</li>\n<li>\n<p>Linux</p>\n<p>可以安装对应的 pack 包（eg：etherwake），这里就不多说了。</p>\n</li>\n</ul>\n<p>当你能成功唤醒后，就证明你的主板支持，bios 上的 wol 有启用，系统配置上也打开了。</p>\n<p>最后，对于部分系统，可能有些在设置完显示  <code>Wake-on: g</code>  后，重启会变回默认配置，这时可以编写一个开机启动服务：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> /etc/systemd/system/wol@.service</pre></td></tr></table></figure><p>添加如下内容：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>wol@.service</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[Unit]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Description=Wake-on-LAN for %i</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Requires=network.target</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>After=network.target</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>[Service]</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ExecStart=/usr/bin/ethtool -s %i wol g</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Type=oneshot</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>[Install]</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>WantedBy=multi-user.target</pre></td></tr></table></figure><p>然后 [Install] 区块中的  <code>WantedBy</code>  字段，是表示该服务所在的 Target。如  <code>WantedBy=multi-user.target</code>  指的是该服务所属于  <code>multi-user.target</code>  ；当执行  <code>systemctl enable xxx.service</code>  命令时， <code>xxx.service</code>  的符号链接就会被创建在  <code>/etc/systemd/system/multi-user.target</code>  目录下。可以通过  <code>systemctl get-default</code>  命令查看系统默认启动的 target，一般为  <code>multi-user</code>  或者是  <code>graphical</code> 。因此配置好相应的  <code>WantedBy</code>  字段，可以实现服务的开机启动。</p>\n<p><code>multi-user.target</code>  表示多用户命令行状态；  <code>graphical.target</code>  表示图形用户状态，它依赖于  <code>multi-user.target</code>  。官方文档有一张非常清晰的 [Target 依赖关系图](<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWRlc2t0b3Aub3JnL3NvZnR3YXJlL3N5c3RlbWQvbWFuL2Jvb3R1cC5odG1sI1N5c3RlbQ==\">https://www.freedesktop.org/software/systemd/man/bootup.html#System</span> Manager Bootup)。</p>\n<p>嘛，如果你是用图形界面的，也是可以用  <code>multi-user.target</code>  的，因为  <code>graphical.target</code>  依赖  <code>multi-user.target</code>  ，可以利用命令  <code>systemctl list-units --type=target</code>  查看到  <code>multi-user.target</code>  是处于 Active 状态的。</p>\n<p>最后，重新加载所有的 systemd 服务，打开自启动并启动服务，其中  <code>@</code>  后面跟随的是你的 wol 网卡名称：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> systemctl daemon-reload</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> wol@eno1</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> systemctl start wol@eno1</pre></td></tr></table></figure><p>note：</p>\n<p>对于 systemd 服务的控制，可以使用如下命令：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl <span class=\"token punctuation\">[</span>command<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>unit<span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>[command]：</p>\n<ul>\n<li>\n<p>start：立刻启动后面接的 unit。</p>\n</li>\n<li>\n<p>stop：立刻关闭后面接的 unit。</p>\n</li>\n<li>\n<p>restart：立刻关闭后启动后面接的 unit，亦即执行 stop 再 start 的意思。</p>\n</li>\n<li>\n<p>reload：不关闭 unit 的情况下，重新载入配置文件，让设置生效。</p>\n</li>\n<li>\n<p>enable：设置下次开机时，后面接的 unit 会被启动。</p>\n</li>\n<li>\n<p>disable：设置下次开机时，后面接的 unit 不会被启动。</p>\n</li>\n<li>\n<p>status：目前后面接的这个 unit 的状态，会列出有没有正在执行、开机时是否启动等信息。</p>\n</li>\n<li>\n<p>is-active：目前有没有正在运行中。</p>\n</li>\n<li>\n<p>is-enable：开机时有没有默认要启用这个 unit。</p>\n</li>\n<li>\n<p>kill ：不要被 kill 这个名字吓着了，它其实是向运行 unit 的进程发送信号。</p>\n</li>\n<li>\n<p>show：列出 unit 的配置。</p>\n</li>\n<li>\n<p>mask：注销 unit，注销后你就无法启动这个 unit 了。</p>\n</li>\n<li>\n<p>unmask：取消对 unit 的注销。</p>\n</li>\n</ul>\n<p>一些其它命令：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl poweroff <span class=\"token comment\"># 系统关机</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>systemctl <span class=\"token function\">reboot</span> <span class=\"token comment\"># 重新开机</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>systemctl <span class=\"token function\">suspend</span> <span class=\"token comment\"># 进入暂停模式</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>systemctl hibernate <span class=\"token comment\"># 进入休眠模式</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>systemctl rescue <span class=\"token comment\"># 强制进入救援模式</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>systemctl emergency <span class=\"token comment\"># 强制进入紧急救援模式</span></pre></td></tr></table></figure><p>资料：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvV2FrZS1vbi1MQU4=\">https://wiki.archlinux.org/title/Wake-on-LAN</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmRlYmlhbi5vcmcvV2FrZU9uTGFu\">https://wiki.debian.org/WakeOnLan</span></p>\n<h2 id=\"异常记录查看\"><a class=\"anchor\" href=\"#异常记录查看\">#</a> 异常记录查看</h2>\n<p>使用  <code>last -x shutdown reboot</code>  命令可以查看系统的关机和重启记录，包括异常关机。该命令会显示每次关机或重启的时间、持续时间。</p>\n<p>使用  <code>dmesg | grep &quot;shutdown&quot;</code>  命令可以查看内核的消息缓冲区，筛选出关机的相关信息。</p>\n<p>参考：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly91bml4LnN0YWNrZXhjaGFuZ2UuY29tL3F1ZXN0aW9ucy85ODE5L2hvdy10by1maW5kLW91dC1mcm9tLXRoZS1sb2dzLXdoYXQtY2F1c2VkLXN5c3RlbS1zaHV0ZG93bg==\">https://unix.stackexchange.com/questions/9819/how-to-find-out-from-the-logs-what-caused-system-shutdown</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI4MzQ1NjU3L2FydGljbGUvZGV0YWlscy8xMjY4MzMxMzE=\">https://blog.csdn.net/qq_28345657/article/details/126833131</span></p>\n<h2 id=\"系统备份\"><a class=\"anchor\" href=\"#系统备份\">#</a> 系统备份</h2>\n<p>linux 系统说白了就是一个强大的文件系统，既然是文件，哪能不能像日常备份文件那样直接压缩备份呢？答案是可以，只是在备份压缩的时候注意把各个文件的权限都保留下来。</p>\n<p>在备份之前先了解一下 linux 的系统目录结构：</p>\n<table>\n<thead>\n<tr>\n<th>文件夹</th>\n<th>英文全称</th>\n<th>文件夹作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>/boot</td>\n<td>Boot</td>\n<td>存放的启动 Linux 时使用的内核文件，包括连接文件以及镜像文件。</td>\n</tr>\n<tr>\n<td>/bin</td>\n<td>Binaries</td>\n<td>存放着最常用的程序和指令，所有用户都可以执行。是  <code>/usr/bin</code>  目录的软连接。</td>\n</tr>\n<tr>\n<td>/sbin</td>\n<td>Super User Binaries</td>\n<td>保存和系统环境设置相关的命令，只有超级用户可以使用这些命令，有些命令可以允许普通用户查看。是  <code>/usr/sbin</code>  目录的软连接。</td>\n</tr>\n<tr>\n<td>/usr</td>\n<td>Unix Software Resources</td>\n<td>用户的很多应用程序和文件都放在这个目录下，类似于 windows 下的 program files 目录。</td>\n</tr>\n<tr>\n<td>/usr/bin</td>\n<td>Unix Software Resources Binaries</td>\n<td>系统用户使用的应用程序与指令。</td>\n</tr>\n<tr>\n<td>/usr/sbin</td>\n<td>Unix Software Resources Superuser Binaries</td>\n<td>超级用户使用的比较高级的管理程序和系统守护程序。</td>\n</tr>\n<tr>\n<td>/usr/local</td>\n<td>Unix Software Resources Local</td>\n<td>安装第三方软件的安装目录，一般是通过编译源码的方式安装的程序。</td>\n</tr>\n<tr>\n<td>/usr/src</td>\n<td>Unix Software Resources Source</td>\n<td>内核源代码默认的放置目录。</td>\n</tr>\n<tr>\n<td>/dev</td>\n<td>Devices</td>\n<td>存放的是 Linux 的外部设备。注意：在 Linux 中访问设备和访问文件的方式是相同的。</td>\n</tr>\n<tr>\n<td>/etc</td>\n<td>Editable Text Configuration Chest</td>\n<td>存放所有的系统需要的配置文件和子目录列表，更改目录下的文件可能会导致系统不能启动。</td>\n</tr>\n<tr>\n<td>/opt</td>\n<td>Optional Application Software Packages</td>\n<td>可选应用软件包，第三方安装的软件保存位置，存放软件安装包。</td>\n</tr>\n<tr>\n<td>/lib</td>\n<td>Library</td>\n<td>存放基本代码库（比如 c++ 库），其作用类似于 Windows 里的 DLL 文件。几乎所有的应用程序都需要用到这些共享库。</td>\n</tr>\n<tr>\n<td>/proc</td>\n<td>Processes</td>\n<td>虚拟文件系统，数据保存在内存中，存放当前进程信息</td>\n</tr>\n<tr>\n<td>/root</td>\n<td>Root</td>\n<td>系统管理员的用户主目录。</td>\n</tr>\n<tr>\n<td>/tmp</td>\n<td>Temporary</td>\n<td>存放临时文件</td>\n</tr>\n<tr>\n<td>/var</td>\n<td>Variable</td>\n<td>存放经常修改的数据，比如程序运行的日志文件（ <code>/var/log</code>  目录下）。</td>\n</tr>\n<tr>\n<td>/home</td>\n<td>Home</td>\n<td>用户缺省宿主目录。</td>\n</tr>\n<tr>\n<td>/lost+found</td>\n<td>Lost And Found</td>\n<td>一般情况下为空的，存放一些系统出错的检查结果</td>\n</tr>\n<tr>\n<td>/srv</td>\n<td>Server</td>\n<td>服务数据目录</td>\n</tr>\n<tr>\n<td>/sys</td>\n<td>System</td>\n<td>这是 linux2.6 内核的一个很大的变化。该目录下安装了 2.6 内核中新出现的一个文件系统 sysfs。sysfs 文件系统集成了下面 3 种文件系统的信息：针对进程信息的 proc 文件系统、针对设备的 devfs 文件系统以及针对伪终端的 devpts 文件系统。该文件系统是内核设备树的一个直观反映。当一个内核对象被创建的时候，对应的文件和目录也在内核对象子系统中。</td>\n</tr>\n<tr>\n<td>/mnt</td>\n<td>Mount</td>\n<td>挂载目录。临时文件系统的安装点，默认挂载光驱和软驱的目录</td>\n</tr>\n<tr>\n<td>/media</td>\n<td>Media</td>\n<td>挂载目录。 挂载媒体设备，如软盘和光盘</td>\n</tr>\n<tr>\n<td>/misc</td>\n<td>Miscellaneous Device</td>\n<td>挂载目录。 挂载 NFS 服务</td>\n</tr>\n<tr>\n<td>/run</td>\n<td>Run</td>\n<td>里面的东西是系统运行时需要的，不能随便删除。当系统重启时，这个目录下的文件应该被删掉或清除；下次系统运行时重新生成。</td>\n</tr>\n</tbody>\n</table>\n<p>备份系统：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-s</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-zcvpf</span> backup.tgz <span class=\"token parameter variable\">--exclude</span><span class=\"token operator\">=</span>/proc <span class=\"token parameter variable\">--exclude</span><span class=\"token operator\">=</span>/lost+found <span class=\"token parameter variable\">--exclude</span><span class=\"token operator\">=</span>/backup.tgz <span class=\"token parameter variable\">--exclude</span><span class=\"token operator\">=</span>/mnt <span class=\"token parameter variable\">--exclude</span><span class=\"token operator\">=</span>/sys <span class=\"token parameter variable\">--exclude</span><span class=\"token operator\">=</span>/media <span class=\"token parameter variable\">--exclude</span><span class=\"token operator\">=</span>/srv/dev-disk-by-uuid* /</pre></td></tr></table></figure><p>恢复系统：</p>\n<p>如果原来的 Debian 系统已经崩溃，无法进入。则可以在目标机上用 ISO、LiveCD 等启动，挂载磁盘（一般会自动挂载到  <code>/media</code>  文件夹）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-s</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-zcvpf</span> backup.tgz <span class=\"token parameter variable\">-C</span> /media/<span class=\"token operator\">&lt;</span>对应的磁盘<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> proc lost+found mnt sys media</pre></td></tr></table></figure><h1 id=\"安装-openmediavault-6x\"><a class=\"anchor\" href=\"#安装-openmediavault-6x\">#</a> 安装 openmediavault 6.x</h1>\n<p>在操作如下流程前，要进行备份！备份！备份！</p>\n<p>具体安装以 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm9wZW5tZWRpYXZhdWx0Lm9yZy9lbi9sYXRlc3QvaW5zdGFsbGF0aW9uL29uX2RlYmlhbi5odG1s\">https://docs.openmediavault.org/en/latest/installation/on_debian.html</span> 为准。</p>\n<p>1、临时配置环境变量</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">LANG</span></span><span class=\"token operator\">=</span>C.UTF-8</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">DEBIAN_FRONTEND</span><span class=\"token operator\">=</span>noninteractive</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">APT_LISTCHANGES_FRONTEND</span><span class=\"token operator\">=</span>none</pre></td></tr></table></figure><p>2、添加软件包存储库</p>\n<p>进入文件编辑：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> /etc/apt/sources.list.d/openmediavault.list</pre></td></tr></table></figure><p>然后粘贴以下存储库链接（这里使用的是 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXJyb3JzLmJmc3UuZWR1LmNuL2hlbHAvb3Blbm1lZGlhdmF1bHQv\">北外镜像</span>，以加快国内访问速度，当然你也可以使用源链接），保存退出：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>openmediavault.list</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>deb https://mirrors.bfsu.edu.cn/OpenMediaVault/public shaitan main</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deb https://mirrors.bfsu.edu.cn/OpenMediaVault/packages shaitan main</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>## Uncomment the following line to add software from the proposed repository.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre># deb https://mirrors.bfsu.edu.cn/OpenMediaVault/public shaitan-proposed main</pre></td></tr><tr><td data-num=\"5\"></td><td><pre># deb https://mirrors.bfsu.edu.cn/OpenMediaVault/packages shaitan-proposed main</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>## This software is not part of OpenMediaVault, but is offered by third-party</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>## developers as a service to OpenMediaVault users.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre># deb https://mirrors.bfsu.edu.cn/OpenMediaVault/public shaitan partner</pre></td></tr><tr><td data-num=\"9\"></td><td><pre># deb https://mirrors.bfsu.edu.cn/OpenMediaVault/packages shaitan partner</pre></td></tr></table></figure><p>3、添加 openmediavault 密钥</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">--yes</span> gnupg</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">wget</span> <span class=\"token parameter variable\">--quiet</span> --output-document<span class=\"token operator\">=</span>- https://packages.openmediavault.org/public/archive.key <span class=\"token operator\">|</span> gpg <span class=\"token parameter variable\">--dearmor</span> <span class=\"token parameter variable\">--yes</span> <span class=\"token parameter variable\">--output</span> <span class=\"token string\">\"/usr/share/keyrings/openmediavault-archive-keyring.gpg\"</span></pre></td></tr></table></figure><p>4、更新软件包源并安装 omv</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt-get</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt-get</span> <span class=\"token parameter variable\">--yes</span> --auto-remove --show-upgraded <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>    --allow-downgrades --allow-change-held-packages <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>    --no-install-recommends <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token parameter variable\">--option</span> DPkg::Options::<span class=\"token operator\">=</span><span class=\"token string\">\"--force-confdef\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token parameter variable\">--option</span> DPkg::Options::<span class=\"token operator\">=</span><span class=\"token string\">\"--force-confold\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>    <span class=\"token function\">install</span> openmediavault</pre></td></tr></table></figure><p>5、同步系统配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-confdbadm populate</pre></td></tr></table></figure><p>note：</p>\n<p>对于网络服务，现在只解析  <code>/etc/network/interfaces</code>  以获取当前的网络配置。 如果以不同的方式配置网络（例如通过  <code>systemd</code>  或  <code>NetworkManager</code> ），则不会填充数据库，并且不包含使用  <code>netplan for systemd-networkd 和 systemd-resolved</code>  部署网络配置所需的信息。 在这种情况下，请使用  <code>omv-firstaid</code>  命令执行初始网络配置。</p>\n<p>如果想通过 openmediavault 使用的服务重新部署网络配置，则执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> /etc/network/interfaces</pre></td></tr></table></figure><p>然后把里面的网卡配置用  <code>#</code>  注释掉，接着：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">rm</span> /etc/systemd/network/*</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>netplan apply</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-salt deploy run systemd-networkd</pre></td></tr></table></figure><h2 id=\"omv6-基本配置\"><a class=\"anchor\" href=\"#omv6-基本配置\">#</a> omv6 基本配置</h2>\n<h2 id=\"用户账户设置\"><a class=\"anchor\" href=\"#用户账户设置\">#</a> 用户账户设置</h2>\n<p>安装完 omv 后，如果有使用  <code>同步系统配置</code>  操作，那么，在  <code>用户</code>  -&gt;  <code>用户</code>  管理中可以看到前面安装系统时创建的用户，之后，你可以在这里创建或修改各类用户；为了安全你也可以禁掉 root 用户，以避免 root 登录，需要注意权限问题，避免登录 omv web 无法操作。</p>\n<p>note：如果存在多个用户，在众多用户里，至少要有一个用户添加到  <code>openmediavault-admin</code>  的  <code>ssh group</code>  中，这将决定在登录 omv web 后是否拥有配置操作，否则任意用户登录 omv web 上都不存完整的配置操作。具体可看 <strong>omv 登陆后界面只剩仪表盘</strong> 。</p>\n<h2 id=\"配置-ssh\"><a class=\"anchor\" href=\"#配置-ssh\">#</a> 配置 SSH</h2>\n<p>进入  <code>服务</code>  -&gt;  <code>SSH</code> ，选择勾选  <code>已启用</code>  选项，接着按个人需求修改配置，同时为能 SSH 登录操作的用户添加到  <code>ssh group</code>  ；如果你想为了安全，而选择关闭  <code>允许 root 登陆</code>  和  <code>密码验证</code>  选项，那么需要注意的是，至少要为一个用户添加  <code>ssh group</code>  ，否则将没有用户可以登录 SSH，同时为用户配置好 SSH 密钥对。</p>\n<p>note：SSH 密钥对生成，需要先在本机系统中（即需要控制的机器上，一般就是我们的 windows 系统上），输入  <code>ssh-keygen</code>  命令，然后输入存储的路径及命名  <code>~/.ssh/omv-id_rsa</code>  ，如果需要为调用私钥而添加密码认证，则输入密码，否者直接留空回车，不设密码，最后再次确认回车，至此就生成了 SSH 密钥对了；紧接着在 omv web 的  <code>用户</code>  -&gt;  <code>用户</code>  中选择你需要进行 SSH 密钥登录的账户，然后编辑，在  <code>SSH 公钥</code>  中添加刚才生成的密钥对中的公钥（即  <code>omv-id_rsa.pub</code>  ），至此就完成了。</p>\n<h2 id=\"创建-raid-软阵列\"><a class=\"anchor\" href=\"#创建-raid-软阵列\">#</a> 创建 Raid 软阵列</h2>\n<p>在这里，不选择在 omv 页面上创建，而是使用命令创建。以 Raid 1 为例：</p>\n<ol>\n<li>\n<p>准备两个硬盘，最好使用同型号的不同批次跟产期的，如果选择不同型号的，那么要考虑转速、缓存、容量这些尽可能一致。</p>\n</li>\n<li>\n<p><code>lsblk</code>  获取需要建立 Raid 的磁盘名称  <code>sdx</code>  （sdx 可以为 sda、sdb 等）。</p>\n</li>\n<li>\n<p>使用  <code>fdisk /dev/sdx</code>  分别为两块磁盘创建单一分区。</p>\n<ul>\n<li><code>m</code>  ：查看命令操作。</li>\n<li><code>d</code>  ：删除已有分区。</li>\n<li><code>n</code>  ：创建新的分区。</li>\n<li><code>p</code>  ：查看创建分区。</li>\n<li><code>w</code>  ：应用分区信息。</li>\n</ul>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>按 n 创建新的分区。</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>然后按 p 选择主分区。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>接下来选择分区号为 1。</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>按两次回车键默认将整个容量分配给它。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>然后，按 p 来打印创建好的分区。</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>按 l，列出所有可用的类型。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>按 t 修改分区类型。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>键入 29 设置为 Linux 的 RAID 类型，然后按 Enter 确认。</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>然后再次使用 p 查看我们所做的更改。</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>使用 w 保存更改。</pre></td></tr></table></figure></li>\n<li>\n<p>利用  <code>mdadm</code>  命令建立 Raid 软阵列。</p>\n<ul>\n<li>\n<p>检查 sdx 分区并确认 Raid 分区的类型  <code>mdadm -E /dev/sdx</code>  。</p>\n</li>\n<li>\n<p>假设用  <code>dev/sdb1</code>  和  <code>dev/sdc1</code>  两个磁盘创建一个名为  <code>/dev/md0</code>  的 Raid 1 设备  <code>mdadm --create /dev/md0 --level=1 --raid-device=2 /dev/sd[b-c]1</code>  。</p>\n</li>\n<li>\n<p>查看 Raid 同步状态  <code>cat /proc/mdstat</code>  。初次建立构建，需要很长一段时间。可以通过以下命令调整 Raid 同步速度：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-w</span> <span class=\"token assign-left variable\">dev.raid.speed_limit_max</span><span class=\"token operator\">=</span><span class=\"token number\">2000000</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-w</span> <span class=\"token assign-left variable\">dev.raid.speed_limit_min</span><span class=\"token operator\">=</span><span class=\"token number\">100000</span></pre></td></tr></table></figure></li>\n<li>\n<p>使用  <code>mdadm -E /dev/sdx1</code>  分别查看 Raid 设备类型。</p>\n</li>\n<li>\n<p>为  <code>dev/md0</code>  创建 ext4 文件系统  <code>mkfs.ext4 /dev/md0</code>  ，最好等初始化构建完成后操作。</p>\n</li>\n<li>\n<p>检查 Raid 信息  <code>mdadm -D /dev/md0</code>  。</p>\n</li>\n</ul>\n</li>\n</ol>\n<p>常见的 RAID 磁盘阵列：</p>\n<table>\n<thead>\n<tr>\n<th>阵列</th>\n<th>描述</th>\n<th>特点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>JBOD（线性）</td>\n<td>JBOD 不是标准的 RAID 级别，它只是在近几年才被一些厂家提出，并被广泛采用。虽然 JBOD 让多个磁盘看来似乎只有一个，但它是通过把多个驱动器合并成一个大的逻辑磁盘来做到这一点的。</td>\n<td>- 任意一块硬盘损坏，整个 JBOD 都无法使用。&lt;br/&gt;- 未损坏的硬盘上的数据不会丢失，但恢复数据存在门槛。</td>\n</tr>\n<tr>\n<td>RAID 0</td>\n<td>RAID 0 是组建磁盘阵列中最简单的一种形式，只需要 2 块以上的硬盘即可。 RAID 0 是 RAID 磁盘阵列中性能最好的硬盘组合方式，但没有提供冗余或错误修复能力。</td>\n<td>按照一定规则，将文件拆分存储在 RAID 0 中，一旦一块硬盘损坏，整个 RAID 0 的所有数据全部丢失。</td>\n</tr>\n<tr>\n<td>RAID 1（镜像）</td>\n<td>RAID 1 称为磁盘镜像，由至少 2 块硬盘组成。原理是把一个磁盘的数据镜像到另一个磁盘上，也就是说数据在写入一块磁盘的同时，会在另一块闲置的磁盘上生成镜像文件。只要系统中任何一对镜像盘中至少有一块磁盘可以使用，甚至可以在一半数量的硬盘出现问题时系统都可以正常运行。它是 RAID 磁盘阵列中性能最差，数据安全性最佳的。</td>\n<td>会损失一半硬盘容量。</td>\n</tr>\n<tr>\n<td>RAID 5</td>\n<td>RAID 5 被称为 “分布式奇偶校验的独立磁盘结构” ，需最低 3 块硬盘组成。&lt;br/&gt; 每在 RAID 5 中存入一个文件，3 块硬盘中：1 块用于存储该文件；2 块用于生成奇偶校验信息。</td>\n<td>只要 RAID 5 中只有 1 块硬盘损坏，就可以替换该硬盘并恢复数据；会损失 1 块硬盘容量。</td>\n</tr>\n<tr>\n<td>RAID 6</td>\n<td>RAID 6 是对 RAID 5 的扩展，需最低 4 块硬盘组成。&lt;br/&gt; 每在 RAID 6 中存入一个文件，4 块硬盘中：2 块用于存储该文件；2 块用于生成奇偶校验信息。</td>\n<td>只要 RAID 6 中有任意 2 块硬盘损坏，就可以替换这 2 块硬盘并恢复数据；会损失 2 块硬盘容量。</td>\n</tr>\n<tr>\n<td>RAID 10</td>\n<td>RAID 10 需要至少 4 块硬盘组成，每 2 块硬盘组成一个 RAID 1 ，2 个 RAID 1 组成一个 RAID 0 。性能与安全性在 RAID 0 和 RAID 1 中取得了一个平衡。</td>\n<td>性能比 RAID 0 差，比 RAID 1 高；安全性同于 RAID 1 。</td>\n</tr>\n</tbody>\n</table>\n<p>扩展：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZmVsaXgtenAvcC85NzM4NzI0Lmh0bWw=\">https://www.cnblogs.com/felix-zp/p/9738724.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZmx5c2ZlcS5zaXRlL2luZGV4LnBocC9hcmNoaXZlcy82NS8=\">https://www.flysfeq.site/index.php/archives/65/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vMzd5YW4vcC83NDg5NTk3Lmh0bWw=\">https://www.cnblogs.com/37yan/p/7489597.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbHBmdXR1cmUvcC82Mzg1NjU3Lmh0bWw=\">https://www.cnblogs.com/lpfuture/p/6385657.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC1hdGxhcy5yZWFkdGhlZG9jcy5pby96aC1jbi9sYXRlc3QvbGludXgvc3RvcmFnZS9zb2Z0d2FyZV9yYWlkL3JhaWQtY2hlY2suaHRtbA==\">https://cloud-atlas.readthedocs.io/zh-cn/latest/linux/storage/software_raid/raid-check.html</span></p>\n<h2 id=\"替换更新镜像源\"><a class=\"anchor\" href=\"#替换更新镜像源\">#</a> 替换更新镜像源</h2>\n<p>配置基本链接的镜像源（原因是在你安装完 omv 后，前面配置的软件包存储库链接将会修改为官方默认的链接，此时需要重新设置镜像）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-env <span class=\"token builtin class-name\">set</span> OMV_APT_REPOSITORY_URL <span class=\"token string\">\"https://mirrors.bfsu.edu.cn/OpenMediaVault/public\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-env <span class=\"token builtin class-name\">set</span> OMV_APT_ALT_REPOSITORY_URL <span class=\"token string\">\"https://mirrors.bfsu.edu.cn/OpenMediaVault/packages\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-env <span class=\"token builtin class-name\">set</span> OMV_APT_KERNEL_BACKPORTS_REPOSITORY_URL <span class=\"token string\">\"https://mirrors.bfsu.edu.cn/debian\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-env <span class=\"token builtin class-name\">set</span> OMV_APT_SECURITY_REPOSITORY_URL <span class=\"token string\">\"https://mirrors.bfsu.edu.cn/debian-security\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-salt stage run all</pre></td></tr></table></figure><p>然后执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr></table></figure><p>重启后回到 omv 网页，你会看到有提示显示可以更新软件。</p>\n<p>note：</p>\n<p>对于使用  <code>omv-env set</code>  更换源，其实是在不同的  <code>openmediavault</code>  文件写入，这些文件可以在  <code>/etc/apt/sources.list.d/</code>  中找到。</p>\n<h2 id=\"安装-omv-extras\"><a class=\"anchor\" href=\"#安装-omv-extras\">#</a> 安装 omv-extras</h2>\n<p>由于国内原因，防 github 解析错误，执行以下操作，如果这时候已经出现网络问题，则使用手动方法，查看 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tLzUyMXh1ZXdlaWhhbi9HaXRIdWI1MjA=\">GitHub520</span> ：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"/# GitHub520 Host Start/Q\"</span> /etc/hosts <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">curl</span> https://raw.hellogithub.com/hosts <span class=\"token operator\">>></span> /etc/hosts</pre></td></tr></table></figure><p>根据<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLm9tdi1leHRyYXMub3JnL2Rva3UucGhwP2lkPW9tdjY6bmV3X3VzZXJfZ3VpZGUjb212LWV4dHJhcw==\">官方</span>提供，安装 omv-extras：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">wget</span> <span class=\"token parameter variable\">-O</span> - https://github.com/OpenMediaVault-Plugin-Developers/packages/raw/master/install <span class=\"token operator\">|</span> <span class=\"token function\">bash</span></pre></td></tr></table></figure><p>然后刷新 omv 网页，即可在  <code>系统</code>  中找到 omv-extras。</p>\n<p>如果网络不好可以手动安装：</p>\n<ol>\n<li>进入 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL09wZW5NZWRpYVZhdWx0LVBsdWdpbi1EZXZlbG9wZXJzL3BhY2thZ2Vz\">https://github.com/OpenMediaVault-Plugin-Developers/packages</span> 下载对应的插件包，然后把插件包放到 omv 上，路径自己决定，然后进入该路径执行：</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>dpkg <span class=\"token parameter variable\">-i</span> openmediavault-omvextrasorg_xxx.deb</pre></td></tr></table></figure><p>更新 omv-extras 镜像源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-env <span class=\"token builtin class-name\">set</span> OMV_EXTRAS_APT_REPOSITORY_URL <span class=\"token string\">\"https://mirrors.bfsu.edu.cn/OpenMediaVault/openmediavault-plugin-developers\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-env <span class=\"token builtin class-name\">set</span> OMV_DOCKER_APT_REPOSITORY_URL <span class=\"token string\">\"https://mirrors.bfsu.edu.cn/docker-ce/linux/debian\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-env <span class=\"token builtin class-name\">set</span> OMV_PROXMOX_APT_REPOSITORY_URL <span class=\"token string\">\"https://mirrors.bfsu.edu.cn/proxmox/debian\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>omv-salt stage run all</pre></td></tr></table></figure><h2 id=\"安装-docker\"><a class=\"anchor\" href=\"#安装-docker\">#</a> 安装 docker</h2>\n<p>进入  <code>系统</code>  -&gt;  <code>插件</code> ，搜索  <code>compose</code>  ，点击选择下载，然后等待下载完成；</p>\n<p>进入  <code>系统</code>  -&gt;  <code>omv-extras</code> ，勾选  <code>Docker repo</code> ，点保存；</p>\n<p>最后在  <code>服务</code>  -&gt;  <code>Compose</code>  中可以找到  <code>设置</code> ，查看 Docker 状态是否为  <code>Installed and running</code> ，如果不是，可以尝试重启 Docker 或者重新安装 Docker；再不行就回到第二点先取消勾选接着保存，然后再把   <code>Docker repo</code>  勾选上保存并重复后面操作。</p>\n<p>参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLm9tdi1leHRyYXMub3JnL2Rva3UucGhwP2lkPW9tdjY6ZG9ja2VyX2luX29tdiNkb2t1d2lraV9fdG9w\">https://wiki.omv-extras.org/doku.php?id=omv6:docker_in_omv#dokuwiki__top</span></p>\n<p>如果 Docker 无法运行，输入  <code>systemctl status docker</code>  查看状态，然后再执行  <code>systemctl restart docker</code>  看是否成功，如果显示如下错误：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Job for docker.service failed because the control process exited with error code.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>See \"systemctl status docker.service\" and \"journalctl -xe\" for details.</pre></td></tr></table></figure><p>可以使用命令  <code>journalctl -xe</code>  和  <code>dockerd --debug</code>  来分析无法运行的错误。</p>\n<p>参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTU5MDY1MDMvZG9ja2VyLWhvdy10by1maXgtam9iLWZvci1kb2NrZXItc2VydmljZS1mYWlsZWQtYmVjYXVzZS10aGUtY29udHJvbC1wcm9jZXNzLWV4\">https://stackoverflow.com/questions/55906503/docker-how-to-fix-job-for-docker-service-failed-because-the-control-process-ex</span></p>\n<h3 id=\"docker-换源\"><a class=\"anchor\" href=\"#docker-换源\">#</a> docker 换源</h3>\n<p>编辑  <code>/etc/docker/daemon.json</code>  配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> /etc/docker/daemon.json</pre></td></tr></table></figure><p>更改为以下信息：</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"><span>daemon.json</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">\"data-root\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"/var/lib/docker\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//docker 存储路径</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">\"registry-mirrors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span> <span class=\"token comment\">// 更改换源</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token property\">\"storage-driver\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"overlay2\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token property\">\"storage-opts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token string\">\"overlay2.override_kernel_check=true\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token string\">\"overlay2.size=15G\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token property\">\"log-driver\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"json-file\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token property\">\"log-opts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token property\">\"max-size\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"80m\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token property\">\"max-file\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>note：如果是在  <code>/etc/docker/daemon.json</code>  文件上指定 Docker 存储路径，那么，在  <code>服务</code>  -&gt;  <code>Compose</code>  -&gt;  <code>设置</code>  -&gt;  <code>Docker</code>  中的  <code>Docker 存储</code>  上留空配置（该下方有备注说明）。</p>\n<p>最后，使用如下命令重启生效：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>systemctl restart <span class=\"token function\">docker</span></pre></td></tr></table></figure><p>完成后使用  <code>docker info</code>  命令，查看  <code>Registry Mirrors:</code>  是否为配置的镜像源。</p>\n<p>测试 docker 镜像下载，可以通过拉取 helloword 镜像测试：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">docker</span> pull helloword</pre></td></tr></table></figure><p>如果成功拉取则证明当前配置能成功链接上 docker hub 镜像网上，否则则需要检查网络及镜像源是否有效。</p>\n<h2 id=\"docker-应用部署\"><a class=\"anchor\" href=\"#docker-应用部署\">#</a> docker 应用部署</h2>\n<p>安装完 docker 后，那么你就可以用它部署各种好玩的应用，例如：私人影院、音乐播放、相册管理等；</p>\n<p><a href=\"https://arachnid.cc/tags/docker/\">https://arachnid.cc/tags/docker/</a></p>\n<h1 id=\"other\"><a class=\"anchor\" href=\"#other\">#</a> other</h1>\n<h2 id=\"omv-登陆后界面只剩仪表盘\"><a class=\"anchor\" href=\"#omv-登陆后界面只剩仪表盘\">#</a> omv 登陆后界面只剩仪表盘</h2>\n<p>一般会出现这种情况是因为更换了用户，但管理权限没有给过去，或者以非管理员登录等，总之就是登录用户没有足够的权限，如果你还禁止了 root 登录，那么你可以使用如下命令把权限给到你要登录的用户  <code>USER_NAME</code>  上：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">usermod</span> <span class=\"token parameter variable\">-a</span> <span class=\"token parameter variable\">-G</span> openmediavault-admin USER_NAME</pre></td></tr></table></figure><p>参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9mb3J1bS5vcGVubWVkaWF2YXVsdC5vcmcvaW5kZXgucGhwP3RocmVhZC80NTQ0My1vbXY2LXdlYi1ndWktb25seS13aXRoLWRhc2hib2FyZC1sb3N0LWV2ZXJ5dGhpbmctYW5kLWktbS1hZG1pbi11c2VyLw==\">https://forum.openmediavault.org/index.php?thread/45443-omv6-web-gui-only-with-dashboard-lost-everything-and-i-m-admin-user/</span></p>\n<h2 id=\"devdm-文件系统\"><a class=\"anchor\" href=\"#devdm-文件系统\">#</a> /dev/dm-* 文件系统</h2>\n<p>dm 是 Device Mapper 的缩写，Device Mapper 是 Linux 2.6 内核中提供的一种从逻辑设备到物理设备的映射框架机制，在该机制下，用户可以很方便的根据自己的需要制定实现存储资源的管理策略，当前比较流行的 Linux 下的逻辑卷管理器如 LVM2（Linux Volume Manager 2 version)、EVMS (Enterprise Volume Management System)、dmraid (Device Mapper Raid Tool) 等都是基于该机制实现的。</p>\n<p>既然是映射，那么就有对应关系，那到底对应着什么，可以使用如下命令查看：</p>\n<ol>\n<li><code>dm-*</code>  一般是在  <code>/dev</code>  文件夹里，而且还不止一个，可以使用  <code>ls /dev/dm*</code>  查看所有  <code>dm</code>  设备映射。</li>\n<li>使用命令  <code>dmsetup ls</code>  查看  <code>dm-*</code>  对应的设备，其中  <code>dm</code>  后面的数字对应（xxx， xx）里的第二个数字。如果想详细查看信息，可以使用  <code>dmsetup info</code>  命令，而  <code>Major, minor:</code>  对应 （xxx， xx）。</li>\n<li>输入  <code>more /etc/fstab</code>  命令查找对应关系，如此便能找到映射点。</li>\n</ol>\n<h2 id=\"挂载新硬盘文件系统失败\"><a class=\"anchor\" href=\"#挂载新硬盘文件系统失败\">#</a> 挂载新硬盘文件系统失败</h2>\n<p>这里导致出现的问题是新硬盘替换旧硬盘，然后旧硬盘可能有共享、引用之类的，因此在旧硬盘不存在的情况下，当你为新硬盘建立了文件系统后，并为其挂载保存的的时候，会出现无法保存并挂载成功，这时候就必须先把旧的不存在的硬盘的文件系统卸载掉先，否者会影响新的文件系统挂载；而如果旧的文件系统是有使用共享服务的，那么需要根据其依赖关系（ <code>磁盘</code>  -&gt;  <code>文件系统</code>  -&gt;  <code>共享文件夹</code>  -&gt;  <code>服务(SMB, FTP等)</code> ）逐步解除并保证卸载成功，这样才可以为新的硬盘挂载文件系统。</p>\n<h2 id=\"手动测试硬盘\"><a class=\"anchor\" href=\"#手动测试硬盘\">#</a> 手动测试硬盘</h2>\n<ol>\n<li>使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYW4uYXJjaGxpbnV4Lm9yZy9tYW4vc21hcnRjdGwuOA==\">smartctl</span> 分析硬盘\n<ul>\n<li><code>smartctl -i /dev/sdxy</code>  显示磁盘基本信息。</li>\n<li><code>smartctl -H /dev/sdxy</code>  显示硬盘的健康状况。</li>\n<li><code>smartctl -A /dev/sdxy</code>  显示硬盘的详细信息。</li>\n<li><code>smartctl -t short /dev/sdxy</code>  后台检测硬盘，消耗时间短，用第二条命令查看结果。</li>\n<li><code>smartctl -t long /dev/sdxy</code>  后台检测硬盘，消耗时间长，用第二条命令查看结果。</li>\n<li><code>smartctl -l selftest /dev/sdxy</code>  显示硬盘检测日志。</li>\n<li><code>smartctl -l error /dev/sda</code>  显示硬盘错误汇总。</li>\n</ul>\n</li>\n<li>使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYW4uYXJjaGxpbnV4Lm9yZy9tYW4vYmFkYmxvY2tzLjg=\">badblocks</span> 扫描硬盘\n<ul>\n<li><code>badblocks -sv -b 512 -o ~/sdx_blocks.txt /dev/sdx</code>  前台显示扫描进度，并将结果保存到文档上。</li>\n<li>-b, 指定磁盘区块大小，单位 byte，理解为最小扫描单位。（如果显示： <code>badblocks: Value too large for defined data type invalid end block (15628053168): must be 32-bit value</code>  则说明设置的 block 大小太小了，可用  <code>fdisk -l /dev/sdx </code>  查看硬盘 block 最小区块大小）</li>\n<li>-o, 指定扫描结果的输出路径</li>\n<li>-s, 检查时显示进度</li>\n<li>-v, 检查时显示详细的信息</li>\n<li>-w, 检查时执行有破坏性的写入测试，注意这个操作会破坏硬盘上的数据，请提前做好数据备份</li>\n<li>-n, 检查时执行没有破坏性的写入测试，只读操作</li>\n</ul>\n</li>\n<li>使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYW4uYXJjaGxpbnV4Lm9yZy9tYW4vaGRwYXJtLjg=\">hdparm</span> 测硬盘读速\n<ul>\n<li><code>hdparm -Ttv /dev/sdxy</code>  该命令将显示磁盘的缓存和读性能。</li>\n<li><code>hdparm -tv --direct /dev/sdxy</code>  添加  <code>--direct</code>  选项将绕过硬盘驱动器的缓冲区高速缓存，从而直接从磁盘读取。</li>\n</ul>\n</li>\n<li>使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYW4uYXJjaGxpbnV4Lm9yZy9tYW4vZGQuMQ==\">dd</span> 测硬盘写速\n<ul>\n<li><code>sync; dd if=/dev/zero of=/srv/dev-disk-by-uuid-xxx/tempfile bs=1M count=5120; sync</code>  以 1MByte 为单位，写入 5120 次，即写入往 tempfile 文件写入 5GB 大小的零数据值。</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"omv-开关机导致硬盘不安全计数增加\"><a class=\"anchor\" href=\"#omv-开关机导致硬盘不安全计数增加\">#</a> omv 开关机导致硬盘不安全计数增加</h2>\n<p>在 SCSI disk 中，有一个  <code>manage_start_stop</code>  flag，它可以控制 disk 的启停，将该值置 1 的时候，将使得 disk 减速关闭，从而让 disk 关机时磁头会复位；如果关机时 disk 磁头不复位直接断电，就会有磁头弹回去的声音，并且这种情况下，硬盘的 SMART 数据里，C0（不安全关机计数）的值应该会 +1，硬盘也有损坏的风险。</p>\n<p>因此，正常情况下，普通 SATA 硬盘的这项属性的值默认为 1，关机时磁头会复位。可以通过下面的命令查看所有磁盘这项属性的值：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cat</span> /sys/class/scsi_disk/*/manage_start_stop</pre></td></tr></table></figure><p>如果上面的文件不存在，可以使用以下命令查看：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cat</span> /sys/block/sdX/device/scsi_disk/*/manage_start_stop</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># sdX 为对应硬盘符</span></pre></td></tr></table></figure><p>然后，对于修改，可以使用：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> /sys/class/scsi_disk/*/manage_start_stop<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token number\">1</span> <span class=\"token operator\">></span> <span class=\"token variable\">$i</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><p>对所有的 SCSI disk 进行更改，同样的，可以把该条命令增加至开机脚本，使其每次生效。</p>\n<p>参考：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGludXgtYXRhLm9yZy9zaHV0ZG93bi5odG1s\">Serial ATA (SATA) shutdown info</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9yb21hY28uY2EvYmxvZy8yMDE3LzA4LzA2L2hvdy10by1zcGluLWRvd24taGFyZC1kaXNrcy1hdC1zaHV0ZG93bi1vbi1sc2ktaGJhcy1vbi1saW51eC8=\">How To Spin Down Hard Disks at Shutdown on LSI HBAs on Linux</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RvcnZhbGRzL2xpbnV4L2NvbW1pdC8zY2MyZmZlNWMxNmRjNjVkZmFjMzU0YmM1YjViYzk4ZDNiMzk3NTY3\">https://github.com/torvalds/linux/commit/3cc2ffe5c16dc65dfac354bc5b5bc98d3b397567</span></p>\n<h2 id=\"硬盘-apm-及-aam-设置\"><a class=\"anchor\" href=\"#硬盘-apm-及-aam-设置\">#</a> 硬盘 APM 及 AAM 设置</h2>\n<p>在 omv wed 的  <code>存储器</code>  -&gt;  <code>磁盘</code>  -&gt;  <code>编辑</code>  中，存在 APM（高级电源管理）和 AAM（自动声音管理）。AAM（Automactic acoustics management）自动噪声管理，指通过调整硬盘盘片转速在安静和高性能之间切换；APM（Advanced power management）高级电源管理，即调节硬盘的睡眠状态，有利于节省移动设备的电能。</p>\n<p>所以，适当降低 AAM 有利于降低转速，实现噪声的控制，增大 APM 有利于杜绝硬盘进入睡眠，从而避免磁头频繁进出停泊区产生摩擦噪音。</p>\n<p>对于  APM/AAM 信息的获取，可以使用以下命令查看：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre>hdparm <span class=\"token parameter variable\">-B</span> <span class=\"token parameter variable\">-M</span> /dev/sdX</pre></td></tr></table></figure><p>如果您的驱动器不支持 AAM，您将收到消息： <code>APM_level=not support</code>  ；</p>\n<p>如果您的驱动器不支持 AAM，您将收到消息： <code>acoustic=not support</code>  。</p>\n<p>然后根据实际情况，在 omv wed 的  <code>存储器</code>  -&gt;  <code>磁盘</code>  -&gt;  <code>编辑</code>  中进行设置。</p>\n<h2 id=\"权限管理\"><a class=\"anchor\" href=\"#权限管理\">#</a> 权限管理</h2>\n<h3 id=\"共享权限\"><a class=\"anchor\" href=\"#共享权限\">#</a> 共享权限</h3>\n<p>FTP/SMB 服务共享权限 (OMV 系统) &lt; 用户权限 (OMV 系统) &lt; 文件夹 / 文件权限 &lt; ACL 特殊权限</p>\n<p>eg：</p>\n<ol>\n<li>当 “共享文件夹 A” 权限缺少  <code>r</code>  读权限时，即使” 用户权限” 设置了  <code>rw</code>  读写也无法列出该文件夹里的内容。</li>\n<li>如果 “用户 B” 对 “共享文件夹 C” 设置了 “禁止读写”，即使该文件夹权限是  <code>rwx</code>  读写执行，也无法打开 “共享文件夹 C” 。</li>\n</ol>\n<h3 id=\"登录权限\"><a class=\"anchor\" href=\"#登录权限\">#</a> 登录权限</h3>\n<p>该权限主要是服务器管理处理，除了上面的禁用 ssh 上的 root 登录及私钥访问，还应禁用避免使用  <code>su</code>  和  <code>sudo</code>  切换到 root 用户。</p>\n<ul>\n<li>\n<p>禁用  <code>su</code>  命令：</p>\n<ul>\n<li>\n<p>修改  <code>/etc/pam.d/su</code>  配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> /etc/pam.d/su</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 去除以下注释</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>auth required pam_wheel.so</pre></td></tr></table></figure></li>\n<li>\n<p>修改  <code>/etc/login.defs</code>  配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> /etc/login.defs</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 找到 SU_WHEEL_ONLY 定义并改写成以下配置</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>SU_WHEEL_ONLY <span class=\"token function\">yes</span></pre></td></tr></table></figure></li>\n</ul>\n<p>如此一来，只有指定加入  <code>wheel</code>  group 的用户才能使用  <code>su</code>  命令，同样也就禁用了  <code>su -</code>  切换 root 了；</p>\n</li>\n<li>\n<p>禁用  <code>su -</code>  命令：</p>\n<p>如果觉得禁用  <code>su</code>  该操作覆盖范围太大了，可以通过  <code>visudo</code>  命令修改  <code>/etc/sudoers</code>  文件，对指定的用户或群组进行限制，eg：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>sudoers</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre># User privilege specification</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>admin   ALL=(ALL:ALL)     ALL, !/usr/bin/su -</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre># Allow members of group sudo to execute any command</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>%wheel  ALL=(ALL:ALL)     ALL, !/usr/bin/su -</pre></td></tr></table></figure><p>以上例子分别表示对  <code>admin</code>  用户及  <code>wheel</code>  群组做了  <code>su -</code>  命令限制。</p>\n</li>\n<li>\n<p>禁用  <code>sudo</code>  升权：</p>\n<p>一般来说，除了安装系统的时候配置的用户拥有  <code>sudo</code>  权限，后期创建用户时，除非明确加入  <code>sudo</code>  组或改写  <code>/etc/sudoers</code>  文件配置，否则是不支持  <code>sudo</code>  命令操作的。</p>\n</li>\n<li>\n<p>防止  <code>sudo su -</code>  直接串权：</p>\n<p>虽说利用  <code>sudo</code>  升权后，同样拥有 root 权限，但与实际登录 root 账户有所区别，毕竟使用  <code>sudo</code>  是有操作记录的，而直接 root 登录后无法跟踪其操作。</p>\n<p>通过设置上面的 &quot;<strong> 禁用  <code>su</code>  命令</strong> &quot;或&quot;<strong> 禁用  <code>su -</code>  命令</strong> &quot; ，同样可以防止  <code>sudo su -</code>  操作，但无法防止  <code>sudo -</code>  后执行  <code>su -</code>  切换到 root 环境，如果要禁掉该操作，可以简单粗暴的使用上面的 &quot; 禁用  <code>sudo</code>  升权 &quot; 操作，或者通过修改  <code>vim /etc/pam.d/su</code>  文件进行滤除操作。</p>\n</li>\n<li>\n<p>root 用户禁用：</p>\n<p><strong>（注意：在进行该操作前要至少确保有一个用户可以提权到 root 权限，以避免出现没有超级权限的可能。）</strong></p>\n<p>除了在 omv web 的  <code>服务</code>  -&gt;  <code>SSH</code>  中禁用 root 登录外，还可以在用户配置上禁用 root 账号，使其无法使用登录（包括本机终端登录）。通过执行以下命令：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 查看 root 帐号密码信息，第二个字符 P 表示有密码</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">passwd</span> <span class=\"token parameter variable\">-S</span> root</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>root P 01/22/2024 <span class=\"token number\">0</span> <span class=\"token number\">99999</span> <span class=\"token number\">7</span> <span class=\"token parameter variable\">-1</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 删除 root 密码</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">passwd</span> <span class=\"token parameter variable\">-d</span> root</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>passwd: password expiry information changed.</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 确认删除密码，此时第二个字符为 NP 即 No Password</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">passwd</span> <span class=\"token parameter variable\">-S</span> root</pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>root NP 01/22/2024 <span class=\"token number\">0</span> <span class=\"token number\">99999</span> <span class=\"token number\">7</span> <span class=\"token parameter variable\">-1</span></pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 禁用锁定 root 帐号</span></pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">passwd</span> <span class=\"token parameter variable\">-l</span> root</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre>passwd: password expiry information changed.</pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 确认删除密码，此时第二个字符为 L 即 Lock</span></pre></td></tr><tr><td data-num=\"18\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">passwd</span> <span class=\"token parameter variable\">-S</span> root</pre></td></tr><tr><td data-num=\"19\"></td><td data-command=\"\"></td><td><pre>root L 01/22/2024 <span class=\"token number\">0</span> <span class=\"token number\">99999</span> <span class=\"token number\">7</span> <span class=\"token parameter variable\">-1</span></pre></td></tr></table></figure></li>\n</ul>\n<p>note：</p>\n<p>关于查看  <code>sudo</code>  执行操作信息，可通过  <code>cat /var/log/auth.log</code>  命令查看，对于文件内大量出现  <code>pam_unix(cron:session): session opened for user root by (uid=0)</code>  的解决办法，通过以下操作滤除信息：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> /etc/pam.d/common-session-noninteractive</pre></td></tr></table></figure><p>找到下行：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>session required        pam_unix.so</pre></td></tr></table></figure><p>在其上一行添加：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>session     [success=1 default=ignore] pam_succeed_if.so service in cron quiet use_uid</pre></td></tr></table></figure><p>保存退出后，重启 crond 服务：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">service</span> <span class=\"token function\">cron</span> restart</pre></td></tr></table></figure><p>参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYXp1cmVvbG9neS9wLzE1MTE0Njg2Lmh0bWw=\">auth.log 大量出现 pam_unix (cron:session): session opened for user root by (uid=0) 解决办法</span></p>\n",
            "tags": [
                "Linux",
                "nas"
            ]
        },
        {
            "id": "https://arachnid.cc/linux_c-time-configuration/",
            "url": "https://arachnid.cc/linux_c-time-configuration/",
            "title": "Linux c 时间时区配置",
            "date_published": "2023-06-21T15:54:38.000Z",
            "content_html": "<h1 id=\"时间与日期\"><a class=\"anchor\" href=\"#时间与日期\">#</a> 时间与日期</h1>\n<p><strong>GMT 和 UTC</strong></p>\n<p>GMT，即格林尼治标准时间，也就是世界时。GMT 的正午是指当太阳横穿格林尼治子午线（本初子午线）时的时间。但由于地球自转不均匀不规则，导致 GMT 不精确，现在已经不再作为世界标准时间使用。</p>\n<p>UTC，即协调世界时。UTC 是以原子时秒长为基础，在时刻上尽量接近于 GMT 的一种时间计量系统。为确保 UTC 与 GMT 相差不会超过 0.9 秒，在有需要的情况下会在 UTC 内加上正或负闰秒。UTC 现在作为世界标准时间使用。</p>\n<p>所以，UTC 与 GMT 基本上等同，误差不超过 0.9 秒。</p>\n<p><strong>时区</strong></p>\n<p>地球自西向东旋转，东边比西边先看到太阳，东边的时间也比西边的早。为了统一世界的时间，1884 年的国际经度会议规规定将全球划分为 24 个时区（东、西各 12 个时区）。规定英国（格林尼治天文台旧址）为零时区（GMT+00），东 1-12 区，西 1-12 区，中国北京处于东 8 区（GMT+08）。</p>\n<p>若中国当前时间为 8 点整，则英国时间为 0 点整。</p>\n<p><strong>UTC 时间与本地时间</strong></p>\n<p>UTC + 时区差 = 本地时间</p>\n<p>时区差东为正，西为负。在此，把东八区时区差记为  <code>+08</code></p>\n<p>UTC + (+08) = 本地（北京）时间</p>\n<p><strong>UNIX 时间戳</strong></p>\n<p>由 Unix 内核提供的基本时间服务是自国际标准时间公元 1970 年 1 月 1 日 00:00:00 以来的秒数。</p>\n<h1 id=\"时间及时区查看命令\"><a class=\"anchor\" href=\"#时间及时区查看命令\">#</a> 时间及时区查看命令</h1>\n<ul>\n<li>获取 UTC 世界时间</li>\n</ul>\n<p><code>date -u</code></p>\n<ul>\n<li>获取当地时间</li>\n</ul>\n<p><code>date</code></p>\n<ul>\n<li>获取当地时间及时差</li>\n</ul>\n<p><code>date -R</code></p>\n<h1 id=\"时区设置命令\"><a class=\"anchor\" href=\"#时区设置命令\">#</a> 时区设置命令</h1>\n<p><strong>1、对于完整的 Linux 系统</strong></p>\n<ol>\n<li>命令跟描述对不上号的  <code>tzselect</code></li>\n</ol>\n<p>看起来很像一个时区选择的工具，但并非如此。事实上 tzselect 仅仅是一个查看时区表示方式的『向导』程序而已。通过依次询问大洲→国家→城市，最后告诉你如何 TZ 变量的写法，比如北京时间是： <code>Asia/Shanghai</code></p>\n<ol start=\"2\">\n<li>TZ 变量</li>\n</ol>\n<p>根据上面的指导，可以获知通过修改 TZ 变量，直接修改时区信息，例如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">date</span> <span class=\"token parameter variable\">-R</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre> Tue, <span class=\"token number\">17</span> Jan <span class=\"token number\">2017</span> <span class=\"token number\">13</span>:57:06 +0000</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token builtin class-name\">export</span>  <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span><span class=\"token string\">'Asia/Shanghai'</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">date</span> <span class=\"token parameter variable\">-R</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre> Tue, <span class=\"token number\">17</span> Jan <span class=\"token number\">2017</span> <span class=\"token number\">19</span>:57:18 +0600</pre></td></tr></table></figure><p>但如果不写在环境变量文件配置里的话，一般是会话级的操作，取消重新打开便会失效；因此对于在 shell 中实现更改 TZ 变量，只能做到临时变更时区信息。</p>\n<p>正确做法是到  <code>/etc/profile</code>  里（或用户的  <code>~/.profile</code>  或  <code>~/.bashrc</code>  文件等），直接  <code>export TZ='xxx'</code>  更改时区（时区的名字可以用  <code>tzselect</code>  向导来确定）</p>\n<ol start=\"3\">\n<li><code>/etc/localtime</code>  文件</li>\n</ol>\n<p>默认情况下情况下，TZ 属性是空，这时候是靠  <code>/etc/localtime</code>  文件来确定的时区。而此文件通常又是一个到  <code>/usr/share/zoneinfo/</code>  下各种时区文件的软连接。通过修改  <code>/etc/localtime</code>  指向的软连接，进而修改系统的时区。比如下面的方法，将 localtime 文件设置为了北京时间：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-sf</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre></td></tr></table></figure><p><strong>2、对于裁剪的 Linux 系统，如：arm linux</strong></p>\n<ol>\n<li><code>tzselect</code>  命令</li>\n</ol>\n<p>正常情况下，裁剪过的是不支持该命令的，因此相对于上面的 2、3 两点并不适用于此。</p>\n<ol start=\"2\">\n<li>TZ 变量</li>\n</ol>\n<p>与上面一样可通过修改 TZ 变量，直接修改时区信息，但与此不同的是，并不能通过  <code>TZ='Asia/Shanghai'</code>  去修改，只能通过时区偏移量来修改，例如我们中国的北京时间相对于  <code>UTC-0</code>  的偏移量是  <code>UTC+8</code>  ；那么则修改为：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">date</span> <span class=\"token parameter variable\">-R</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre> Tue, <span class=\"token number\">17</span> Jan <span class=\"token number\">2017</span> <span class=\"token number\">13</span>:57:06 +0000</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token builtin class-name\">export</span>  <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span><span class=\"token string\">'CST-8'</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">date</span> <span class=\"token parameter variable\">-R</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre> Tue, <span class=\"token number\">17</span> Jan <span class=\"token number\">2017</span> <span class=\"token number\">19</span>:57:18 +0600</pre></td></tr></table></figure><p>注意，在这里，UTC+、- 是相反的，UTC-8 代表的是相对于 UTC 加八个小时，反之减八个小时......；而 CST 则是对应为北京时区缩写。</p>\n<p>时区表信息可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudGltZWFuZGRhdGUuY29tL3RpbWUvem9uZXMv\">https://www.timeanddate.com/time/zones/</span></p>\n<ol start=\"3\">\n<li><code>/etc/localtime</code>  文件</li>\n</ol>\n<p>由于裁剪问题，系统中是没有  <code>/usr/share/zoneinfo/</code>  文件夹的，如有需要，将 PC 端的  <code>/usr/share/zoneinfo</code>  整个  <code>zoneinfo</code>  文件夹复制到 rootfs 的  <code>/usr/share</code>  下，这样嵌入式系统中就有了  <code>timezone</code>  。</p>\n<p>最后同样执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-sf</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre></td></tr></table></figure><p>note：时区信息保存在  <code>/etc/localtime</code>  文件里，如果没有该文件则系统是零时区，有该文件时系统会去读取该文件。具体该文件的内容可以不同关心，在  <code>/usr/share/zoneinfo/</code>  目录下有各个时区对应的文件，只需要拷贝过去就可以。比如我们常用的东八区时间就是对应  <code>/usr/share/zoneinfo/Asia/Shanghai</code>  文件，只需要将该文件指向或拷贝到  <code>/etc/localtime</code>  就将系统时间改为东八区。</p>\n<h1 id=\"常用-api\"><a class=\"anchor\" href=\"#常用-api\">#</a> 常用 API</h1>\n<h2 id=\"时间结构体\"><a class=\"anchor\" href=\"#时间结构体\">#</a> 时间结构体</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">int</span> tm_sec<span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* Seconds (0-60) */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">int</span> tm_min<span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* Minutes (0-59) */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">int</span> tm_hour<span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* Hours (0-23) */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">int</span> tm_mday<span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* Day of the month (1-31) */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">int</span> tm_mon<span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* Month (0-11) */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">int</span> tm_year<span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* Year - 1900 */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">int</span> tm_wday<span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* Day of the week (0-6, Sunday = 0) */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">int</span> tm_yday<span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* Day in the year (0-365, 1 Jan = 0) */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">int</span> tm_isdst<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* Daylight saving time */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">timeval</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">time_t</span>      tv_sec<span class=\"token punctuation\">;</span>     <span class=\"token comment\">/* seconds (秒) */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">suseconds_t</span> tv_usec<span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* microseconds (微秒) */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">timezone</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">int</span> tz_minuteswest<span class=\"token punctuation\">;</span>     <span class=\"token comment\">/* minutes west of Greenwich */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">int</span> tz_dsttime<span class=\"token punctuation\">;</span>         <span class=\"token comment\">/* type of DST correction */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"时间函数归类\"><a class=\"anchor\" href=\"#时间函数归类\">#</a> 时间函数归类</h2>\n<p><strong>1、C99 标准库函数</strong></p>\n<p>需  <code>#include &lt;time.h&gt;</code></p>\n<ul>\n<li>获取时间戳：</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* time () 函数，返回一个从 1970 年 1 月 1 日 00:00:00 到现在的 time_t 类型 UTC 时间，当参数为 NULL 时直接返回秒数，当然也会将该值写入 t 指针指向的地址。 */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">time_t</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">time_t</span> <span class=\"token operator\">*</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">/* mktime () 会把本地时间转换为 UTC 时间 */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">time_t</span> <span class=\"token function\">mktime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span>tm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">//note：两者区别在于传入的参数结构体不同，mktime 存在时区转换；time (t) 等价于 mktime (localtime (time (t)))。</span></pre></td></tr></table></figure><ul>\n<li>获取  <code>struct tm</code>  类型的时间：</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* gmtime () 是零时区，把 UTC 时间转换成北京时间的话，需要在年数上加 1900，月份上加 1，小时数加上 8。 */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span><span class=\"token function\">gmtime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">time_t</span> <span class=\"token operator\">*</span>timep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span><span class=\"token function\">gmtime_r</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">time_t</span> <span class=\"token operator\">*</span>timep<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">/* localtime () 将得到本地时间，该函数与 gmtime () 唯一区别是，在转换成北京时间的小时数不需要加上 8。 */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span><span class=\"token function\">localtime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">time_t</span> <span class=\"token operator\">*</span>timep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span><span class=\"token function\">localtime_r</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">time_t</span> <span class=\"token operator\">*</span>timep<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">//note：localtime 是将时区考虑在内了，转出的是当前时区的时间。但是注意，有些嵌入式设备上被裁减过的系统，时区没有被设置好，导致二者转出来的时间都是零时区的。在多线程应用里面，应该用后缀不带 `_r` 的函数，如： localtime_r 函数替代 localtime 函数，因为 localtime_r 是线程安全的，例子看第五大点。</span></pre></td></tr></table></figure><ul>\n<li>时间日期格式化：</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* 将 tm 结构中的时间信息转换为相应时间的字符串 */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token function\">asctime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span>tm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token function\">asctime_r</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span>tm<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">/* 将日历时间参数 timep 转换为一个表示本地当前时间的字符串，函数已经由时区转换成当地时间 */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token function\">ctime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">time_t</span> <span class=\"token operator\">*</span>timep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token function\">ctime_r</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">time_t</span> <span class=\"token operator\">*</span>timep<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">//note：两者区别在于传入的参数结构体不同，但转换出来的信息格式显示是一样的；asctime 是直接把时间格式化，而 ctime 是经过时区转换后再格式化输出；ctime (t) 等价于 asctime (localtime (t))。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">/* 常用时间格式化参数看下方描述 */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token class-name\">size_t</span> <span class=\"token function\">strftime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>s<span class=\"token punctuation\">,</span> <span class=\"token class-name\">size_t</span> max<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>format<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span>tm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在使用  <code>strftime</code>  时间格式化函数所涉及的相关参数的含义如下：</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>%F</td>\n<td>将时间格式化为年 - 月 - 日</td>\n</tr>\n<tr>\n<td>%T</td>\n<td>将时间格式化为显示时分秒: hh:mm:ss</td>\n</tr>\n<tr>\n<td>%Y</td>\n<td>将时间格式化为带世纪部分的十制年份</td>\n</tr>\n<tr>\n<td>%m</td>\n<td>将时间格式化为十进制表示的月份</td>\n</tr>\n<tr>\n<td>%d</td>\n<td>将时间格式化为十进制的每月中的第几天</td>\n</tr>\n<tr>\n<td>%H</td>\n<td>将时间格式化为 24 小时制的小时</td>\n</tr>\n<tr>\n<td>%M</td>\n<td>将时间格式化为十进制表示的分钟数</td>\n</tr>\n<tr>\n<td>%S</td>\n<td>将时间格式化为十进制表示的秒数</td>\n</tr>\n</tbody>\n</table>\n<p>更多参数请阅：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS9jcHJvZ3JhbW1pbmcvYy1mdW5jdGlvbi1zdHJmdGltZS5odG1s\">https://www.runoob.com/cprogramming/c-function-strftime.html</span></p>\n<ul>\n<li>获取时间差：</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">double</span> <span class=\"token function\">difftime</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">time_t</span> time1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">time_t</span> time0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>2、Uinx 系统函数</strong></p>\n<p>需  <code>#include &lt;sys/time.h&gt;</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/time.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>获取 <span class=\"token keyword\">struct</span> <span class=\"token class-name\">timeval</span> 类型的时间：</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/* 相对于 time () 和 mktime () ，gettimeofday () 能获取更精准的微秒级别，及相应的时区信息，需要注意的是 tz 是依赖于系统，不同的系统可能存在获取不到的可能，因此通常设置为 NULL */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">gettimeofday</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">timeval</span> <span class=\"token operator\">*</span>tv<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">timezone</span> <span class=\"token operator\">*</span>tz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 成功则返回 0，失败返回 －1，错误代码存于 errno</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// EFAULT：指针 tv 或 tz 所指的内存空间无效。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>设置 <span class=\"token keyword\">struct</span> <span class=\"token class-name\">timeval</span> 类型的时间：</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">settimeofday</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">timeval</span> <span class=\"token operator\">*</span>tv<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">timezone</span> <span class=\"token operator\">*</span>tz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 成功则返回 0，失败返回 －1，错误代码存于 errno</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// EPERM：调用进程没有足够权限调用 settimeofday ()，即权限不够。</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// EINVAL：时区或其它内容无效，无法正确设置时间。</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">//note：settimeofday 的修改时间需要在 root 权限下才能配置成功。</span></pre></td></tr></table></figure><p><strong>3、总结</strong></p>\n<p><code>time</code> 、 <code>gmtime</code> 、 <code>asctime</code>  所表示的时间都是 UTC 时间，只是数据类型不一样，<br />\n而  <code>mktime</code> 、 <code>localtime</code> 、 <code>ctime</code>  的时间都存在时区之间变换。</p>\n<table>\n<thead>\n<tr>\n<th>函数</th>\n<th>传参类型</th>\n<th>返回类型</th>\n<th>时区转换</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>time()</td>\n<td>time_t</td>\n<td>time_t</td>\n<td>UTC+0</td>\n<td>用于获取 UTC 零时区的时间戳格式</td>\n</tr>\n<tr>\n<td>mktime()</td>\n<td>struct tm</td>\n<td>time_t</td>\n<td>UTC-t</td>\n<td>用于获取 UTC 零时区的时间戳格式，但会经过时区转换，把本地时间内部换成 UTC+0</td>\n</tr>\n<tr>\n<td>gmtime()</td>\n<td>time_t</td>\n<td>struct tm</td>\n<td>UTC+0</td>\n<td>用于获取 UTC 零时区的</td>\n</tr>\n<tr>\n<td>localtime()</td>\n<td>time_t</td>\n<td>struct tm</td>\n<td>UTC+t</td>\n<td></td>\n</tr>\n<tr>\n<td>asctime()</td>\n<td>struct tm</td>\n<td>string</td>\n<td>UTC+0</td>\n<td></td>\n</tr>\n<tr>\n<td>ctime()</td>\n<td>time_t</td>\n<td>string</td>\n<td>UTC+t</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"函数应用\"><a class=\"anchor\" href=\"#函数应用\">#</a> 函数应用</h2>\n<p>1、获取当前时区的时间戳偏移量</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">time_t</span> <span class=\"token function\">get_localtime_interval</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">time_t</span> timep_utc<span class=\"token punctuation\">,</span> timep_local<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> tm_utc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>timep_utc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">gmtime_r</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>timep_utc<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>tm_utc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\ttimep_local <span class=\"token operator\">=</span> <span class=\"token function\">mktime</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>tm_utc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>timep_utc <span class=\"token operator\">-</span> timep_local<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2、获取当前时区的时间戳（带时区的本地时间）</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">time_t</span> <span class=\"token function\">get_time_stamp</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token class-name\">time_t</span> timep<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>timep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\ttimep <span class=\"token operator\">+=</span> <span class=\"token function\">get_localtime_interval</span><span class=\"token punctuation\">(</span>timep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">return</span> timep<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>3、获取时区偏移量</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">time_t</span> <span class=\"token function\">get_time_stamp</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token class-name\">time_t</span> timep_zone<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    timep_zone <span class=\"token operator\">=</span> <span class=\"token function\">get_localtime_interval</span><span class=\"token punctuation\">(</span>timep<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">3600</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">return</span> timep_zone<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>4、时区设置函数</p>\n<p>时间函数除了 gmttime ()、asctime () 不受环境变量 TZ 的影响外，大部分函数都受到环境变量 TZ 的影响，这几个函数是： localtime、mktime、ctime 和 strftime。如果定义了 TZ，则这些函数将使用其值以代替系统默认时区。</p>\n<p>在 Unix 环境下可以通过改变系统文件修改环境变量，也可以通过函数 setenv () 修改。</p>\n<p>TZ 指定了当前的系统时区。这个时区会影响我们所做的时间转换。例如假设当前的系统时间是 8:00AM，如果我们把当前的时区设置成东八区，则标准时间就是（即 UTC+0）的时间就是 8-8=0:00AM，如果是看成是东六区的话，则标准时间就变成了 8-6=2:00AM。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span>  </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;time.h></span>  </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span>    </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">setenv</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TZ\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CST-8\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 北京东八区</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">//setenv (\"TZ\", \"UTC+0\", 1);   // 将当前时区设置成标准区</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">char</span> buf<span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">timeval</span> tv<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span><span class=\"token operator\">*</span> tm_time<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">gettimeofday</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>tv<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    tm_time <span class=\"token operator\">=</span> <span class=\"token function\">gmtime</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>tv<span class=\"token punctuation\">.</span>tv_sec<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">strftime</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"%a %b %m %H:%M:%S %Z %Y\"</span><span class=\"token punctuation\">,</span> tm_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GMT time: %s\\n\"</span><span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    tm_time <span class=\"token operator\">=</span> <span class=\"token function\">localtime</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>tv<span class=\"token punctuation\">.</span>tv_sec<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">strftime</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"%a %b %m %H:%M:%S %Z %Y\"</span><span class=\"token punctuation\">,</span> tm_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"local time: %s\\n\"</span><span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"localtime-和-localtime_r-区别\"><a class=\"anchor\" href=\"#localtime-和-localtime_r-区别\">#</a> localtime 和 localtime_r 区别</h1>\n<p>示例来源（下方为原文备份记录）：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Rlc3QxMjgwL2FydGljbGUvZGV0YWlscy84MDkxNzk2Mg==\">https://blog.csdn.net/test1280/article/details/80917962</span></p>\n<p><code>localtime</code>  和  <code>localtime_r</code>  的函数功能： converts the calendar time timep to broken-time representation</p>\n<p>在调用  <code>localtime</code>  和  <code>localtime_t</code>  函数时，需特别注意：</p>\n<ul>\n<li>\n<p><code>localtime</code>  是不可重入函数，非线程安全</p>\n</li>\n<li>\n<p><code>localtime_r</code>  是可重入函数，线程安全</p>\n</li>\n</ul>\n<p>1、使用  <code>localtime</code>  时不可重入示范：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;time.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token class-name\">time_t</span> curTime <span class=\"token operator\">=</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">time_t</span> aftTime <span class=\"token operator\">=</span> curTime <span class=\"token operator\">+</span> <span class=\"token number\">3600</span><span class=\"token operator\">*</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span>pTm1 <span class=\"token operator\">=</span> <span class=\"token function\">localtime</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>curTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> <span class=\"token operator\">*</span>pTm2 <span class=\"token operator\">=</span> <span class=\"token function\">localtime</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>aftTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">fprintf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"%04d%02d%02d%02d%02d%02d\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            pTm1<span class=\"token operator\">-></span>tm_year <span class=\"token operator\">+</span> <span class=\"token number\">1900</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            pTm1<span class=\"token operator\">-></span>tm_mon <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            pTm1<span class=\"token operator\">-></span>tm_mday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            pTm1<span class=\"token operator\">-></span>tm_hour<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            pTm1<span class=\"token operator\">-></span>tm_min<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            pTm1<span class=\"token operator\">-></span>tm_sec<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token function\">fprintf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"%04d%02d%02d%02d%02d%02d\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            pTm2<span class=\"token operator\">-></span>tm_year <span class=\"token operator\">+</span> <span class=\"token number\">1900</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            pTm2<span class=\"token operator\">-></span>tm_mon <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            pTm2<span class=\"token operator\">-></span>tm_mday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            pTm2<span class=\"token operator\">-></span>tm_hour<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            pTm2<span class=\"token operator\">-></span>tm_min<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            pTm2<span class=\"token operator\">-></span>tm_sec<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>编译 &amp; 运行：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ gcc <span class=\"token parameter variable\">-o</span> main main.c</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ ./main</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">20180704225205</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">20180704225205</span></pre></td></tr></table></figure><p>调用  <code>localtime</code>  函数并获取其返回值（一个指向  <code>struct tm</code>  结构类型数据的指针）后，我们并未对返回值进行<strong>显式地释放</strong>。</p>\n<p><strong>这并没有什么问题（不会导致内存泄漏）</strong>。</p>\n<p>因为  <code>localtime</code>  函数返回值是一个指针，指向一个静态变量，这个静态变量是库中的一个  <code>static struct tm</code>  类型数据。</p>\n<p>man localtime：</p>\n<p>The return value points to a <strong>statically allocated struct</strong> which might <strong>be overwritten</strong> by <strong>subsequent calls</strong> to any of the date and time functions.</p>\n<p>这将引出新的问题，<strong>同一进程</strong>多个线程中同时调用（极短时间内连续调用）  <code>localtime</code>  函数，返回值  <code>tm</code>  可能被覆盖。</p>\n<p>举个栗子：</p>\n<p>两个线程 A 和 B 同时调用  <code>localtime</code>  函数：</p>\n<p>时刻 1：线程 A 调用  <code>localtime</code>  函数，得到一个指针，指向  <code>static struct tm</code>  类型变量；（tm 中存储的值更新为 value-a）</p>\n<p>时刻 2：线程 B 调用  <code>localtime</code>  函数，得到一个指针，指向  <code>static struct tm</code>  类型变量；（tm 中存储的值更新为 value-b）</p>\n<p>时刻 3：线程 A 对  <code>localtime</code>  返回的指针进行相关引用操作（例如 printf 输出某字段），此时  <code>static struct tm</code>  中的值实际是 value-b，并非预期的 value-a。</p>\n<p>时刻 4：线程 B 对  <code>localtime</code>  返回的指针进行相关引用操作，此时  <code>static struct tm</code>  中的值实际是 value-b。</p>\n<p>上面的示范代码虽然是在同一线程中，但是已经可以简单模拟这样的多线程执行调用流程。</p>\n<p><strong>如何解决？</strong></p>\n<p><code>localtime_r</code>  是  <code>localtime</code>  的可重入版本（线程安全版本）。</p>\n<p><code>localtime</code>  不可重入是由于  <code>static struct tm</code>  是库中的一个静态变量，如果我们在调用  <code>localtime</code>  时传入一个  <code>struct tm</code>  类型变量（指针）用于存放结果，岂不是实现<strong>可重入</strong>？</p>\n<p>Bingo！</p>\n<p><code>struct tm *localtime(const time_t *timep);</code></p>\n<p><code>struct tm *localtime_r(const time_t *timep, struct tm *result);</code></p>\n<p>调用  <code>localtime</code>  只需要传入指向  <code>time_t</code>  的一个常量指针；</p>\n<p>调用  <code>localtime_t</code>  不仅需要传入指向  <code>time_t</code>  的一个常量指针，还需要传入指向  <code>struct tm</code>  的一个指针，结果将存储在  <code>result</code>  指向的  <code>struct tm</code>  对象中；</p>\n<p>The return value points to a statically allocated struct which might be overwritten by subsequent calls to any of the date and time functions.</p>\n<p>The localtime_r() function does the same, <strong>but stores the data in a user-supplied struct</strong>.</p>\n<p>2、使用  <code>localtime_r</code>  时可重入示范：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;time.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token class-name\">time_t</span> curTime <span class=\"token operator\">=</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">time_t</span> aftTime <span class=\"token operator\">=</span> curTime <span class=\"token operator\">+</span> <span class=\"token number\">3600</span><span class=\"token operator\">*</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> tm1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tm</span> tm2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">localtime_r</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>curTime<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>tm1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">localtime_r</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>aftTime<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>tm2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">fprintf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"%04d%02d%02d%02d%02d%02d\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            tm1<span class=\"token punctuation\">.</span>tm_year <span class=\"token operator\">+</span> <span class=\"token number\">1900</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            tm1<span class=\"token punctuation\">.</span>tm_mon <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            tm1<span class=\"token punctuation\">.</span>tm_mday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            tm1<span class=\"token punctuation\">.</span>tm_hour<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            tm1<span class=\"token punctuation\">.</span>tm_min<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            tm1<span class=\"token punctuation\">.</span>tm_sec<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token function\">fprintf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"%04d%02d%02d%02d%02d%02d\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            tm2<span class=\"token punctuation\">.</span>tm_year <span class=\"token operator\">+</span> <span class=\"token number\">1900</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            tm2<span class=\"token punctuation\">.</span>tm_mon <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            tm2<span class=\"token punctuation\">.</span>tm_mday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            tm2<span class=\"token punctuation\">.</span>tm_hour<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            tm2<span class=\"token punctuation\">.</span>tm_min<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            tm2<span class=\"token punctuation\">.</span>tm_sec<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>编译 &amp; 运行：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ gcc <span class=\"token parameter variable\">-o</span> main main.c</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ ./main</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">20180704200531</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">20180704230531</span></pre></td></tr></table></figure><h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vc3VuLWZyZWRlcmljay9wLzQ3NzI1MzUuaHRtbA==\">https://www.cnblogs.com/sun-frederick/p/4772535.html</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Rlc3QxMjgwL2FydGljbGUvZGV0YWlscy84MDkxNzk2Mg==\">https://blog.csdn.net/test1280/article/details/80917962</span></p>\n",
            "tags": [
                "Linux",
                "linux_c"
            ]
        },
        {
            "id": "https://arachnid.cc/linux-rootfs-create/",
            "url": "https://arachnid.cc/linux-rootfs-create/",
            "title": "Linux 根文件系统的构建",
            "date_published": "2023-03-08T12:24:36.000Z",
            "content_html": "<blockquote>\n<p>开发平台：Ubuntu 18.04.6</p>\n<p>目标平台：imx-6ull</p>\n<p>busybox 版本：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9idXN5Ym94Lm5ldC9kb3dubG9hZHMvYnVzeWJveC0xLjMyLjAudGFyLmJ6Mg==\">busybox-1.32.0.tar.bz2</span></p>\n<p>编译工具链：gcc versions 10.3.1 20210621 (GNU Toolchain for the A-profile Architecture 10.3-2021.07 (arm-10.29))</p>\n</blockquote>\n<h1 id=\"环境搭建\"><a class=\"anchor\" href=\"#环境搭建\">#</a> 环境搭建</h1>\n<h2 id=\"交叉编译器\"><a class=\"anchor\" href=\"#交叉编译器\">#</a> 交叉编译器</h2>\n<p>关于 arm linux 交叉编译工具链的搭建，这里就再不展开说明了，毕竟在此之前如果有移植过 uboot，那么这里就可以省略了，对于没有搭过交叉编译工具链的，可以查看上一篇 <a href=\"https://arachnid.cc/6ull-uboot-transplant/\">imx-6ULL uboot 移植</a> 的交叉编译搭建的环节。</p>\n<h1 id=\"文件系统\"><a class=\"anchor\" href=\"#文件系统\">#</a> 文件系统</h1>\n<p>你可能听过这么一句 “Unix 系统中一切皆文件” 的话，它是指 Unix 系统中的所有的一切都可以通过文件的方式访问、管理，即使不是文件，也以文件的形式来管理；那么对于这些文件的管理，需要一个系统去管理集中访问，而这样一个系统称为文件系统，它可以使我们以文件 IO 的形式对文件目录进行访问，而非以 Flash 存储地址进行访问，在使用上更为方便轻松。</p>\n<h2 id=\"组成\"><a class=\"anchor\" href=\"#组成\">#</a> 组成</h2>\n<p>对于现有的 Linux 版本，不同的 Linux 衍生版本其文件系统的根目录都略有不同，但整体上的组成没多大区别。</p>\n<p><img data-src=\"image-20240817230144056.png\" alt=\"image-20240817230144056\" /></p>\n<p><img data-src=\"image-20240817230822485.png\" alt=\"image-20240817230822485\" /></p>\n<p>一般来说，在构成最小 rootfs 的目录结构会包含以下几个：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">目录</th>\n<th style=\"text-align:left\">说明</th>\n<th style=\"text-align:left\">补充</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">bin</td>\n<td style=\"text-align:left\">可执行文件，主要的是系统命令，普通用户和 root 都可以执行</td>\n<td style=\"text-align:left\">必须存在</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">dev</td>\n<td style=\"text-align:left\">设备文件，设备树定义的节点就在这里</td>\n<td style=\"text-align:left\">必须存在</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">etc</td>\n<td style=\"text-align:left\">存放着各配置文件</td>\n<td style=\"text-align:left\">必须存在</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">home</td>\n<td style=\"text-align:left\">系统预设的使用者家目录</td>\n<td style=\"text-align:left\">非必须</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">lib</td>\n<td style=\"text-align:left\">存放的是 32 bit 系统中的动态和静态链接库文件</td>\n<td style=\"text-align:left\">必须存在</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">lib64</td>\n<td style=\"text-align:left\">64 bit 桌面系统存在的东西，存放着支持 64 bit 的运行库</td>\n<td style=\"text-align:left\">嵌入式系统不需要</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">mnt</td>\n<td style=\"text-align:left\">临时挂载目录，一般是空目录</td>\n<td style=\"text-align:left\">非必须</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">opt</td>\n<td style=\"text-align:left\">第三方软件安装存放目录 ，目前都安装在 /usr/local 目录里</td>\n<td style=\"text-align:left\">非必须</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">proc</td>\n<td style=\"text-align:left\">虚拟文件系统，是系统内存的映射，主要存放系统的内核、进程和网络状态</td>\n<td style=\"text-align:left\">必须存在</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sbin</td>\n<td style=\"text-align:left\">系统管理命令存放目录，只有 root 可以使用，普通用户只可查看</td>\n<td style=\"text-align:left\">必须存在</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sys</td>\n<td style=\"text-align:left\">系统使用的目录，虚拟文件系统。和 /proc/ 相似，该目录中的数据都保存在内存中</td>\n<td style=\"text-align:left\">必须存在</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">usr</td>\n<td style=\"text-align:left\">是 Unix Software Resource <code> </code> 的缩写，也就是 Unix 操作系统软件资源目录</td>\n<td style=\"text-align:left\">非必须</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">var</td>\n<td style=\"text-align:left\">存放一些可以改变的数据，包括系统运行中需调用或改变的数据</td>\n<td style=\"text-align:left\">必须存在</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"构建\"><a class=\"anchor\" href=\"#构建\">#</a> 构建</h1>\n<p>根文件系统的制作方法有很多，像在已知的系统中把整个根文件系统打包出来然后再进行裁剪，或者使用三大神器 busybox、buildroot、yocto 构建等。</p>\n<p>利用已有的系统提取裁剪，这种方法一般适用于同平台版本的情况下，对于不同的平台版本下，可能会出现运行环境错误的情况；</p>\n<p>使用 busybox 构建文件系统，则仅仅只是帮我们构建好一些 shell 命令程序集，像 lib 库、/etc 目录下的一些文件都需要自己手动创建，如果需要用到第三方软件，还需要去移植一些第三方软件库，比如 alsa、iperf、mplayer 等等；而且 busybox 构建的根文件系统默认没有用户名和密码设置；</p>\n<p>buildroot，它不仅包含了 busybox 的功能，而且里面还集成了各种软件包，当需要什么软件就选择什么软件，不需要额外移植；buildroot 可以构建完整的根文件系统，因此极大的方便了嵌入式 Linux 开发人员对根文件系统进行制作；</p>\n<p>至于 yocto 构建根文件系统，是一个古老的、很庞大的系统构建工具，其实其不单止可以构建根文件系统，还可以用来构建 u-boot、kernel、交叉编译工具链等等，一般为 SOC 厂家、设备厂商、系统开发这些用于统一发布标准套件，但由于操作复杂，开发学习时间也久，一般用户开发不会选择这一方式。</p>\n<h2 id=\"busybox\"><a class=\"anchor\" href=\"#busybox\">#</a> busybox</h2>\n<p>官方下载：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9idXN5Ym94Lm5ldC9kb3dubG9hZHMv\">https://busybox.net/downloads/</span></p>\n<p>在这里选择下载 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9idXN5Ym94Lm5ldC9kb3dubG9hZHMvYnVzeWJveC0xLjMyLjAudGFyLmJ6Mg==\">busybox-1.32.0.tar.bz2</span> 版本。</p>\n<p>对下载下来的 busybox 进行解压：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-jxvf</span> busybox-1.32.0.tar.bz2</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">cd</span> busybox-1.32.0</pre></td></tr></table></figure><h3 id=\"编译验证\"><a class=\"anchor\" href=\"#编译验证\">#</a> 编译验证</h3>\n<p>选择交叉编译工具对其进行默认编译：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-s</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ARCH</span><span class=\"token operator\">=</span>arm</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CROSS_COMPILE</span><span class=\"token operator\">=</span>arm-none-linux-gnueabihf-</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">make</span> distclean</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">make</span> defconfig</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">make</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token function\">install</span></pre></td></tr></table></figure><p>最后，生成一个名为  <code>_install</code>  的文件目录（当然，你也可以使用  <code>CONFIG_PREFIX=rootfs_dir</code>  指定文件目录名称及路径），该目录就是本次默认配置所构建的残缺文件系统，为什么说是残缺，是因为还缺少相关的文件及目录，这个下面再说。</p>\n<h3 id=\"自主配置\"><a class=\"anchor\" href=\"#自主配置\">#</a> 自主配置</h3>\n<p>前面说了，上面的操作只是构建了一个默认的配置用以验证，实际过程中，往往根据需要选择必要的功能，而在 busybox 中支持以下几种快速配置模式：</p>\n<ul>\n<li>defconfig：缺省配置，也就是默认配置选项。</li>\n<li>allyesconfi：全选配置，也就是选中 busybox 的所有功能。</li>\n<li>allnoconfig：最小配置，什么都不选中，即空配置。</li>\n</ul>\n<p>在应用中，你可以先选择你最接近的快速配置进行初始化配置，然后再修改定制，这里笔者选择  <code>make allnoconfig</code>  进行配置初始化，配置完成后可通过查看是否有  <code>.config</code>  文件来验证配置成功。</p>\n<p>同样的，跟 <a href=\"https://arachnid.cc/6ull-uboot-transplant/\">uboot</a> 和 kernel 一样，在 busybox 中也存在图形界面配置操作（关于无法调出图形配置界面进行配置可看 <a href=\"https://arachnid.cc/6ull-kernel-transplant/\">imx-6ULL kernel 移植</a> 的图形配置说明）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">make</span> menuconfig</pre></td></tr></table></figure><p>关于其选项操作：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Settings ---> \t\t\t# BusyBox 的通用配置，一般采用默认值即可。</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--- Applets</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Archival Utilities ---> \t\t\t# 压缩、解压缩相关工具。   </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    Coreutils ---> \t\t\t\t\t\t# 最基本的命令，如cat、cp、ls等。   </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    Console Utilities ---> \t\t\t\t# 控制台相关命令。   </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    Debian Utilities ---> \t\t\t\t# Debian 操作系统相关命令。   </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    klibc-utils ---> \t\t\t\t\t# 供 initramfs 所使用的最小化 libc 子集。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    Editors ---> \t\t\t\t\t\t# 编辑工具，如 vi、awk、sed 等。   </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    Finding Utilities ---> \t\t\t\t# 查找工具，如find、grep、xargs。   </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    Init Utilities ---> \t\t\t\t# BusyBox init 相关命令。   </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    Login/Password Management Utilities ---> # 登陆、用户账号/密码等方面的命令。   </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    Linux Ext2 FS Progs ---> \t\t\t# ext2 文件系统的一些工具。   </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    Linux Module Utilities ---> \t\t# 加载/卸载模块等相关的命令。   </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    Linux System Utilities --->  \t\t# 一些系统命令。   </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    Miscellaneous Utilities ---> \t\t# 一些不好分类的命令，如crond、crontab。   </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    Networking Utilities --->    \t\t# 网络相关的命令和工具。   </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    Print Utilities --->    \t\t\t# print spool 服务及相关工具。   </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    Mail Utilities --->      \t\t\t# mail 相关命令。   </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    Process Utilities --->      \t\t# 进程相关命令，如ps、kill等。   </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    Runit Utilities --->    \t\t\t# runit 程序。   </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    Shells --->             \t\t\t# shell 程序。   </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    System Logging Utilities --->   \t# 系统日志相关工具，如 syslogd、klogd。</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tLoad an Alternate Configuration File\t\t# 加载备用配置文件</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tSave Configuration to an Alternate File\t\t# 将配置保存到备用文件</pre></td></tr></table></figure><p>然后在这里记录几个关键的配置：</p>\n<ul>\n<li>\n<p>静态或者动态编译 busybox，取消选择静态编译，使得 busybox 可执行文件更小</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-> Settings</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  -> [ ] Build static binary (no shared libs)</pre></td></tr></table></figure></li>\n<li>\n<p>打开命令行编辑，增加 vi 编辑样式，其余默认或按需修改</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-> Settings</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  -> [*] Command line editing</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     [*]   vi-style line editing commands</pre></td></tr></table></figure></li>\n<li>\n<p>打开简洁式 help 命令提示</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-> Settings</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  -> [*] Show applet usage messages</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     [ ]   Show verbose applet usage messages</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     [*]   Store applet usage messages in compressed form</pre></td></tr></table></figure></li>\n<li>\n<p>选择支持 Unicode 编码，其余默认或按需修改</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-> Settings</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  -> [*] Support Unicode</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     [*]   Check $LC_ALL, $LC_CTYPE and $LANG environment variables</pre></td></tr></table></figure></li>\n<li>\n<p>取消对模块实用程序的简化，这样在该表将会额外多出几个拓展选项</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-> Linux Module Utilities</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  -> [ ] Simplified modutils</pre></td></tr></table></figure></li>\n<li>\n<p>打开设备自主管理功能，实现初始化常用设备和动态更新</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-> Linux System Utilities</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  -> [*] mdev</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     [*]   Support /etc/mdev.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     [*]     Support subdirs/symlinks</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     [*]       Support regular expressions substitutions when renaming dev</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     [*]     Support command execution at device addition/removal</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     [*]   Support loading of firmware</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     [*]   Support daemon mode</pre></td></tr></table></figure></li>\n<li>\n<p>选择内核启动后 init 进程处理</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-> Init Utilities</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  -> [*] init</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  -> [ ] linuxrc: support running init from initrd (not initramfs)</pre></td></tr></table></figure><p>在这里，取消勾选  <code>linuxrc</code>  ；在 Linux2.4 内核及更低版本，由  <code>initrd</code>  引导加载文件系统，核心文件就是  <code>linuxrc</code>  ，其通常是一个脚本文件，负责加载内核访问根文件系统必须的驱动， 以及加载根文件系统，如果你勾选上那么编译后你将会看到一个  <code>/linuxrc</code>  文件；Linux2.6 内核之后被  <code>initramfs</code>  取代，与  <code>initrd</code>  需要先解压再挂载模拟成一个块设备不同，  <code>initramfs</code>  在编译阶段就被打包成  <code>cpio</code>  格式，内核可以直接将其解压建立文件系统。</p>\n<p>为了保持向后兼容性，实际上，在这些发行版中，  <code>initrd</code>  通常只是一个指向  <code>initramfs</code>  的符号链接；也就是说，你所看到的  <code>initrd</code>  实际上已经是现代化的  <code>initramfs</code>  了，通过  <code>ls -l linuxrc</code>  可以看到其实是个软链接而非文件脚本了。</p>\n</li>\n<li>\n<p>shell 终端选择</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-> Shells</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  -> [*] ash</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  -> [*] hush</pre></td></tr></table></figure><p>Almquist shell (也称为 A shell、ash 和 sh) 是一种轻量级 Unix shell（最大的特点就是轻量化）；Hush 是一个创新的 shell 脚本语言，它将 Lua 的简洁性和 Unix 的实用性融为一体。</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-> Shells</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>     Choose which shell is aliased to 'sh' name (ash)  ---></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     Choose which shell is aliased to 'bash' name (hush)  ---></pre></td></tr></table></figure><p>分别为  <code>sh</code>  /  <code>bash</code>  指定 ash 和 hush shell 名称。</p>\n</li>\n</ul>\n<h3 id=\"添加中文支持\"><a class=\"anchor\" href=\"#添加中文支持\">#</a> 添加中文支持</h3>\n<p>在上面启用 Unicode 编码后，可以通过修改以下几个文件来实现中文显示。</p>\n<p>1、修改  <code>unicode.c</code>  文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> libbb/unicode.c</pre></td></tr></table></figure><p>找到  <code>unicode_conv_to_printable2</code>  函数，进行以下修改：</p>\n<p><img data-src=\"image-20240822210341756.png\" alt=\"image-20240822210341756\" /></p>\n<p>2、修改  <code>printable_string.c</code>  文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> libbb/printable_string.c</pre></td></tr></table></figure><p>找到  <code>printable_string2</code>  函数，进行以下修改：</p>\n<p><img data-src=\"image-20240822210801046.png\" alt=\"image-20240822210801046\" /></p>\n<h2 id=\"编写脚本\"><a class=\"anchor\" href=\"#编写脚本\">#</a> 编写脚本</h2>\n<p>1、默认配置生成脚本</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>build.sh</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 若之前已经导入到环境变量则不需要</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span>:/usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/bin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 若已经在顶层 Makefile 文件中指定则不需要</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ARCH</span><span class=\"token operator\">=</span>arm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 若已经在顶层 Makefile 文件中指定则不需要</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CROSS_COMPILE</span><span class=\"token operator\">=</span>arm-none-linux-gnueabihf-</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">make</span> distclean</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">make</span> defconfig</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token function\">make</span> -j<span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token function\">install</span> -j<span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span></pre></td></tr></table></figure><p>2、数据修改脚本</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>autobuild.sh</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 若之前已经导入到环境变量则不需要</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span>:/usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/bin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 若已经在顶层 Makefile 文件中指定则不需要</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ARCH</span><span class=\"token operator\">=</span>arm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 若已经在顶层 Makefile 文件中指定则不需要</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CROSS_COMPILE</span><span class=\"token operator\">=</span>arm-none-linux-gnueabihf-</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">make</span> clean</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">make</span> -j<span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token function\">install</span> -j<span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span></pre></td></tr></table></figure><p>通过执行  <code>build.sh</code>  或  <code>make menuconfig</code>  修改及执行  <code>autobuild.sh</code>  得到所需的二进制执行程序，这时在生成的目录下可以看到：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>|</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>|-- bin</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>|-- sbin</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>|-- usr</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     |-- bin</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     |-- sbin</pre></td></tr></table></figure><h2 id=\"补充-rootfs-目录\"><a class=\"anchor\" href=\"#补充-rootfs-目录\">#</a> 补充 rootfs 目录</h2>\n<p>根据上面 rootfs 的构成，尽管是要做最小 rootfs，除 busybox 生成的目录文件外，还需要我们去填补运行所需的目录文件。</p>\n<h3 id=\"添加-lib-库\"><a class=\"anchor\" href=\"#添加-lib-库\">#</a> 添加 lib 库</h3>\n<p>Linux 中的应用程序一般都是需要动态库的，当然你也可以编译成静态的，但是静态的可执行文件会很大。如果编译为动态的话就需要动态库，所以我们需要向根文件系统中添加动态库，包括前面提到的 busybox 配置中的动态编译。这些动态库可以从调用的交叉编译器中获取，。</p>\n<p><strong>1、  <code>/lib</code>  库添加</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:rootfs] #\"></td><td><pre><span class=\"token function\">mkdir</span> lib</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost:rootfs] #\"></td><td><pre><span class=\"token function\">cp</span> <span class=\"token parameter variable\">-d</span> /usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/arm-none-linux-gnueabihf/libc/lib/*so* lib/</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost:rootfs] #\"></td><td><pre><span class=\"token function\">cp</span> <span class=\"token parameter variable\">-d</span> /usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/arm-none-linux-gnueabihf/libc/lib/*.a lib/</pre></td></tr></table></figure><p>复制 arm linux 交叉编译器下的  <code>libc/lib</code>  库里的  <code>*so*</code>  和  <code>*.a</code>  到 rootfs 的  <code>lib</code>  中，  <code>-d</code>  连同软链接也一起拷贝。</p>\n<p><strong>2、  <code>/usr/lib</code>  库添加</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:rootfs] #\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> usr/lib</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost:rootfs] #\"></td><td><pre><span class=\"token function\">cp</span> <span class=\"token parameter variable\">-d</span> /usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/arm-none-linux-gnueabihf/libc/usr/lib/*so* usr/lib</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost:rootfs] #\"></td><td><pre><span class=\"token function\">cp</span> <span class=\"token parameter variable\">-d</span> /usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/arm-none-linux-gnueabihf/libc/usr/lib/*.a usr/lib</pre></td></tr></table></figure><p>复制 arm linux 交叉编译器下的  <code>libc/usr/lib</code>  库里的  <code>*so*</code>  和  <code>*.a</code>  到 rootfs 的  <code>usr/lib</code>  中，  <code>-d</code>  连同软链接也一起拷贝。</p>\n<h3 id=\"完善根目录\"><a class=\"anchor\" href=\"#完善根目录\">#</a> 完善根目录</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost:rootfs] #\"></td><td><pre><span class=\"token function\">mkdir</span>  dev  etc  home  mnt  proc  sys  var</pre></td></tr></table></figure><h1 id=\"测试\"><a class=\"anchor\" href=\"#测试\">#</a> 测试</h1>\n<p>在完成上面的所有操作后，可以利用 NFS 网络挂载文件系统进行测试完善；关于 NFS 服务的搭建可看 <a href=\"https://arachnid.cc/ubuntu-tftp-nfs-create/\">Ubuntu 搭建 tftp 及 NFS 服务</a> 。</p>\n<p>对于利用 NFS 挂载根文件系统，可以通过修改 uboot 启动的  <code>bootargs</code>  配置来变更文件系统挂载路径，例如：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>=> setenv bootargs 'console=ttymxc0,115200 root=/dev/nfs nfsroot=192.168.1.100:/home/user/nfs_rootfs,proto=tcp rw ip=192.168.1.251:192.168.1.100:192.168.1.1:255.255.255.0::eth0:off'</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>=></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>=> saveenv</pre></td></tr></table></figure><p>关于 uboot 改成 NFS 挂载 rootfs 的格式（更多信息可看 kernel 里面的  <code>Documentation/filesystems/nfs/nfsroot.txt</code>  及其相关文件）：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root=/dev/nfs nfsroot=[&lt;server-ip>:]&lt;root-dir>[,&lt;nfs-options>] ip=&lt;client-ip>:&lt;server-ip>:&lt;gw-ip>:&lt;netmask>:&lt;hostname>:&lt;device>:&lt;autoconf>:&lt;dns0-ip>:&lt;dns1-ip></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>&lt;server-ip>：服务器 IP 地址；比如这里的 PC 主机 IP 地址为 192.168.1.100。</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>&lt;root-dir>：根文件系统的存放路径，要保证放在 NFS 共享目录下；比如 /home/user/nfs_rootfs。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>&lt;nfs-options>：NFS 的其他可选选项，一般不设置。</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>&lt;client-ip>：客户端 IP 地址，也就是开发板的 IP 地址。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>&lt;server-ip>：服务器 IP 地址，前面已经说了。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>&lt;gw-ip>：网关地址。</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>&lt;netmask>：子网掩码。</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>&lt;hostname>：客户机的名字，一般不设置，此值可以空着。</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>&lt;device>：设备名，也就是网卡名，一般是 eth0，eth1...。</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>&lt;autoconf>：自动配置，一般不使用，所以设置为 off。</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>&lt;dns0-ip>：DNS0 服务器 IP 地址，不使用。</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>&lt;dns1-ip>：DNS1 服务器 IP 地址，不使用。</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>“proto=tcp”表示使用 TCP 协议，“rw”表示 nfs 挂载的根文件系统为可读可写。</pre></td></tr></table></figure><p>在这里，结合 <a href=\"https://arachnid.cc/6ull-uboot-transplant/\">imx-6ULL uboot 移植</a> 篇章，可以配置成：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>=> setenv netargs setenv bootargs 'console=$&#123;console&#125;,$&#123;baudrate&#125; root=/dev/nfs nfsroot=$&#123;serverip&#125;:/home/user/nfs_rootfs,proto=tcp rw ip=$&#123;ipaddr&#125;:$&#123;serverip&#125;:$&#123;gatewayip&#125;:$&#123;netmask&#125;::eth0:off'</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>=></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>=> setenv nfsboot 'run findfdt; run findtee; mmc dev $&#123;mmcdev&#125;; mmc dev $&#123;mmcdev&#125;; run netargs; run loadimage; run loadfdt; bootz $&#123;loadaddr&#125; - $&#123;fdt_addr&#125;'</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>=></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>=> saveenv</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>=></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>=> run nfsboot</pre></td></tr></table></figure><p>最后，通过运行  <code>nfsboot</code>  来启动。</p>\n<h2 id=\"添加-rcs-文件\"><a class=\"anchor\" href=\"#添加-rcs-文件\">#</a> 添加 rcS 文件</h2>\n<p>通过 uboot 执行  <code>run nfsboot</code>  进入系统后，可以看到已经成功挂在 NFS 上的 rootfs 了：</p>\n<p><img data-src=\"JQKH%7B0OI%25CXEAYY0PYJ%7DFW.png\" alt=\"img\" /></p>\n<p>但是在进入根文件系统的时候，打印上有一行报错，显示错误提示：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>can<span class=\"token string\">'t run '</span>/etc/init.d/rcS': No such <span class=\"token function\">file</span> or directory</pre></td></tr></table></figure><p>提示不能运行  <code>/etc/init.d/rcS</code>  ，没有这个文件；该文件是个 shell 脚本，Linux 内核启动以后需要启动一些服务，而 rcS 就是规定启动哪些文件的脚本文件</p>\n<p>那么补充一下这个文件，并写入以下内容：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"><span>rcS</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># rcS\t\tCall all S??* scripts in /etc/rcS.d in</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#\t\tnumerical/alphabetical order.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># Version:\t@(#)/etc/init.d/rcS  2.76  19-Apr-1999  miquels@cistron.nl</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span>/sbin:/bin:/usr/sbin:/usr/bin  <span class=\"token comment\"># 初始化环境变量 PATH，操作系统执行程序默认到 PATH 指定的目录下寻找该程序</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">runlevel</span><span class=\"token operator\">=</span>S  <span class=\"token comment\"># 设置系统运行级别为 S，即 single-user（单用户）模式</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">prevlevel</span><span class=\"token operator\">=</span>N <span class=\"token comment\"># 用来记录上一个运行级别的值，以便系统能够在需要时回到前一个运行级别，为 N 则表示没有</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token builtin class-name\">umask</span> 022   <span class=\"token comment\"># 指定当前用户在创建文件时的默认权限，默认 touch 创建一个文件的权限是 644</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token environment constant\">PATH</span> runlevel prevlevel  <span class=\"token comment\"># 导出环境变量</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#\tMount all file systems defined in /etc/fstab</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token function\">mkdir</span> /dev/pts</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token function\">mount</span> <span class=\"token parameter variable\">-a</span>    <span class=\"token comment\"># 挂载 /etc/fstab 文件中指定的文件系统</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">#\tMake sure proc is mounted</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"/proc/1\"</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token function\">mount</span> /proc <span class=\"token comment\"># 确保 /proc 已挂载</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">#\tTrap CTRL-C &amp;c only in this shell so we can interrupt subprocesses.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token builtin class-name\">trap</span> <span class=\"token string\">\":\"</span> INT QUIT TSTP  <span class=\"token comment\"># 捕捉 INT、QUIT、TSTP 信号</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">#\tCall all parts in order.</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token builtin class-name\">exec</span> /etc/init.d/rc.local   <span class=\"token comment\"># 转去执行 rc.local 文件中内容</span></pre></td></tr></table></figure><h3 id=\"补充-fstab-和-rclocal-文件\"><a class=\"anchor\" href=\"#补充-fstab-和-rclocal-文件\">#</a> 补充 fstab 和 rc.local 文件</h3>\n<p>在添加完  <code>/etc/init.d/rcS</code>  后再次运行：</p>\n<p><img data-src=\"QQ%E5%9B%BE%E7%89%8720240829205505.png\" alt=\"QQ图片20240829205505\" /></p>\n<p>可以看到本次打印已经没有上面的提示了，但是会多出两个文件的报错：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mount: can<span class=\"token string\">'t read '</span>/etc/fstab<span class=\"token string\">': No such file or directory</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mount: can'</span>t <span class=\"token builtin class-name\">read</span> <span class=\"token string\">'/etc/fstab'</span><span class=\"token builtin class-name\">:</span> No such <span class=\"token function\">file</span> or directory</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/etc/init.d/rcS: exec: line <span class=\"token number\">34</span>: /etc/init.d/rc.local: not found</pre></td></tr></table></figure><p>分别是缺失  <code>/etc/fstab</code>  和  <code>/etc/init.d/rc.local</code>  ，其实从上面的 rcS 文件上的注释可以看到，该文件是会调用  <code>fstab</code>  和  <code>rc.local</code>  ，因此补充这两个文件：</p>\n<ul>\n<li>\n<p><code>/etc/fstab</code></p>\n<p>用于指定系统需要挂载的文件系统，其格式如下：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>&lt;file system> &lt;mount point> &lt;type> &lt;options> &lt;dump> &lt;pass></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>&lt;file system>：要挂载的特殊的设备，也可以是块设备，比如 /dev/sda 等等</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>&lt;mount point>：挂载点。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>&lt;type>：文件系统类型，比如 ext2、ext3、proc、romfs、tmpfs 等等。</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>&lt;options>：挂载选项，一般使用 defaults，defaults 包含了 rw、suid、 dev、 exec、 auto、 nouser 和 async。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>&lt;dump>：为 1 的话表示允许备份，为 0 不备份，一般不备份，因此设置为 0。</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>&lt;pass>：磁盘检查设置，为 0 表示不检查。根目录 ‘/’ 设置为 1，其他的都不能设置为 1，因此这里一般设置为 0</pre></td></tr></table></figure><figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>fstab</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre># stock fstab - you probably want to override this with a machine specific one</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proc                 /proc                proc       defaults              0  0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>tmpfs                /dev                 tmpfs      defaults              0  0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>sysfs                /sys                 sysfs      defaults              0  0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>devpts               /dev/pts             devpts     mode=0620,gid=5       0  0</pre></td></tr></table></figure></li>\n<li>\n<p><code>/etc/init.d/rc.local</code></p>\n<p>该文件一般作为  <code>rcS</code>  文件的拓展，可有可无，用于设置特定的与系统级无关的操作</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>rc.local</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 设置从 /etc/hostname 文件中获取的主机名</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/bin/hostname <span class=\"token parameter variable\">-F</span> /etc/hostname</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 使用 mdev 来管理热插拔设备，使 Linux 内核就可以在 /dev 目录下自动创建设备节点</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">echo</span> /sbin/mdev <span class=\"token operator\">></span> /proc/sys/kernel/hotplug</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>mdev <span class=\"token parameter variable\">-s</span></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"完善-devpts-和-etchostname\"><a class=\"anchor\" href=\"#完善-devpts-和-etchostname\">#</a> 完善 /dev/pts 和 /etc/hostname</h3>\n<p>在补充完上述的两个文件后，如果再次运行，那么还是会出现报错：</p>\n<p><img data-src=\"QQ%E5%9B%BE%E7%89%8720240829205721.png\" alt=\"\" /></p>\n<p>嘛，这也是预料之中：</p>\n<ul>\n<li>\n<p>在  <code>fstab</code>  中需要挂载一个 /dev/pts 路径的虚拟文件系统，用于实现终端设备的动态分配和管理</p>\n</li>\n<li>\n<p><code>rc.local</code>  中需要读取 /etc/hostname 文件来获取主机名</p>\n</li>\n</ul>\n<p>所以在  <code>rcS</code>  中的  <code>mount -a</code>  前面添加  <code>mkdir /dev/pts</code>  命令；创建  <code>/etc/hostname</code>  文件，并在里面填写你喜欢的开发板名字。</p>\n<p>再运行一次，这次就没有报错提示了，但是有个问题就是，终端的主机名和用户名都没有显示，与常规的终端显示不一样：</p>\n<p><img data-src=\"QQ%E5%9B%BE%E7%89%8720240829205755.png\" alt=\"\" /></p>\n<h2 id=\"添加-profile-文件\"><a class=\"anchor\" href=\"#添加-profile-文件\">#</a> 添加 profile 文件</h2>\n<p>之前添加了 /bin/hostname 以获取主机名，并用  <code>hostname -F</code>  配置主机名，但实际效果是命令行的提示符是没有显示，而调用各种执行程序是没问题的，说明这部分是 Shell 变量设置导致的。</p>\n<p>查阅常见环境变量：</p>\n<ul>\n<li>\n<p>PATH：执行命令时要搜索的目录列表</p>\n</li>\n<li>\n<p>HOME：当前用户的家目录</p>\n</li>\n<li>\n<p>MAIL： 当前用户的邮件储蓄目录</p>\n</li>\n<li>\n<p>SHELL：当前用户的 Shell 路径</p>\n</li>\n<li>\n<p>TZ：时区</p>\n</li>\n<li>\n<p>HISTSIZE：是指保存历史命令记录的条数</p>\n</li>\n<li>\n<p>LOGNAME：是指当前用户的登录名</p>\n</li>\n<li>\n<p>PWD：当前的工作目录</p>\n</li>\n<li>\n<p>HOSTNAME：是指主机的名称，许多应用程序如果要用到主机名的话，通常是从这个环境变量中来取得的</p>\n</li>\n<li>\n<p>LANG/LANGUGE：是和语言相关的环境变量，使用多种语言的用户可以修改此环境变量</p>\n</li>\n<li>\n<p>PS1：是基本提示符，对于 root 用户是 #，对于普通用户是 $</p>\n</li>\n<li>\n<p>PS2：是附属提示符，默认是 “&gt;” ，可以通过修改此环境变量来修改当前的命令符</p>\n</li>\n</ul>\n<p>为了验证是否靠环境变量实现这一作用，编写一个  <code>profile</code>  文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"><span>profile</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># /etc/profile: system-wide .profile file for the Bourne shell (sh(1))</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># and Bourne compatible shells (bash(1), ksh(1), ash(1), ...).</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span>:/usr/local/bin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-e</span> /etc/localtime <span class=\"token parameter variable\">-a</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-e</span> /etc/TZ <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span><span class=\"token string\">\"UTC\"</span>\t\t<span class=\"token comment\"># Time Zone. Look at http://theory.uwinnipeg.ca/gnu/glibc/libc_303.html</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t\t<span class=\"token comment\"># for an explanation of how to set this to your local timezone.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token builtin class-name\">export</span> TZ</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">USER</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">id</span> <span class=\"token parameter variable\">-un</span><span class=\"token variable\">`</span></span>\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">LOGNAME</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$USER</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">HOSTNAME</span></span><span class=\"token operator\">=</span><span class=\"token string\">'/bin/hostname'</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token environment constant\">$HOME</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"/home/root\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span>:/usr/local/sbin</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PS1</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># works for bash and ash (no other shells known to be in use here)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   <span class=\"token assign-left variable\"><span class=\"token environment constant\">PS1</span></span><span class=\"token operator\">=</span><span class=\"token string\">'\\u@\\h:\\w\\$ '</span>  <span class=\"token comment\"># 显示主机名、当前路径等信息</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token environment constant\">USER</span> <span class=\"token environment constant\">LOGNAME</span> <span class=\"token environment constant\">PATH</span> <span class=\"token environment constant\">PS1</span></pre></td></tr></table></figure><p>上面的文件除了配置主机名变量和显示终端基本提示符，还追加 $PASH 路径、指定时区及用户名等。</p>\n<p>然后重启查看效果，是否能解决命令行提示符显示：</p>\n<p><img data-src=\"QQ%E5%9B%BE%E7%89%8720240829205846.png\" alt=\"\" /></p>\n<p>现在是：第一，profile 文件起了作用，hostname 显示出来了，路径指示也显示了；第二，还有个问题就是登录用户名没显示出来。</p>\n<h2 id=\"添加-passwad-shadow-group-gshadow-文件\"><a class=\"anchor\" href=\"#添加-passwad-shadow-group-gshadow-文件\">#</a> 添加 passwad , shadow , group , gshadow 文件</h2>\n<p>前面已经在  <code>profile</code>  中加入了用户名变量，然而还是没从终端显示出来，那么是不是因为系统没有获取到用户配置信息呢？</p>\n<p>与用户配置信息有关的几个文件：</p>\n<ul>\n<li><strong>etc/passwad</strong></li>\n</ul>\n<p><code>/etc/passwd</code>  文件，是系统用户配置文件，存储了系统中所有用户的基本信息，并且所有用户都可以对此文件执行读操作。</p>\n<p>文件中每行代表一个用户信息，以  <code>:</code>  作为分隔符，划分为 7 个字段，每个字段所表示的含义如下：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>用户名 : 密码 : UID（用户ID） : GID（组ID） : 描述性信息 : 主目录 : Shell 路径</pre></td></tr></table></figure><p>添加以下信息：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>passwad</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root:x:0:0:root:/home/root:/bin/bash</pre></td></tr></table></figure><p>note：&quot;x&quot; 表示此用户设有密码，但不是真正的密码，真正的密码保存在  <code>/etc/shadow</code>  文件中。</p>\n<ul>\n<li><strong>/etc/shadow</strong></li>\n</ul>\n<p><code>/etc/shadow</code>  文件，用于存储 Linux 系统中用户的密码信息。</p>\n<p>文件中每行代表一个用户信息，以  <code>:</code>  作为分隔符，划分为 9 个字段，每个字段所表示的含义如下：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>用户名 : 加密密码 : 最后一次修改时间 : 最小修改时间间隔 : 密码有效期 : 密码需要变更前的警告天数 : 密码过期后的宽限时间 : 账号失效时间 : 保留字段</pre></td></tr></table></figure><p>添加以下信息：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>shadow</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root::19424:0:99999:7:::</pre></td></tr></table></figure><p>note：这里的加密密码保存的是真正加密的密码，目前 Linux 的密码采用的是 SHA512 散列加密算法，原来采用的是 MD5 或 DES 加密算法；而最后一次修改时间是指在 1970 年 1 月 1 日之后的第 n 天修改，eg：19424，可通过  <code>date -d &quot;1970-01-01 19424 days&quot; </code>  得到  <code>2023年 03月 08日 星期三 00:00:00 CST</code> 。</p>\n<ul>\n<li><strong>/etc/group</strong></li>\n</ul>\n<p><code>/ect/group</code>  文件是用户组配置文件，即用户组的所有信息都存放在此文件中。</p>\n<p>文件中每行代表一个用户组信息，以  <code>:</code>  作为分隔符，划分为 4 个字段，，每个字段所表示的含义如下：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>组名 : 密码 : GID（组ID） : 该用户组中的用户列表</pre></td></tr></table></figure><p>添加以下信息：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>shadow</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root:x:0:</pre></td></tr></table></figure><p>note：和  <code>/etc/passwd</code>  文件一样，这里的 &quot;x&quot; 仅仅是密码标识，真正加密后的组密码默认保存在  <code>/etc/gshadow</code>  文件中。</p>\n<ul>\n<li><strong>/etc/gshadow</strong></li>\n</ul>\n<p><code>/etc/gshadow</code>  文件，用于存储 Linux 系统中组用户的密码信息。</p>\n<p>文件中每行代表一个组用户的密码信息，以  <code>:</code>  作为分隔符，划分为 4 个字段，每个字段所表示的含义如下：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>组名 : 加密密码 : 组管理员 : 组附加用户列表</pre></td></tr></table></figure><p>添加以下信息：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>gshadow</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root:*::</pre></td></tr></table></figure><p>最后，添加上这几个文件后再运行一次：</p>\n<p><img data-src=\"QQ%E5%9B%BE%E7%89%8720240829211053.png\" alt=\"\" /></p>\n<p>这下子，基本的 rootfs 雏形就出来了。</p>\n<h2 id=\"添加-inittab-文件\"><a class=\"anchor\" href=\"#添加-inittab-文件\">#</a> 添加 inittab 文件</h2>\n<p>为什么需要这个文件？Linux 内核启动完成后，内核通过启动第一个用户进程（init 进程）来启动其他用户记的进程或服务，init 进程是 Linux 系统中所有进程的父进程。</p>\n<p>init 进程将解析 inittab 文件，运行操作系统的配置脚本，对 Linux 系统进行初始化：</p>\n<p><img data-src=\"1436095-20180709194017319-1896253481.png\" alt=\"img\" /></p>\n<p>inittab 文件是一个不可执行的文本文件，它被按照固定的格式书写，以供 init 进程识别；inittab 由若干条指令组成，每条指令的结构都相同，以  <code>:</code>  作为分隔符，划分为 4 个字段，每个字段所表示的含义如下：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>identifier : runlevels : action : process</pre></td></tr></table></figure><ol>\n<li>\n<p>identifier</p>\n<p>用于唯一标识 inittab 文件中的每条指令。</p>\n</li>\n<li>\n<p>runlevels</p>\n<table>\n<thead>\n<tr>\n<th>level</th>\n<th>note</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>runlevel  0</td>\n<td>让 init 关闭所有进程并终止系统。</td>\n</tr>\n<tr>\n<td>runlevel  1</td>\n<td>用来将系统转到单用户模式，单用户模式只能有系统管理员进入，在该模式下处理那些在有登录用户的情况下不能进行更改的文件，改 runlevel 的编号 1 也可以用 S 代替。</td>\n</tr>\n<tr>\n<td>runlevel  2</td>\n<td>允许系统进入多用户的模式，但并不支持文件共享，这种模式很少应用。</td>\n</tr>\n<tr>\n<td>runlevel  3</td>\n<td>最常用的运行模式，主要用来提供真正的多用户模式，也是多数服务器的缺省模式。</td>\n</tr>\n<tr>\n<td>runlevel  4</td>\n<td>一般不被系统使用，用户可以设计自己的系统状态并将其应用到 runlevel。</td>\n</tr>\n<tr>\n<td>runlevel  5</td>\n<td>将系统初始化为专用的 X Window 终端。对功能强大的 Linux 系统来说，这并不是好的选择，但用户如果需要这样，也可以通过在 runlevel 启动来实现该方案。</td>\n</tr>\n<tr>\n<td>runlevel  6</td>\n<td>关闭所有运行的进程并重新启动系统。</td>\n</tr>\n</tbody>\n</table>\n</li>\n<li>\n<p>action</p>\n<table>\n<thead>\n<tr>\n<th>字段</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>sysinit</td>\n<td>在系统初始化的时候 process 才会执行一次。</td>\n</tr>\n<tr>\n<td>wait</td>\n<td>告诉 init，要等待相应的进程执行完以后才能继续执行。</td>\n</tr>\n<tr>\n<td>once</td>\n<td>init 只运行一次该进程。</td>\n</tr>\n<tr>\n<td>respawn</td>\n<td>init 会监视这个 process，即使其结束后也会立即被重新启动。</td>\n</tr>\n<tr>\n<td>askfirst</td>\n<td>与 respawn 类似，在运行 process 之前在控制台上显示 “Please press Enter to activate this console.”。只要用户按下 “Enter” 键以后才会执行 process。</td>\n</tr>\n<tr>\n<td>ctrlaltdel</td>\n<td>当 Ctrl+Alt+Del 三个键同时按下时会执行 process。</td>\n</tr>\n<tr>\n<td>restart</td>\n<td>当 init 重启的时候才会执行 procee。</td>\n</tr>\n<tr>\n<td>shutdown</td>\n<td>关机的时候执行 process。</td>\n</tr>\n</tbody>\n</table>\n</li>\n<li>\n<p>process</p>\n<p>表示所要执行的程序、脚本或命令等。</p>\n</li>\n</ol>\n<p>在了解完 inittab 文件的作用后，那么你可以编写你所需要的执行操作了；在这里你可能会问，前面没有创建  <code>/etc/inittab</code>  文件，那为何可以对 Linux 系统进行初始化，这个其实查看代码可以看到，当无法获取  <code>/etc/inittab</code>  文件时，将会使用固定流程进行初始化：</p>\n<p><img data-src=\"image-20240829221814093.png\" alt=\"image-20240829221814093\" /></p>\n<p>但对于固定流程，我们更偏向于自定义初始化流程，因此可以简单编写：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>inittab</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre># Boot-time system configuration/initialization script.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre># This is run first except when booting in emergency (-b) mode.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>::sysinit:/etc/init.d/rcS</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>::askfirst:-/bin</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>#::askfirst:-/bin/login</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre># Stuff to do before rebooting</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>::ctrlaltdel:/sbin/reboot</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre># umount all filesystem</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>::shutdown:/bin/umount -a -r</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>#::shutdown:/sbin/swapoff -a</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre># restart init process</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>::restart:/sbin/init</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre># Example of how to put a getty on a serial line (for a terminal)</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>::once:/sbin/getty -L tty0 115200 vt100 -n root -I \"Auto login as root ...\"</pre></td></tr></table></figure><h1 id=\"扩展-bosybox-执行命令\"><a class=\"anchor\" href=\"#扩展-bosybox-执行命令\">#</a> 扩展 bosybox 执行命令</h1>\n<p>这里的拓展命令，并不是指基于原有的 bosybox 工程追加命令，而是通过新的工程编译成独立的执行文件，用以拓展命令。</p>\n<p>对于新增编译的 bosybox，一般要满足两个要求：</p>\n<ol>\n<li>glibc 版本的兼容</li>\n<li>尽可能使 bosybox 版本一致</li>\n</ol>\n<h2 id=\"glibc-版本获取\"><a class=\"anchor\" href=\"#glibc-版本获取\">#</a> GLIBC 版本获取</h2>\n<p><strong>方法一：</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"><span>get_glibc_version.c</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span>                                                                </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;gnu/libc-version.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span> str_gnu_ver <span class=\"token operator\">=</span> <span class=\"token function\">gnu_get_libc_version</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gnuc lib version : %s \\n\"</span><span class=\"token punctuation\">,</span>str_gnu_ver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"__GLIBC__ =  %d \\n\"</span><span class=\"token punctuation\">,</span>__GLIBC__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"__GLIBC_MINOR__  = %d \\n\"</span><span class=\"token punctuation\">,</span>__GLIBC_MINOR__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>编译运行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>gcc get_glibc_version.c <span class=\"token parameter variable\">-o</span> get_glibc_version</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>./get_glibc_version</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>gnuc lib version <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2.23</span> </pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>__GLIBC__ <span class=\"token operator\">=</span>  <span class=\"token number\">2</span> </pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>__GLIBC_MINOR__  <span class=\"token operator\">=</span> <span class=\"token number\">23</span></pre></td></tr></table></figure><p>这里利用哪个交叉编译器，输出的版本就是该编译器的 GLIBC 版本。</p>\n<p>note：GNU C 从 2.0 开始，为 GLIBC 提供两个常量  <code>__GLIBC__</code>  和  <code>__GLIBC_MINOR__</code>  用来指示版本。</p>\n<p><strong>方法二：</strong></p>\n<p>对于开发平台，找到你的交叉编译器所在的安装文件夹，从里面找到  <code>libc.so.6</code>  文件，在该目录下或指向该目录（eg： <code>/usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/arm-none-linux-gnueabihf/libc/lib/</code> ），运行以下命令：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>strings /usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/arm-none-linux-gnueabihf/libc/lib/libc.so.6 <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> ^GLIBC</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.4</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.5</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.6</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.7</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.8</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.9</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.10</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.11</pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.12</pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.13</pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.14</pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.15</pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.16</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.17</pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.18</pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.22</pre></td></tr><tr><td data-num=\"18\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.23</pre></td></tr><tr><td data-num=\"19\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.24</pre></td></tr><tr><td data-num=\"20\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.25</pre></td></tr><tr><td data-num=\"21\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.26</pre></td></tr><tr><td data-num=\"22\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.27</pre></td></tr><tr><td data-num=\"23\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.28</pre></td></tr><tr><td data-num=\"24\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.29</pre></td></tr><tr><td data-num=\"25\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.30</pre></td></tr><tr><td data-num=\"26\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.32</pre></td></tr><tr><td data-num=\"27\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.33</pre></td></tr><tr><td data-num=\"28\"></td><td data-command=\"\"></td><td><pre>GLIBC_PRIVATE</pre></td></tr><tr><td data-num=\"29\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.29</pre></td></tr><tr><td data-num=\"30\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.26</pre></td></tr><tr><td data-num=\"31\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.25</pre></td></tr><tr><td data-num=\"32\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.23</pre></td></tr><tr><td data-num=\"33\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.8</pre></td></tr><tr><td data-num=\"34\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.33</pre></td></tr><tr><td data-num=\"35\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.30</pre></td></tr><tr><td data-num=\"36\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.5</pre></td></tr><tr><td data-num=\"37\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.9</pre></td></tr><tr><td data-num=\"38\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.7</pre></td></tr><tr><td data-num=\"39\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.6</pre></td></tr><tr><td data-num=\"40\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.18</pre></td></tr><tr><td data-num=\"41\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.14</pre></td></tr><tr><td data-num=\"42\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.11</pre></td></tr><tr><td data-num=\"43\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.16</pre></td></tr><tr><td data-num=\"44\"></td><td data-command=\"\"></td><td><pre>GLIBC_2.13</pre></td></tr></table></figure><p>通常 <span class=\"exturl\" data-url=\"aHR0cDovL2xpYmMuc28=\">libc.so</span> 会支持多个版本，即向前兼容，查看该文件中包含的字符串可以看到其支持的版本，通常是连续的。</p>\n<p>对于目标平台，同样在相关的  <code>lib</code>  库目录上找到  <code>libc.so.6</code>  文件，然后通过执行或查看软链接：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>/lib/lib.so.6</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>GNU C Library <span class=\"token punctuation\">(</span>GNU libc<span class=\"token punctuation\">)</span> stable release version <span class=\"token number\">2.21</span>, by Roland McGrath et al.</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>Copyright <span class=\"token punctuation\">(</span>C<span class=\"token punctuation\">)</span> <span class=\"token number\">2015</span> Free Software Foundation, Inc.</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>This is <span class=\"token function\">free</span> software<span class=\"token punctuation\">;</span> see the <span class=\"token builtin class-name\">source</span> <span class=\"token keyword\">for</span> copying conditions.</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>There is NO warranty<span class=\"token punctuation\">;</span> not even <span class=\"token keyword\">for</span> MERCHANTABILITY or FITNESS FOR A</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>PARTICULAR PURPOSE.</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>Compiled by GNU CC version <span class=\"token number\">5.3</span>.1 <span class=\"token number\">20160113</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>Available extensions:</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>        crypt add-on version <span class=\"token number\">2.1</span> by Michael Glad and others</pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>        GNU Libidn by Simon Josefsson</pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>        Native POSIX Threads Library by Ulrich Drepper et al</pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>        BIND-8.2.3-T5B</pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>libc ABIs: UNIQUE</pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>For bug reporting instructions, please see:</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre><span class=\"token operator\">&lt;</span>http://www.gnu.org/software/libc/bugs.html<span class=\"token operator\">></span>.</pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">ls</span> <span class=\"token parameter variable\">-al</span> /lib/lib.so.6</pre></td></tr><tr><td data-num=\"18\"></td><td data-command=\"\"></td><td><pre>lrwxrwxrwx    <span class=\"token number\">1</span> root     root            <span class=\"token number\">12</span> Mar <span class=\"token number\">8</span>  <span class=\"token number\">2023</span> /lib/libc.so.6 -<span class=\"token operator\">></span> libc-2.21.so</pre></td></tr></table></figure><h2 id=\"bosybox-版本获取\"><a class=\"anchor\" href=\"#bosybox-版本获取\">#</a> bosybox 版本获取</h2>\n<p>主要是获取目标平台上的版本，然后下载相应的 bosybox 版本进行拓展编译。关于获取目标平台上的版本，可以通过执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>bosybox</pre></td></tr></table></figure><p>然后下载相应版本进行编译，在这里需要  <code>make menuconfig</code>  把静态编译勾上：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>-> Settings</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  -> [*] Build static binary (no shared libs)</pre></td></tr></table></figure><p>因为如果用动态编译的话，需要调用  <code>lib</code>  库，这样就会使得需要确保交叉编译器得尽可能一致，使用的  <code>lib</code>  库也要尽可能一致，而利用静态编译就不用调用  <code>lib</code>  库了。</p>\n<h2 id=\"实现合并\"><a class=\"anchor\" href=\"#实现合并\">#</a> 实现合并</h2>\n<p>当你编译好一个新的 busybox 后，在 rootfs 上找个目录存放，或者取一个 busybox1 之类的名字存放至  <code>/bin</code>  目录上，然后把生成软链接拓展命令，替换链接到新的 busybox1 即可。</p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9mdXppZGFnZS5naXRodWIuaW8vMjAyNC8wNy8yMC9MaW51eCVFNSU4NiU4NSVFNiVBMCVCOC1yb290ZnMlRTYlOUUlODQlRTUlQkIlQkElRTclQTclQkIlRTYlQTQlOEQvIzMtZ291LWppYW4tZ2VuLXdlbi1qaWFuLXhpLXRvbmc=\">https://fuzidage.github.io/2024/07/20/Linux 内核 - rootfs 构建移植 /#3-gou-jian-gen-wen-jian-xi-tong</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5sdWp1bi5vcmcuY24vP3A9MzU3NA==\">http://www.lujun.org.cn/?p=3574</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGluZmVuZy1sZWFybmluZy9wLzkyODU1NDMuaHRtbA==\">https://www.cnblogs.com/linfeng-learning/p/9285543.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2Jsb2cuY2hpbmF1bml4Lm5ldC91aWQtMjA1NjQ4NDgtaWQtNzM5NTQuaHRtbA==\">http://blog.chinaunix.net/uid-20564848-id-73954.html</span></p>\n",
            "tags": [
                "Linux",
                "arm_linux"
            ]
        },
        {
            "id": "https://arachnid.cc/6ull-kernel-transplant/",
            "url": "https://arachnid.cc/6ull-kernel-transplant/",
            "title": "imx-6ULL kernel 移植",
            "date_published": "2023-03-04T15:32:46.000Z",
            "content_html": "<blockquote>\n<p>开发平台：Ubuntu 18.04.6</p>\n<p>目标平台：imx-6ull</p>\n<p>kernel 版本：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL254cC1pbXgvbGludXgtaW14L3RyZWUvaW14XzUuNC43MF8yLjMuMA==\">linux-imx-imx_5.4.70_2.3.0</span></p>\n<p>编译工具链：gcc versions 10.3.1 20210621 (GNU Toolchain for the A-profile Architecture 10.3-2021.07 (arm-10.29))</p>\n</blockquote>\n<h1 id=\"环境搭建\"><a class=\"anchor\" href=\"#环境搭建\">#</a> 环境搭建</h1>\n<h2 id=\"交叉编译器\"><a class=\"anchor\" href=\"#交叉编译器\">#</a> 交叉编译器</h2>\n<p>关于 arm linux 交叉编译工具链的搭建，这里就再不展开说明了，毕竟在此之前如果有移植过 uboot，那么这里就可以省略了，对于没有搭过交叉编译工具链的，可以查看上一篇 <a href=\"https://arachnid.cc/6ull-uboot-transplant/\">imx-6ULL uboot 移植</a> 的交叉编译搭建的环节。</p>\n<h2 id=\"kernel-源码\"><a class=\"anchor\" href=\"#kernel-源码\">#</a> kernel 源码</h2>\n<p>NXP 维护的 kernel 仓库地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL254cC1pbXgvbGludXgtaW14\">https://github.com/nxp-imx/linux-imx</span></p>\n<p>获取 NXP kernel 5.4.70_2.3.0 版本的源码：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 直接拉取 5.4.70_2.3.0 版本源码文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">git</span> clone <span class=\"token parameter variable\">-b</span> imx_5.4.70_2.3.0 https://github.com/nxp-imx/linux-imx</pre></td></tr></table></figure><h1 id=\"编译验证\"><a class=\"anchor\" href=\"#编译验证\">#</a> 编译验证</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-s</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ARCH</span><span class=\"token operator\">=</span>arm</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CROSS_COMPILE</span><span class=\"token operator\">=</span>arm-none-linux-gnueabihf-</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">make</span> distclean</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">make</span> imx_v7_defconfig</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">make</span></pre></td></tr></table></figure><p>第一次编译可能不会通过，如果出现以下报错：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HOSTCC  scripts/extract-cert</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>scripts/extract-cert.c:21:10: fatal error: openssl/bio.h: 没有那个文件或目录</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">#include &lt;openssl/bio.h></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>          ^~~~~~~~~~~~~~~</pre></td></tr></table></figure><p>则需要安装相应的依赖库：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> libssl-dev</pre></td></tr></table></figure><p>出现：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/bin/sh: <span class=\"token number\">1</span>: lzop: not found</pre></td></tr></table></figure><p>安装：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> lzop</pre></td></tr></table></figure><p>最后再次编译验证，最后得到  <code>arch/arm/boot</code>  目录下的  <code>zImage</code>  内核文件以及  <code>arch/arm/boot/dts</code>  目录下所需的  <code>.dtb</code>  设备树文件。</p>\n<h1 id=\"移植\"><a class=\"anchor\" href=\"#移植\">#</a> 移植</h1>\n<h2 id=\"设备树文件\"><a class=\"anchor\" href=\"#设备树文件\">#</a> 设备树文件</h2>\n<p>1、 <code>imx6ull-14x14-lanjut-emmc.dts</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">ls</span> arch/arm/boot/dts/*6ull*.dts</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-14x14-evk-btwifi.dts</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-14x14-evk-btwifi-oob.dts</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-14x14-evk.dts</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-14x14-evk-emmc.dts</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-14x14-evk-gpmi-weim.dts</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-9x9-evk-btwifi.dts</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-9x9-evk-btwifi-oob.dts</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-9x9-evk.dts</pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-9x9-evk-ldo.dts</pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-colibri-eval-v3.dts</pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-colibri-wifi-eval-v3.dts</pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-phytec-segin-ff-rdk-emmc.dts</pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-phytec-segin-ff-rdk-nand.dts</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre>arch/arm/boot/dts/imx6ull-phytec-segin-lc-rdk-nand.dts</pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> arch/arm/boot/dts/imx6ull-14x14-evk-emmc.dts arch/arm/boot/dts/imx6ull-14x14-lanjut-emmc.dts</pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> arch/arm/boot/dts/imx6ull-14x14-lanjut-emmc.dts</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<p>把  <code>#include &quot;imx6ull-14x14-evk.dts&quot;</code>  更改为  <code>#include &quot;imx6ull-14x14-lanjut.dts&quot;</code>  。</p>\n<p>2、 <code>imx6ull-14x14-lanjut.dts</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> arch/arm/boot/dts/imx6ull-14x14-evk.dts arch/arm/boot/dts/imx6ull-14x14-lanjut.dts</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> arch/arm/boot/dts/imx6ull-14x14-lanjut.dts</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<p>把  <code>#include &quot;imx6ul-14x14-evk.dtsi&quot;</code>  更改为  <code>#include &quot;imx6ull-14x14-lanjut.dtsi&quot;</code>  ；</p>\n<p>同时更改以下内容：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/ &#123;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tmodel = \"i.MX6 ULL 14x14 EVK Board\";</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tcompatible = \"fsl,imx6ull-14x14-evk\", \"fsl,imx6ull\";</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>&#125;;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>改为</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>/ &#123;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tmodel = \"i.MX6 ULL 14x14 LANJUT Board\";</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tcompatible = \"fsl,imx6ull-14x14-lanjut\", \"fsl,imx6ull\";</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>&#125;;</pre></td></tr></table></figure><p>把两个  <code>status = &quot;okay&quot;;</code>  改为  <code>status = &quot;disabled&quot;;</code>  ，这里暂不需要摄像头驱动。</p>\n<p>3、  <code>imx6ull-14x14-lanjut.dtsi</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> arch/arm/boot/dts/imx6ul-14x14-evk.dtsi arch/arm/boot/dts/imx6ull-14x14-lanjut.dtsi</pre></td></tr></table></figure><h2 id=\"配置文件\"><a class=\"anchor\" href=\"#配置文件\">#</a> 配置文件</h2>\n<p>在这里，imx6ull 的 kernel 默认配置文件为  <code>imx_v7_defconfig</code>  ，因此，我们独立一个专属自己的配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> arch/arm/configs/imx_v7_defconfig arch/arm/configs/imx_v7_lanjut_defconfig</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>去除其它芯片类型的设备树的生成</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>CONFIG_SOC_IMX50=y</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>CONFIG_SOC_IMX51=y</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>CONFIG_SOC_IMX53=y</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CONFIG_SOC_IMX6Q=y</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>CONFIG_SOC_IMX6SL=y</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>CONFIG_SOC_IMX6SLL=y</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>CONFIG_SOC_IMX6SX=y</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>CONFIG_SOC_IMX6UL=y</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>CONFIG_SOC_IMX7D=y</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>CONFIG_SOC_IMX7ULP=y</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>CONFIG_SOC_VF610=y</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>改为</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre># CONFIG_SOC_IMX50 is not set</pre></td></tr><tr><td data-num=\"18\"></td><td><pre># CONFIG_SOC_IMX51 is not set</pre></td></tr><tr><td data-num=\"19\"></td><td><pre># CONFIG_SOC_IMX53 is not set</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>CONFIG_SOC_IMX6Q=y</pre></td></tr><tr><td data-num=\"21\"></td><td><pre># CONFIG_SOC_IMX6SL is not set</pre></td></tr><tr><td data-num=\"22\"></td><td><pre># CONFIG_SOC_IMX6SLL is not set</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>CONFIG_SOC_IMX6SX=y</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>CONFIG_SOC_IMX6UL=y</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>CONFIG_SOC_IMX7D=y</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>CONFIG_SOC_IMX7ULP=y</pre></td></tr><tr><td data-num=\"27\"></td><td><pre># CONFIG_SOC_VF610 is not set</pre></td></tr></table></figure><p>这里除了  <code>CONFIG_SOC_IMX6UL</code>  还有几个是必须的，否则编译不过，还有其它关联的直接屏蔽：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># CONFIG_MTD_NAND_VF610_NFC=y</pre></td></tr><tr><td data-num=\"2\"></td><td><pre># CONFIG_NVMEM_VF610_OCOTP=y</pre></td></tr></table></figure><p>最后，添加一个热插拔管理：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CONFIG_UEVENT_HELPER=y</pre></td></tr></table></figure><p>然后，这个配置文件其它东西我们就先不去更改了，因为内核配置太多太复杂了，它们之间的功能关系也很难分清，后面我们使用图形配置操作对需要的功能进行增删。</p>\n<h2 id=\"其它文件\"><a class=\"anchor\" href=\"#其它文件\">#</a> 其它文件</h2>\n<p>为  <code>Makefile</code>  添加新增的文件编译：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> arch/arm/boot/dts/Makefile</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<figure class=\"highlight makefile\"><figcaption data-lang=\"makefile\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>dtb-<span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>CONFIG_SOC_IMX6UL<span class=\"token punctuation\">)</span> <span class=\"token operator\">+=</span> \\</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\timx6ul-14x14-evk.dtb \\</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\timx6ul-14x14-evk-csi.dtb \\</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\timx6ul-14x14-evk-emmc.dtb \\</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\timx6ul-14x14-evk-btwifi.dtb \\</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\timx6ul-14x14-evk-btwifi-oob.dtb \\</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\timx6ul-14x14-evk-ecspi-slave.dtb \\</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\timx6ul-14x14-evk-ecspi.dtb \\</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\timx6ul-14x14-evk-gpmi-weim.dtb \\</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\timx6ul-9x9-evk.dtb \\</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\timx6ul-9x9-evk-ldo.dtb \\</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\timx6ul-9x9-evk-btwifi.dtb \\</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\timx6ul-9x9-evk-btwifi-oob.dtb \\</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\timx6ul-ccimx6ulsbcexpress.dtb \\</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\timx6ul-ccimx6ulsbcpro.dtb \\</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\timx6ul-geam.dtb \\</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\timx6ul-isiot-emmc.dtb \\</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\timx6ul-isiot-nand.dtb \\</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\timx6ul-kontron-n6310-s.dtb \\</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\timx6ul-kontron-n6310-s-43.dtb \\</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\timx6ul-liteboard.dtb \\</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\timx6ul-opos6uldev.dtb \\</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\timx6ul-pico-hobbit.dtb \\</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\timx6ul-pico-pi.dtb \\</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\timx6ul-phytec-segin-ff-rdk-nand.dtb \\</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\timx6ul-tx6ul-0010.dtb \\</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\timx6ul-tx6ul-0011.dtb \\</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\timx6ul-tx6ul-mainboard.dtb \\</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\timx6ull-14x14-evk.dtb \\</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\timx6ull-14x14-evk-emmc.dtb \\</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\timx6ull-14x14-evk-btwifi.dtb \\</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\timx6ull-14x14-evk-btwifi-oob.dtb \\</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\timx6ull-14x14-evk-gpmi-weim.dtb \\</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\timx6ull-14x14-lanjut-emmc.dtb \\  <span class=\"token comment\"># 将设备树文件添加进编译项</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\timx6ull-9x9-evk.dtb \\</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\timx6ull-9x9-evk-ldo.dtb \\</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\timx6ull-9x9-evk-btwifi.dtb \\</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\timx6ull-9x9-evk-btwifi-oob.dtb \\</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\timx6ull-colibri-eval-v3.dtb \\</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\timx6ull-colibri-wifi-eval-v3.dtb \\</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\timx6ull-phytec-segin-ff-rdk-nand.dtb \\</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\timx6ull-phytec-segin-ff-rdk-emmc.dtb \\</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\timx6ull-phytec-segin-lc-rdk-nand.dtb \\</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\timx6ulz-14x14-evk.dtb \\</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\timx6ulz-14x14-evk-btwifi.dtb \\</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\timx6ulz-14x14-evk-gpmi-weim.dtb \\</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\timx6ulz-14x14-evk-emmc.dtb</pre></td></tr></table></figure><h1 id=\"外设配置\"><a class=\"anchor\" href=\"#外设配置\">#</a> 外设配置</h1>\n<p>这里不多阐述了，主要是根据你的硬件进行修改，是对设备树、功能配置、函数修改的操作。</p>\n<h1 id=\"配置内核\"><a class=\"anchor\" href=\"#配置内核\">#</a> 配置内核</h1>\n<h2 id=\"图形配置\"><a class=\"anchor\" href=\"#图形配置\">#</a> 图形配置</h2>\n<p>需要先  <code>make xxx_config</code>  生成  <code>.config</code>  。</p>\n<p>使用  <code>make menuconfig</code>  调出图形配置界面进行配置；如果  <code>make menuconfig</code>  失败，说明缺少  <code>ncurses</code>  库 ，需要安装  <code>libncurses-dev</code>  ，在安装前则需要加载  <code>libncurses-dev</code>  的<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYWNrYWdlcy51YnVudHUuY29tL2ZvY2FsL2FtZDY0L2xpYm5jdXJzZXMtZGV2L2Rvd25sb2Fk\">源镜像</span>，然后通过  <code>apt update</code>  更新，然后再次使用命令  <code>apt install libncurses-dev </code>  安装，若安装后还不行，可能是由于某些库可能没安装好，或者被  <code>auto remove</code>  掉了，可以尝试以下安装：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">apt</span> <span class=\"token function\">install</span> lib32ncurses5 lib32ncurses5-dev lib32ncursesw5 lib32ncursesw5-dev lib32tinfo-dev lib32tinfo5 libcunit1-ncurses libcunit1-ncurses-dev libncurses5 libncurses5-dbg libncurses5-dev libncursesw5 libncursesw5-dbg libncursesw5-dev</pre></td></tr></table></figure><p>当进入图形菜单后，可以通过以下热键进行选择：</p>\n<ul>\n<li><code>Y</code>  显示为 [*] 。模块驱动编译到内核中，启动时自动加载。</li>\n<li><code>N</code>  显示为 [ ] 。移除该模块驱动。</li>\n<li><code>M</code>  显示为 [M] 。模块会被编译，但是不会被编译到内核中，只是生成  <code>.o</code>  /  <code>.ko</code>  文件，通过  <code>insmod</code>  命令实现动态加载。</li>\n</ul>\n<p>note：如果想要 Load 加载原有的配置信息，那么需要先  <code>make zImage</code>  才能获取回来。</p>\n<h1 id=\"添加编译脚本\"><a class=\"anchor\" href=\"#添加编译脚本\">#</a> 添加编译脚本</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">touch</span> build.sh</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> build.sh</pre></td></tr></table></figure><p><strong>写入：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 若之前已经导入到环境变量则不需要</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span>:/usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/bin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 若已经在顶层 Makefile 文件中指定则不需要</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ARCH</span><span class=\"token operator\">=</span>arm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 若已经在顶层 Makefile 文件中指定则不需要</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CROSS_COMPILE</span><span class=\"token operator\">=</span>arm-none-linux-gnueabihf-</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">make</span> distclean</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">make</span> mx6ull_14x14_lanjut_emmc_defconfig</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token function\">make</span> zImage -j<span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token function\">make</span> dtbs -j<span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token function\">make</span> modules -j<span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span></pre></td></tr></table></figure><h1 id=\"附\"><a class=\"anchor\" href=\"#附\">#</a> 附</h1>\n<p>kernel 文件结构：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">类型</th>\n<th style=\"text-align:center\">名称</th>\n<th style=\"text-align:center\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\" rowspan=\"22\">文件夹</td>\n<td style=\"text-align:center\">arch</td>\n<td style=\"text-align:center\">与架构体系相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">block</td>\n<td style=\"text-align:center\">块设备相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">certs</td>\n<td style=\"text-align:center\">内核签名相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">crypto</td>\n<td style=\"text-align:center\">加密相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Documentation</td>\n<td style=\"text-align:center\">各说明文档</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">drivers</td>\n<td style=\"text-align:center\">驱动相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">fs</td>\n<td style=\"text-align:center\">文件系统相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">include</td>\n<td style=\"text-align:center\">头文件相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">init</td>\n<td style=\"text-align:center\">初始化相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">ipc</td>\n<td style=\"text-align:center\">进程间通信相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">kernel</td>\n<td style=\"text-align:center\">内核相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">lib</td>\n<td style=\"text-align:center\">lib 库文件</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">LICENSES</td>\n<td style=\"text-align:center\">许可证相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">mm</td>\n<td style=\"text-align:center\">内存管理相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">net</td>\n<td style=\"text-align:center\">网络相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">samples</td>\n<td style=\"text-align:center\">例程相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">scripts</td>\n<td style=\"text-align:center\">相关脚本</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">security</td>\n<td style=\"text-align:center\">内核安全模型相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">sound</td>\n<td style=\"text-align:center\">音频处理相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">tools</td>\n<td style=\"text-align:center\">kernel 构建工具相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">usr</td>\n<td style=\"text-align:center\">早期用户空间代码（与 initramfs 文件相关）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">virt</td>\n<td style=\"text-align:center\">内核虚拟机 KVM</td>\n</tr>\n<tr>\n<td style=\"text-align:center\" rowspan=\"7\">文件</td>\n<td style=\"text-align:center\">COPYING</td>\n<td style=\"text-align:center\">版权声明</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">CREDITS</td>\n<td style=\"text-align:center\">贡献者名单</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Kbuild</td>\n<td style=\"text-align:center\">Makefile 引用文件</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Kconfig</td>\n<td style=\"text-align:center\">图形配置界面相关文件</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">MAINTAINERS</td>\n<td style=\"text-align:center\">开发及维护记录</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Makefile</td>\n<td style=\"text-align:center\">主 Makefile 脚本</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">README</td>\n<td style=\"text-align:center\">工程说明</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "Linux",
                "arm_linux",
                "imx6ull"
            ]
        },
        {
            "id": "https://arachnid.cc/6ull-uboot-transplant/",
            "url": "https://arachnid.cc/6ull-uboot-transplant/",
            "title": "imx-6ULL uboot 移植",
            "date_published": "2023-03-03T12:52:11.000Z",
            "content_html": "<blockquote>\n<p>开发平台：Ubuntu 18.04.6</p>\n<p>目标平台：imx-6ull</p>\n<p>uboot 版本：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL254cC1pbXgvdWJvb3QtaW14L3RyZWUvaW14X3YyMDIwLjA0XzUuNC43MF8yLjMuMA==\">uboot-imx-imx_v2020.04_5.4.70_2.3.0</span></p>\n<p>编译工具链：gcc versions 10.3.1 20210621 (GNU Toolchain for the A-profile Architecture 10.3-2021.07 (arm-10.29))</p>\n</blockquote>\n<h1 id=\"环境搭建\"><a class=\"anchor\" href=\"#环境搭建\">#</a> 环境搭建</h1>\n<h2 id=\"交叉编译器\"><a class=\"anchor\" href=\"#交叉编译器\">#</a> 交叉编译器</h2>\n<p>在 ARM <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYXJtLmNvbS9kb3dubG9hZHMvLS9nbnUtYQ==\">官方链接</span>下载 Arm A-profile architecture 编译工具链，选择自己相应的平台，这里的话是： <code>gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf</code>  。</p>\n<p>解压添加至本地：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 创建存放编译工具链的文件夹</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> /usr/local/arm</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 移动文件</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf.tar.xz /usr/local/arm/</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 解压文件</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvf</span> /usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf.tar.xz</pre></td></tr></table></figure><p>添加环境变量：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 添加到系统环境变量 (对所有用户有效)</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/profile</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span>:/usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/bin</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 添加到用户环境变量 (仅对当前用户有效)</span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> ~/.bashrc </pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span>:/usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/bin</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 以上二选一</span></pre></td></tr></table></figure><p>测试命令：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 成功打印版本信息则为通过</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] $\"></td><td><pre>arm-none-linux-gnueabihf-gcc <span class=\"token parameter variable\">-v</span></pre></td></tr></table></figure><h2 id=\"uboot-源码\"><a class=\"anchor\" href=\"#uboot-源码\">#</a> uboot 源码</h2>\n<p>NXP 维护的 uboot 仓库地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL254cC1pbXgvdWJvb3QtaW14\">https://github.com/nxp-imx/uboot-imx</span></p>\n<p>获取 NXP uboot 5.4.70_2.3.0 版本的源码：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 拉取源码文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">git</span> clone https://github.com/nxp-imx/uboot-imx.git</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 切换到</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">git</span> checkout imx_v2020.04_5.4.70_2.3.0</pre></td></tr></table></figure><p>上面的 clone 操作会拉取所有分支文件及历史提交信息下来，文件比较大，如果网络不太好，可以尝试打开 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL254cC1pbXgvdWJvb3QtaW14L3RyZWUvaW14X3YyMDIwLjA0XzUuNC43MF8yLjMuMA==\">https://github.com/nxp-imx/uboot-imx/tree/imx_v2020.04_5.4.70_2.3.0</span> 只下载 ZIP 压缩包下来，然后利用  <code>unzip</code>  命令解压。</p>\n<p>或者使用  <code>git clone -b imx_v2020.04_5.4.70_2.3.0 https://github.com/nxp-imx/uboot-imx.git</code>  直接下载指定版本。</p>\n<p>note：对于不同分支，有  <code>fslc</code>  和  <code>imx</code>  关键字的区分，以下摘录解释：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>There are two BSPs, the BSP Releases which are supported by NXP and their documentation can be found on the Linux i.MX webpage, and the Community BSP.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>A BSP Release roadmap is not publicly available, but as you may see there are new BSPs every several months. However, it usually lags in respect to the Linux Mainline Kernel as a lot of work is done to ensure that the kernel works correctly on the NXP hardware. The kernel from these BSP Releases (linux-imx) can be found on the following repository and it is indeed an upstream from the Community BSP Kernel.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>https://source.codeaurora.org/external/imx/linux-imx/</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>As for the Community BSP, it’s constantly being updated by the Community but due to its nature is hard to predict how fast each branch will be developed.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>You can find more information about the Community BSP on the link below:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>http://freescale.github.io/</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>The Kernel recipes of the community BSP (linux-fslc) would be on the meta-freescale layer:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>http://git.yoctoproject.org/cgit/cgit.cgi/meta-freescale</pre></td></tr></table></figure><p>简单的来讲，就是  <code>imx</code>  是官方发行版，而  <code>fslc</code>  是社区发行版。</p>\n<p>来源：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb21tdW5pdHkubnhwLmNvbS90NS9pLU1YLVByb2Nlc3NvcnMvd2hhdC1pcy10aGUtcHVycG9zZS1vZi1saW51eC1mc2xjLWdpdC9tLXAvMTA0NzYwMg==\">https://community.nxp.com/t5/i-MX-Processors/what-is-the-purpose-of-linux-fslc-git/m-p/1047602</span></p>\n<p>关于 uboot 版本选择：</p>\n<p>随着时间的变化，uboot 的更新也出现了多个的版本，那么到底应该选择哪一个呢？有些人可能会说当然是越新越好啦。其实呢不是这个样子的，虽然 uboot 本身是在不断的开发和进化当中，但对于新版本来说，可能开发者们在某一个版本中加入了一些新的特性，然后呢过了一段时间又发现这个新功能不是很稳定，就有可能会把它删掉或者需要后期继续更新迭代修复；这样一来就会对我们所移植的 uboot 来说就会增加很多不必要的复杂性，因为不排除是否会影响到所使用的功能，所以一般的原则就是够用就可以了，不需要频繁更新。</p>\n<p>那如何选择属于自己的版本呢：</p>\n<ol>\n<li>\n<p>打开下载的 uboot 目录下的： <code>arch/arm/cpu</code>  目录，确认使用的 cpu 型号是否支持及对应。</p>\n</li>\n<li>\n<p>打开 uboot 目录下的： <code>board</code>  目录，查看相对应的外设是否都支持。eq： <code>board/freescale/mx6ull_board/</code>  。</p>\n</li>\n</ol>\n<p>一般来说，uboot 版本越新支持的开发板和 cpu 就越多，代码量就越多，如果我们的 cpu 和开发板的并没有这么多东西，那我们可以不用新的。而用适合自己产品外设的，通常是根据开发板发行的日期和 uboot 的更新日期来找到合适的 uboot。</p>\n<h1 id=\"编译验证\"><a class=\"anchor\" href=\"#编译验证\">#</a> 编译验证</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-s</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ARCH</span><span class=\"token operator\">=</span>arm</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CROSS_COMPILE</span><span class=\"token operator\">=</span>arm-none-linux-gnueabihf-</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">make</span> distclean</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">make</span> mx6ull_14x14_evk_emmc_defconfig</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">make</span></pre></td></tr></table></figure><p>编译源码这一步的目的：</p>\n<ul>\n<li>一是为了验证编译环境是否正常；</li>\n<li>二是为了下一步移植过程中的代码分析（一些文件只有在编译后才会生成）。</li>\n</ul>\n<p>note：</p>\n<p><code>make clean</code>  - 清除了目标机器上可以运行的 bin 文件以及目录，还有中间的过程文件和编译日志，但是会保留内核的配置文件 .config 以及编译支持的扩展模块；</p>\n<p><code>make mrproper</code>  - 在 clean 的基础上，清除了交叉编译工具链、menuconfig 的内容；</p>\n<p><code>make distclean</code>  - 在 mrproper 的基础上，删除编辑器备份和补丁文件。</p>\n<p>删除的文件范围从小到大依次为：  <code>make clean</code>  &lt;  <code>make mrproper</code>  &lt;  <code>make distclean</code>  。</p>\n<p>注意：</p>\n<p>若是提示  <code>make: 未找到命令</code>  ，则需要安装  <code>make</code>  工具：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token function\">make</span></pre></td></tr></table></figure><p>若是出现  <code>/bin/sh: 1: cc: not found</code>  ，需要安装 gcc 依赖，因为  <code>HOSTCC  scripts/basic/fixdep</code>  强制定义使用了 gcc， <code>HOSTCC=gcc</code>  ：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> gcc</pre></td></tr></table></figure><p>若是在系统上第一次编译 uboot 源码可能会遇到缺少   <code>bison</code> 、 <code>flex</code>  的报错信息导致编译失败，只需安装相应的工具包后重新执行编译即可：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 语法分析工具</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> bison</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># 词法分析工具</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[user@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> flex</pre></td></tr></table></figure><p>最后再次编译验证，最后得到主目录下的  <code>u-boot-dtb.imx</code>  镜像文件。</p>\n<h1 id=\"移植\"><a class=\"anchor\" href=\"#移植\">#</a> 移植</h1>\n<p>下面以命名为  <code>lanjut</code>  的板子为例。</p>\n<h2 id=\"开发板文件夹\"><a class=\"anchor\" href=\"#开发板文件夹\">#</a> 开发板文件夹</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">ls</span> <span class=\"token parameter variable\">-d</span> board/freescale/*6ull*</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>board/freescale/mx6ullevk     board/freescale/mx6ull_ddr3_val</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> <span class=\"token parameter variable\">-r</span> board/freescale/mx6ullevk/ board/freescale/mx6ull_lanjut/</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">mv</span> board/freescale/mx6ull_lanjut/mx6ullevk.c board/freescale/mx6ull_lanjut/mx6ull_lanjut.c</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">ls</span> board/freescale/mx6ull_lanjut/</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>imximage.cfg         Kconfig      Makefile        plugin.S</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>imximage_lpddr2.cfg  MAINTAINERS  mx6ull_lanjut.c  README</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<p>1、 <code>Kconfig</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> board/freescale/mx6ull_lanjut/Kconfig</pre></td></tr></table></figure><p>更改内容为（注意该文件  <code>endif</code>  后面必须有换行）：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>if TARGET_MX6ULL_14X14_LANJUT</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>config SYS_BOARD</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tdefault \"mx6ull_lanjut\"</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>config SYS_VENDOR</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tdefault \"freescale\"</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>config SYS_CONFIG_NAME</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tdefault \"mx6ull_lanjut\"</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>config SYS_TEXT_BASE</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tdefault 0x87800000</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>endif</pre></td></tr></table></figure><p>2、 <code>Makefile</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> board/freescale/mx6ull_lanjut/Makefile</pre></td></tr></table></figure><p>把  <code>obj-y  := mx6ullevk.o</code>  改为  <code>obj-y  := mx6ull_lanjut.o</code>  。</p>\n<p>3、 <code>imximage_lpddr2.cfg</code>  和  <code>imximage.cfg</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> board/freescale/mx6ull_lanjut/imximage_lpddr2.cfg</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> board/freescale/mx6ull_lanjut/imximage.cfg</pre></td></tr></table></figure><p>该更改受控于  <code>CONFIG_USE_IMXIMG_PLUGIN</code>  宏定义，在配置文件中是没有使能的，改不改都无所谓，但为了统一，把  <code>PLUGIN\tboard/freescale/mx6ullevk/plugin.bin 0x00907000</code>  改为  <code>PLUGIN\tboard/freescale/mx6ull_lanjut/plugin.bin 0x00907000</code>  。</p>\n<p>4、 <code>MAINTAINERS</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> board/freescale/mx6ull_lanjut/MAINTAINERS</pre></td></tr></table></figure><p>是维护者记录文件，作为个人使用，改不改都无所谓；如果是作为 uboot 项目维护者，则需要完整记录好详细的信息，以便更好的发展维护。</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>MX6ULL_LANJUT BOARD</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>M:\tArachnid &lt;xxxx@qq.com></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>S:\tMaintained</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>F:\tboard/freescale/mx6ull_lanjut/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>F:\tinclude/configs/mx6ull_lanjut.h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>F:\tconfigs/mx6ull_14x14_lanjut_defconfig</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>F:\tconfigs/mx6ull_14x14_lanjut_plugin_defconfig</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>F:\tconfigs/mx6ulz_14x14_lanjut_defconfig</pre></td></tr></table></figure><p>5、 <code>mx6ull_lanjut.c</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> board/freescale/mx6ull_lanjut/mx6ull_lanjut.c</pre></td></tr></table></figure><ul>\n<li>\n<p><code>board_late_init</code>  函数</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">board_late_init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_CMD_BMODE</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token function\">add_board_boot_modes</span><span class=\"token punctuation\">(</span>board_boot_modes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">env_set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tee\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"no\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_IMX_OPTEE</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token function\">env_set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tee\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"yes\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_ENV_VARS_UBOOT_RUNTIME_CONFIG</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token function\">env_set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"board_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LANJUT\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 决定了后面 findfdt 和 findtee 环境变量的选择</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_mx6ull_9x9_evk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token function\">env_set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"board_rev\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"9X9\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token function\">env_set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"board_rev\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"14X14\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_cpu_type</span><span class=\"token punctuation\">(</span>MXC_CPU_MX6ULZ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token function\">env_set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"board_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ULZ-EVK\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token function\">env_set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"usb_net_cmd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"usb start\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token function\">setup_lcd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_ENV_IS_IN_MMC</span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token function\">board_late_mmc_env_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token function\">set_wdog_reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">wdog_regs</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>WDOG1_BASE_ADDR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p><code>checkboard</code>  函数</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">checkboard</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_mx6ull_9x9_evk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Board: MX6ULL 9x9 EVK\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_cpu_type</span><span class=\"token punctuation\">(</span>MXC_CPU_MX6ULZ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Board: MX6ULZ 14x14 EVK\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Board: MX6ULL 14x14 LANJUT\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">//uboot 板载信息显示</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"设备树文件\"><a class=\"anchor\" href=\"#设备树文件\">#</a> 设备树文件</h2>\n<p>在新版本 uboot 中，参考 Linux 内核引入了<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZGV2aWNldHJlZS5vcmcv\">设备树</span>和<span class=\"exturl\" data-url=\"aHR0cHM6Ly91LWJvb3QucmVhZHRoZWRvY3MuaW8vZW4vbGF0ZXN0L2RldmVsb3AvZHJpdmVyLW1vZGVsL2luZGV4Lmh0bWw=\">驱动模型 (Driver Model)</span>。</p>\n<p>1、 <code>imx6ull-14x14-lanjut-emmc.dts</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">ls</span> arch/arm/dts/*6ull*.dts</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-14x14-ddr3-val.dts</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-14x14-ddr3-val-emmc.dts</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-14x14-ddr3-val-epdc.dts</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-14x14-ddr3-val-gpmi-weim.dts</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-14x14-ddr3-val-lcdif.dts</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-14x14-ddr3-val-tsc.dts</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-14x14-evk.dts</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-14x14-evk-emmc.dts</pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-14x14-evk-gpmi-weim.dts</pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-9x9-evk.dts</pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-colibri.dts</pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-dart-6ul.dts</pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-phytec-segin-ff-rdk-emmc.dts</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre>arch/arm/dts/imx6ull-somlabs-visionsom.dts</pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> arch/arm/dts/imx6ull-14x14-evk-emmc.dts arch/arm/dts/imx6ull-14x14-lanjut-emmc.dts</pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> arch/arm/dts/imx6ull-14x14-lanjut-emmc.dts</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<p>把  <code>#include &quot;imx6ull-14x14-evk.dts&quot;</code>  更改为  <code>#include &quot;imx6ull-14x14-lanjut.dts&quot;</code>  。</p>\n<p>2、 <code>imx6ull-14x14-lanjut.dts</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> arch/arm/dts/imx6ull-14x14-evk.dts arch/arm/dts/imx6ull-14x14-lanjut.dts</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> arch/arm/dts/imx6ull-14x14-lanjut.dts</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<p>把  <code>#include &quot;imx6ul-14x14-evk.dtsi&quot;</code>  更改为  <code>#include &quot;imx6ul-14x14-lanjut.dtsi&quot;</code>  ；</p>\n<p>把  <code>#include &quot;imx6ul-14x14-evk-u-boot.dtsi&quot;</code>  更改为  <code>#include &quot;imx6ul-14x14-lanjut-u-boot.dtsi&quot;</code>  。</p>\n<p>同时更改以下内容：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/ &#123;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tmodel = \"i.MX6 ULL 14x14 EVK Board\";</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tcompatible = \"fsl,imx6ull-14x14-evk\", \"fsl,imx6ull\";</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>&#125;;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>改为</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>/ &#123;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tmodel = \"i.MX6 ULL 14x14 LANJUT Board\";</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tcompatible = \"fsl,imx6ull-14x14-lanjut\", \"fsl,imx6ull\";</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>&#125;;</pre></td></tr></table></figure><p>3、 <code>imx6ul-14x14-lanjut.dtsi</code>  和  <code>imx6ul-14x14-lanjut-u-boot.dtsi</code>  文件：</p>\n<p>根据  <code>imx6ull-14x14-lanjut.dts</code>  文件的  <code>#include</code>  包含文件，分别添加文件。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> arch/arm/dts/imx6ul-14x14-evk.dtsi arch/arm/dts/imx6ul-14x14-lanjut.dtsi</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> arch/arm/dts/imx6ul-14x14-evk-u-boot.dtsi arch/arm/dts/imx6ul-14x14-lanjut-u-boot.dtsi</pre></td></tr></table></figure><h2 id=\"配置文件\"><a class=\"anchor\" href=\"#配置文件\">#</a> 配置文件</h2>\n<p>1、 <code>mx6ull_14x14_lanjut_emmc_defconfig</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">ls</span> configs/*6ull*</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>configs/colibri-imx6ull_defconfig</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_ddr3_val_defconfig</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_ddr3_val_emmc_defconfig</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_ddr3_val_epdc_defconfig</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_ddr3_val_nand_defconfig</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_ddr3_val_plugin_defconfig</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_ddr3_val_qspi1_defconfig</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_ddr3_val_spinor_defconfig</pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_ddr3_val_tsc_defconfig</pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_evk_defconfig</pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_evk_emmc_defconfig</pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_evk_nand_defconfig</pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_evk_optee_defconfig</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_evk_plugin_defconfig</pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_14x14_evk_qspi1_defconfig</pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_9x9_evk_defconfig</pre></td></tr><tr><td data-num=\"18\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_9x9_evk_plugin_defconfig</pre></td></tr><tr><td data-num=\"19\"></td><td data-command=\"\"></td><td><pre>configs/mx6ull_9x9_evk_qspi1_defconfig</pre></td></tr><tr><td data-num=\"20\"></td><td data-command=\"\"></td><td><pre>configs/somlabs_visionsom_6ull_defconfig</pre></td></tr><tr><td data-num=\"21\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> configs/mx6ull_14x14_evk_emmc_defconfig configs/mx6ull_14x14_lanjut_emmc_defconfig</pre></td></tr><tr><td data-num=\"22\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> configs/mx6ull_14x14_lanjut_emmc_defconfig</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<p>把  <code>CONFIG_TARGET_MX6ULL_14X14_EVK=y</code>  改为  <code>CONFIG_TARGET_MX6ULL_14X14_LANJUT=y</code>  ；</p>\n<p>把  <code>CONFIG_SYS_EXTRA_OPTIONS=&quot;IMX_CONFIG=board/freescale/mx6ullevk/imximage.cfg&quot;</code>  改为  <code>CONFIG_SYS_EXTRA_OPTIONS=&quot;IMX_CONFIG=board/freescale/mx6ull_lanjut/imximage.cfg&quot;</code>  ；</p>\n<p>把  <code>CONFIG_DEFAULT_DEVICE_TREE=&quot;imx6ull-14x14-evk-emmc&quot;</code>  改为  <code>CONFIG_DEFAULT_DEVICE_TREE=&quot;imx6ull-14x14-lanjut-emmc&quot;</code>  。</p>\n<p>2、 <code>include/configs/mx6ull_lanjut.h</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">ls</span> include/configs/*6ull*</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>include/configs/colibri-imx6ull.h  include/configs/mx6ullevk.h</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>include/configs/mx6ull_ddr3_val.h  include/configs/somlabs_visionsom_6ull.h</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">cp</span> include/configs/mx6ullevk.h include/configs/mx6ull_lanjut.h</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> include/configs/mx6ull_lanjut.h</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<p>把  <code>#ifndef __MX6ULLEVK_CONFIG_H</code>  和  <code>#define __MX6ULLEVK_CONFIG_H</code>  改为  <code>#ifndef __MX6ULL_LANJUT_CONFIG_H</code>  和  <code>#define __MX6ULL_LANJUT_CONFIG_H</code>  。</p>\n<p>更改 uboot 默认命令配置值：</p>\n<ul>\n<li>\n<p>findfdt（用于设置  <code>fdt_file</code>  变量，根据  <code>board_name</code>  来指定<strong>传递给内核的设备树</strong>文件名）</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>\"findfdt=\"\\</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t\t\t\"if test $fdt_file = undefined; then \" \\</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t\t\t\"if test $board_name = ULZ-EVK &amp;&amp; test $board_rev = 14X14; then \" \\</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t\t\t\t\"setenv fdt_file imx6ulz-14x14-evk.dtb; fi; \" \\</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t\t\"if test $board_name = EVK &amp;&amp; test $board_rev = 9X9; then \" \\</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\t\t\t\"setenv fdt_file imx6ull-9x9-evk.dtb; fi; \" \\</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t\t\"if test $board_name = EVK &amp;&amp; test $board_rev = 14X14; then \" \\</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t\t\t\"setenv fdt_file imx6ull-14x14-evk.dtb; fi; \" \\</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t\t\"if test $board_name = LANJUT &amp;&amp; test $board_rev = 14X14; then \" \\</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t\t\t\"setenv fdt_file imx6ull-14x14-lanjut.dtb; fi; \" \\</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t\t\"if test $fdt_file = undefined; then \" \\</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t\t\"echo WARNING: Could not determine dtb to use; \" \\</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\t\"fi; \" \\</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t\"fi;\\0\" \\</pre></td></tr></table></figure></li>\n<li>\n<p>findtee（用于设置  <code>tee_file</code>  变量，根据  <code>board_name</code>  来指定 uboot 设备树文件名）</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>\"findtee=\"\\</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t\t\t\"if test $tee_file = undefined; then \" \\</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t\t\t\"if test $board_name = ULZ-EVK &amp;&amp; test $board_rev = 14X14; then \" \\</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t\t\t\t\"setenv tee_file uTee-6ulzevk; fi; \" \\</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t\t\"if test $board_name = EVK &amp;&amp; test $board_rev = 9X9; then \" \\</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\t\t\t\"setenv tee_file uTee-6ullevk; fi; \" \\</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t\t\"if test $board_name = EVK &amp;&amp; test $board_rev = 14X14; then \" \\</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t\t\t\"setenv tee_file uTee-6ullevk; fi; \" \\</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t\t\"if test $board_name = LANJUT &amp;&amp; test $board_rev = 14X14; then \" \\</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t\t\t\"setenv tee_file uTee-6ull_lanjut; fi; \" \\</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t\t\"if test $tee_file = undefined; then \" \\</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t\t\"echo WARNING: Could not determine tee to use; \" \\</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\t\"fi; \" \\</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t\"fi;\\0\" \\</pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"其它文件\"><a class=\"anchor\" href=\"#其它文件\">#</a> 其它文件</h2>\n<p>1、 <code>Makefile</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> arch/arm/dts/Makefile</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<figure class=\"highlight makefile\"><figcaption data-lang=\"makefile\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>dtb-<span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>CONFIG_MX6ULL<span class=\"token punctuation\">)</span> <span class=\"token operator\">+=</span> \\</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\timx6ull-14x14-ddr3-val.dtb \\</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\timx6ull-14x14-ddr3-val-epdc.dtb \\</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\timx6ull-14x14-ddr3-val-emmc.dtb \\</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\timx6ull-14x14-ddr3-val-gpmi-weim.dtb \\</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\timx6ull-14x14-ddr3-val-tsc.dtb \\</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\timx6ull-14x14-evk.dtb \\</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\timx6ull-14x14-evk-emmc.dtb \\</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\timx6ull-14x14-evk-gpmi-weim.dtb \\</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\timx6ull-14x14-lanjut-emmc.dtb \\  <span class=\"token comment\"># 将设备树文件添加进编译项</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\timx6ull-9x9-evk.dtb \\</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\timx6ull-colibri.dtb \\</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\timx6ull-phytec-segin-ff-rdk-emmc.dtb \\</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\timx6ull-dart-6ul.dtb \\</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\timx6ull-somlabs-visionsom.dtb \\</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\timx6ulz-14x14-evk.dtb \\</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\timx6ulz-14x14-evk-emmc.dtb \\</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\timx6ulz-14x14-evk-gpmi-weim.dtb</pre></td></tr></table></figure><p>2、 <code>Kconfig</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> arch/arm/mach-imx/mx6/Kconfig</pre></td></tr></table></figure><p><strong>修改：</strong></p>\n<p>在  <code>config TARGET_MX6ULL_14X14_EVK</code>  配置的下方添加：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>config TARGET_MX6ULL_14X14_LANJUT</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tbool \"Support mx6ull_14x14_lanjut\"</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tselect BOARD_LATE_INIT</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tselect DM</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tselect DM_THERMAL</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tselect MX6ULL</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\timply CMD_DM</pre></td></tr></table></figure><p>在  <code>source &quot;board/freescale/mx6ullevk/Kconfig&quot;</code>  配置的下方添加：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>source \"board/freescale/mx6ull_lanjut/Kconfig\"</pre></td></tr></table></figure><h1 id=\"定制外设\"><a class=\"anchor\" href=\"#定制外设\">#</a> 定制外设</h1>\n<h2 id=\"移除-74lv595-芯片相关配置\"><a class=\"anchor\" href=\"#移除-74lv595-芯片相关配置\">#</a> 移除 74lv595 芯片相关配置</h2>\n<p>1、 <code>mx6ull_14x14_lanjut_emmc_defconfig</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> configs/mx6ull_14x14_lanjut_emmc_defconfig</pre></td></tr></table></figure><p>由于开发板上不需要用到 74lv595 芯片，因此取消与其相关的配置：</p>\n<ul>\n<li>找到  <code>CONFIG_DM_74X164=y</code>  改为  <code># CONFIG_DM_74X164 is not used</code>  ，官网 EVK 开发板使用了一个 74LV594，这里没有使用所以屏蔽掉。</li>\n<li>找到  <code>CONFIG_SOFT_SPI=y</code>  改为  <code># CONFIG_SOFT_SPI is not used</code>  ，屏蔽掉软件模拟的 SPI，这是官方驱动 74LV594 用的，同样也是用不到。</li>\n</ul>\n<p>2、 <code>imx6ul-14x14-lanjut.dtsi</code>  文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> arch/arm/dts/imx6ul-14x14-lanjut.dtsi</pre></td></tr></table></figure><p>在  <code>configs/mx6ull_14x14_lanjut_emmc_defconfig</code>  文件中，我们有屏蔽掉  <code>74LV594</code>  和  <code>软件模拟的 SPI</code>  的定义使用，因此在设备树操作这里同样把其相关的配置屏蔽掉，从它们的调用关系可以得到以下需要屏蔽：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/ &#123;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t// aliases &#123;</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t// \tspi5 = &amp;&#123;/spi4&#125;;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t// &#125;;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t// reg_can_3v3: regulator-can-3v3 &#123;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t// \tcompatible = \"regulator-fixed\";</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t// \tregulator-name = \"can-3v3\";</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t// \tregulator-min-microvolt = &lt;3300000>;</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t// \tregulator-max-microvolt = &lt;3300000>;</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t// \tgpios = &lt;&amp;gpio_spi 3 GPIO_ACTIVE_LOW>;</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t// &#125;;</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t// spi4 &#123;</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t// \tcompatible = \"spi-gpio\";</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t// \tpinctrl-names = \"default\";</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t// \tpinctrl-0 = &lt;&amp;pinctrl_spi4>;</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t// \tstatus = \"okay\";</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t// \tpinctrl-assert-gpios = &lt;&amp;gpio5 8 GPIO_ACTIVE_LOW>;</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t// \tgpio-sck = &lt;&amp;gpio5 11 0>;</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t// \tgpio-mosi = &lt;&amp;gpio5 10 0>;</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t// \tcs-gpios = &lt;&amp;gpio5 7 0>;</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t// \tnum-chipselects = &lt;1>;</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t// \t#address-cells = &lt;1>;</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t// \t#size-cells = &lt;0>;</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t// \tgpio_spi: gpio@0 &#123;</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t// \t\tcompatible = \"fairchild,74hc595\";</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t// \t\tgpio-controller;</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t// \t\t#gpio-cells = &lt;2>;</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t// \t\treg = &lt;0>;</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t// \t\tregisters-number = &lt;1>;</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t// \t\tregisters-default = /bits/ 8 &lt;0x57>;</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t// \t\tspi-max-frequency = &lt;100000>;</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t// \t&#125;;</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t// &#125;;</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>&#125;;</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>&amp;can1 &#123;</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tpinctrl-names = \"default\";</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tpinctrl-0 = &lt;&amp;pinctrl_flexcan1>;</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t// xceiver-supply = &lt;&amp;reg_can_3v3>;</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tstatus = \"okay\";</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>&#125;;</pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>&amp;can2 &#123;</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tpinctrl-names = \"default\";</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tpinctrl-0 = &lt;&amp;pinctrl_flexcan2>;</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t// xceiver-supply = &lt;&amp;reg_can_3v3>;</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\tstatus = \"okay\";</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>&#125;;</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>&amp;iomuxc &#123;</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\tpinctrl-names = \"default\";</pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t// pinctrl_spi4: spi4grp &#123;</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t// \tfsl,pins = &lt;</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t// \t\tMX6UL_PAD_BOOT_MODE0__GPIO5_IO10\t0x70a1</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t// \t\tMX6UL_PAD_BOOT_MODE1__GPIO5_IO11\t0x70a1</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t// \t\tMX6UL_PAD_SNVS_TAMPER7__GPIO5_IO07\t0x70a1</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t// \t\tMX6UL_PAD_SNVS_TAMPER8__GPIO5_IO08\t0x80000000</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t// \t>;</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t// &#125;;</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>&#125;;</pre></td></tr></table></figure><h2 id=\"修改网络接口配置\"><a class=\"anchor\" href=\"#修改网络接口配置\">#</a> 修改网络接口配置</h2>\n<p>打开你的设备树文件  <code>arch/arm/dts/imx6ull-14x14-lanjut-emmc.dts</code>  ，可以看到相应的引用关系： <code>imx6ull-14x14-lanjut-emmc.dts</code>  -&gt;  <code>imx6ull-14x14-lanjut.dts</code>  -&gt;  <code>imx6ull.dtsi</code>  -&gt;  <code>imx6ul-14x14-lanjut.dtsi</code>  -&gt;  <code>imx6ul-14x14-lanjut-u-boot.dtsi</code>  。而一般来说，  <code>.dtsi</code>  是系列芯片的公共部分，如同 C 语言上的头文件一般，  <code>.dts</code>  则用于定义特定部分；同样的，对于已经在  <code>.dtsi</code>  定义过的节点，可以在  <code>.dts</code>  中重新定义并覆盖。</p>\n<p>在 imx6ull 中，共提供了两组 ETH 网络接口引脚，在这里只需要配置一组就好了，多了没必要；可能你也会觉得 uboot 阶段只是为了引导 kernel 启动，何必多此一举呢，毕竟真正执行的配置是在 kernel 中的属性配置，但你是否想过后期如果需要修改 kernel，那么在此操作前，你能进行的 kernel 更新就只有 OTG 烧录及 SD Card 更新，并且需要拨码，相对于网络更新，稍微复杂一点，而且像 SD Card 你也未必携带有；因此，既然在 uboot 中存在一个如此便捷的升级方式，为何不好好应用起来呢？</p>\n<p>前面讲了 imx6ull 提供了两组 ETH 网络接口引脚，因此，只要有引出 ETH 接口，那么它们必定成组配置，所以无论你是用  <code>eth0</code>  或是  <code>eth1</code>  或想两组都用，在官方 demo 中一般都存在着对应组的设备树节点，可能唯一区别是  <code>eth0</code>  或  <code>eth1</code>  对应哪一组、PHY 地址不一样及网络芯片复位引脚所关联 GPIO 之类的；而且，对于用户设计来讲，一般都是跟官方的设计大同小异，没必要大改动以至于重新适配调试整个设备树配置及驱动修改，对此在这里以  <code>eth1</code> 、PHY 地址为 0x01 为例：</p>\n<p><strong>1、查阅关联信息</strong></p>\n<p>翻看芯片参考手册，找到与网络相关的章节，可以看到官方主要命名为 ENET；接下来在设备树中，包括引用的设备树头文件  <code>.dtsi</code>  里面搜索  <code>enet</code>  ，能找到名为  <code>&amp;fecx</code>  的设备树节点，这些节点信息就是对网络接口的配置。</p>\n<p><strong>2、节点属性</strong></p>\n<p>网络设备树节点属性，在这里可以根据自己所使用的 uboot 版本日期，去 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZGV2aWNldHJlZS5vcmcvc3BlY2lmaWNhdGlvbnM=\">https://www.devicetree.org/specifications</span> 里找附近时期的文档查看；还有一种方式是在  <code>doc/device-tree-bindings/net/</code>  路径下查找相关的信息；不过不管是以上哪种方式，大部分也只是给出参考，实际需根据设备树函数处理来分析具体参数效果。</p>\n<p><strong>3、功能配置修改</strong></p>\n<p>在简单了解相关的信息后，然后就可以开始操刀修改配置了。</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>...</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>&amp;fec1 &#123;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tpinctrl-names = \"default\";</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tpinctrl-0 = &lt;&amp;pinctrl_enet1>;</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tphy-mode = \"rmii\";</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tphy-handle = &lt;&amp;ethphy0>;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tstatus = \"okay\";</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>&#125;;</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>&amp;fec2 &#123;</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tpinctrl-names = \"default\";</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tpinctrl-0 = &lt;&amp;pinctrl_enet2>;</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tphy-mode = \"rmii\";</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tphy-handle = &lt;&amp;ethphy1>;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tstatus = \"okay\";</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tmdio &#123;</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t#address-cells = &lt;1>;</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t#size-cells = &lt;0>;</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tethphy0: ethernet-phy@2 &#123;</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\treg = &lt;2>;</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\tmicrel,led-mode = &lt;1>;</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\tclocks = &lt;&amp;clks IMX6UL_CLK_ENET_REF>;</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tclock-names = \"rmii-ref\";</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t&#125;;</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tethphy1: ethernet-phy@1 &#123;</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\treg = &lt;1>;</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\tmicrel,led-mode = &lt;1>;</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\tclocks = &lt;&amp;clks IMX6UL_CLK_ENET2_REF>;</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\tclock-names = \"rmii-ref\";</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t&#125;;</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t&#125;;</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>&#125;;</pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>...</pre></td></tr></table></figure><p>以上是相关的原有功能配置，然后  <code>eth0</code>  对应  <code>&amp;fec1</code>  、  <code>eth1</code>  对应  <code>&amp;fec2</code>  ，在这里只应用  <code>eth1</code>  ，因此在  <code>&amp;fec1</code>  中把  <code>status</code>  参数改成  <code>disable</code>  以关闭该项功能；紧接着如果你的 PHY 芯片复位引脚是引接到芯片上控制而非复位按键上，那么你应该需要添加对 PHY 芯片复位的控制：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>&amp;fec2 &#123;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tpinctrl-names = \"default\";</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tpinctrl-0 = &lt;&amp;pinctrl_enet2>;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tphy-mode = \"rmii\";</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tphy-handle = &lt;&amp;ethphy1>;</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tphy-reset-gpios = &lt;&amp;gpio5 8 GPIO_ACTIVE_LOW>;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tphy-reset-duration = &lt;10>;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tphy-reset-post-delay = &lt;10>;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tstatus = \"okay\";</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t...</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>&#125;;</pre></td></tr></table></figure><p>在  <code>&amp;fec2</code>  节点中，加入  <code>phy-reset-gpios</code>  参数指定 PHY 的复位引脚且说明低电平复位， <code>phy-reset-duration</code>  指定复位的持续时间， <code>phy-reset-post-delay</code>  指定复位延迟时间。</p>\n<p>在官方设备树里面， <code>eth0</code>  的 PHY 地址配置为 2、  <code>eth</code>  的 PHY 地址配置为 1，如果需要修改 PHY 地址，则可以在  <code>mdio</code>  里的  <code>ethphyx</code>  中的  <code>reg</code>  属性里更改为硬件设计上的 PHY 地址，然后为了统一标准，把  <code>ethernet-phy@x</code>  中  <code>@x</code>  的  <code>x</code>  改为  <code>reg</code>  上的数值（当然，你也可以选择不改，这并不会影响什么功能，只是设备树作为一份适合人类阅读的文本文件，影响到的是后期的阅读分析），在这里因为设计地址跟官方一样， <code>eth1</code>  的 PHY 地址为 1，因此不需要修改：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>&amp;fec2 &#123;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t...</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tmdio &#123;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t#address-cells = &lt;1>;</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t#size-cells = &lt;0>;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tethphy0: ethernet-phy@2 &#123;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\treg = &lt;2>;</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\tmicrel,led-mode = &lt;1>;</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tclocks = &lt;&amp;clks IMX6UL_CLK_ENET_REF>;</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\tclock-names = \"rmii-ref\";</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t&#125;;</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tethphy1: ethernet-phy@1 &#123;\t// 标识 PHY 地址为 1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\treg = &lt;1>;\t// PHY 地址设置为 1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\tmicrel,led-mode = &lt;1>;</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\tclocks = &lt;&amp;clks IMX6UL_CLK_ENET2_REF>;</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tclock-names = \"rmii-ref\";</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t&#125;;</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t&#125;;</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>&#125;;</pre></td></tr></table></figure><p><strong>4、复位引脚配置</strong></p>\n<p>A、配置分析</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>...</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>&amp;iomuxc &#123;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tpinctrl-names = \"default\";</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t...</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tpinctrl_enet1: enet1grp &#123;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tfsl,pins = &lt;</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\tMX6UL_PAD_ENET1_RX_EN__ENET1_RX_EN\t0x1b0b0</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tMX6UL_PAD_ENET1_RX_ER__ENET1_RX_ER\t0x1b0b0</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\tMX6UL_PAD_ENET1_RX_DATA0__ENET1_RDATA00\t0x1b0b0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\tMX6UL_PAD_ENET1_RX_DATA1__ENET1_RDATA01\t0x1b0b0</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\tMX6UL_PAD_ENET1_TX_EN__ENET1_TX_EN\t0x1b0b0</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\tMX6UL_PAD_ENET1_TX_DATA0__ENET1_TDATA00\t0x1b0b0</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\tMX6UL_PAD_ENET1_TX_DATA1__ENET1_TDATA01\t0x1b0b0</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\tMX6UL_PAD_ENET1_TX_CLK__ENET1_REF_CLK1\t0x4001b031</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t>;</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t&#125;;</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tpinctrl_enet2: enet2grp &#123;</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tfsl,pins = &lt;</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\tMX6UL_PAD_GPIO1_IO07__ENET2_MDC\t\t0x1b0b0</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\tMX6UL_PAD_GPIO1_IO06__ENET2_MDIO\t0x1b0b0</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\tMX6UL_PAD_ENET2_RX_EN__ENET2_RX_EN\t0x1b0b0</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tMX6UL_PAD_ENET2_RX_ER__ENET2_RX_ER\t0x1b0b0</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\tMX6UL_PAD_ENET2_RX_DATA0__ENET2_RDATA00\t0x1b0b0</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\tMX6UL_PAD_ENET2_RX_DATA1__ENET2_RDATA01\t0x1b0b0</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tMX6UL_PAD_ENET2_TX_EN__ENET2_TX_EN\t0x1b0b0</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tMX6UL_PAD_ENET2_TX_DATA0__ENET2_TDATA00\t0x1b0b0</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\tMX6UL_PAD_ENET2_TX_DATA1__ENET2_TDATA01\t0x1b0b0</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\tMX6UL_PAD_ENET2_TX_CLK__ENET2_REF_CLK2\t0x4001b031</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t>;</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t&#125;;</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t...</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>&#125;;</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>...</pre></td></tr></table></figure><p>在功能配置里为  <code>eth1</code>  的 PHY 芯片添加了复位引脚的操作，因此我们必须对其 IO 进行初始化配置；由于以下修改主要涉及到设备树的引脚配置，因此在修改前先了解一下该芯片设备树中引脚定义规则和解析：</p>\n<p>在手册上，一个引脚一般支持 n 个可选功能（Alternate 缩写为 ALT）， 通过 IOMUX Controller 的控制器进行选择，IOMUX Controller 由两个子模块组成：</p>\n<ul>\n<li>IOMUXC_REGISTERS 包括所有的 IOMUXC 寄存器。</li>\n<li>IOMUXC_LOGIC 包括所有的 IOMUXC 组合逻辑（IP 接口控制、地址解码器、可观察性互斥器）。</li>\n</ul>\n<p>而 IOMUXC_REGISTERS 主要通过两个寄存器进行引脚的配置（note：XXX 表示为某一个 PAD 的名称，eg：GPIO1_IO07）：</p>\n<ul>\n<li>\n<p>IOMUXC_SW_MUX_CTL_PAD_XXX：用于配置引脚 MUX 的输入功能，包括 UART，GPIO，CSI 等功能。</p>\n<p><img data-src=\"image-20240728182215737.png\" alt=\"image-20240728182215737\" /></p>\n</li>\n<li>\n<p>IOMUXC_SW_PAD_CTL_PAD__XXX：用于配置具体功能的特性，包括上拉 / 下拉，速度，等特性。</p>\n<p><img data-src=\"image-20240728182843672.png\" alt=\"image-20240728182843672\" /></p>\n</li>\n</ul>\n<p>在设备树上 imx6u 系列的引脚定义在  <code>arch/arm/dts/imx6ul-pinfunc.h</code>  ，6ull 在此基础上追加  <code>imx6ull-pinfunc.h</code>  和  <code>imx6ull-pinfunc-snvs.h</code>  定义的扩展性功能引脚，而对于 GPIO1_IO07 的定义涵盖以下几项：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MX6UL_PAD_GPIO1_IO07__ENET1_MDC</span>\t\t\t<span class=\"token expression\"><span class=\"token number\">0x0078</span> <span class=\"token number\">0x0304</span> <span class=\"token number\">0x0000</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MX6UL_PAD_GPIO1_IO07__ENET2_MDC</span>\t\t\t<span class=\"token expression\"><span class=\"token number\">0x0078</span> <span class=\"token number\">0x0304</span> <span class=\"token number\">0x0000</span> <span class=\"token number\">1</span> <span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MX6UL_PAD_GPIO1_IO07__USB_OTG_HOST_MODE</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x0078</span> <span class=\"token number\">0x0304</span> <span class=\"token number\">0x0000</span> <span class=\"token number\">2</span> <span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MX6UL_PAD_GPIO1_IO07__CSI_PIXCLK</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x0078</span> <span class=\"token number\">0x0304</span> <span class=\"token number\">0x0528</span> <span class=\"token number\">3</span> <span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MX6UL_PAD_GPIO1_IO07__USDHC2_CD_B</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x0078</span> <span class=\"token number\">0x0304</span> <span class=\"token number\">0x0674</span> <span class=\"token number\">4</span> <span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MX6UL_PAD_GPIO1_IO07__GPIO1_IO07</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x0078</span> <span class=\"token number\">0x0304</span> <span class=\"token number\">0x0000</span> <span class=\"token number\">5</span> <span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MX6UL_PAD_GPIO1_IO07__CCM_STOP</span>\t\t\t<span class=\"token expression\"><span class=\"token number\">0x0078</span> <span class=\"token number\">0x0304</span> <span class=\"token number\">0x0000</span> <span class=\"token number\">6</span> <span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MX6UL_PAD_GPIO1_IO07__UART1_DCE_RTS</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x0078</span> <span class=\"token number\">0x0304</span> <span class=\"token number\">0x0620</span> <span class=\"token number\">8</span> <span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MX6UL_PAD_GPIO1_IO07__UART1_DTE_CTS</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x0078</span> <span class=\"token number\">0x0304</span> <span class=\"token number\">0x0000</span> <span class=\"token number\">8</span> <span class=\"token number\">0</span></span></span></pre></td></tr></table></figure><p>可以看到 MX6UL_PAD_GPIO1_IO07 是这个引脚的寄存器名称，后面 ENET1_MDC 部分则是对应这个引脚的可选功能（ALTn），然后所定义的参数有 4 个值，而这 4 个值可以在该头文件顶部看到说明：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * The pin function ID is a tuple of</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * &lt;mux_reg conf_reg input_reg mux_mode input_val></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr></table></figure><p>因此，像  <code>MX6UL_PAD_GPIO1_IO07__ENET2_MDC</code>  这个宏，其定义数值分别表示：</p>\n<ul>\n<li>mux_reg：IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO07 - 偏移地址 <strong>0x0078</strong></li>\n<li>conf_reg：IOMUXC_SW_PAD_CTL_PAD_GPIO1_IO07 - 偏移地址 <strong>0x0304</strong></li>\n<li>input_reg：无寄存器（若有一般为 xxx_SELECT_INPUT） - 偏移地址 <strong>0x0000</strong></li>\n<li>mux_reg：IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO07[3:0] - <strong>1</strong>（配置成 ALT0 - ENET2_MDC）</li>\n<li>input_val：由 input_reg 决定是否存在，依据 mux_reg 选择复用 - <strong>0</strong>（无 input_reg，此处为 0）</li>\n</ul>\n<p>而对于在  <code>dts</code>  中的  <code>MX6UL_PAD_GPIO1_IO07__ENET2_MDC 0x1b0b0</code>  主要是对 conf_reg 的配置，即 IOMUXC_SW_PAD_CTL_PAD_GPIO1_IO07 的值为  <code>0x1b0b0</code>  。这些数据的处理可以在  <code>drivers/pinctrl/nxp/pinctrl-imx.c</code>  中查到。至此，得到这样的一个配置关系：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">mux_reg_ofs</th>\n<th style=\"text-align:center\">conf_reg_ofs</th>\n<th style=\"text-align:center\">input_reg_ofs</th>\n<th style=\"text-align:center\">mux_mode</th>\n<th style=\"text-align:center\">input_val</th>\n<th style=\"text-align:center\">config_val</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">0x0078</td>\n<td style=\"text-align:center\">0x0304</td>\n<td style=\"text-align:center\">0x0000</td>\n<td style=\"text-align:center\">1</td>\n<td style=\"text-align:center\">0</td>\n<td style=\"text-align:center\">0x1b0b0</td>\n</tr>\n</tbody>\n</table>\n<p>B、追加配置</p>\n<p>在了解完如何配置后，然后来配置一个  <code>GPIO5_IO08</code>  引脚的复位操作，草鸡简单，在  <code>pinctrl_enet2</code>  节点上追加  <code>MX6UL_PAD_SNVS_TAMPER8__GPIO5_IO08</code>  引脚的配置：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>...</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>&amp;iomuxc &#123;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tpinctrl-names = \"default\";</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t...</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tpinctrl_enet2: enet2grp &#123;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tfsl,pins = &lt;</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t...</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\tMX6UL_PAD_SNVS_TAMPER8__GPIO5_IO08\t0x898\t/* ENET2 NRST */</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t>;</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t&#125;;</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t...</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>&#125;;</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>...</pre></td></tr></table></figure><h1 id=\"uboot-裁剪\"><a class=\"anchor\" href=\"#uboot-裁剪\">#</a> uboot 裁剪</h1>\n<p>不管是购买的板子还是自己设计的板子，基本都是参考半导体厂商的 demo 板，而半导体厂商会在他们自己的开发板上移植好 uboot、linux kernel 和 rootfs 等，最终制作好 BSP 包提供给用户。我们只需在官方提供的 BSP 包的基础上，修改适应于自己的板子的外设配置，也就是俗称的移植。</p>\n<p>一般对 uboot 的移植裁剪。只需要解决串口、NAND、EMMC 或 SD 卡、网络和 LCD 驱动，因为 uboot 的主要目的就是启动 Linux 内核，所以不需要考虑太多的外设驱动，剩下的交给 linux kernel 进行详细配置。</p>\n<p>如果以单片机思维来讲，Linux 的 uboot 类似于 bootloader ，因此，在 uboot 上不需要过多的配置，只需要确保能正常进入 linux kernel 即可，毕竟进入到 linux kernel 后将会重新根据 linux kernel 的配置再次初始化一遍。</p>\n<p>前面讲了，除非必要的外设，把其余的功能移除掉，这便是裁剪；因此像 IIC、SPI、USB 这些等都可以屏蔽掉（或者确认以存储介质启动把网络也禁掉都是可以的），以减少编译生成使得缩少文件大小。</p>\n<p>裁剪方式很简单：</p>\n<p>1、在  <code>configs/</code>  文件夹中，找到你的板子配置文件，eg：  <code>mx6ull_14x14_lanjut_emmc_defconfig</code>  对不需要的功能进行屏蔽操作：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>CONFIG_ARM=y</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>CONFIG_ARCH_MX6=y</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>CONFIG_TARGET_MX6ULL_14X14_LANJUT=y</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>CONFIG_ENV_SIZE=0x2000</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>CONFIG_ENV_OFFSET=0xE0000</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CONFIG_DM_GPIO=y</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>CONFIG_NR_DRAM_BANKS=1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>CONFIG_SYS_EXTRA_OPTIONS=\"IMX_CONFIG=board/freescale/mx6ull_lanjut/imximage.cfg\"</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>CONFIG_BOOTDELAY=1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre># CONFIG_CONSOLE_MUX is not set</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>CONFIG_SYS_CONSOLE_IS_IN_ENV=y</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>CONFIG_SUPPORT_RAW_INITRD=y</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>CONFIG_BOUNCE_BUFFER=y</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>CONFIG_BOARD_EARLY_INIT_F=y</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>CONFIG_HUSH_PARSER=y</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>CONFIG_CMD_BOOTZ=y</pre></td></tr><tr><td data-num=\"17\"></td><td><pre># CONFIG_CMD_IMLS is not set</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>CONFIG_CMD_MEMTEST=y</pre></td></tr><tr><td data-num=\"19\"></td><td><pre># CONFIG_CMD_GPIO=y</pre></td></tr><tr><td data-num=\"20\"></td><td><pre># CONFIG_CMD_I2C=y</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>CONFIG_CMD_MMC=y</pre></td></tr><tr><td data-num=\"22\"></td><td><pre># CONFIG_CMD_SF=y</pre></td></tr><tr><td data-num=\"23\"></td><td><pre># CONFIG_CMD_USB=y</pre></td></tr><tr><td data-num=\"24\"></td><td><pre># CONFIG_CMD_DHCP=y</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>CONFIG_CMD_PING=y</pre></td></tr><tr><td data-num=\"26\"></td><td><pre># CONFIG_CMD_BMP=y</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>CONFIG_CMD_CACHE=y</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>CONFIG_CMD_NET=y</pre></td></tr><tr><td data-num=\"29\"></td><td><pre># CONFIG_CMD_EXT2=y</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>CONFIG_CMD_EXT4=y</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>CONFIG_CMD_EXT4_WRITE=y</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>CONFIG_CMD_FAT=y</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>CONFIG_CMD_FS_GENERIC=y</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>CONFIG_OF_CONTROL=y</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>CONFIG_DEFAULT_DEVICE_TREE=\"imx6ull-14x14-lanjut-emmc\"</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>CONFIG_ENV_IS_IN_MMC=y</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>CONFIG_SYS_RELOC_GD_ENV_ADDR=y</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>CONFIG_ENV_VARS_UBOOT_RUNTIME_CONFIG=y</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>CONFIG_NET_RANDOM_ETHADDR=y</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre># CONFIG_DM_74X164 is not used</pre></td></tr><tr><td data-num=\"42\"></td><td><pre># CONFIG_DM_I2C=y</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>CONFIG_DM_MMC=y</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>CONFIG_FSL_USDHC=y</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>CONFIG_MTD=y</pre></td></tr><tr><td data-num=\"46\"></td><td><pre># CONFIG_DM_SPI_FLASH=y</pre></td></tr><tr><td data-num=\"47\"></td><td><pre># CONFIG_SF_DEFAULT_MODE=0</pre></td></tr><tr><td data-num=\"48\"></td><td><pre># CONFIG_SF_DEFAULT_SPEED=40000000</pre></td></tr><tr><td data-num=\"49\"></td><td><pre># CONFIG_SPI_FLASH_STMICRO=y</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>CONFIG_PHYLIB=y</pre></td></tr><tr><td data-num=\"51\"></td><td><pre># CONFIG_PHY_MICREL=y</pre></td></tr><tr><td data-num=\"52\"></td><td><pre># CONFIG_PHY_MICREL_KSZ8XXX=y</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>CONFIG_DM_ETH=y</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>CONFIG_DM_ETH_PHY=y</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>CONFIG_FEC_MXC=y</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>CONFIG_MII=y</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>CONFIG_PINCTRL=y</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>CONFIG_PINCTRL_IMX6=y</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>CONFIG_DM_REGULATOR=y</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>CONFIG_DM_REGULATOR_FIXED=y</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>CONFIG_DM_REGULATOR_GPIO=y</pre></td></tr><tr><td data-num=\"62\"></td><td><pre># CONFIG_SPI=y</pre></td></tr><tr><td data-num=\"63\"></td><td><pre># CONFIG_DM_SPI=y</pre></td></tr><tr><td data-num=\"64\"></td><td><pre># CONFIG_SOFT_SPI is not used</pre></td></tr><tr><td data-num=\"65\"></td><td><pre># CONFIG_FSL_QSPI=y</pre></td></tr><tr><td data-num=\"66\"></td><td><pre># CONFIG_USB=y</pre></td></tr><tr><td data-num=\"67\"></td><td><pre># CONFIG_DM_USB=y</pre></td></tr><tr><td data-num=\"68\"></td><td><pre># CONFIG_USB_STORAGE=y</pre></td></tr><tr><td data-num=\"69\"></td><td><pre># CONFIG_USB_HOST_ETHER=y</pre></td></tr><tr><td data-num=\"70\"></td><td><pre># CONFIG_USB_ETHER_ASIX=y</pre></td></tr><tr><td data-num=\"71\"></td><td><pre># CONFIG_DM_VIDEO=y</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>CONFIG_SYS_WHITE_ON_BLACK=y</pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre># CONFIG_USB_GADGET=y</pre></td></tr><tr><td data-num=\"75\"></td><td><pre># CONFIG_USB_GADGET_DOWNLOAD=y</pre></td></tr><tr><td data-num=\"76\"></td><td><pre># CONFIG_USB_GADGET_MANUFACTURER=\"FSL\"</pre></td></tr><tr><td data-num=\"77\"></td><td><pre># CONFIG_USB_GADGET_VENDOR_NUM=0x0525</pre></td></tr><tr><td data-num=\"78\"></td><td><pre># CONFIG_USB_GADGET_PRODUCT_NUM=0xa4a5</pre></td></tr><tr><td data-num=\"79\"></td><td><pre># CONFIG_CI_UDC=y</pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre># CONFIG_CMD_FASTBOOT=y</pre></td></tr><tr><td data-num=\"82\"></td><td><pre># CONFIG_USB_FUNCTION_FASTBOOT=y</pre></td></tr><tr><td data-num=\"83\"></td><td><pre># CONFIG_FASTBOOT_UUU_SUPPORT=y</pre></td></tr><tr><td data-num=\"84\"></td><td><pre># CONFIG_FASTBOOT=y</pre></td></tr><tr><td data-num=\"85\"></td><td><pre># CONFIG_FASTBOOT_BUF_ADDR=0x83800000</pre></td></tr><tr><td data-num=\"86\"></td><td><pre># CONFIG_FASTBOOT_BUF_SIZE=0x40000000</pre></td></tr><tr><td data-num=\"87\"></td><td><pre># CONFIG_FASTBOOT_FLASH=y</pre></td></tr><tr><td data-num=\"88\"></td><td><pre># CONFIG_EFI_PARTITION=y</pre></td></tr></table></figure><p>以上操作主要是裁切不需要的命令行、USB 操作、IIC 功能、SPI 功能、video  功能；当然你也可以通过先  <code>make xxx_defconfig</code>  生成  <code>.config</code>  文件，然后进行  <code>make meunconfig</code>  进入图型交互界面，对不需要的配置进行移除，在这里修改的目的是为了通过执行  <code>make xxx_defconfig</code>  后生成的默认  <code>.config</code>  文件即为裁剪好的配置，而不需要再进行  <code>make meunconfig</code>  选择移除。</p>\n<p>2、修改单板配置文件，eg：  <code>include/configs/mx6ull_lanjut.h</code>  ；该文件主要是配置 uboot env 环境及启动初始化。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* SPDX-License-Identifier: GPL-2.0+ */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * Copyright (C) 2016 Freescale Semiconductor, Inc.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Copyright 2017 NXP</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * Configuration settings for the Freescale i.MX6UL 14x14 EVK board.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">__MX6ULL_LANJUT_CONFIG_H</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__MX6ULL_LANJUT_CONFIG_H</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;asm/arch/imx-regs.h></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/sizes.h></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"mx6_common.h\"</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;asm/mach-imx/gpio.h></span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"imx_env.h\"</span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">is_mx6ull_9x9_evk</span><span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\t<span class=\"token function\">CONFIG_IS_ENABLED</span><span class=\"token punctuation\">(</span>TARGET_MX6ULL_9X9_EVK<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_TARGET_MX6ULL_9X9_EVK</span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PHYS_SDRAM_SIZE</span>\t\t<span class=\"token expression\">SZ_256M</span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BOOTARGS_CMA_SIZE</span>   <span class=\"token string\">\"cma=96M \"</span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PHYS_SDRAM_SIZE</span>\t\t<span class=\"token expression\">SZ_512M</span></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BOOTARGS_CMA_SIZE</span>   <span class=\"token string\">\"\"</span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">/* DCDC used on 14x14 EVK, no PMIC */</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">undef</span> <span class=\"token expression\">CONFIG_LDO_BYPASS_CHECK</span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">/* Size of malloc() pool */</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_MALLOC_LEN</span>\t\t<span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token number\">16</span> <span class=\"token operator\">*</span> SZ_1M<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_MXC_UART</span></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_MXC_UART_BASE</span>\t\t<span class=\"token expression\">UART1_BASE</span></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">/* MMC Configs */</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_FSL_USDHC</span></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_FSL_ESDHC_ADDR</span>\t<span class=\"token expression\">USDHC2_BASE_ADDR</span></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\">/* NAND pin conflicts with usdhc2 */</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_NAND_MXS</span></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_FSL_USDHC_NUM</span>\t<span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_FSL_USDHC_NUM</span>\t<span class=\"token expression\"><span class=\"token number\">2</span></span></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">/* I2C configs */</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_CMD_I2C</span></span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_I2C_MXC</span></span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_I2C_MXC_I2C1</span>\t\t<span class=\"token comment\">/* enable I2C bus 1 */</span></span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_I2C_MXC_I2C2</span>\t\t<span class=\"token comment\">/* enable I2C bus 2 */</span></span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_I2C_SPEED</span>\t\t<span class=\"token expression\"><span class=\"token number\">100000</span></span></span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_MMC_IMG_LOAD_PART</span>\t<span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_NAND_BOOT</span></span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MFG_NAND_PARTITION</span> <span class=\"token string\">\"mtdparts=gpmi-nand:64m(nandboot),16m(nandkernel),16m(nanddtb),16m(nandtee),-(nandrootfs)\"</span></span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MFG_NAND_PARTITION</span> <span class=\"token string\">\"\"</span></span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_CMD_READ</span></span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SERIAL_TAG</span></span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_FASTBOOT_USB_DEV</span> <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_MFG_ENV_SETTINGS</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token expression\">CONFIG_MFG_ENV_SETTINGS_DEFAULT </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token string\">\"initrd_addr=0x86800000\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token string\">\"initrd_high=0xffffffff\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token string\">\"emmc_dev=1\\0\"</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token string\">\"emmc_ack=1\\0\"</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token string\">\"sd_dev=1\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token string\">\"mtdparts=\"</span> <span class=\"token expression\">MFG_NAND_PARTITION </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token string\">\"\\0\"</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>CONFIG_NAND_BOOT<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_EXTRA_ENV_SETTINGS</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token expression\">CONFIG_MFG_ENV_SETTINGS </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token expression\">TEE_ENV </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token string\">\"splashimage=0x8c000000\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t<span class=\"token string\">\"fdt_addr=0x83000000\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token string\">\"fdt_high=0xffffffff\\0\"</span>\t  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token string\">\"tee_addr=0x84000000\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token string\">\"console=ttymxc0\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token string\">\"bootargs=console=ttymxc0,115200 ubi.mtd=nandrootfs \"</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t<span class=\"token string\">\"root=ubi0:rootfs rootfstype=ubifs \"</span>\t\t     <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t<span class=\"token expression\">BOOTARGS_CMA_SIZE </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t<span class=\"token expression\">MFG_NAND_PARTITION </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t<span class=\"token string\">\"\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t<span class=\"token string\">\"bootcmd=nand read $&#123;loadaddr&#125; 0x4000000 0xc00000;\"</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t<span class=\"token string\">\"nand read $&#123;fdt_addr&#125; 0x5000000 0x100000;\"</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t<span class=\"token string\">\"if test $&#123;tee&#125; = yes; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t\t<span class=\"token string\">\"nand read $&#123;tee_addr&#125; 0x6000000 0x400000;\"</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t\t<span class=\"token string\">\"bootm $&#123;tee_addr&#125; - $&#123;fdt_addr&#125;;\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t<span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t\t<span class=\"token string\">\"bootz $&#123;loadaddr&#125; - $&#123;fdt_addr&#125;;\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t<span class=\"token string\">\"fi\\0\"</span></span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_EXTRA_ENV_SETTINGS</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t<span class=\"token expression\">CONFIG_MFG_ENV_SETTINGS </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t<span class=\"token expression\">TEE_ENV </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t<span class=\"token string\">\"script=boot.scr\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t<span class=\"token string\">\"image=zImage\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t<span class=\"token string\">\"console=ttymxc0\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t<span class=\"token string\">\"fdt_high=0xffffffff\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t<span class=\"token string\">\"initrd_high=0xffffffff\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t<span class=\"token string\">\"fdt_file=undefined\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t<span class=\"token string\">\"fdt_addr=0x83000000\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t<span class=\"token string\">\"tee_addr=0x84000000\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t<span class=\"token string\">\"tee_file=undefined\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t<span class=\"token string\">\"boot_fdt=try\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t<span class=\"token string\">\"ip_dyn=no\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t<span class=\"token string\">\"splashimage=0x8c000000\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t<span class=\"token string\">\"mmcdev=\"</span><span class=\"token expression\"><span class=\"token function\">__stringify</span><span class=\"token punctuation\">(</span>CONFIG_SYS_MMC_ENV_DEV<span class=\"token punctuation\">)</span></span><span class=\"token string\">\"\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t<span class=\"token string\">\"mmcpart=\"</span> <span class=\"token expression\"><span class=\"token function\">__stringify</span><span class=\"token punctuation\">(</span>CONFIG_SYS_MMC_IMG_LOAD_PART<span class=\"token punctuation\">)</span> </span><span class=\"token string\">\"\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t<span class=\"token string\">\"mmcroot=\"</span> <span class=\"token expression\">CONFIG_MMCROOT </span><span class=\"token string\">\" rootwait rw\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t<span class=\"token string\">\"mmcautodetect=yes\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t<span class=\"token string\">\"mmcargs=setenv bootargs console=$&#123;console&#125;,$&#123;baudrate&#125; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t<span class=\"token expression\">BOOTARGS_CMA_SIZE </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t<span class=\"token string\">\"root=$&#123;mmcroot&#125;\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t<span class=\"token string\">\"loadbootscript=\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t<span class=\"token string\">\"fatload mmc $&#123;mmcdev&#125;:$&#123;mmcpart&#125; $&#123;loadaddr&#125; $&#123;script&#125;;\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t<span class=\"token string\">\"bootscript=echo Running bootscript from mmc ...; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t\t<span class=\"token string\">\"source\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t<span class=\"token string\">\"loadimage=fatload mmc $&#123;mmcdev&#125;:$&#123;mmcpart&#125; $&#123;loadaddr&#125; $&#123;image&#125;\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t<span class=\"token string\">\"loadfdt=fatload mmc $&#123;mmcdev&#125;:$&#123;mmcpart&#125; $&#123;fdt_addr&#125; $&#123;fdt_file&#125;\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t<span class=\"token string\">\"loadtee=fatload mmc $&#123;mmcdev&#125;:$&#123;mmcpart&#125; $&#123;tee_addr&#125; $&#123;tee_file&#125;\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t<span class=\"token string\">\"mmcboot=echo Booting from mmc ...; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\t<span class=\"token string\">\"run mmcargs; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\t<span class=\"token string\">\"if test $&#123;tee&#125; = yes; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t\t<span class=\"token string\">\"run loadfdt; run loadtee; bootm $&#123;tee_addr&#125; - $&#123;fdt_addr&#125;; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\t<span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t\t\t<span class=\"token string\">\"if test $&#123;boot_fdt&#125; = yes || test $&#123;boot_fdt&#125; = try; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if run loadfdt; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"bootz $&#123;loadaddr&#125; - $&#123;fdt_addr&#125;; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"if test $&#123;boot_fdt&#125; = try; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t\t\t\t\t\t<span class=\"token string\">\"bootz; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t\t\t\t\t\t<span class=\"token string\">\"echo WARN: Cannot load the DT; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\t\t\t<span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"bootz; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t\t\t<span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t\t<span class=\"token string\">\"fi;\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\t<span class=\"token string\">\"netargs=setenv bootargs console=$&#123;console&#125;,$&#123;baudrate&#125; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t\t<span class=\"token expression\">BOOTARGS_CMA_SIZE </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t\t<span class=\"token string\">\"root=/dev/nfs \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\t\t<span class=\"token string\">\"ip=dhcp nfsroot=$&#123;serverip&#125;:$&#123;nfsroot&#125;,v3,tcp\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t<span class=\"token string\">\"netboot=echo Booting from net ...; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t\t<span class=\"token string\">\"$&#123;usb_net_cmd&#125;; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t\t<span class=\"token string\">\"run netargs; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>\t\t<span class=\"token string\">\"if test $&#123;ip_dyn&#125; = yes; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\t\t\t<span class=\"token string\">\"setenv get_cmd dhcp; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t\t<span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\t\t\t<span class=\"token string\">\"setenv get_cmd tftp; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t\t<span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t\t<span class=\"token string\">\"$&#123;get_cmd&#125; $&#123;image&#125;; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>\t\t<span class=\"token string\">\"if test $&#123;tee&#125; = yes; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t\t\t<span class=\"token string\">\"$&#123;get_cmd&#125; $&#123;tee_addr&#125; $&#123;tee_file&#125;; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t\t\t<span class=\"token string\">\"$&#123;get_cmd&#125; $&#123;fdt_addr&#125; $&#123;fdt_file&#125;; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t\t\t<span class=\"token string\">\"bootm $&#123;tee_addr&#125; - $&#123;fdt_addr&#125;; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t\t<span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t\t\t<span class=\"token string\">\"if test $&#123;boot_fdt&#125; = yes || test $&#123;boot_fdt&#125; = try; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if $&#123;get_cmd&#125; $&#123;fdt_addr&#125; $&#123;fdt_file&#125;; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"bootz $&#123;loadaddr&#125; - $&#123;fdt_addr&#125;; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"if test $&#123;boot_fdt&#125; = try; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>\t\t\t\t\t\t<span class=\"token string\">\"bootz; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>\t\t\t\t\t\t<span class=\"token string\">\"echo WARN: Cannot load the DT; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>\t\t\t<span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"bootz; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>\t\t\t<span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>\t\t<span class=\"token string\">\"fi;\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>\t\t<span class=\"token string\">\"findfdt=\"</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>\t\t\t<span class=\"token string\">\"if test $fdt_file = undefined; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if test $board_name = ULZ-EVK &amp;&amp; test $board_rev = 14X14; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"setenv fdt_file imx6ulz-14x14-evk.dtb; fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if test $board_name = EVK &amp;&amp; test $board_rev = 9X9; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"setenv fdt_file imx6ull-9x9-evk.dtb; fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if test $board_name = EVK &amp;&amp; test $board_rev = 14X14; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"setenv fdt_file imx6ull-14x14-evk.dtb; fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if test $board_name = LANJUT &amp;&amp; test $board_rev = 14X14; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"setenv fdt_file imx6ull-14x14-lanjut.dtb; fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if test $fdt_file = undefined; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"echo WARNING: Could not determine dtb to use; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>\t\t\t<span class=\"token string\">\"fi;\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>\t\t<span class=\"token string\">\"findtee=\"</span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t\t\t<span class=\"token string\">\"if test $tee_file = undefined; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if test $board_name = ULZ-EVK &amp;&amp; test $board_rev = 14X14; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"setenv tee_file uTee-6ulzevk; fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if test $board_name = EVK &amp;&amp; test $board_rev = 9X9; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"setenv tee_file uTee-6ullevk; fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if test $board_name = EVK &amp;&amp; test $board_rev = 14X14; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"setenv tee_file uTee-6ullevk; fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if test $board_name = LANJUT &amp;&amp; test $board_rev = 14X14; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"setenv tee_file uTee-6ull_lanjut; fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"if test $tee_file = undefined; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>\t\t\t\t\t<span class=\"token string\">\"echo WARNING: Could not determine tee to use; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>\t\t\t<span class=\"token string\">\"fi;\\0\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre></span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_BOOTCOMMAND</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>\t   <span class=\"token string\">\"run findfdt;\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>\t   <span class=\"token string\">\"run findtee;\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>\t   <span class=\"token string\">\"mmc dev $&#123;mmcdev&#125;;\"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>\t   <span class=\"token string\">\"mmc dev $&#123;mmcdev&#125;; if mmc rescan; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>\t\t   <span class=\"token string\">\"if run loadbootscript; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>\t\t\t   <span class=\"token string\">\"run bootscript; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>\t\t   <span class=\"token string\">\"else \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>\t\t\t   <span class=\"token string\">\"if run loadimage; then \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>\t\t\t\t   <span class=\"token string\">\"run mmcboot; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>\t\t\t   <span class=\"token string\">\"else run netboot; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>\t\t\t   <span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>\t\t   <span class=\"token string\">\"fi; \"</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>\t   <span class=\"token string\">\"else run netboot; fi\"</span></span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre></pre></td></tr><tr><td data-num=\"227\"></td><td><pre><span class=\"token comment\">/* Miscellaneous configurable options */</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_MEMTEST_START</span>\t<span class=\"token expression\"><span class=\"token number\">0x80000000</span></span></span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_MEMTEST_END</span>\t\t<span class=\"token expression\"><span class=\"token punctuation\">(</span>CONFIG_SYS_MEMTEST_START <span class=\"token operator\">+</span> <span class=\"token number\">0x8000000</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre></pre></td></tr><tr><td data-num=\"231\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_LOAD_ADDR</span>\t\t<span class=\"token expression\">CONFIG_LOADADDR</span></span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_HZ</span>\t\t\t<span class=\"token expression\"><span class=\"token number\">1000</span></span></span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre></pre></td></tr><tr><td data-num=\"234\"></td><td><pre><span class=\"token comment\">/* Physical Memory Map */</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PHYS_SDRAM</span>\t\t\t<span class=\"token expression\">MMDC0_ARB_BASE_ADDR</span></span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre></pre></td></tr><tr><td data-num=\"237\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_SDRAM_BASE</span>\t\t<span class=\"token expression\">PHYS_SDRAM</span></span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_INIT_RAM_ADDR</span>\t<span class=\"token expression\">IRAM_BASE_ADDR</span></span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_INIT_RAM_SIZE</span>\t<span class=\"token expression\">IRAM_SIZE</span></span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre></pre></td></tr><tr><td data-num=\"241\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_INIT_SP_OFFSET</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>\t<span class=\"token expression\"><span class=\"token punctuation\">(</span>CONFIG_SYS_INIT_RAM_SIZE <span class=\"token operator\">-</span> GENERATED_GBL_DATA_SIZE<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_INIT_SP_ADDR</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>\t<span class=\"token expression\"><span class=\"token punctuation\">(</span>CONFIG_SYS_INIT_RAM_ADDR <span class=\"token operator\">+</span> CONFIG_SYS_INIT_SP_OFFSET<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre></pre></td></tr><tr><td data-num=\"246\"></td><td><pre><span class=\"token comment\">/* environment organization */</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_MMC_ENV_DEV</span>\t\t<span class=\"token expression\"><span class=\"token number\">1</span>\t</span><span class=\"token comment\">/* USDHC2 */</span></span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_MMC_ENV_PART</span>\t\t<span class=\"token expression\"><span class=\"token number\">0</span>\t</span><span class=\"token comment\">/* user area */</span></span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_MMCROOT</span>\t\t\t<span class=\"token string\">\"/dev/mmcblk1p2\"</span>  <span class=\"token comment\">/* USDHC2 */</span></span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre></pre></td></tr><tr><td data-num=\"251\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_IOMUX_LPSR</span></span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre></pre></td></tr><tr><td data-num=\"253\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_FSL_QSPI</span></span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_FSL_QSPI_AHB</span></span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FSL_QSPI_FLASH_NUM</span>\t\t<span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">FSL_QSPI_FLASH_SIZE</span>\t\t<span class=\"token expression\">SZ_32M</span></span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre></pre></td></tr><tr><td data-num=\"259\"></td><td><pre><span class=\"token comment\">/* NAND stuff */</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_NAND_MXS</span></span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_MAX_NAND_DEVICE</span>\t<span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_NAND_BASE</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x40000000</span></span></span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_NAND_5_ADDR_CYCLE</span></span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_NAND_ONFI_DETECTION</span></span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SYS_NAND_USE_FLASH_BBT</span></span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre></pre></td></tr><tr><td data-num=\"267\"></td><td><pre><span class=\"token comment\">/* DMA stuff, needed for GPMI/MXS NAND support */</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre></pre></td></tr><tr><td data-num=\"270\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>CONFIG_ENV_IS_IN_SPI_FLASH<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_ENV_SPI_BUS</span>\t\t<span class=\"token expression\">CONFIG_SF_DEFAULT_BUS</span></span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_ENV_SPI_CS</span>\t\t<span class=\"token expression\">CONFIG_SF_DEFAULT_CS</span></span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_ENV_SPI_MODE</span>\t\t<span class=\"token expression\">CONFIG_SF_DEFAULT_MODE</span></span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_ENV_SPI_MAX_HZ</span>\t\t<span class=\"token expression\">CONFIG_SF_DEFAULT_SPEED</span></span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre></pre></td></tr><tr><td data-num=\"277\"></td><td><pre><span class=\"token comment\">/* USB Configs */</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_CMD_USB</span></span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_EHCI_HCD_INIT_AFTER_RESET</span></span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_MXC_USB_PORTSC</span>  <span class=\"token expression\"><span class=\"token punctuation\">(</span>PORT_PTS_UTMI <span class=\"token operator\">|</span> PORT_PTS_PTW<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_MXC_USB_FLAGS</span>   <span class=\"token expression\"><span class=\"token number\">0</span></span></span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_USB_MAX_CONTROLLER_COUNT</span> <span class=\"token expression\"><span class=\"token number\">2</span></span></span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre></pre></td></tr><tr><td data-num=\"285\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_FEC_XCV_TYPE</span>             <span class=\"token expression\">RMII</span></span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_ETHPRIME</span>\t\t\t<span class=\"token string\">\"eth1\"</span></span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre></pre></td></tr><tr><td data-num=\"288\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_IMX_THERMAL</span></span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre></pre></td></tr><tr><td data-num=\"290\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">CONFIG_SPL_BUILD</span></span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>CONFIG_DM_VIDEO<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_VIDEO_MXS</span></span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_VIDEO_LINK</span></span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_VIDEO_LOGO</span></span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SPLASH_SCREEN</span></span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SPLASH_SCREEN_ALIGN</span></span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_BMP_16BPP</span></span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_VIDEO_BMP_RLE8</span></span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_VIDEO_BMP_LOGO</span></span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre></pre></td></tr><tr><td data-num=\"303\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_MODULE_FUSE</span></span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_OF_SYSTEM_SETUP</span></span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre></pre></td></tr><tr><td data-num=\"306\"></td><td><pre><span class=\"token comment\">/* Network Configs */</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_IPADDR</span>          <span class=\"token expression\"><span class=\"token number\">192.168</span><span class=\"token number\">.137</span><span class=\"token number\">.234</span>      </span><span class=\"token comment\">/* board ip */</span></span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_SERVERIP</span>     <span class=\"token expression\"><span class=\"token number\">192.168</span><span class=\"token number\">.137</span><span class=\"token number\">.1</span>      </span><span class=\"token comment\">/* server ip */</span></span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_GATEWAYIP</span>    <span class=\"token expression\"><span class=\"token number\">192.168</span><span class=\"token number\">.137</span><span class=\"token number\">.1</span>        </span><span class=\"token comment\">/* board gateway ip */</span></span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CONFIG_NETMASK</span>      <span class=\"token expression\"><span class=\"token number\">255.255</span><span class=\"token number\">.255</span><span class=\"token number\">.0</span>       </span><span class=\"token comment\">/* board netmask */</span></span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre></pre></td></tr><tr><td data-num=\"312\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr></table></figure><p>以上添加了网络信息配置，因为在  <code>mx6ull_14x14_lanjut_emmc_defconfig</code>  中，我们有移除 DHCP 命令操作，因此如果使用到网络，那么必然需要配置静态网络  <code>setenv ipaddr</code>  这些，而在这里我们直接先配置好默认 ip（即  <code>/* Network Configs */</code>  下的操作）。同样，在这里可以找到与 NAND、IIC、SPI、VIDEO 这些不需要的功能，部分通过  <code>#ifdef</code>  宏来启用，那么如果在  <code>mx6ull_14x14_lanjut_emmc_defconfig</code>  中有屏蔽相应的宏则不要处理，否则对于一些没有在  <code>mx6ull_14x14_lanjut_emmc_defconfig</code>  中出现的并且想要裁切的功能，可以直接屏蔽对应的宏（例如是对  <code>board/freescale/mx6ull_lanjut/mx6ull_lanjut.c</code>  中的操作选择）。</p>\n<h1 id=\"添加编译脚本\"><a class=\"anchor\" href=\"#添加编译脚本\">#</a> 添加编译脚本</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">touch</span> build.sh</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] #\"></td><td><pre><span class=\"token function\">vim</span> build.sh</pre></td></tr></table></figure><p><strong>写入：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 若之前已经导入到环境变量则不需要</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span>:/usr/local/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/bin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 若已经在顶层 Makefile 文件中指定则不需要</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ARCH</span><span class=\"token operator\">=</span>arm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 若已经在顶层 Makefile 文件中指定则不需要</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CROSS_COMPILE</span><span class=\"token operator\">=</span>arm-none-linux-gnueabihf-</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LCPU</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-c</span> processor /proc/cpuinfo<span class=\"token variable\">`</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">make</span> clean</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token function\">make</span> mx6ull_14x14_lanjut_emmc_defconfig</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token function\">make</span> -j<span class=\"token variable\">$&#123;LCPU&#125;</span></pre></td></tr></table></figure><h1 id=\"附\"><a class=\"anchor\" href=\"#附\">#</a> 附</h1>\n<p>uboot 文件结构：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">类型</th>\n<th style=\"text-align:center\">名称</th>\n<th style=\"text-align:center\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\" rowspan=\"21\">文件夹</td>\n<td style=\"text-align:center\">api</td>\n<td style=\"text-align:center\">通用的 API 函数相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">arch</td>\n<td style=\"text-align:center\">与芯片架构相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">board</td>\n<td style=\"text-align:center\">板级相关信息</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">cmd</td>\n<td style=\"text-align:center\">uboot 命令相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">common</td>\n<td style=\"text-align:center\">通用代码</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">configs</td>\n<td style=\"text-align:center\">uboot 配置内容</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">disk</td>\n<td style=\"text-align:center\">磁盘相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">doc</td>\n<td style=\"text-align:center\">各说明文档</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">drivers</td>\n<td style=\"text-align:center\">驱动代码相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">dts</td>\n<td style=\"text-align:center\">设备树相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">env</td>\n<td style=\"text-align:center\">uboot 环境相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">examples</td>\n<td style=\"text-align:center\">示例代码</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">fs</td>\n<td style=\"text-align:center\">文件系统相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">include</td>\n<td style=\"text-align:center\">头文件相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">lib</td>\n<td style=\"text-align:center\">lib 库文件</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Licenses</td>\n<td style=\"text-align:center\">许可证相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">net</td>\n<td style=\"text-align:center\">网络相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">post</td>\n<td style=\"text-align:center\">上电自检相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">scripts</td>\n<td style=\"text-align:center\">相关脚本</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">test</td>\n<td style=\"text-align:center\">测试代码</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">tools</td>\n<td style=\"text-align:center\">uboot 构建工具相关</td>\n</tr>\n<tr>\n<td style=\"text-align:center\" rowspan=\"6\">文件</td>\n<td style=\"text-align:center\"><span class=\"exturl\" data-url=\"aHR0cDovL2NvbmZpZy5taw==\">config.mk</span></td>\n<td style=\"text-align:center\">某个 Makefile 需要调用此文件</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Kbuild</td>\n<td style=\"text-align:center\">用于生成汇编相关的文件</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Kconfig</td>\n<td style=\"text-align:center\">图形配置界面相关文件</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">MAINTAINERS</td>\n<td style=\"text-align:center\">开发及维护记录</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Makefile</td>\n<td style=\"text-align:center\">主 Makefile 脚本</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">README</td>\n<td style=\"text-align:center\">工程说明</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "Linux",
                "arm_linux",
                "imx6ull"
            ]
        },
        {
            "id": "https://arachnid.cc/virtual-network-setup/",
            "url": "https://arachnid.cc/virtual-network-setup/",
            "title": "vmware 下 Ubuntu 双网卡设置",
            "date_published": "2023-02-25T09:28:19.345Z",
            "content_html": "<blockquote>\n<p>背景：主机电脑通过 WiFi 上网，网口用于跟开发板等设备有线连接；为此需要实现虚拟机内对系统可以进行外网访问网页或下载工具包等（避免切换主机操作），同时具备通过网线访问内网设备机器进行控制调试等操作。</p>\n<p>环境：VMware® Workstation 15 Pro</p>\n<p>平台：Ubuntu 18.04.6</p>\n</blockquote>\n<h1 id=\"step-1添加网卡\"><a class=\"anchor\" href=\"#step-1添加网卡\">#</a> step 1：添加网卡</h1>\n<p>在虚拟机窗口栏，依次点击  <code>编辑</code>  -&gt;  <code>虚拟网络编辑器</code>  ，可以看到原有默认的 VMnet 接口：</p>\n<p><img data-src=\"image-20230225172822709.png\" alt=\"image-20230225172822709\" /></p>\n<p>它们分别对应主机 ip 地址。</p>\n<p>然后我们建立一个桥接模式的 VMnet 虚拟网络，并指定响应网卡（如出现灰屏无法设置，需要<strong>以管理员身份打开</strong> VMware，或在当前窗口点击  <code>更改设置</code>  来赋予权限），然后选择对应需要进行桥接的网卡（即网口网卡）：</p>\n<p><img data-src=\"image-20230225193931835.png\" alt=\"image-20230225193931835\" /></p>\n<h1 id=\"setp-2配置网络设备器\"><a class=\"anchor\" href=\"#setp-2配置网络设备器\">#</a> setp 2：配置网络设备器</h1>\n<p>在 ubuntu 虚拟机右键点击  <code>设置</code>  -&gt;  <code>添加</code>  -&gt;  <code>网络适配器</code>  ，然后指定上面配置为桥接模式的  VMnet 虚拟网络：</p>\n<p><img data-src=\"image-20230225194908857.png\" alt=\"image-20230225194908857\" /></p>\n<h2 id=\"拓展\"><a class=\"anchor\" href=\"#拓展\">#</a> 拓展</h2>\n<p>关于 NAT（网络地址转换模式）、Host-only（主机模式）及 bridged（桥接模式）：</p>\n<p><img data-src=\"Perbedaan-NAT-Bridge-Dan-Host-Only-Di-Vmware-Dan-Virtualbox-1170x731.jpg\" alt=\"Perbedaan NAT Bridge Dan Host Only\" /></p>\n<ul>\n<li>\n<p>NAT 模式：使用 NAT 模式，就是让虚拟机借助 NAT （网络地址转换）功能，通过宿主机器所在的网络来访问外部网络，即：使用 NAT 模式可以实现在虚拟系统里访问互联网。</p>\n<p>优点：是从虚拟机访问外部网络的最简单方法；通常，它会自动设置网络地址转换到虚拟机上，不需要在宿主机器的网络信息上配置或通过访客操作系统上进行配置。</p>\n<p>缺点：就像路由器后面的专用网络一样，虚拟机是不可见的，无法从外部网络访问。</p>\n<p><img data-src=\"Virtual_network_switch_in_nat_mode.png\" alt=\"vmware-network-nat\" /></p>\n</li>\n<li>\n<p>Host-only 模式：构建一个与外界断开连接的内部网络，只允许使用 host-only 方法的虚拟机才能通信，因此无法与外部网络或其他 PC 主机通信，只能相互通信。</p>\n<p>优点：与内部网络一样，其不需要存在物理网络接口，相当于使用 host-only 方法的虚拟机通过双绞线直连形成网络节点进行通讯；由于无法访问外部网络，因此对于安全性来讲，比其余两种相对要高。</p>\n<p>缺点：如其名，无法与主机外部的网络通信，同时外部网络设备也无法与其通讯。</p>\n<p><img data-src=\"Virtual_network_switch_in_host-only_mode.png\" alt=\"vmware-network-hostonly\" /></p>\n</li>\n<li>\n<p>bridged 模式：在这种模式下，虚拟系统就像是局域网中的一台独立的主机，具有自己的 MAC 和 IP 地址；由于虚拟机和宿主机器分配了相同网段的 IP，因此宿主机器和虚拟机被识别为同一级别的物理主机。</p>\n<p>优点：虚拟机就像是一台独立的主机，拥有正常主机的网络功能，可以对外部网络进行访问，而外部网络也可以访问进来。</p>\n<p>缺点：由于外部网络可以访问，其安全性比其余两种相对要低；因与宿主机器平等的存在于网络中，需要进行分配网络地址、子网掩码、网关等操作。</p>\n<p><img data-src=\"Virtual_network_switch_in_bridged_mode.png\" alt=\"vmware-network-bridged\" /></p>\n</li>\n</ul>\n<p>示例：</p>\n<p>一些 VMnet 虚拟机具有特定功能：VMnet0 专用于 bridged 模式，VMnet1 专用于 host-only 模式，而 VMnet8 专用于 NAT 模式；其他的 VMnet2 等，可供虚拟机使用自定义网络模式。如图分析各模式作用：</p>\n<p><img data-src=\"workstation-networking_thumb1.jpg\" alt=\"工作站网络\" /></p>\n<ul>\n<li>\n<p>VM-1 可以与 host PC 通信，并连接到外部 LAN or internet，但不能与 NAT 和 host-only 网络通信。</p>\n</li>\n<li>\n<p>VM-2 和 VM-3 可以相互通信，也可以与 NAT 网络中的其他 VM 通信，也可以与 host PC 通信。</p>\n</li>\n<li>\n<p>VM-5 和 VM-4 可以相互通信，但不能与主机操作系统和 host-only 网络中的其他 VM 通信。</p>\n</li>\n<li>\n<p>VM-6 和 VM-7 无法相互通信。</p>\n</li>\n</ul>\n<p>参考：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdXBlcnVzZXIuY29tL3F1ZXN0aW9ucy8yMjc1MDUvd2hhdC1pcy10aGUtZGlmZmVyZW5jZS1iZXR3ZWVuLW5hdC1icmlkZ2VkLWhvc3Qtb25seS1uZXR3b3JraW5n\">What is the difference between NAT / Bridged / Host-Only networking?</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9waWJ5dGVzLndvcmRwcmVzcy5jb20vMjAxMi8xMS8xNi92bXdhcmUtd29ya3N0YXRpb24tbmV0d29ya2luZy1iYXNpY3Mv\">VMware Workstation Networking Basics</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hZ3Vzc2FzLndvcmRwcmVzcy5jb20vMjAxNS8xMC8yOC92bXdhcmUtbmV0d29ya2luZy1jb25jZXB0LWJyaWRnZWQtbmF0LWhvc3Qtb25seS1sYW4tc2VnbWVudC8=\">VMWare Networking Concept [Bridged, NAT, Host Only, LAN Segment]</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubW9uaXRvcnRla25vbG9naS5jb20vcGVyYmVkYWFuLW5hdC1icmlkZ2UtZGFuLWhvc3Qtb25seS8=\">Perbedaan NAT Bridge Dan Host Only Di VMware Dan VirtualBox</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmxpYnZpcnQub3JnL1ZpcnR1YWxOZXR3b3JraW5nLmh0bWw=\">Virtual Networking</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudW5hbWUuaW4vNjA=\">Vmware Host-Only, NAT, Bridge 차이</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kaWFybXVpZG1jY2FydGh5LndvcmRwcmVzcy5jb20vMjAxMS8wMi8xNS9oZWxsby13b3JsZC8=\">Intro to Virtual Machine Networking</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9yeWFuaXNhZ29vZGd1eS5ibG9nc3BvdC5jb20vMjAxOS8wNi92bXdhcmVuZXR3b3JrLXR5cGVicmlkZ2VkaG9zdC1vbmx5LW5hdC5odG1s\">VMware 虛擬機器上網路連線 (Network type) 的三種模式</span></p>\n<h1 id=\"setp-3网络信息配置\"><a class=\"anchor\" href=\"#setp-3网络信息配置\">#</a> setp 3：网络信息配置</h1>\n<p>从上一步可以知道我们目前有两个网络适配器，分别是 NAT 和 桥接模式，然后针对这几个模式的作用也在上面作了介绍了；因此在这里，实际只需要在虚拟机系统中配置桥接模式对应的网卡网络信息就好了；至于 NAT 模式对应的网卡网络信息将由虚拟机借助 NAT （网络地址转换）功能实现自动配置即可实现访问外网功能。</p>\n<ol>\n<li>\n<p>查看所有网卡信息：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">ifconfig</span> <span class=\"token parameter variable\">-a</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>ens33: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.154.133  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.154.255</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>        inet6 fe80::b52c:a0e6:1419:116b  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>        ether 00:0c:29:f0:76:35  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>以太网<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>        RX packets <span class=\"token number\">102259</span>  bytes <span class=\"token number\">150687397</span> <span class=\"token punctuation\">(</span><span class=\"token number\">150.6</span> MB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>        TX packets <span class=\"token number\">13950</span>  bytes <span class=\"token number\">938511</span> <span class=\"token punctuation\">(</span><span class=\"token number\">938.5</span> KB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>ens36: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.17.218  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.17.255</pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>        inet6 240e:47c:680:2899:56c0:dff:d5fe:b1aa  prefixlen <span class=\"token number\">64</span>  scopeid 0x<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>global<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>        inet6 240e:47c:680:2899:18e7:3cfa:5fad:bbe  prefixlen <span class=\"token number\">64</span>  scopeid 0x<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>global<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre>        inet6 fe80::a25b:a66f:67e7:3e67  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre>        ether 00:0c:29:f0:76:3f  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>以太网<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"\"></td><td><pre>        RX packets <span class=\"token number\">426</span>  bytes <span class=\"token number\">474569</span> <span class=\"token punctuation\">(</span><span class=\"token number\">474.5</span> KB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td data-command=\"\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"19\"></td><td data-command=\"\"></td><td><pre>        TX packets <span class=\"token number\">403</span>  bytes <span class=\"token number\">44762</span> <span class=\"token punctuation\">(</span><span class=\"token number\">44.7</span> KB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td data-command=\"\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"21\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td data-command=\"\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"23\"></td><td data-command=\"\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"24\"></td><td data-command=\"\"></td><td><pre>        inet6 ::1  prefixlen <span class=\"token number\">128</span>  scopeid 0x1<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td data-command=\"\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>本地环回<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td data-command=\"\"></td><td><pre>        RX packets <span class=\"token number\">308</span>  bytes <span class=\"token number\">26853</span> <span class=\"token punctuation\">(</span><span class=\"token number\">26.8</span> KB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td data-command=\"\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"28\"></td><td data-command=\"\"></td><td><pre>        TX packets <span class=\"token number\">308</span>  bytes <span class=\"token number\">26853</span> <span class=\"token punctuation\">(</span><span class=\"token number\">26.8</span> KB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td data-command=\"\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr></table></figure></li>\n<li>\n<p>启用网卡（如已启用则跳过该步骤），其中  <code>ens36</code>  是设置 bridged 模式的网卡。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">ifconfig</span> ens36 up</pre></td></tr></table></figure></li>\n<li>\n<p>修改网络信息配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">cp</span> /etc/netplan/01-network-manager-all.yaml /etc/netplan/01-network-manager-all.yaml.back <span class=\"token comment\"># 备份</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">vim</span> /etc/netplan/01-network-manager-all.yaml</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\"># Let NetworkManager manage all devices on this system</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>network:</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre>  ethernets:</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre>    ens33:</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>      dhcp4: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre>      dhcp4-overrides:</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"\"></td><td><pre>        route-metric: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>      <span class=\"token comment\"># addresses: [192.168.1.110/24]</span></pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre>      <span class=\"token comment\"># gateway4: 192.168.1.1</span></pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre>      <span class=\"token comment\"># nameservers:</span></pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre>       <span class=\"token comment\"># addresses: [192.168.1.1]</span></pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre>    ens36:</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre>      dhcp4: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"16\"></td><td data-command=\"\"></td><td><pre>  version: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"17\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td data-command=\"\"></td><td><pre>  bridges:</pre></td></tr><tr><td data-num=\"19\"></td><td data-command=\"\"></td><td><pre>    br0:</pre></td></tr><tr><td data-num=\"20\"></td><td data-command=\"\"></td><td><pre>     interfaces: <span class=\"token punctuation\">[</span>ens36<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td data-command=\"\"></td><td><pre>     dhcp4: no</pre></td></tr><tr><td data-num=\"22\"></td><td data-command=\"\"></td><td><pre>     addresses:</pre></td></tr><tr><td data-num=\"23\"></td><td data-command=\"\"></td><td><pre>      - <span class=\"token number\">192.168</span>.1.110/24</pre></td></tr><tr><td data-num=\"24\"></td><td data-command=\"\"></td><td><pre>     nameservers:</pre></td></tr><tr><td data-num=\"25\"></td><td data-command=\"\"></td><td><pre>       addresses: <span class=\"token punctuation\">[</span><span class=\"token number\">8.8</span>.8.8<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td data-command=\"\"></td><td><pre>     routes:</pre></td></tr><tr><td data-num=\"27\"></td><td data-command=\"\"></td><td><pre>      - to: <span class=\"token number\">0.0</span>.0.0/0</pre></td></tr><tr><td data-num=\"28\"></td><td data-command=\"\"></td><td><pre>        via: <span class=\"token number\">192.168</span>.1.1</pre></td></tr><tr><td data-num=\"29\"></td><td data-command=\"\"></td><td><pre>        metric: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"30\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td data-command=\"\"></td><td><pre><span class=\"token comment\">#  renderer: NetworkManager</span></pre></td></tr><tr><td data-num=\"32\"></td><td data-command=\"\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td data-command=\"\"></td><td><pre>netplan apply</pre></td></tr><tr><td data-num=\"34\"></td><td data-command=\"\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr></table></figure></li>\n<li>\n<p>重启后查看验证网路</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>route <span class=\"token parameter variable\">-n</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>内核 IP 路由表</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>目标            网关            子网掩码        标志  跃点   引用  使用 接口</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">192.168</span>.154.2   <span class=\"token number\">0.0</span>.0.0         UG    <span class=\"token number\">100</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> ens33</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">192.168</span>.1.1     <span class=\"token number\">0.0</span>.0.0         UG    <span class=\"token number\">1000</span>   <span class=\"token number\">0</span>        <span class=\"token number\">0</span> br0</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">192.168</span>.1.0     <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.0   U     <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> br0</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">192.168</span>.154.0   <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.0   U     <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> ens33</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">192.168</span>.154.2   <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.255 UH    <span class=\"token number\">100</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> ens33</pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"[root@localhost] $\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">ping</span> baidu.com</pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"[root@localhost] $\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"[root@localhost] $\"></td><td><pre><span class=\"token function\">ping</span> <span class=\"token function\">host</span> <span class=\"token function\">ip</span></pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure></li>\n</ol>\n<h1 id=\"关于双网卡无法上网问题\"><a class=\"anchor\" href=\"#关于双网卡无法上网问题\">#</a> 关于双网卡无法上网问题</h1>\n<p>当在虚拟机网络中设置完 VMnet0 桥接的 IP 地址等信息，打开网络后，发现网络不通。</p>\n<p>但如果关闭 VMnet0，只保留 VMnet8，网络又是可行的，由此考虑到可能是网卡优先级的配置问题。</p>\n<p>通过上面可以发现  <code>br0</code>  的跃点比  <code>ens33</code>  的 metric 要高，而 metric 越低，其优先级越高，因此按上面操作来一般没问题的；如果这两个网卡的 metric 值反过来，那么会造成无法上网的问题，因为本身我们的有线网口是没有联网的，但优先级又比联网的网卡优先级高，所以会出现 ping 不通外网的情况。</p>\n<p>假设需要临时调整 ip /gateway/metric 等，可以使用  <code>route</code>  命令，而避免更改网络配置表文件，关于  <code>route</code>  命令使用可看 <a href=\"http://arachnid.cc/linux-routing-table\">Linux 路由表说明</a> 。</p>\n",
            "tags": [
                "Ubuntu",
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/uboot-starting/",
            "url": "https://arachnid.cc/uboot-starting/",
            "title": "uboot 引导启动分析",
            "date_published": "2023-02-22T13:19:51.653Z",
            "content_html": "<h1 id=\"uboot-命令\"><a class=\"anchor\" href=\"#uboot-命令\">#</a> uboot 命令</h1>\n<h2 id=\"命令支持\"><a class=\"anchor\" href=\"#命令支持\">#</a> 命令支持</h2>\n<p>当不清楚 uboot 支持什么命令时， 可输入  <code>help</code>  或  <code>?</code>  可查看 uboot 支持的命令列表；当需要具体使用哪个命令时，可使用  <code>help [命令]</code>  或  <code>? [命令]</code>  的方式查看具体命令的使用说明，eg： <code>help printenv</code>  。</p>\n<p>具体可以使用什么命令，实际跟 uboot 中的  <code>CONFIG_CMD_xxx</code>  宏的使能有关，因此，如果无法使用某些命令，可能是因为把特定的  <code>CONFIG_CMD_xxx</code>  宏去掉了；而对于这些命令的开关，可以在  <code>configs/xxx_defconfig</code>  中定义，或者使用  <code>make menuconfig</code>  选择使能相应命令的支持。</p>\n<h2 id=\"常用命令行命令\"><a class=\"anchor\" href=\"#常用命令行命令\">#</a> 常用命令行命令</h2>\n<p><strong>A、环境变量操作</strong></p>\n<ol>\n<li>\n<p>printenv</p>\n<p>功能：打印环境变量。</p>\n<p>用法： <code>printenv &lt;name&gt;</code>  ，其中 name 为相应的环境变量名，不填则打印所有环境变量配置。</p>\n</li>\n<li>\n<p>setenv</p>\n<p>功能：设置环境变量。</p>\n<p>用法： <code>setenv &lt;key&gt; &lt;value&gt;</code>  ，其中 key 是变量名，value 是变量值。如果 value 为空，则表示删除对应的环境变量。</p>\n</li>\n<li>\n<p>saveenv</p>\n<p>功能：保存环境变量修改，使用 setenv 设置环境变量后不会掉电保存，需要保存后才不会丢失。</p>\n<p>用法： <code>saveenv</code>  。</p>\n</li>\n<li>\n<p>run</p>\n<p>功能：执行指定的环境变量里的语句。</p>\n<p>用法： <code>run &lt;var&gt;</code>  ，其中 key 是指定的环境变量。</p>\n</li>\n</ol>\n<p><strong>B、存储介质操作</strong></p>\n<ol>\n<li>\n<p>mmc &amp; SD</p>\n<p>功能：对 mmc 存储介质进行操作，包括 EMMC 和 SD 卡。</p>\n<p>用法：</p>\n<ul>\n<li><code>mmc list</code>  ，用于查看板子上 mmc 设备。</li>\n<li><code>mmc dev &lt;dev&gt; &lt;part&gt;</code>  ，用于切换当前 mmc 设备，其中 dev 用来设置要切换的 mmc 设备号，part 是分区号（可以不写，默认为分区 0）。</li>\n<li><code>mmc info</code>  ，查看当前 mmc 设备信息。</li>\n<li><code>mmc part</code>  ，查看当前 mmc 设备分区。</li>\n<li><code>mmc read / write &lt;addr&gt; &lt;blk#&gt; &lt;cnt&gt;</code>  ，读取 / 写入当前 mmc 设备数据，其中 addr 是数据写入 / 读取到 DRAM 中的地址 (十六进制)， blk# 是要读取 / 写入到 emmc 的块起始地址 (十六进制)，一个块是 512 字节，这里的块和扇区是一个意思，在 mmc 设备中我们通常说扇区， cnt 是要读取 / 写入的块数量 (十六进制)。</li>\n<li><code>mmc erase &lt;blk#&gt; &lt;cnt&gt;</code>  ，擦除当前 mmc 设备数据，其中 blk# 为要擦除的起始块 (十六进制)， cnt 是要擦除的数量 (十六进制)。</li>\n<li><code>mmc rescan</code>  ，令用于扫描设备上所有的 mmc 设备，包括 EMMC 和 SD 卡。</li>\n</ul>\n</li>\n<li>\n<p>nand</p>\n<p>功能：对 nand flash 存储介质进行操作。</p>\n<p>用法：</p>\n<ul>\n<li><code>nand info</code>  ，查看当前 nand flash 信息。</li>\n<li><code>nand dev &lt;dev&gt; &lt;part&gt;</code>  ，用于切换当前 nand flash 设备，其中 dev 用来设置要切换的 nand 设备号，part 是分区号（可以不写，默认为分区 0）。</li>\n<li><code>nand read / write &lt;addr&gt; &lt;off&gt; &lt;size&gt;</code>  ，读取 / 写入当前 nand flash 设备数据，其中 addr 是数据写入 / 读取到 DRAM 中的地址 (十六进制)， off 是要读取 / 写入 nand flash 的起始地址 (十六进制)，size 是要读取 / 写入的数据大小 (十六进制)。</li>\n<li><code>mmc erase &lt;addr&gt; &lt;size&gt;</code>  ，擦除当前 nand flash 设备数据，其中 addr 为要擦除的起始地址 (十六进制)， size 是要擦除的数据大小 (十六进制)。</li>\n</ul>\n</li>\n</ol>\n<p><strong>C、网络操作</strong></p>\n<ol>\n<li>\n<p>ping</p>\n<p>功能：发送 ICMP_ECHO 请求到网络主机。</p>\n<p>用法： <code>ping &lt;hostaddr&gt;</code>  ，其中 hostaddr 是目标发送请求主机 IP。</p>\n</li>\n<li>\n<p>dhcp</p>\n<p>功能：获取 ip 地址及通过 tftp 下载到内存。</p>\n<p>用法：</p>\n<ul>\n<li><code>dhcp</code>  ，单纯用于自动获取 ip 地址。</li>\n<li><code>dhcp &lt;loadaddr&gt; &lt;[hostIPaddr:]filename&gt;</code>  ，其中 loadaddr 是加载内存地址，hostIPaddr 是获取链接的主机 IP，filename 是要下载的文件名。</li>\n</ul>\n</li>\n<li>\n<p>nfs</p>\n<p>功能：通过 nfs (Network File System) 下载到内存。</p>\n<p>用法： <code>nfs &lt;loadaddr&gt; &lt;[hostIPaddr:]filename&gt;</code>  ，其中 loadaddr 是加载内存地址，hostIPaddr 是获取链接的主机 ip，filename 是要下载的文件名。</p>\n</li>\n<li>\n<p>tftp / tftpboot</p>\n<p>功能：通过 tftp 下载到内存。</p>\n<p>用法： <code>tftp / tftpboot &lt;loadaddr&gt; &lt;[hostIPaddr:]filename&gt;</code>  ，其中 loadaddr 是加载内存地址，hostIPaddr 是获取链接的主机 ip，filename 是要下载的文件名。</p>\n</li>\n</ol>\n<p><strong>D、文件系统操作</strong></p>\n<ol>\n<li>\n<p>fatinfo</p>\n<p>功能：查询指定 mmc 设置指定分区的文件系统信息。</p>\n<p>用法： <code>fatinfo &lt;interface&gt; &lt;dev&gt;:&lt;part&gt;</code>  ，其中 interface 表示接口（mmc 等），dev 是查询的设备号， part 是要查询的分区。</p>\n</li>\n<li>\n<p>fatls / ext4ls</p>\n<p>功能：查询 FAT /ext4 格式设备的目录和文件信息。</p>\n<p>用法： <code>fatls / ext4ls &lt;interface&gt; &lt;dev&gt;:&lt;part&gt; &lt;directory&gt;</code>  ，其中 interface 表示接口（mmc 等），dev 是查询的设备号， part 是要查询的分区，directory 是要查询的目录（默认为根目录  <code>/</code>  ）。</p>\n</li>\n<li>\n<p>fatload / ext4load</p>\n<p>功能：查询 FAT /ext4 格式设备的目录和文件信息。</p>\n<p>用法： <code>fatload / ext4load &lt;interface&gt; &lt;dev&gt;:&lt;part&gt; &lt;addr&gt; &lt;filename&gt; &lt;bytes&gt; &lt;pos&gt;</code>  ，其中 interface 表示接口（mmc 等），dev 是查询的设备号， part 是要查询的分区，addr 是保存在 DRAM 中的起始地址， filename 是要读取的文件名字，bytes 表示读取多少字节的数据（0 或者省略表示读取整个文件），pos 是要读的文件相对于文件首地址的偏移（0 或者省略表示从文件首地址开始读取）。</p>\n</li>\n</ol>\n<p><strong>E、内存操作</strong></p>\n<ol>\n<li>\n<p>md</p>\n<p>功能：用于显示内存值。</p>\n<p>用法： <code>md[.b, .w, .l] address [# of objects]</code>  ，其中，[.b, .w, .l] 对应 byte、word 和 long，也就是分别以 1 个字节、2 个字节、4 个字节来显示内存值。address 就是要查看的内存起始地址，[# of objects] 表示要查看的数据长度，这个数据长度单位不是字节，而是跟你所选择的显示格式有关；其数值皆为十六进制。</p>\n</li>\n<li>\n<p>nm</p>\n<p>功能：用于修改指定地址的内存值。</p>\n<p>用法： <code>mw [.b, .w, .l] address value [count]</code>  ，同样以 [.b, .w, .l] 对应 byte、word 和 long，也就是分别以 1 个字节、2 个字节、4 个字节来指定操作格式，ddress 表示要填充的内存起始地址，value 为要填充的数据，count 是填充的长度（与选择的操作格式有关）；其数值皆为十六进制。</p>\n</li>\n<li>\n<p>cp</p>\n<p>功能：用于将数据从一段内存拷贝到另一段内存中。</p>\n<p>用法： <code>cp [.b, .w, .l] source target count</code>  ，[.b, .w, .l] 对应 byte、word 和 long 来指定操作格式，source 为源地址，target 为目的地址，count 为拷贝的长度（与选择的操作格式有关）；其数值皆为十六进制。</p>\n</li>\n<li>\n<p>cmp</p>\n<p>功能：用于将数据从一段内存拷贝到另一段内存中。</p>\n<p>用法： <code>cmp [.b, .w, .l] addr1 addr2 count</code>  ，[.b, .w, .l] 对应 byte、word 和 long 来指定操作格式，addr1 为第一段内存首地址，addr2 为第二段内存首地址，count 为要比较的长度（与选择的操作格式有关）；其数值皆为十六进制。</p>\n</li>\n</ol>\n<p><strong>F、启动内核</strong></p>\n<ol>\n<li>\n<p>bootz</p>\n<p>功能：从指定内存位置加载启动 <strong>zImage 镜像文件</strong> 。</p>\n<p>用法： <code>bootm &lt;zImageaddr&gt; - &lt;fdtaddr&gt;</code>  ，其中，kerneladdr 是 zImage 镜像地址，fdtaddr 是设备树文件地址。</p>\n</li>\n<li>\n<p>bootm</p>\n<p>功能：从指定内存位置加载启动 <strong>uImage 镜像文件</strong> 。</p>\n<p>用法： <code>bootm &lt;uImageaddr&gt; &lt;- arg...&gt;</code>  ，其中，kerneladdr 是 uImage 镜像地址，arg 是为可选子命令，具体可看  <code>? bootm</code>  。</p>\n</li>\n<li>\n<p>boot</p>\n<p>功能：通过读取环境变量  <code>bootcmd</code>  来启动 linux 系统。</p>\n<p>用法： <code>boot</code>  。</p>\n</li>\n</ol>\n<p><strong>G、other</strong></p>\n<ol>\n<li>\n<p>reset</p>\n<p>功能：重启 uboot。</p>\n</li>\n<li>\n<p>env default -a</p>\n<p>功能：获取默认 env 环境变量，即  <code>include/env_default.h</code>  中  <code>default_environment</code>  数组中的变量。</p>\n</li>\n<li>\n<p>ls</p>\n<p>功能：查看当前 mmc 介质里的文件。eg： <code>ls mmc 1:1</code>  可以获取到设备 1 的分区 1 中存放着内核和设备树； <code>ls mmc 1:2</code>  可以获取到系统中的文件系统根目录所存在的文件及文件夹；如果  <code>ls mmc 1:0</code>  ，你会发现提示文件系统未知或错误，这是因为分区 0 存放的是 uboot，并且分区 0 没有格式化，所以文件系统格式未知。</p>\n</li>\n</ol>\n<h1 id=\"环境变量\"><a class=\"anchor\" href=\"#环境变量\">#</a> 环境变量</h1>\n<p>需要注意的是，环境变量的名字并不是统一的，除部分重要变量名外，主要是由芯片厂商或开发者自行协定的。</p>\n<h2 id=\"默认环境变量\"><a class=\"anchor\" href=\"#默认环境变量\">#</a> 默认环境变量</h2>\n<p>默认环境变量可以在  <code>include/configs/</code>  文件夹中找到对应的芯片配置头文件及在  <code>include/env_default.h</code>  文件中查看定义。一般其主要环境变量参数整体被定义在  <code>CONFIG_EXTRA_ENV_SETTINGS</code>  宏参数中，在 README 文件中可找到说明：</p>\n<figure class=\"highlight markdown\"><figcaption data-lang=\"markdown\"><span>README</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token list punctuation\">-</span> Default Environment:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t\tCONFIG_EXTRA_ENV_SETTINGS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token code keyword\">\t\tDefine this to contain any number of null terminated</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tstrings (variable = value pairs) that will be part of</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tthe default environment compiled into the boot image.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token code keyword\">\t\tFor example, place something like this in your</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tboard's config file:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token code keyword\">\t\t#define CONFIG_EXTRA_ENV_SETTINGS \\</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\"myvar1=value1\\0\" \\</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\"myvar2=value2\\0\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token code keyword\">\t\tWarning: This method is based on knowledge about the</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\tinternal format how the environment is stored by the</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tU-Boot code. This is NOT an official, exported</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tinterface! Although it is unlikely that this format</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\twill change soon, there is no guarantee either.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tYou better know what you are doing here.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token code keyword\">\t\tNote: overly (ab)use of the default environment is</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tdiscouraged. Make sure to check other ways to preset</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tthe environment like the \"source\" command or the</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tboot command first.</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token code keyword\">\t\tCONFIG_DELAY_ENVIRONMENT</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token code keyword\">\t\tNormally the environment is loaded when the board is</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tinitialised so that it is available to U-Boot. This inhibits</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\tthat so that the environment is not available until</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\texplicitly loaded later by U-Boot code. With CONFIG_OF_CONTROL</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\tthis is instead controlled by the value of</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t/config/load-environment.</span></pre></td></tr></table></figure><h2 id=\"常用环境变量\"><a class=\"anchor\" href=\"#常用环境变量\">#</a> 常用环境变量</h2>\n<p>在  <code>include/env_default.h</code>  文件定义的环境变量，可通过读取宏来配置相应值，及从  <code>CONFIG_EXTRA_ENV_SETTINGS</code>  宏参数追加自定义环境变量，其中有几个变量是比较重要，这里结合 NXP 厂商的定义进行如下参考分析：</p>\n<p><strong>1、console 变量（固有）</strong></p>\n<p>功能：表示控制台输出设备。</p>\n<p><strong>2、baudrate 变量（固有）</strong></p>\n<p>功能：指定 linux 系统启动过程中串口控制台打印的波特率。</p>\n<p><strong>3、bootdelay 变量（固有）</strong></p>\n<p>功能：设置 uboot 启动时等待用户输入的延时，单位是秒。</p>\n<p><strong>4、fdt_addr 变量（私人）</strong></p>\n<p>功能：设备树加载启动的地址。</p>\n<p><strong>5、fdt_file 变量（私人）</strong></p>\n<p>功能：设备树加载显示的名称，如果 uboot 中配置的名称对应不上获取的设备树文件，将显示 undefined。</p>\n<p><strong>6、image 变量（私人）</strong></p>\n<p>功能：内核加载启动读取的文件名。</p>\n<p><strong>7、loadaddr 变量（固有）</strong></p>\n<p>功能：内核加载启动的地址。</p>\n<p><strong>8、ipaddr/serverip/gatewayip/netmask 变量（固有）</strong></p>\n<p>功能：用于设置网络信息，分别对应开发板 ip、服务器 ip、网关、子网掩码；设置完成后可用 ping 命令测试网络连通性。</p>\n<p><strong>9、bootcmd 变量（固有）</strong></p>\n<p>功能： <code>bootcmd</code>  变量是用来存储启动命令的环境变量，它定义了 uboot 启动 linux 系统的具体步骤。当 uboot 倒计时结束以后就会执行  <code>bootcmd</code>  中的命令。这些命令一般都是用来启动 linux 内核的，比如读取 EMMC 或者 NAND Flash 中的 linux 内核镜像文件和设备树文件到 DRAM 中，然后启动 linux 内核。</p>\n<p>也可以在 uboot 启动以后进入命令行设置  <code>bootcmd</code>  环境变量的值。如果 EMMC 或者 NAND 中没有保存  <code>bootcmd</code>  的值，那么 uboot 就会使用默认的值。</p>\n<p>应用： <code>bootcmd</code>  变量的内容通常是一系列 uboot 命令和参数的组合，例如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">bootcmd</span><span class=\"token operator\">=</span>run load_kernel<span class=\"token punctuation\">;</span> run load_dtb<span class=\"token punctuation\">;</span> bootz <span class=\"token variable\">$&#123;kernel_addr_r&#125;</span> - <span class=\"token variable\">$&#123;fdt_addr_r&#125;</span></pre></td></tr></table></figure><p>上述  <code>bootcmd</code>  变量定义了两个命令： <code>load_kernel</code>  和  <code>load_dtb</code> ，并最后执行了  <code>bootz</code>  命令来启动 linux 内核。这里的  <code>run</code>  命令表示执行一个之前定义好的环境变量，例如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">load_kernel</span><span class=\"token operator\">=</span>mmc dev <span class=\"token variable\">$&#123;mmc_dev&#125;</span><span class=\"token punctuation\">;</span> fatload mmc <span class=\"token variable\">$&#123;mmc_dev&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;mmc_part&#125;</span> <span class=\"token variable\">$&#123;kernel_addr&#125;</span> zImage</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">load_dtb</span><span class=\"token operator\">=</span>fatload mmc <span class=\"token variable\">$&#123;mmc_dev&#125;</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$&#123;mmc_part&#125;</span> <span class=\"token variable\">$&#123;fdt_addr&#125;</span> devicetree.dtb</pre></td></tr></table></figure><p>在上述命令中， <code>load_kernel</code>  和  <code>load_dtb</code>  分别使用  <code>fatload</code>  命令从 mmc 设备  <code>$&#123;mmc_dev&#125;</code>  的  <code>$&#123;mmc_part&#125;</code>  分区（ <code>mmc $&#123;mmc_dev&#125;:$&#123;mmc_part&#125;</code> ）中加载内核和设备树； <code>$&#123;kernel_addr&#125;</code>  和  <code>$&#123;fdt_addr&#125;</code>  是在 uboot 中预定义的环境变量，分别表示内核和设备树在内存中的地址。</p>\n<p>在实际应用中， <code>bootcmd</code>  变量的内容需要根据硬件平台和具体应用场景来设置，以确保系统能够正确启动。可以使用  <code>printenv bootcmd</code>  命令来查看当前的  <code>bootcmd</code>  命令，使用  <code>setenv bootcmd &lt;cmd&gt;</code>  命令来手动设置  <code>bootcmd</code>  变量，例如，把上述命令定义并保存到  <code>bootcmd</code>  变量中：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>setenv bootcmd <span class=\"token string\">'run load_kernel; run load_dtb; run load_rootfs; bootm'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>saveenv</pre></td></tr></table></figure><p><strong>10、bootargs 变量（固有）</strong></p>\n<p>功能： <code>bootargs</code>  变量是用来存储内核启动参数的环境变量，它在启动 linux 内核时会被传递给内核。bootargs 变量可以在 uboot 命令行中手动设置，也可以通过脚本自动设置。下面是一些常见的  <code>bootargs</code>  参数：</p>\n<ul>\n<li>\n<p>console：指定内核输出信息的终端设备，可以是串口、LCD 显示屏等。</p>\n</li>\n<li>\n<p>root：指定根文件系统所在的设备和分区。</p>\n</li>\n<li>\n<p>rootfstype：指定根文件系统的文件系统类型，例如  <code>ext4</code> 、 <code>jffs2</code> 、 <code>nfs</code>  等。</p>\n</li>\n<li>\n<p>ip：指定 IP 地址和网络参数，用于网络启动。</p>\n</li>\n<li>\n<p>mem：指定系统可用内存的大小，用于系统启动时内存的自适应分配。</p>\n</li>\n<li>\n<p>quiet：设置内核启动时不显示冗长的信息。</p>\n</li>\n<li>\n<p>debug：开启内核调试模式，用于调试内核代码。</p>\n</li>\n</ul>\n<p>应用：在设置  <code>bootargs</code>  变量时，需要根据硬件平台和具体应用场景来选择合适的参数，并确保参数的正确性。例如， <code>console</code>  参数需要根据硬件平台的串口地址和波特率来设置， <code>root</code>  参数需要根据具体的文件系统类型和分区来设置。例如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>setenv bootargs <span class=\"token assign-left variable\">console</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;console&#125;</span>,<span class=\"token variable\">$&#123;baudrate&#125;</span> <span class=\"token assign-left variable\">root</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;mmc_root&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>saveenv</pre></td></tr></table></figure><h2 id=\"环境变量设置\"><a class=\"anchor\" href=\"#环境变量设置\">#</a> 环境变量设置</h2>\n<p>环境变量的设置有两种方法，一种方法是通过修改静态配置，即通过修改 uboot 的文件中相关环境变量的配置。不过此类方法在实际中显然非常不实际，每次需要修改一次环境变量都需要重新编译整个 uboot。</p>\n<p>另一种方法是利用 uboot 提供的  <code>setenv</code>  动态修改环境变量的设置，当设置完成后再通过  <code>saveenv</code>  把相应的环境变量设置保存到 Flash 等非易失性存储设备上。</p>\n<p>在更改多次环境变量后，如果想恢复成 uboot 的文件中默认环境变量的配置，可以通过  <code>env default -a</code>  重新读取，最后通过  <code>saveenv</code>  保存。</p>\n<p>uboot 的环境参数，在 uboot 启动过程中，会去校验 CRC 存放环境变量的一段空间，若 CRC 有效则使用该空间里的环境变量，无效则用默认的环境变量；因此在初次移植烧录 uboot 的时候，由于没有使用  <code>saveenv</code>  存储过，所以读不出 CRC 校验，而使用的默认环境变量（可通过  <code>printenv</code>  输出对比文件里环境变量的配置），同样的在信息打印中也会输出  <code>*** Warning - bad CRC, using default environment</code>  。</p>\n<h1 id=\"启动方式\"><a class=\"anchor\" href=\"#启动方式\">#</a> 启动方式</h1>\n<p>uboot 有两种启动 linux 内核和 rootfs 的方法，一种是直接从 flash (nand 或 emmc) 启动，一种是从网络启动。这里面用到了两个非常重要的环境变量  <code>bootcmd</code>  和  <code>bootargs</code>  。</p>\n<h2 id=\"从-emmc-启动\"><a class=\"anchor\" href=\"#从-emmc-启动\">#</a> 从 EMMC 启动</h2>\n<p>从 EMMC 启动也就是将编译出来的 linux 镜像文件 zImage 和设备树文件保存在 EMMC 中， uboot 从 EMMC 中读取这两个文件并启动。</p>\n<p>以 NXP 的 imx-6ull 为例：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>setenv bootargs <span class=\"token string\">'console=ttymxc0,115200 root=/dev/mmcblk1p2 rootwait rw'</span> <span class=\"token comment\"># 设置控制台输出设备为 ttymxc0、波特率为 115200；指明根文件系统存放在 mmcblk1 设备的分区 2 中，EMMC 版本的核心板启动 linux 以后会存在 /dev/mmcblk0、/dev/mmcblk1、 /dev/mmcblk0p1、/dev/mmcblk0p2、 /dev/mmcblk1p1 和 /dev/mmcblk1p2 这样的文件，其中 /dev/mmcblkx (x=0~ n) 表示 mmc 设备，而 /dev/mmcblkxpy (x=0~ n,y=1~ n) 表示 mmc 设备 x 的分区 y；rootwait 表示等待 mmc 设备初始化完成以后再挂载，否则的话 mmc 设备还没初始化完成就挂载根文件系统会出错的，rw 表示根文件系统是可以读写的，不加 rw 的话可能无法在根文件系统中进行写操作，只能进行读操作。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mmc dev <span class=\"token number\">1</span> <span class=\"token comment\"># 切换到 EMMC</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>fatload mmc <span class=\"token number\">1</span>:1 0x80800000 zImage <span class=\"token comment\"># 读取 zImage 到 0x80800000 处</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>fatload mmc <span class=\"token number\">1</span>:1 0x83000000 imx6ull-14x14-evk.dtb <span class=\"token comment\"># 读取设备树到 0x83000000 处</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>bootz 0x80800000 - 0x83000000 <span class=\"token comment\"># 启动内核</span></pre></td></tr></table></figure><h2 id=\"从网络启动\"><a class=\"anchor\" href=\"#从网络启动\">#</a> 从网络启动</h2>\n<p>从网络启动最主要的是用来调试，试想，假设你更改了部分 linux kernel 驱动或 rootfs，如果是使用 EMMC 进行烧录下载，那么就得每次都对其镜像或文件系统烧写到 EMMC 中，这样就太麻烦，因此我们可以使用网络对其进行烧写替换。其前提条件是必须配置好网络设备及 uboot 设备树，能正常连通，否者一切都是扯淡。</p>\n<p>以 NXP 的 imx-6ull 为例：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>setenv ethaddr 8e:14:c8:bc:02:49</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>setenv ipaddr <span class=\"token number\">192.168</span>.1.2</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>setenv gatewayip <span class=\"token number\">192.168</span>.1.1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>setenv netmask <span class=\"token number\">255.255</span>.255.0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>setenv serverip <span class=\"token number\">192.168</span>.1.100</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>setenv nfsroot /home/user/nfs_rootfs</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>setenv netargs setenv bootargs <span class=\"token string\">'console=ttymxc0,115200 root=/dev/nfs nfsroot=$&#123;serverip&#125;:$&#123;nfsroot&#125;,proto=tcp rw ip=$&#123;ipaddr&#125;:$&#123;serverip&#125;:$&#123;gatewayip&#125;:$&#123;netmask&#125;::eth0:off'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>tftp <span class=\"token number\">80800000</span> zImage</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>tftp <span class=\"token number\">83000000</span> imx6ull-14x14-evk.dtb</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>bootz <span class=\"token number\">80800000</span> - <span class=\"token number\">83000000</span></pre></td></tr></table></figure><p>note：网络获取设备树及镜像需要 tftp 服务的支持，网络挂载文件系统需要 nfs 服务的支持。</p>\n",
            "tags": [
                "Linux",
                "arm_linux"
            ]
        },
        {
            "id": "https://arachnid.cc/linux-routing-table/",
            "url": "https://arachnid.cc/linux-routing-table/",
            "title": "Linux 路由表说明",
            "date_published": "2023-02-05T06:32:47.036Z",
            "content_html": "<h1 id=\"route-命令\"><a class=\"anchor\" href=\"#route-命令\">#</a> route 命令</h1>\n<p>选项：</p>\n<ul>\n<li>\n<p><code>-v</code>  ：显示详细信息。</p>\n</li>\n<li>\n<p><code>-n</code>  ：不执行 DNS 反向查找（即不解析名称），直接显示数字形式的 IP 地址。</p>\n</li>\n<li>\n<p><code>-e</code>  ：netstat 格式显示路由表。</p>\n</li>\n<li>\n<p><code>-C</code>  ：打印 Linux 内核的路由缓存。</p>\n</li>\n<li>\n<p><code>add</code>  ：增加路由记录 /  <code>del</code>  ：删除路由记录</p>\n<ul>\n<li><code>-net</code>  ：目的地址是一个网络。</li>\n<li><code>-host</code>  ：目的地址是一台主机。</li>\n<li><code>netmask</code>  ：目的地址的网络掩码。</li>\n<li><code>gw</code>  ：路由数据包通过的网关。</li>\n<li><code>metric</code>  ：设置路由跃点。</li>\n</ul>\n</li>\n</ul>\n<p>eg：</p>\n<p>1、添加主机路由</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>添加主机路由</span></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>route <span class=\"token function\">add</span> <span class=\"token parameter variable\">-net</span> <span class=\"token number\">10.0</span>.0.10 netmask <span class=\"token number\">255.255</span>.255.255 gw <span class=\"token number\">10.139</span>.128.1 dev eth0</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>route <span class=\"token parameter variable\">-n</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">10.0</span>.0.10       <span class=\"token number\">10.139</span>.128.1    <span class=\"token number\">255.255</span>.255.255 UGH   <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth0</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>2、添加网络路由</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>添加网络路由</span></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>route <span class=\"token function\">add</span> <span class=\"token parameter variable\">-net</span> <span class=\"token number\">10.0</span>.0.0 netmask <span class=\"token number\">255.255</span>.255.0 gw <span class=\"token number\">10.139</span>.128.1 dev eth0</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>route <span class=\"token parameter variable\">-n</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">10.0</span>.0.0        <span class=\"token number\">10.139</span>.128.1    <span class=\"token number\">255.255</span>.255.0   UG    <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth0</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>3、添加设置默认网关跃点为 80</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>添加设置默认网关</span></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>route <span class=\"token function\">add</span> default gw <span class=\"token number\">192.168</span>.1.1 metric <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>route <span class=\"token parameter variable\">-n</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">192.168</span>.1.1     <span class=\"token number\">0.0</span>.0.0         UG    <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth0</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>4、删除路由</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>删除路由</span></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>route del default gw <span class=\"token number\">192.168</span>.1.1 metric <span class=\"token number\">80</span></pre></td></tr></table></figure><h1 id=\"字段分析\"><a class=\"anchor\" href=\"#字段分析\">#</a> 字段分析</h1>\n<p>使用  <code>route</code>  or  <code>route -n</code>  命令查看内核路由表：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>命令行提示符</span></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>route</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>default         _gateway        <span class=\"token number\">0.0</span>.0.0         UG    <span class=\"token number\">100</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> ens33</pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre>default         _gateway        <span class=\"token number\">0.0</span>.0.0         UG    <span class=\"token number\">1000</span>   <span class=\"token number\">0</span>        <span class=\"token number\">0</span> br0</pre></td></tr><tr><td data-num=\"5\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">192.168</span>.10.0    <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.0   U     <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> br0</pre></td></tr><tr><td data-num=\"6\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">192.168</span>.29.0    <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.0   U     <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> ens33</pre></td></tr><tr><td data-num=\"7\"></td><td data-command=\"\"></td><td><pre>_gateway        <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.255 UH    <span class=\"token number\">100</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> ens33</pre></td></tr><tr><td data-num=\"8\"></td><td data-command=\"[root@localhost] $\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td data-command=\"[root@localhost] $\"></td><td><pre>route <span class=\"token parameter variable\">-n</span></pre></td></tr><tr><td data-num=\"10\"></td><td data-command=\"\"></td><td><pre>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</pre></td></tr><tr><td data-num=\"11\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">192.168</span>.29.2    <span class=\"token number\">0.0</span>.0.0         UG    <span class=\"token number\">100</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> ens33</pre></td></tr><tr><td data-num=\"12\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">192.168</span>.10.1    <span class=\"token number\">0.0</span>.0.0         UG    <span class=\"token number\">1000</span>   <span class=\"token number\">0</span>        <span class=\"token number\">0</span> br0</pre></td></tr><tr><td data-num=\"13\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">192.168</span>.10.0    <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.0   U     <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> br0</pre></td></tr><tr><td data-num=\"14\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">192.168</span>.29.0    <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.0   U     <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> ens33</pre></td></tr><tr><td data-num=\"15\"></td><td data-command=\"\"></td><td><pre><span class=\"token number\">192.168</span>.29.2    <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.255 UH    <span class=\"token number\">100</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> ens33</pre></td></tr></table></figure><p>字段分类说明：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">字段</th>\n<th style=\"text-align:left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Destination</td>\n<td style=\"text-align:left\">目标网络或目标主机。Destination 为 default（ <code>0.0.0.0</code> ）时，表示这个是默认网关，所有数据都发到这个网关（这里是  <code>10.139.128.1</code> ）。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Gateway</td>\n<td style=\"text-align:left\">网关地址， <code>0.0.0.0</code>  表示当前记录对应的 Destination 跟本机在同一个网段，通信时不需要经过网关（同一个局域网内 2 台主机通信不需要经过网关）。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Genmask</td>\n<td style=\"text-align:left\">Destination 字段的网络掩码，Destination 是主机时需要设置为  <code>255.255.255.255</code>  ，是默认路由时会设置为  <code>0.0.0.0</code>  。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Flags</td>\n<td style=\"text-align:left\">见下文说明。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Metric</td>\n<td style=\"text-align:left\">跃点，指到达指定网络所需的中转数，是大型局域网和广域网设置所必需的 （不在 Linux 内核中使用）。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Ref</td>\n<td style=\"text-align:left\">路由项引用次数 （不在 Linux 内核中使用）。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Use</td>\n<td style=\"text-align:left\">此路由项被路由软件查找的次数。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Iface</td>\n<td style=\"text-align:left\">网卡名字，例如  <code>eth0</code>  ；要去往这个网段需要使用哪一个网络接口。也就是  <code>eth0</code>  这张网卡。</td>\n</tr>\n</tbody>\n</table>\n<p>可以看到 Flags 下面有许多字母组合，他们分别的含义是：</p>\n<ul>\n<li>\n<p><strong>U (route is up)</strong> ：该路由处于活跃；</p>\n</li>\n<li>\n<p><strong>H (target is a host)</strong> ：目标是一部主机 (IP) 而非网域（子网掩码是 255.255.255.255）；</p>\n</li>\n<li>\n<p><strong>G (use gateway)</strong> ：需要透过外部的主机 (gateway) 来转递封包（一般指向默认网关）；</p>\n</li>\n<li>\n<p><strong>R (reinstate route for dynamic routing)</strong> ：使用动态路由时，恢复路由资讯的旗标；</p>\n</li>\n<li>\n<p><strong>D (dynamically installed by daemon or redirect)</strong> ：已经由服务或转 port 功能设定为动态路由</p>\n</li>\n<li>\n<p><strong>M (modified from routing daemon or redirect)</strong> ：路由已经被修改了；</p>\n</li>\n<li>\n<p><strong>! (reject route)</strong> ：这个路由将不会被接受（用来抵挡不安全的网域）。</p>\n</li>\n</ul>\n<h1 id=\"路由种类\"><a class=\"anchor\" href=\"#路由种类\">#</a> 路由种类</h1>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">路由类型</th>\n<th style=\"text-align:left\">子网掩码</th>\n<th style=\"text-align:left\">Flag 字段</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">主机路由</td>\n<td style=\"text-align:left\">255.255.255.255</td>\n<td style=\"text-align:left\">UH</td>\n<td style=\"text-align:left\">指向单个 IP 地址或主机名的路由记录</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">网络路由</td>\n<td style=\"text-align:left\">255.255.255.0</td>\n<td style=\"text-align:left\">U</td>\n<td style=\"text-align:left\">代表主机可以到达的网络，比如说目的地址是  <code>192.168.10.xxx</code></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">默认路由</td>\n<td style=\"text-align:left\">0.0.0.0</td>\n<td style=\"text-align:left\">UG</td>\n<td style=\"text-align:left\">当主机不能在路由表中查找到目标主机的 IP 时，数据包就发到默认路由上</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/linux-system-constitute/",
            "url": "https://arachnid.cc/linux-system-constitute/",
            "title": "Linux 系统构成：bootloader、kernel、rootfs",
            "date_published": "2023-02-02T11:34:26.713Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>完整的 linux 系統需要以下部分：</p>\n<ul>\n<li>Bootloader\n<ul>\n<li>boot.img</li>\n</ul>\n</li>\n<li>Linux Kernel（Linux 内核）\n<ul>\n<li>Device tree blob</li>\n</ul>\n</li>\n<li>Root Filesystem（根目录文件系統）</li>\n</ul>\n<h1 id=\"bootloader\"><a class=\"anchor\" href=\"#bootloader\">#</a> bootloader</h1>\n<p>bootloader（引导装载程序）就是在操作系统内核运行之前运行的一段小程序。通过这段小程序，我们可以初始化硬件设备、建立内存空间的映射图，从而将系统的软硬件环境设置成一个合适的状态，以便为最终调用操作系统内核准备好正确的环境。</p>\n<p>常见的 bootloader 有 PC 平台的 Grub；嵌入式平台的 vivi, RedBoot, u-boot 等，其中 u-boot 在使用上最广泛，因此在嵌入式中又常称 linux 系统构成为 u-boot、kernel、rootfs。</p>\n<p>bootloader 是严重地依赖于硬件而实现的，特别是在嵌入式系统。因此，在嵌入式系统里建立一个通用的 bootloader 几乎是不可能的。尽管如此，我们仍然可以对 bootloader 归纳出一些通用的概念来，以指导用户进行特定的 bootloader 设计与实现。</p>\n<p>在嵌入式系统中，bootloader 的意义与作用相当于 PC 平台中的 BIOS + Grub，它对开发板上的主要部件如 CPU、SDRAM、FLASH、串口等进行了初始化，可以使用 bootloader 下载文件到开发板，可以浏览目录，可以烧录 flash，可以启动系统等，实际上，一个功能比较强大的 bootloader 已经相当于一个微型的操作系统了。</p>\n<p>总体上 bootloader 需要完成以下工作：</p>\n<ul>\n<li>\n<p>初始化 CPU 速度；</p>\n</li>\n<li>\n<p>初始化内存，包括初始化内存配置寄存器等；</p>\n</li>\n<li>\n<p>初始化中断控制器，在系统启动时，关闭中断，关闭看门狗；</p>\n</li>\n<li>\n<p>初始化串行端口（如果在目标上有的话）；</p>\n</li>\n<li>\n<p>启用指令 / 数据高速缓存；</p>\n</li>\n<li>\n<p>设置堆栈指针；</p>\n</li>\n<li>\n<p>设置参数区域并构造参数结构和标记（这是重要的一步，因为内核在标识根设备、页面大小、内存大小以及更多内容时可能需要使用引导参数）；</p>\n</li>\n<li>\n<p>执行 POST（加电自检）来标识存在的设备并报告有何问题；</p>\n</li>\n<li>\n<p>为电源管理提供挂起 / 恢复支持；</p>\n</li>\n<li>\n<p>传输操作系统内核镜像文件到目标机。也可以将操作系统内核镜像文件事先存放在 Flash 中，这样就不需要 bootLoader 和主机传输操作系统内核镜像文件，这通常是在做成产品的情况下使用。而一般在开发过程中，为了调试内核的方便，不将操作系统内核镜像文件固化在 Flash 中，这就需要主机和目标机进行文件传输；</p>\n</li>\n<li>\n<p>跳转到内核的开始，在此又分为 ROM 启动和 RAM 启动。所谓 ROM 启动就是用 XIP 技术直接在 Flash 中执行操作系统镜像文件；所谓 RAM 启动就是指把内核镜像从 Flash 复制到 RAM 中，然后再将 PC 指针跳转到 RAM 中的操作系统启动地址。</p>\n</li>\n</ul>\n<p>目前使用的主流<strong>嵌入式平台</strong>，几乎都是用 u-boot 作为启动引导，u-boot 有哪些突出的优点呢？</p>\n<p>① 开放源码：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3UtYm9vdC91LWJvb3QlRUYlQkMlOUI=\">https://github.com/u-boot/u-boot；</span></p>\n<p>② 支持多种嵌入式操作系统内核，如 Linux、NetBSD, VxWorks, QNX, RTEMS, ARTOS, LynxOS, android；</p>\n<p>③ 支持多个处理器系列，如 PowerPC、ARM、x86、MIPS；</p>\n<p>④ 较高的可靠性和稳定性；</p>\n<p>⑤ 高度灵活的功能设置，适合 u-boot 调试、操作系统不同引导要求、产品发布等；</p>\n<p>⑥ 丰富的设备驱动源码，如串口、以太网、SDRAM、FLASH、LCD、NVRAM、EEPROM、RTC、键盘等；</p>\n<p>⑦ 较为丰富的开发调试文档与强大的网络技术支持。</p>\n<h1 id=\"kernel\"><a class=\"anchor\" href=\"#kernel\">#</a> kernel</h1>\n<p>kernel 即 linux 内核。内核源代码可以免费从<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cua2VybmVsLm9yZy8=\">官网</span>获取，这是一个通用的内核，里面包含着内核支持的所有的硬件平台及驱动的所有代码，是一个大而全的内核源代码。</p>\n<p>在使用层面上，当嵌入式平台使用 linux 系统，那么最重要的就是 kernel 中驱动的移植；一般都不会从一个纯净的 kernel 中去进行移植操作，而是根据芯片厂商提供的 kernel 对特定的硬件平台及设备进行各种外设驱动相关的适配工作。</p>\n<h2 id=\"device-tree\"><a class=\"anchor\" href=\"#device-tree\">#</a> Device Tree</h2>\n<p>设备树（Device Tree）是描述计算机的特定硬件设备信息的数据结构，以便于操作系统的内核可以管理和使用这些硬件，包括 CPU 或 CPU，内存，总线和其他一些外设。</p>\n<p>老版本的 linux kernel 是没有设备树概念的，后来因为 SOC 的发展，kernel 中需要对这些新增的 SOC 进行支持，而这些代码都会编译到 kernel 中，会导致 kernel 日渐臃肿，于是后面就引入了在 PowerPC 等架构就已经采用的设备树。</p>\n<p><strong>1、dts (device tree source 设备树源文件)</strong><br />\n dts 文件是一种 ASCII 文本格式的设备树描述文件，此文件适合人类阅读主要是给用户看的。一个  <code>.dts</code>  文件对应一个 ARM 的设备，一般放置在  <code>arch/arm/boot/dts/</code>  中。</p>\n<p><strong>2、dtsi (device tree source include 设备树头文件)</strong><br />\n 由于  <code>.dts</code>  中包含了很多公共部分，linux 内核为了简化，将 Soc 公共部分提炼为  <code>.dtsi</code>  文件，类似 c 语言中的  <code>.h</code>  文件。当然，和 C 语言的头文件类似，.dtsi 也可以 include 其他的  <code>.dtsi</code>  ，譬如几乎所有的 ARM SoC 的  <code>.dtsi</code>  都引用了 <code>skeleton.dtsi</code>  。对于同一个节点的设置情况， <code>.dts</code>  中的配置会覆盖  <code>.dtsi</code>  中的配置；因此， <code>.dtsi</code>  一般写 Soc 共性部分，而  <code>.dts</code>  一般写目标单板特性部分，所以一般  <code>.dts</code>  包含并重写部分  <code>.dtsi</code> 。</p>\n<p><strong>3、dtb (device tree blob 设备树二进制文件)</strong><br />\n <code>.dts</code>  通过 dtc 编译工具编译成  <code>.dtb</code>  文件，被编译后的设备树文件与内核一同放入到存储介质中，当内核启动时读取设备树文件，就可以动态的将板级信息写入到内核中。</p>\n<h1 id=\"rootfs\"><a class=\"anchor\" href=\"#rootfs\">#</a> rootfs</h1>\n<p>rootfs（Root Filesystem）即根目录文件系统，是 kernel 启动后挂载的第一个文件系统。rootfs 和 kernel 是分开的，但单独的 kernel 没有 rootfs 是没法正常工作的。在系统终端执行  <code>cd /</code>  即可看到当前的文件系统内容了。</p>\n<p>现在有许多制作 rootfs 的工具，如 busybox，buildroot，Yocto 等。其中 buildroot 中包含了 busybox 的功能，只需要简单的操作就可以生成一个 rootfs 了。</p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9xMjQ4MjY5NjczLnBpeG5ldC5uZXQvYmxvZy9wb3N0LzY5NTcwMjc5\">完整的 linux 系統：bootloader、linux kernel（linux 內核）、rootfile（根文件系統）</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5lbWJlZGRlZGxpbnV4Lm9yZy5jbi9lbWJsaW51eGFwcGRldi8=\">嵌入式 linux 应用开发</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9oYWNrbWQuaW8vQGEyOTY1NDA2OC9ISjF1VVlFOHI=\">Linux 筆記 2</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNDg0MjAxMjYvd2hhdC1pcy10aGUtZGlmZmVyZW5jZS1iZXR3ZWVuLWR0cy1maWxlLWFuZC1kdHNpLWZpbGU=\">What is the difference between .dts file and .dtsi file?</span></p>\n",
            "tags": [
                "Linux",
                "arm_linux"
            ]
        },
        {
            "id": "https://arachnid.cc/linux-command-summary/",
            "url": "https://arachnid.cc/linux-command-summary/",
            "title": "Linux 命令简述总结",
            "date_published": "2022-12-31T07:40:35.772Z",
            "content_html": "<h1 id=\"系统\"><a class=\"anchor\" href=\"#系统\">#</a> 系统</h1>\n<h2 id=\"信息\"><a class=\"anchor\" href=\"#信息\">#</a> 信息</h2>\n<ul>\n<li><code>uname -m</code>  显示处理器架构</li>\n<li><code>uname -r</code>  显示正在使用的内核版本</li>\n<li><code>cat /proc/cpuinfo</code>  查看详细 CPU 信息</li>\n<li>date 显示系统日期</li>\n</ul>\n<h2 id=\"查询\"><a class=\"anchor\" href=\"#查询\">#</a> 查询</h2>\n<ul>\n<li>man 查看命令或函数的详细信息。eg： <code>man &lt;info&gt;</code></li>\n<li>which 查找命令。eg： <code>which &lt;cmd&gt;</code></li>\n<li>pwd 显示当前工作的操作路径</li>\n<li>grep 查找内容里符合条件的字符串或正则表达式</li>\n<li>du 用于显示目录或文件的大小。eg： <code>du -sh &lt;path&gt;</code></li>\n</ul>\n<h2 id=\"进程\"><a class=\"anchor\" href=\"#进程\">#</a> 进程</h2>\n<ul>\n<li>\n<p>ps 显示当前进程的状态</p>\n<ul>\n<li><code>-aux</code>  输出格式： <code>USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND</code>\n<ul>\n<li>USER: 行程拥有者</li>\n<li>PID: pid</li>\n<li>% CPU: 占用的 CPU 使用率</li>\n<li>% MEM: 占用的记忆体使用率</li>\n<li>VSZ: 占用的虚拟记忆体大小</li>\n<li>RSS: 占用的记忆体大小</li>\n<li>TTY: 终端的次要装置号码 (minor device number of tty)</li>\n<li>STAT: 该行程的状态:\n<ul>\n<li>D: 无法中断的休眠状态 (通常 IO 的进程)</li>\n<li>R: 正在执行中</li>\n<li>S: 静止状态</li>\n<li>T: 暂停执行</li>\n<li>Z: 不存在但暂时无法消除</li>\n<li>W: 没有足够的记忆体分页可分配</li>\n<li>&lt;: 高优先序的行程</li>\n<li>N: 低优先序的行程</li>\n<li>L: 有记忆体分页分配并锁在记忆体内 (实时系统或捱 A I/O)</li>\n</ul>\n</li>\n<li>START: 行程开始时间</li>\n<li>TIME: 执行的时间</li>\n<li>COMMAND: 所执行的指令</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>top 实时显示系统的整体性能信息以及正在运行的进程的相关信息</p>\n<ul>\n<li><code>-d &lt;number&gt;</code>  指定 top 命令的刷新时间间隔，单位为秒</li>\n<li><code>-n &lt;number&gt;</code>  指定 top 命令运行的次数后自动退出</li>\n<li><code>-p &lt;pid&gt;</code>  仅显示指定进程 PID 的信息</li>\n<li><code>-u &lt;user&gt;</code>  仅显示指定用户名的进程信息</li>\n</ul>\n<p><strong>整体性能信息：</strong></p>\n<ul>\n<li>\n<p>us, user：运行不需要的用户进程的时间</p>\n</li>\n<li>\n<p>sy, system：运行内核进程的时间</p>\n</li>\n<li>\n<p>ni, nice：运行 nice 用户进程的时间</p>\n</li>\n<li>\n<p>id, idle：内核空闲处理程序花费的时间</p>\n</li>\n<li>\n<p>wa, IO-wait：等待 I/O 完成的时间</p>\n</li>\n<li>\n<p>hi：用于维护硬件中断的时间</p>\n</li>\n<li>\n<p>si：用于处理软件中断的时间</p>\n</li>\n<li>\n<p>st：虚拟化环境从该虚拟机窃取的时间</p>\n</li>\n</ul>\n<p><strong>进程信息：</strong></p>\n<ul>\n<li>PID：进程的标识符。</li>\n<li>USER：运行进程的用户名。</li>\n<li>PR（优先级）：进程的优先级。</li>\n<li>NI（Nice 值）：进程的优先级调整值。</li>\n<li>VIRT（虚拟内存）：进程使用的虚拟内存大小。</li>\n<li>RES（常驻内存）：进程实际使用的物理内存大小。</li>\n<li>SHR（共享内存）：进程共享的内存大小。</li>\n<li>% CPU：进程占用 CPU 的使用率。</li>\n<li>% MEM：进程占用内存的使用率。</li>\n<li>TIME+：进程的累计 CPU 时间。</li>\n</ul>\n</li>\n<li>\n<p>kill 终止正在运行的进程。eg： <code>kill &lt;pid&gt;</code></p>\n<ul>\n<li><code>-9</code>  表示无条件退出，但由进程自行决定是否退出</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"控制\"><a class=\"anchor\" href=\"#控制\">#</a> 控制</h2>\n<ul>\n<li>halt 关闭系统</li>\n<li>reboot 重启系统</li>\n<li>poweroff 关机</li>\n</ul>\n<h1 id=\"操作目录\"><a class=\"anchor\" href=\"#操作目录\">#</a> 操作目录</h1>\n<ul>\n<li>\n<p>ls 列出目录内容</p>\n<ul>\n<li><code>-a</code>  显示所有文件和目录包括隐藏的</li>\n<li><code>-l</code>  显示详细列表</li>\n</ul>\n</li>\n<li>\n<p>cd 切换目录路径。eg： <code>cd &lt;path&gt;</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> / --<span class=\"token operator\">></span> 跳转到根目录</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">cd</span> ~ --<span class=\"token operator\">></span> 跳转到家目录</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">cd</span> <span class=\"token punctuation\">..</span> --<span class=\"token operator\">></span> 跳转到上级目录</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">cd</span> ./home --<span class=\"token operator\">></span> 跳转到当前目录的 home 目录下</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /home --<span class=\"token operator\">></span> 跳转到根目录下的 home 目录下</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">cd</span> --<span class=\"token operator\">></span> 不添加任何参数，也是回到家目录</pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"操作文件文件夹\"><a class=\"anchor\" href=\"#操作文件文件夹\">#</a> 操作文件 / 文件夹</h1>\n<h2 id=\"浏览\"><a class=\"anchor\" href=\"#浏览\">#</a> 浏览</h2>\n<ul>\n<li>\n<p>cat 一次性显示文件所有内容，更适合查看小的文件。eg： <code>cat &lt;file&gt;</code></p>\n<ul>\n<li><code>-n</code>  显示行号</li>\n</ul>\n</li>\n<li>\n<p>less 分页显示文件内容，更适合查看大的文件。eg： <code>less &lt;file&gt;</code></p>\n</li>\n<li>\n<p>head 显示文件的开头几行（默认是 10 行）。eg： <code>head &lt;file&gt;</code></p>\n</li>\n<li>\n<p>tail 显示文件的结尾几行（默认是 10 行）。eg： <code>tail &lt;file&gt;</code></p>\n</li>\n</ul>\n<h2 id=\"更改\"><a class=\"anchor\" href=\"#更改\">#</a> 更改</h2>\n<ul>\n<li>touch 创建文件。eg： <code>touch &lt;name&gt;</code></li>\n<li>mkdir 创建文件夹。eg： <code>mkdir &lt;name&gt;</code>\n<ul>\n<li><code>-m</code>  配置文件权限，无视默认权限（umask）</li>\n<li><code>-p</code>  递归创建所需目录，无论是否有上一级目录路径</li>\n</ul>\n</li>\n<li>cp 拷贝文件 / 文件夹。eg： <code>cp &lt;source&gt; &lt;dest&gt;</code>\n<ul>\n<li><code>-r</code>  递归复制文件夹及其子文件</li>\n<li><code>-i</code>  在复制前提示确认，如果目标文件已存在，则会询问是否覆盖</li>\n<li><code>-p</code>  保留源文件的权限、所有者和时间戳信息</li>\n<li><code>-f</code>  强制复制，即使目标文件已存在也会覆盖，而且不给出提示</li>\n</ul>\n</li>\n<li>mv 移动文件 / 文件夹。eg： <code>mv -v &lt;source&gt; &lt;dest&gt;</code></li>\n<li>rm 删除文件。eg： <code>rm &lt;name&gt;</code>\n<ul>\n<li><code>-r</code>  递归删除文件夹文件夹及其子文件</li>\n<li><code>-i</code>  向用户确认是否删除</li>\n<li><code>-f</code>  强制删除，不给出提示</li>\n</ul>\n</li>\n<li>ln 创建链接（硬链接 or 软链接）。硬链接：等同于复制多一个文件，但共享同一块数据内容（即修改任何一个文件，修改的都是同一块内容）；软链接：类似  <code>windows</code>  平台下的快捷方式， <code>ln</code>  出来的文件指向源文件，当源文件丢失，将会变成死链接。。eg： <code>ln &lt;source&gt; &lt;dest&gt;</code>\n<ul>\n<li><code>-sv</code>  创建软链接，并显示处理过程</li>\n<li>软链接删除使用  <code>rm -rf</code>  命令操作，跟正常的删除命令一样</li>\n<li><code>-snf</code>  修改指向新的源地址</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"压缩\"><a class=\"anchor\" href=\"#压缩\">#</a> 压缩</h1>\n<ul>\n<li>tar 压缩\n<ul>\n<li><code>-v</code>  表示详细输出，列出被解压的文件</li>\n<li><code>-f</code>  指定文件的名称</li>\n<li><code>-c</code>  表示创建新的归档文件</li>\n<li><code>-x</code>  表示解压操作</li>\n<li><code>-r</code>  向已存在的归档中追加文件</li>\n<li><code>-t</code>  列出归档文件中的内容</li>\n<li><code>-z</code>  表示使用 gzip 压缩程序，得到  <code>.tar.gz</code>  后缀</li>\n<li><code>-j</code>  表示使用 bzip2 压缩程序，得到  <code>.tar.bz2</code>  后缀</li>\n<li><code>-J</code>  表示使用 xz 压缩程序，得到  <code>.tar.xz</code>  后缀</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"文件夹压缩\"><a class=\"anchor\" href=\"#文件夹压缩\">#</a> 文件夹压缩</h2>\n<table>\n<thead>\n<tr>\n<th>格式</th>\n<th>压缩</th>\n<th>显示</th>\n<th>解压</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>.tar.gz</td>\n<td><code>tar -zcvf xxx.tar.gz &lt;folder&gt;</code></td>\n<td><code>tar -tvf xxx.tar.gz</code></td>\n<td><code>tar -zxvf xxx.tar.gz</code></td>\n</tr>\n<tr>\n<td>.tar.xz</td>\n<td><code>tar -Jcvf xxx.tar.xz &lt;folder&gt;</code></td>\n<td><code>tar -tvf xxx.tar.xz</code></td>\n<td><code>tar -Jxvf xxx.tar.xz</code></td>\n</tr>\n<tr>\n<td>.tar.bz2</td>\n<td><code>tar -jcvf xxx.tar.bz2 &lt;folder&gt;</code></td>\n<td><code>tar -tvf xxx.tar.bz2</code></td>\n<td><code>tar -jxvf xxx.tar.bz2</code></td>\n</tr>\n<tr>\n<td>.zip</td>\n<td><code>zip xxx.zip &lt;folder&gt;</code></td>\n<td><code>zip -sf xxx.zip</code></td>\n<td><code>unzip xxx.zip</code></td>\n</tr>\n<tr>\n<td>.rar</td>\n<td><code>rar -a xxx.rar &lt;folder&gt;</code></td>\n<td><code>rar -v xxx.rar</code></td>\n<td><code>unrar -x xxx.rar</code></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"文件压缩\"><a class=\"anchor\" href=\"#文件压缩\">#</a> 文件压缩</h2>\n<table>\n<thead>\n<tr>\n<th>格式</th>\n<th>压缩</th>\n<th>显示</th>\n<th>解压</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>.Z</td>\n<td><code>compress &lt;file&gt;</code></td>\n<td>无</td>\n<td><code>uncompress xxx.Z</code></td>\n</tr>\n<tr>\n<td>.bz2</td>\n<td><code>bzip2 -z &lt;file&gt;</code></td>\n<td>无</td>\n<td><code>bzip2 -d xxx.bz2</code></td>\n</tr>\n<tr>\n<td>.gz</td>\n<td><code>gzip &lt;file&gt;</code></td>\n<td>无</td>\n<td><code>gzip -d xxx.gz</code></td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"用户和群组\"><a class=\"anchor\" href=\"#用户和群组\">#</a> 用户和群组</h1>\n<h2 id=\"用户\"><a class=\"anchor\" href=\"#用户\">#</a> 用户</h2>\n<ul>\n<li>\n<p>sudo 以  <code>root</code>  身份运行命令，使用当前用户密码解锁</p>\n<p>一般来说， <code>sudo</code>  命令用来临时提升权限并运行单行命令，但也有几个特殊的命令切换至超级管理员权限：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-s</span> <span class=\"token comment\"># 使用当前用户的环境变量，不跳转目录，拥有超级管理员权限</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-i</span> <span class=\"token comment\"># 使用 root 用户的环境变量，跳转到 /root，拥有超级管理员权限</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">su</span> <span class=\"token comment\"># 使用 root 用户的环境变量，不跳转目录，拥有超级管理员权限</span></pre></td></tr></table></figure></li>\n<li>\n<p>su 切换用户，需要  <code>root</code>  用户权限，使用 root 用户密码解锁</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">su</span> <span class=\"token operator\">&lt;</span>user<span class=\"token operator\">></span> <span class=\"token comment\"># 切换 &lt;user> 后，不改变原用户的工作目录，及其他环境变量目录</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">su</span> - <span class=\"token operator\">&lt;</span>user<span class=\"token operator\">></span> <span class=\"token comment\"># 切换 &lt;user> 后，同时切换到新用户的工作环境中</span></pre></td></tr></table></figure><p>note：当  <code>&lt;user&gt;</code>  缺省时，切换成 root 身份。</p>\n</li>\n<li>\n<p><code>sudo</code>  VS  <code>su</code>  拥有超级管理员权限</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>sudo</th>\n<th>su</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>密码</td>\n<td>需要输入当前用户的密码</td>\n<td>需要输入 root 用户的密码</td>\n</tr>\n<tr>\n<td>行为</td>\n<td>临时使用超管权限运行单行命令</td>\n<td>允许多条命令以超管权限运行，直至退出登录</td>\n</tr>\n<tr>\n<td>记录</td>\n<td>执行的操作都会被记录下</td>\n<td>无法直接跟踪记录执行了什么操作</td>\n</tr>\n</tbody>\n</table>\n<p>note：</p>\n<p>大概是因为使用  <code>su</code>  命令或直接以 root 用户身份登录有风险，所以，一些 Linux 发行版（如 Ubuntu）默认禁用 root 用户帐户。鼓励用户在需要 root 权限时使用  <code>sudo</code>  命令。如果你想在系统中启用 root 用户帐户（强烈反对，因为你可以使用  <code>sudo</code>  命令或  <code>sudo su</code>  命令），你必须手动设置 root 用户密码，可以使用命令： <code>sudo passwd root</code>  。</p>\n</li>\n<li>\n<p>useradd 添加新用户。eg： <code>useradd &lt;user&gt;</code></p>\n</li>\n<li>\n<p>passwd 修改用户密码。eg：  <code>passwd &lt;user&gt;</code></p>\n<ul>\n<li><code>-d</code>  删除 user 帐号的密码</li>\n<li><code>-l</code>  禁用锁定 user 帐号</li>\n<li><code>-u</code>  解锁启用 user 帐号</li>\n<li><code>-S</code>  显示 user 帐号密码信息</li>\n</ul>\n</li>\n<li>\n<p>userdel 删除用户。eg： <code>userdel &lt;user&gt;</code></p>\n</li>\n<li>\n<p><code>cat /etc/passwd</code>  列出 linux 上的所有用户。eg：可以用  <code> cat /etc/passwd | cut -d: -f 1,3,7</code>  指定输出 1，3，7 项信息</p>\n<ul>\n<li>\n<p>第一项：对应的用户名</p>\n</li>\n<li>\n<p>第二项：加密密码（  <code>x</code>  代表已存储密码）</p>\n</li>\n<li>\n<p>第三项：用户 ID 号 (UID)</p>\n</li>\n<li>\n<p>第四项：用户的组 ID 号 (GID)</p>\n</li>\n<li>\n<p>第五项：全名</p>\n</li>\n<li>\n<p>第六项：用户的主目录</p>\n</li>\n<li>\n<p>第七项：用户的登录 shell（默认为 bash shell）</p>\n</li>\n</ul>\n<p>note：该列表显示的用户比您预期的要多得多，因为它还列出了所有系统用户，现在如果你想区分普通用户和系统用户，你可以参考用户标识符（UID）号。</p>\n<p>一般来说，普通用户的 UID 大于或等于 1000，这会提示您 UID&gt;=1000 的用户是普通用户，UID &lt; 1000 的用户是系统用户（具体看  <code>/etc/login.defs</code>  文件配置）；您还会注意到，一些用户的最后一项使用 “nologin shell”，这意味着这些用户无法登录系统，这些用户也称为伪用户。</p>\n</li>\n</ul>\n<h2 id=\"群组\"><a class=\"anchor\" href=\"#群组\">#</a> 群组</h2>\n<ul>\n<li>groupadd 创建群组（默认为普通组）。eg： <code>groupadd &lt;group&gt;</code>\n<ul>\n<li><code>-g &lt;GID&gt;</code>  指定新群组的标识号（GID）</li>\n<li><code>-o</code>  表示新群组的 GID 可以与系统已有群组的 GID 相同</li>\n<li><code>-r</code>  创建的为系统组</li>\n</ul>\n</li>\n<li>groupdel 删除一个已存在的群组。eg： <code>groupdel &lt;group&gt;</code></li>\n<li>groups 查看某个用户属于哪些组。eg：  <code>groups &lt;user&gt;</code></li>\n<li><code>getent group</code>  列出 linux 上的所有组</li>\n<li><code>usermod -a -G &lt;group&gt; &lt;user&gt;</code>  将 user 用户追加到 group 组中</li>\n<li><code>gpasswd -d &lt;user&gt; &lt;group&gt;</code>  将 user 用户从 group 组中移除</li>\n</ul>\n<h2 id=\"权限\"><a class=\"anchor\" href=\"#权限\">#</a> 权限</h2>\n<p>Linux 下权限的属组有 <strong>拥有者 、群组 、其它组</strong> 三种，权限类型一般包括读，写，执行。对应字母为 r、w、x。</p>\n<ul>\n<li>\n<p>id 查看所属权限</p>\n</li>\n<li>\n<p>chmod 改变文件 / 文件夹权限</p>\n<ul>\n<li>\n<p><code>-R</code>  递归应用权限</p>\n</li>\n<li>\n<p>十位权限设定表示：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rwx = 111 = 7</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rw- = 110 = 6</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>r-x = 101 = 5</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>r-- = 100 = 4</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>-wx = 011 = 3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>-w- = 010 = 2</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>--x = 001 = 1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>--- = 000 = 0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>常见的权限表示形式有：</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>-rw------- (600)    只有拥有者有读写权限。</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>-rw-r--r-- (644)    只有拥有者有读写权限；所属组用户和其他用户只有读权限。</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>-rwx------ (700)    只有拥有者有读、写、执行权限。</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>-rwxr-xr-x (755)    拥有者有读、写、执行权限；所属组用户和其他用户只有读、执行权限。</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>-rwx--x--x (711)    拥有者有读、写、执行权限；所属组用户和其他用户只有执行权限。</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>-rw-rw-rw- (666)    所有用户都有文件读、写权限。</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>-rwxrwxrwx (777)    所有用户都有读、写、执行权限。</pre></td></tr></table></figure></li>\n<li>\n<p>字串权限设定表示：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[ugoa...][[+-=][rwxX]...]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>u：用户权限</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>g：组用户权限</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>o：其他用户权限</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>chmod ugo+r    所有用户追加读权限</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>chmod u+rw     拥有者追加读、写权限</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>chmod g+rx     所属组用户追加读、执行权限</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>chmod o-rwx    其他用户无读、写、执行权限</pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h1 id=\"磁盘\"><a class=\"anchor\" href=\"#磁盘\">#</a> 磁盘</h1>\n<ul>\n<li>df -h 参看文件系统容量及挂载情况</li>\n<li>lsblk 查看磁盘挂载情况</li>\n<li>fdisk 交互式磁盘分区\n<ul>\n<li><code>-l</code>  查看分区表参数</li>\n<li><code>/dev/sdx</code>\n<ul>\n<li><code>m</code>  查看命令操作\n<ul>\n<li><code>d</code>  删除已有分区</li>\n<li><code>n</code>  创建新的分区</li>\n<li><code>p</code>  查看创建分区</li>\n<li><code>w</code>  应用分区信息</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>sfdisk 命令式磁盘分区\n<ul>\n<li><code>-T</code>  查看分区类型码</li>\n</ul>\n</li>\n<li>mount 挂载磁盘</li>\n<li>umount 取消挂载</li>\n<li>blkid 查看 disk 设备名</li>\n</ul>\n<h1 id=\"数据\"><a class=\"anchor\" href=\"#数据\">#</a> 数据</h1>\n<ul>\n<li>\n<p>dd 数据转换</p>\n<p>通用语法：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">dd</span> <span class=\"token assign-left variable\">if</span><span class=\"token operator\">=</span>path/to/input_file <span class=\"token assign-left variable\">of</span><span class=\"token operator\">=</span>/path/to/output_file <span class=\"token assign-left variable\">bs</span><span class=\"token operator\">=</span>block_size <span class=\"token assign-left variable\">count</span><span class=\"token operator\">=</span>number_of_blocks</pre></td></tr></table></figure><p>命令简介：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>if=file 　　　　　　　　　　　　　　　　输入文件名，缺省为标准输入。 </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>of=file 　　　　　　　　　　　　　　　　输出文件名，缺省为标准输出。 </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ibs=bytes 　　　　　　　　　　　　　　　一次读入 bytes 个字节(即一个块大小为 bytes 个字节)。 </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>obs=bytes 　　　　　　　　　　　　　　　一次写 bytes 个字节(即一个块大小为 bytes 个字节)。 </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>bs=bytes 　　　　　　　　　　　　　　　 同时设置读写块的大小为 bytes ，可代替 ibs 和 obs 。 </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>cbs=bytes 　　　　　　　　　　　　　　　一次转换 bytes 个字节，即转换缓冲区大小。 </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>skip=blocks 　　　　　　　　　　　　　 从输入文件开头跳过 blocks 个块后再开始复制。 </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>seek=blocks      　　　　　　　　　　 从输出文件开头跳过 blocks 个块后再开始复制。(通常只有当输出文件是磁盘或磁带时才有效)。 </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>count=blocks 　　　　　　　　　　　　　仅拷贝 blocks 个块，块大小等于 ibs 指定的字节数。 </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>conv=conversion[,conversion...]    用指定的参数转换文件。</pre></td></tr></table></figure><ul>\n<li>\n<p>conv 符号参数：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ascii 　　　　　　　　　　　　　　　　　转换 EBCDIC 为 ASCII。 </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ebcdic 　　　　　　　　　　　　     　 转换 ASCII 为 EBCDIC。 </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ibm 　　　　　　　　　　　　　　　　　　转换 ASCII 为 alternate EBCDIC. </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>block 　　　　　　　　　　　　　　　　 把每一行转换为长度为 cbs 的记录，不足部分用空格填充。 </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>unblock 　　　　　　　　　　　　　　　 使每一行的长度都为 cbs ，不足部分用空格填充。 </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>lcase 　　　　　　　　　　　　　　　　 把大写字符转换为小写字符。 </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ucase 　　　　　　　　　　　　　　　　 把小写字符转换为大写字符。 </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>swab 　　　　　　　　　　　　　　　　  交换输入的每对字节。 </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>noerror 　　　　　　　　　　　　　　　 出错时不停止。 </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>notrunc 　　　　　　　　　　　　　　　 不截短输出文件。</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>sync 　　　　　　　　　　　　　　　　　 把每个输入块填充到ibs个字节，不足部分用空(NUL)字符补齐。</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>fsync 　　　　　　　　　　　　　　　　 在完成之前同步输出数据和元数据，这强制对输出数据和元数据进行物理写入。</pre></td></tr></table></figure></li>\n</ul>\n<pre><code>\n</code></pre>\n</li>\n<li>\n<p><code>/dev/zero</code>  和  <code>/dev/null</code></p>\n<ul>\n<li>\n<p><code>/dev/zero</code>  （产生字符）不产生 IO，主要的用处是用来创建一个指定长度用于初始化的空文件，向设备或文件无穷尽地写入空字符流；</p>\n</li>\n<li>\n<p><code>/dev/null</code>  （回收站、无底洞）不产生 IO，你可以向它输出任何数据，它通吃，并且不会撑着！</p>\n</li>\n<li>\n<p><code>conv=fsync</code>  用途：一些设备使用缓冲区和缓存来提高吞吐量和延迟性能。此命令使设备刷新其缓冲区和缓存，以便如果删除设备，则在操作标记为完成之前将数据写入设备，并将控制传递回终端提示。</p>\n</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"补丁\"><a class=\"anchor\" href=\"#补丁\">#</a> 补丁</h1>\n<p>补丁操作一般为已有文件的修改操作，通过新旧文件对比进行修改，对于新文件的增删，目前是无法通过该操作来进行的。</p>\n<p><strong>1、补丁生成</strong></p>\n<p>补丁文件是通过  <code>diff</code>  命令生成的，生成补丁文件的命令使用格式如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">diff</span> <span class=\"token parameter variable\">-uNr</span> <span class=\"token operator\">&lt;</span>src<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>modify<span class=\"token operator\">></span> <span class=\"token operator\">></span> xxx.patch</pre></td></tr></table></figure><ul>\n<li>src：源文件（目录），未进行修改的。</li>\n<li>modify：基于 src，根据需求对里面的文件内容修改之后结果。</li>\n</ul>\n<p>命令选项：</p>\n<ul>\n<li><code>-u</code>  选项以统一格式创建补丁文件，这种格式比缺省格式更紧凑些</li>\n<li><code>-N</code>  选项确保补丁文件将正确地处理已经创建和删除文件的情况</li>\n<li><code>-r</code>  递归选项，设置了这个选项，diff 会将两个不同版本源代码目录中的所有对应文件全部都进行一次比较，包括子目录文件</li>\n</ul>\n<p>&quot;&gt;&quot; 是重定向符号，表示将 diff 比较的结果重定向输入到  <code>xxx.patch</code>  文件中（如不指定重定向，diff 的结果将打印到标准输出），  <code>xxx.patch</code>  文件一般指定以  <code>.patch</code>  为后缀。</p>\n<p>上述的补丁命令的功能就是逐个比较源文件（夹）和目标文件（夹）的所有文件，将差异信息记录到  <code>xxx.patch</code>  中，  <code>xxx.patch</code>  文件也就是我们所谓的补丁文件。</p>\n<p><strong>2、打补丁</strong></p>\n<p>有了补丁文件那么就可以来进行打补丁操作了，打补丁是通过 patch 命令完成的。一般情况下，打补丁命令使用格式如下（这里只介绍了对源文件 / 文件夹进行打补丁操作）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>patch <span class=\"token parameter variable\">-pN</span> <span class=\"token operator\">&lt;</span> xxx.patch</pre></td></tr></table></figure><p><code>xxx.patch</code>  文件是上面 diff 命令生成的补丁文件，打补丁就是 patch 利用 diff 制作的补丁来实现源文件（夹）和目的文件（夹）的转换。这样说就意味着你可以从源文件 / 文件夹到目的文件 / 文件夹，也可以目的文件 / 文件夹到源文件 / 文件夹。一般情况下，我们都是将源文件 / 文件夹打补丁到我们修改后的目的文件 / 文件夹。</p>\n<p>命令选项：</p>\n<ul>\n<li><code>-pN</code>  选项打补丁时要忽略掉第 N 层目录。</li>\n</ul>\n<h1 id=\"驱动模块加载\"><a class=\"anchor\" href=\"#驱动模块加载\">#</a> 驱动模块加载</h1>\n<ul>\n<li>lsmod 查看已加载模块</li>\n<li>insmod 动态加载模块</li>\n<li>rmmod 卸载模块</li>\n</ul>\n<h1 id=\"网络\"><a class=\"anchor\" href=\"#网络\">#</a> 网络</h1>\n<ul>\n<li>ping 测试网络。eg： <code>ping &lt;ip/host&gt;</code></li>\n</ul>\n<p>其它具体网络配置使用命令，根据不同的网络工具，所使用的命令不一样，可以参考：</p>\n<p><a href=\"https://arachnid.cc/net-tools-vs-proute2/\">Linux 网络管理套件</a></p>\n<p><a href=\"https://arachnid.cc/linux-routing-table/\">Linux 路由表说明</a></p>\n<p><a href=\"https://arachnid.cc/linux-network-config-tool/\">Linux 网络一探究竟</a></p>\n<h1 id=\"other\"><a class=\"anchor\" href=\"#other\">#</a> other</h1>\n<ul>\n<li>\n<p>lsusb -tv 显示 USB 设备</p>\n</li>\n<li>\n<p>clear 清屏</p>\n</li>\n<li>\n<p>ftpget /ftpput 文件传输的 get 及 put 操作。eg：</p>\n<p><code>ftpget -u &lt;username&gt; -p &lt;password&gt; [server ip] &lt;source file&gt; &lt;target file&gt;</code></p>\n<p><code>ftpput  -u &lt;username&gt; -p &lt;password&gt; [server ip] &lt;target file&gt; &lt;source file&gt;</code></p>\n<ul>\n<li><code>-u</code>  指定登录名称</li>\n<li><code>-p</code>  输入登录密码</li>\n</ul>\n</li>\n</ul>\n<p>通过 APT（高级软件包工具）在基于 Debian 的 Linux 系统上进行管理</p>\n<ol>\n<li>从存储库安装软件包： <code>sudo apt install package-name</code></li>\n<li>删除已安装的软件包： <code>sudo apt purge package-name</code></li>\n<li>查看系统当前配置使用哪些存储库： <code>cat /etc/apt/sources.list</code></li>\n<li>更新存储库的软件包： <code>sudo apt update</code></li>\n<li>处理依赖： <code>sudo apt install -f</code>  or 用  <code>aptitude</code>  来代替  <code>apt</code></li>\n<li>获取已安装软件包： <code>sudo apt list --installed</code>  or  <code>sudo dpkg -l</code></li>\n</ol>\n<ul>\n<li><strong>sudo add-apt-repository</strong> 添加新存储库\n<ul>\n<li>添加 PPA 源文件： <code>sudo add-apt-repository ppa:xxx</code></li>\n<li>删除 PPA 源文件： <code>sudo add-apt-repository -r ppa:xxx</code></li>\n</ul>\n</li>\n</ul>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/ubuntu-tftp-nfs-create/",
            "url": "https://arachnid.cc/ubuntu-tftp-nfs-create/",
            "title": "Ubuntu 搭建 tftp 及 NFS 服务",
            "date_published": "2022-12-13T14:56:07.000Z",
            "content_html": "<blockquote>\n<p>平台：Ubuntu 18.04.6</p>\n</blockquote>\n<h1 id=\"tftp-服务端搭建\"><a class=\"anchor\" href=\"#tftp-服务端搭建\">#</a> tftp 服务端搭建</h1>\n<h2 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> tftpd-hpa</pre></td></tr></table></figure><h2 id=\"配置\"><a class=\"anchor\" href=\"#配置\">#</a> 配置</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> /home/user/tftp_share</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> <span class=\"token parameter variable\">-R</span> <span class=\"token number\">777</span> /home/user/tftp_share</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[user@localhost] #\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/default/tftpd-hpa</pre></td></tr></table></figure><p>更改  <code>TFTP_DIRECTORY</code>  字段，填写配置 tftp 服务共享的路径，eg：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>TFTP_USERNAME=\"tftp\"</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>TFTP_DIRECTORY=\"/home/user/tftp_share\"</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>TFTP_ADDRESS=\":69\"</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>TFTP_OPTIONS=\"-l -c -s\"</pre></td></tr></table></figure><h2 id=\"启动服务\"><a class=\"anchor\" href=\"#启动服务\">#</a> 启动服务</h2>\n<p>在加载完后，重启服务器：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> systemctl restart tftpd-hpa</pre></td></tr></table></figure><p>查看服务启动状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> systemctl status tftpd-hpa</pre></td></tr></table></figure><h2 id=\"测试传输\"><a class=\"anchor\" href=\"#测试传输\">#</a> 测试传输</h2>\n<p>如果本机没有安装 tftp 客户端，可以使用以下命令安装：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> tftp-hpa</pre></td></tr></table></figure><p>然后连接 tftp 服务器，通过 get 和 put 读写文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre>tftp <span class=\"token number\">127.0</span>.0.1 <span class=\"token comment\">#连接服务器</span></pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre><span class=\"token operator\">></span> get a.txt <span class=\"token comment\"># 获取 a.txt</span></pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre><span class=\"token operator\">></span> put b.txt <span class=\"token comment\"># 上传 b.txt</span></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"\"></td><td><pre><span class=\"token operator\">></span> q <span class=\"token comment\"># 断开连接</span></pre></td></tr></table></figure><h1 id=\"nfs-服务端搭建\"><a class=\"anchor\" href=\"#nfs-服务端搭建\">#</a> NFS 服务端搭建</h1>\n<h2 id=\"安装-2\"><a class=\"anchor\" href=\"#安装-2\">#</a> 安装</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> nfs-kernel-server</pre></td></tr></table></figure><h2 id=\"配置-2\"><a class=\"anchor\" href=\"#配置-2\">#</a> 配置</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> /home/user/nfs_share</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> <span class=\"token parameter variable\">-R</span> <span class=\"token number\">777</span> /home/user/nfs_share</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"[user@localhost] #\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/exports</pre></td></tr></table></figure><p>在最后一行添加自己的共享路径，如：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/home/user/nfs_share *(rw,sync,no_root_squash,no_subtree_check)</pre></td></tr></table></figure><p><strong>note：</strong></p>\n<p><code>/home/nfs_share</code>  是 NFS 服务端的共享路径。</p>\n<p><code>*</code>  表示所有网段都可以访问（可以指定具体的 ip ）。</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>ro</code></td>\n<td>只读访问</td>\n</tr>\n<tr>\n<td><code>rw</code></td>\n<td>读写访问</td>\n</tr>\n<tr>\n<td><code>sync</code></td>\n<td>所有数据在请求时写入共享</td>\n</tr>\n<tr>\n<td><code>async</code></td>\n<td>nfs 在写入数据前可以响应请求</td>\n</tr>\n<tr>\n<td><code>secure</code></td>\n<td>nfs 通过 1024 以下的安全 TCP/IP 端口发送</td>\n</tr>\n<tr>\n<td><code>insecure</code></td>\n<td>nfs 通过 1024 以上的端口发送</td>\n</tr>\n<tr>\n<td><code>wdelay</code></td>\n<td>如果多个用户要写入 nfs 目录，则归组写入（默认）</td>\n</tr>\n<tr>\n<td><code>no_wdelay</code></td>\n<td>如果多个用户要写入 nfs 目录，则立即写入，当使用 async 时，无需此设置</td>\n</tr>\n<tr>\n<td><code>hide</code></td>\n<td>在 nfs 共享目录中不共享其子目录</td>\n</tr>\n<tr>\n<td><code>no_hide</code></td>\n<td>共享 nfs 目录的子目录</td>\n</tr>\n<tr>\n<td><code>subtree_check</code></td>\n<td>如果共享 /usr/bin 之类的子目录时，强制 nfs 检查父目录的权限（默认）</td>\n</tr>\n<tr>\n<td><code>no_subtree_check</code></td>\n<td>不检查父目录权限</td>\n</tr>\n<tr>\n<td><code>all_squash</code></td>\n<td>共享文件的 UID 和 GID 映射匿名用户 anonymous，适合公用目录</td>\n</tr>\n<tr>\n<td><code>no_all_squash</code></td>\n<td>保留共享文件的 UID 和 GID（默认）</td>\n</tr>\n<tr>\n<td><code>root_squash</code></td>\n<td>root 用户的所有请求映射成如 anonymous 用户一样的权限（默认）</td>\n</tr>\n<tr>\n<td><code>no_root_squash</code></td>\n<td>root 用户具有根目录的完全管理访问权限</td>\n</tr>\n<tr>\n<td><code>anonuid=xxx</code></td>\n<td>指定 nfs 服务器 /etc/passwd 文件中匿名用户的 UID</td>\n</tr>\n<tr>\n<td><code>anongid=xxx</code></td>\n<td>指定 nfs 服务器 /etc/passwd 文件中匿名用户的 GID</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"启动服务-2\"><a class=\"anchor\" href=\"#启动服务-2\">#</a> 启动服务</h2>\n<p>在加载完后，重启服务器：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> systemctl restart nfs-kernel-server</pre></td></tr></table></figure><p>查看服务启动状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> systemctl status nfs-kernel-server</pre></td></tr></table></figure><h2 id=\"测试挂载\"><a class=\"anchor\" href=\"#测试挂载\">#</a> 测试挂载</h2>\n<p>如果本机没有安装 NFS 客户端，可以使用以下命令安装：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> nfs-common</pre></td></tr></table></figure><p>然后执行本地挂载测试：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mount</span> <span class=\"token parameter variable\">-t</span> nfs <span class=\"token parameter variable\">-o</span> nolock localhost:/home/user/nfs_share /mnt</pre></td></tr></table></figure><h2 id=\"添加对-version-2-的支持\"><a class=\"anchor\" href=\"#添加对-version-2-的支持\">#</a> 添加对 version 2 的支持</h2>\n<p>使用如下命令查看对 NFS 版本的支持：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">cat</span> /proc/fs/nfsd/versions</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"\"></td><td><pre><span class=\"token parameter variable\">-2</span> +3 +4 +4.1 +4.2</pre></td></tr></table></figure><p>可以看出来  <code>-2</code>  说明目前是对 NFS 的 version 2 并不支持的，因此需要稍作修改才可完成兼容工作：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/default/nfs-kernel-server</pre></td></tr></table></figure><p>通过修改  <code>RPCNFSDCOUNT</code>  、 <code>RPCMOUNTDOPTS</code>  、 <code>RPCSVCGSSDOPTS</code>  的字段得到：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># Number of servers to start up</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>RPCNFSDCOUNT=\"-V 2 8\"</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre># Runtime priority of server (see nice(1))</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>RPCNFSDPRIORITY=0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre># Options for rpc.mountd.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre># If you have a port-based firewall, you might want to set up</pre></td></tr><tr><td data-num=\"9\"></td><td><pre># a fixed port here using the --port option. For more information, </pre></td></tr><tr><td data-num=\"10\"></td><td><pre># see rpc.mountd(8) or http://wiki.debian.org/SecuringNFS</pre></td></tr><tr><td data-num=\"11\"></td><td><pre># To disable NFSv4 on the server, specify '--no-nfs-version 4' here</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>RPCMOUNTDOPTS=\"-V 2 --manage-gids\"</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre># Do you want to start the svcgssd daemon? It is only required for Kerberos</pre></td></tr><tr><td data-num=\"15\"></td><td><pre># exports. Valid alternatives are \"yes\" and \"no\"; the default is \"no\".</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>NEED_SVCGSSD=\"\"</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre># Options for rpc.svcgssd.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>RPCSVCGSSDOPTS=\"--nfs-version 2,3,4 --debug --syslog\"</pre></td></tr></table></figure><p>然后重启一下服务，再次查看版本支持：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> systemctl restart nfs-kernel-server</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">cat</span> /proc/fs/nfsd/versions</pre></td></tr><tr><td data-num=\"3\"></td><td data-command=\"\"></td><td><pre>+2 +3 +4 +4.1 +4.2</pre></td></tr></table></figure>",
            "tags": [
                "history",
                "Ubuntu",
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/ubuntu-ftp-create/",
            "url": "https://arachnid.cc/ubuntu-ftp-create/",
            "title": "Ubuntu 下 FTP 的搭建配置",
            "date_published": "2022-11-03T13:13:57.653Z",
            "content_html": "<blockquote>\n<p>平台：Ubuntu 18.04.6</p>\n<p>vsftpd 官网：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zZWN1cml0eS5hcHBzcG90LmNvbS92c2Z0cGQuaHRtbA==\">https://security.appspot.com/vsftpd.html</span></p>\n</blockquote>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<p>安装 FTP 服务，命令行输入：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> vsftpd</pre></td></tr></table></figure><h1 id=\"配置\"><a class=\"anchor\" href=\"#配置\">#</a> 配置</h1>\n<p>先备份配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> /etc/vsftpd.conf /etc/vsftpd.conf.back</pre></td></tr></table></figure><p>vim 进入编辑信息：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/vsftpd.conf</pre></td></tr></table></figure><p>然后增加或修改以下信息：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># Example config file /etc/vsftpd.conf</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>#</pre></td></tr><tr><td data-num=\"3\"></td><td><pre># The default compiled in settings are fairly paranoid. This sample file</pre></td></tr><tr><td data-num=\"4\"></td><td><pre># loosens things up a bit, to make the ftp daemon more usable.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre># Please see vsftpd.conf.5 for all compiled in defaults.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>#</pre></td></tr><tr><td data-num=\"7\"></td><td><pre># READ THIS: This example file is NOT an exhaustive list of vsftpd options.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre># Please read the vsftpd.conf.5 manual page to get a full idea of vsftpd's</pre></td></tr><tr><td data-num=\"9\"></td><td><pre># capabilities.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>#</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>#</pre></td></tr><tr><td data-num=\"12\"></td><td><pre># Run standalone?  vsftpd can run either from an inetd or as a standalone</pre></td></tr><tr><td data-num=\"13\"></td><td><pre># daemon started from an initscript.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>listen=NO #是否开启侦听状态</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre># This directive enables listening on IPv6 sockets. By default, listening</pre></td></tr><tr><td data-num=\"17\"></td><td><pre># on the IPv6 \"any\" address (::) will accept connections from both IPv6</pre></td></tr><tr><td data-num=\"18\"></td><td><pre># and IPv4 clients. It is not necessary to listen on *both* IPv4 and IPv6</pre></td></tr><tr><td data-num=\"19\"></td><td><pre># sockets. If you want that (perhaps because you want to listen on specific</pre></td></tr><tr><td data-num=\"20\"></td><td><pre># addresses) then you must run two copies of vsftpd with two configuration</pre></td></tr><tr><td data-num=\"21\"></td><td><pre># files.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>listen_ipv6=YES #如果能使用 ipv6的可以打开使用；只能用 ipv4的必须注释掉，不然重启不了</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre># Allow anonymous FTP? (Disabled by default).</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>anonymous_enable=YES #允许匿名用户登录</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre># Uncomment this to allow local users to log in.</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>local_enable=YES #允许实名登录</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre># Uncomment this to enable any form of FTP write command.</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>write_enable=YES #允许实名用户进行写操作</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre># Default umask for local users is 077. You may wish to change this to 022,</pre></td></tr><tr><td data-num=\"34\"></td><td><pre># if your users expect that (022 is used by most other ftpd's)</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>#local_umask=022</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre># Uncomment this to allow the anonymous FTP user to upload files. This only</pre></td></tr><tr><td data-num=\"38\"></td><td><pre># has an effect if the above global write enable is activated. Also, you will</pre></td></tr><tr><td data-num=\"39\"></td><td><pre># obviously need to create a directory writable by the FTP user.</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>anon_upload_enable=YES #允许匿名用户上传文件</pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre># Uncomment this if you want the anonymous FTP user to be able to create</pre></td></tr><tr><td data-num=\"43\"></td><td><pre># new directories.</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>anon_mkdir_write_enable=YES #允许匿名用户创建目录</pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre># Activate directory messages - messages given to remote users when they</pre></td></tr><tr><td data-num=\"47\"></td><td><pre># go into a certain directory.</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>dirmessage_enable=YES</pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre># If enabled, vsftpd will display directory listings with the time</pre></td></tr><tr><td data-num=\"51\"></td><td><pre># in  your  local  time  zone.  The default is to display GMT. The</pre></td></tr><tr><td data-num=\"52\"></td><td><pre># times returned by the MDTM FTP command are also affected by this</pre></td></tr><tr><td data-num=\"53\"></td><td><pre># option.</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>use_localtime=YES</pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre># Activate logging of uploads/downloads.</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>xferlog_enable=YES</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre># Make sure PORT transfer connections originate from port 20 (ftp-data).</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>connect_from_port_20=YES</pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre># If you want, you can arrange for uploaded anonymous files to be owned by</pre></td></tr><tr><td data-num=\"63\"></td><td><pre># a different user. Note! Using \"root\" for uploaded files is not</pre></td></tr><tr><td data-num=\"64\"></td><td><pre># recommended!</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>#chown_uploads=YES</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>#chown_username=whoever</pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre># You may override where the log file goes if you like. The default is shown</pre></td></tr><tr><td data-num=\"69\"></td><td><pre># below.</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>#xferlog_file=/var/log/vsftpd.log</pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre># If you want, you can have your log file in standard ftpd xferlog format.</pre></td></tr><tr><td data-num=\"73\"></td><td><pre># Note that the default log file location is /var/log/xferlog in this case.</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>#xferlog_std_format=YES</pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre># You may change the default value for timing out an idle session.</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>#idle_session_timeout=600</pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre># You may change the default value for timing out a data connection.</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>#data_connection_timeout=120</pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre># It is recommended that you define on your system a unique user which the</pre></td></tr><tr><td data-num=\"83\"></td><td><pre># ftp server can use as a totally isolated and unprivileged user.</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>#nopriv_user=ftpsecure</pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre># Enable this and the server will recognise asynchronous ABOR requests. Not</pre></td></tr><tr><td data-num=\"87\"></td><td><pre># recommended for security (the code is non-trivial). Not enabling it,</pre></td></tr><tr><td data-num=\"88\"></td><td><pre># however, may confuse older FTP clients.</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>#async_abor_enable=YES</pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre># By default the server will pretend to allow ASCII mode but in fact ignore</pre></td></tr><tr><td data-num=\"92\"></td><td><pre># the request. Turn on the below options to have the server actually do ASCII</pre></td></tr><tr><td data-num=\"93\"></td><td><pre># mangling on files when in ASCII mode.</pre></td></tr><tr><td data-num=\"94\"></td><td><pre># Beware that on some FTP servers, ASCII support allows a denial of service</pre></td></tr><tr><td data-num=\"95\"></td><td><pre># attack (DoS) via the command \"SIZE /big/file\" in ASCII mode. vsftpd</pre></td></tr><tr><td data-num=\"96\"></td><td><pre># predicted this attack and has always been safe, reporting the size of the</pre></td></tr><tr><td data-num=\"97\"></td><td><pre># raw file.</pre></td></tr><tr><td data-num=\"98\"></td><td><pre># ASCII mangling is a horrible feature of the protocol.</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>#ascii_upload_enable=YES</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>#ascii_download_enable=YES</pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre># You may fully customise the login banner string:</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>#ftpd_banner=Welcome to blah FTP service.</pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre># You may specify a file of disallowed anonymous e-mail addresses. Apparently</pre></td></tr><tr><td data-num=\"106\"></td><td><pre># useful for combatting certain DoS attacks.</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>#deny_email_enable=YES</pre></td></tr><tr><td data-num=\"108\"></td><td><pre># (default follows)</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>#banned_email_file=/etc/vsftpd.banned_emails</pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre># You may restrict local users to their home directories.  See the FAQ for</pre></td></tr><tr><td data-num=\"112\"></td><td><pre># the possible risks in this before using chroot_local_user or</pre></td></tr><tr><td data-num=\"113\"></td><td><pre># chroot_list_enable below.</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>chroot_local_user=YES #用户访问将被限制在当前目录</pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre># You may specify an explicit list of local users to chroot() to their home</pre></td></tr><tr><td data-num=\"117\"></td><td><pre># directory. If chroot_local_user is YES, then this list becomes a list of</pre></td></tr><tr><td data-num=\"118\"></td><td><pre># users to NOT chroot().</pre></td></tr><tr><td data-num=\"119\"></td><td><pre># (Warning! chroot'ing can be very dangerous. If using chroot, make sure that</pre></td></tr><tr><td data-num=\"120\"></td><td><pre># the user does not have write access to the top level directory within the</pre></td></tr><tr><td data-num=\"121\"></td><td><pre># chroot)</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>#chroot_local_user=YES</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>#chroot_list_enable=YES</pre></td></tr><tr><td data-num=\"124\"></td><td><pre># (default follows)</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>#chroot_list_file=/etc/vsftpd.chroot_list</pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre># You may activate the \"-R\" option to the builtin ls. This is disabled by</pre></td></tr><tr><td data-num=\"128\"></td><td><pre># default to avoid remote users being able to cause excessive I/O on large</pre></td></tr><tr><td data-num=\"129\"></td><td><pre># sites. However, some broken FTP clients such as \"ncftp\" and \"mirror\" assume</pre></td></tr><tr><td data-num=\"130\"></td><td><pre># the presence of the \"-R\" option, so there is a strong case for enabling it.</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>#ls_recurse_enable=YES</pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre># Customization</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>#</pre></td></tr><tr><td data-num=\"135\"></td><td><pre># Some of vsftpd's settings don't fit the filesystem layout by</pre></td></tr><tr><td data-num=\"136\"></td><td><pre># default.</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>#</pre></td></tr><tr><td data-num=\"138\"></td><td><pre># This option should be the name of a directory which is empty.  Also, the</pre></td></tr><tr><td data-num=\"139\"></td><td><pre># directory should not be writable by the ftp user. This directory is used</pre></td></tr><tr><td data-num=\"140\"></td><td><pre># as a secure chroot() jail at times vsftpd does not require filesystem</pre></td></tr><tr><td data-num=\"141\"></td><td><pre># access.</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>secure_chroot_dir=/var/run/vsftpd/empty</pre></td></tr><tr><td data-num=\"143\"></td><td><pre></pre></td></tr><tr><td data-num=\"144\"></td><td><pre># This string is the name of the PAM service vsftpd will use.</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>pam_service_name=vsftpd</pre></td></tr><tr><td data-num=\"146\"></td><td><pre></pre></td></tr><tr><td data-num=\"147\"></td><td><pre># This option specifies the location of the RSA certificate to use for SSL</pre></td></tr><tr><td data-num=\"148\"></td><td><pre># encrypted connections.</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>ssl_enable=NO</pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre></pre></td></tr><tr><td data-num=\"154\"></td><td><pre># Uncomment this to indicate that vsftpd use a utf8 filesystem.</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>utf8_filesystem=YES</pre></td></tr><tr><td data-num=\"156\"></td><td><pre></pre></td></tr><tr><td data-num=\"157\"></td><td><pre></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>no_anon_password=YES #匿名登录是否需要密码</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>anon_root=/home/user/ftp_dir #匿名登录访问的文件路径</pre></td></tr><tr><td data-num=\"160\"></td><td><pre></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>local_root=/ftp_share #实名登录访问的文件路径</pre></td></tr><tr><td data-num=\"162\"></td><td><pre></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>allow_writeable_chroot=YES</pre></td></tr></table></figure><p>编辑完成后， <code>:wq</code>  保存退出。</p>\n<p>note：<mark>如果自己电脑的当前网络环境支持 ipv6 的话可以将  <code>listen_ipv6</code>  设置为 YES，但是  <code>listen</code>  就要设置为 NO，因为 ipv4 和 ipv6 的服务监听不能共存。</mark></p>\n<h1 id=\"重新加载配置文件\"><a class=\"anchor\" href=\"#重新加载配置文件\">#</a> 重新加载配置文件</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> /etc/init.d/vsftpd restart</pre></td></tr></table></figure><h1 id=\"启动服务\"><a class=\"anchor\" href=\"#启动服务\">#</a> 启动服务</h1>\n<p>在加载完后，重启服务器：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> systemctl restart vsftpd</pre></td></tr></table></figure><p>查看服务启动状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> systemctl status vsftpd</pre></td></tr></table></figure><p><img data-src=\"image-20221106152005206.png\" alt=\"image-20221106152005206\" /></p>\n<p>设置开机启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> vsftpd</pre></td></tr></table></figure><p>如果想关闭开机启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">sudo</span> systemctl disable vsftpd</pre></td></tr></table></figure><h1 id=\"ftp连接\"><a class=\"anchor\" href=\"#ftp连接\">#</a> FTP 连接</h1>\n<p>本机连接：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td data-command=\"[user@localhost] #\"></td><td><pre><span class=\"token function\">ftp</span> <span class=\"token number\">127.0</span>.0.1</pre></td></tr></table></figure><p>其它电脑连接：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ftp</span> <span class=\"token function\">ip</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># eg:ftp 192.168.0.3</span></pre></td></tr></table></figure><p>1、输入用户名：（1）匿名：anonymous 或 ftp （2）主机用户名：即你当前主机名。</p>\n<p>2、回车。</p>\n<p>3、如果需要密码则进行相应输入，这里上面配置设了匿名登录不需要密码，所以以匿名登录时没有提示输入密码。</p>\n<p>4、进入到相应的用户访问根目录里（ps：即进入到配置文件中设置的登录访问的文件路径，可以用  <code>ls</code>  查看是否对应上访问的文件目录），这样就可以愉快的玩耍了；输入：  <code>quit</code>  退出。</p>\n<p>eg：本地连接并退出，如下图：</p>\n<p><img data-src=\"image-20221106164252568.png\" alt=\"image-20221106164252568\" /></p>\n<p>windows 下可视化文件访问：按  <code>Win</code>  +  <code>E</code>  快捷键，调用文件资源管理器，输入访问地址，回车：</p>\n<p><img data-src=\"image-20221106160826118.png\" alt=\"image-20221106160826118\" /></p>\n<p>windows 下命令行文件访问：同样按  <code>Win</code>  +  <code>E</code>  快捷键，调用文件资源管理器，然后在输写框跟上面 linux 访问连接一样输入  <code>ftp ip</code>  ，即可跳到 ftp 操作控制台中：</p>\n<p><img data-src=\"image-20221106161411644.png\" alt=\"image-20221106161411644\" /></p>\n<h1 id=\"ftp客户端常用命令\"><a class=\"anchor\" href=\"#ftp客户端常用命令\">#</a> FTP 客户端常用命令</h1>\n<p>在登录进入 ftp 后，可以使用  <code>help</code>  查看可以使用哪些指令操作：</p>\n<p><img data-src=\"image-20221106163512272.png\" alt=\"image-20221106163512272\" /></p>\n<ul>\n<li>\n<p>ls：和 linux 上的 ls 命令类似</p>\n</li>\n<li>\n<p>Ctrl+Shift + L：清屏</p>\n</li>\n<li>\n<p>put：使用  <code>put [本地文件路径+名称]</code>  上传</p>\n</li>\n<li>\n<p>get：使用  <code>get [远程文件路径+名称]</code>  下载</p>\n</li>\n<li>\n<p>mput：批量上传多个文件  <code>mput 文件名1 文件名2</code></p>\n</li>\n<li>\n<p>mget：批量获取多个文件  <code>mget 文件名1 文件名2</code></p>\n</li>\n<li>\n<p>prompt：屏蔽批量输出信息，批量上传下载文件就不需要一直回车确认了</p>\n</li>\n<li>\n<p>quit：退出 ftp 访问</p>\n</li>\n</ul>\n",
            "tags": [
                "history",
                "Ubuntu",
                "Linux"
            ]
        },
        {
            "id": "https://arachnid.cc/arch-linux-install/",
            "url": "https://arachnid.cc/arch-linux-install/",
            "title": "基于官方指导安装 Arch Linux",
            "date_published": "2022-04-12T03:02:19.000Z",
            "content_html": "<blockquote>\n<p>官方 wiki 安装中文指导：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvSW5zdGFsbGF0aW9uX2d1aWRlXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcp\">https://wiki.archlinux.org/title/Installation_guide_(简体中文)</span></p>\n<p>最好还是以<strong>英文版</strong>的为基准，因为 ArchLinux 是一个激进的系统，更新比较快，可能刚写完这篇笔记，转头已经有些对应不上了，哈哈哈。</p>\n</blockquote>\n<h2 id=\"系统镜像\"><a class=\"anchor\" href=\"#系统镜像\">#</a> 系统镜像</h2>\n<p>官方镜像下载地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNobGludXgub3JnL2Rvd25sb2FkLw==\">https://archlinux.org/download/</span></p>\n<p>当然，也可以去各大高校提供的镜像源网站下载。</p>\n<h2 id=\"启动盘制作\"><a class=\"anchor\" href=\"#启动盘制作\">#</a> 启动盘制作</h2>\n<p><strong>1、windows 平台</strong></p>\n<p>可以使用 Rufus：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ydWZ1cy5pZS96aC8=\">https://rufus.ie/zh/</span></p>\n<p>这是一款开源、免费、小巧（1.1mb）纯粹的系统启动盘制作工具。<br />\n目前所支持的 ISO 镜像如下：</p>\n<p><img data-src=\"image-20220412112425056.png\" alt=\"image-20220412112425056\" /></p>\n<p><strong>2、Uinx 平台</strong></p>\n<p>类 Unix 系统可以直接使用  <code>dd</code>  命令来制作启动盘。</p>\n<p><code>dd</code>  命令使用可参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS9saW51eC9saW51eC1jb21tLWRkLmh0bWw=\">https://www.runoob.com/linux/linux-comm-dd.html</span></p>\n<p><strong>3、多平台</strong></p>\n<p>可以使用开源的 etcher：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmFsZW5hLmlvL2V0Y2hlci8=\">https://www.balena.io/etcher/</span></p>\n<blockquote>\n<p>然后本篇文章是基于官方指导的总结分析安装的笔记，如下开始正式安装配置，因为是以官方 wiki 安装为指导，所以下面用到的操作的标题将一一对应官方 wiki 的标题，没用到的将忽略不写，以及需要增加的将给出说明。目前使用的镜像版本： <code>archlinux-2022.04.01-x86_64.iso</code></p>\n</blockquote>\n<h2 id=\"引导安装\"><a class=\"anchor\" href=\"#引导安装\">#</a> 引导安装</h2>\n<p>Arch 的启动引导过程有两种：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQklPUw==\">BIOS</span> 和 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvVUVGSQ==\">UEFI</span> 系统，这两者的引导过程是完全不同的。在 Arch 中它们的引导加载及区别可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvQXJjaF9ib290X3Byb2Nlc3M=\">https://wiki.archlinux.org/title/Arch_boot_process</span></p>\n<p>目前大部分设备的引导方式主要分为  <code>UEFI 引导 + GPT 分区表</code>  和  <code>BIOS(LEGACY) 引导 + MBR 分区表</code>  这两种，而在新的机器里大部分都采用了  <code>UEFI/GPT</code>  引导的方式，当然，同时也兼容  <code>BIOS/MBR</code>  。</p>\n<p>UEFI 进入：</p>\n<p><img data-src=\"image-20220412115757611.png\" alt=\"image-20220412115757611\" /></p>\n<p>BIOS 进入：</p>\n<p><img data-src=\"image-20220412120426116.png\" alt=\"image-20220412120426116\" /></p>\n<p>启动安装后，最终界面出现的效果是一样的：</p>\n<p><img data-src=\"image-20220412153955531.png\" alt=\"image-20220412153955531\" /></p>\n<h2 id=\"验证引导模式\"><a class=\"anchor\" href=\"#验证引导模式\">#</a> 验证引导模式</h2>\n<p>键入如下命令：（ <code>ls</code> ：表示列出目录内容；后面的路径可以利用 Tab 键 自动补全，即键入命令或文件名的前几个字符，然后按 [Tab] 键）</p>\n<pre><code>ls /sys/firmware/efi/efivars\n</code></pre>\n<p>如果命令结果显示了目录且没有报告错误，则系统以 UEFI 模式引导。</p>\n<p>如果目录不存在，则系统可能 <strong>（注意是可能，并不一定确是 BIOS 模式）</strong> 以 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvemg6QklPUw==\">BIOS</span> 模式 (或 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29tcGF0aWJpbGl0eV9TdXBwb3J0X01vZHVsZQ==\">CSM</span> 模式) 引导，如显示：</p>\n<pre><code>ls: cannot access '/sys/firmware/efi/efivars': No such file or directory\n</code></pre>\n<p>对于一些不是新的 / 格式过的磁盘，可能就不太适用了，当然，最好方法就是查看安装的主分区磁盘的属性。</p>\n<h2 id=\"连接到因特网\"><a class=\"anchor\" href=\"#连接到因特网\">#</a> 连接到因特网</h2>\n<p>1、检查网络接口是否启用</p>\n<pre><code>ip link\n</code></pre>\n<p>2、连接到网络</p>\n<ul>\n<li>有线：连接网线，并保证上级路由有网。</li>\n<li>无线：使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvSXdkXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpI2l3Y3Rs\">iwctl</span> 验证无线网络，具体操作点击链接查看。</li>\n</ul>\n<p>3、配置网络连接</p>\n<ul>\n<li>\n<p>动态：需要支持 DHCP，然后执行以下命令。</p>\n<pre><code>dhcpcd\n</code></pre>\n</li>\n<li>\n<p>静态：直接按照 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTmV0d29ya19jb25maWd1cmF0aW9uXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpIyVFOSU5RCU5OSVFNiU4MCU4MV9JUF8lRTUlOUMlQjAlRTUlOUQlODA=\">静态 IP 地址</span> 这个链接进行操作。</p>\n</li>\n</ul>\n<p>4、检查网络连接</p>\n<p>在确认无误完成上面的操作后，通过 PING IP 来检查：</p>\n<pre><code>ping archlinux.org\n</code></pre>\n<p><strong>note：</strong> 关于网络部分的，详情请看 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTmV0d29ya19jb25maWd1cmF0aW9u\">https://wiki.archlinux.org/title/Network_configuration</span></p>\n<h2 id=\"更新系统时间\"><a class=\"anchor\" href=\"#更新系统时间\">#</a> 更新系统时间</h2>\n<p>执行：</p>\n<pre><code>timedatectl set-ntp true\n</code></pre>\n<p>然后正常情况下是并没有输出的，所谓没有消息就是最好的消息，这就是 Linux/Unix 系统的设计思想。</p>\n<p>最后，执行如下命令来检查服务状态：</p>\n<pre><code>timedatectl status\n</code></pre>\n<h2 id=\"建立硬盘分区\"><a class=\"anchor\" href=\"#建立硬盘分区\">#</a> 建立硬盘分区</h2>\n<p>系统如果识别到磁盘，就会将其分配为一个块设备，如  <code>/dev/sda</code> 、 <code>/dev/nvme0n1</code>  或  <code>/dev/mmcblk0</code>  等等。然后可以执行如下命令查看：</p>\n<pre><code>fdisk -l\n</code></pre>\n<p>然后，针对不同的引导方式，其分区布局是不一样的，以官方给出的分区为例：</p>\n<ul>\n<li>\n<p><strong>UEFI 与</strong> <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvUGFydGl0aW9uaW5nXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpI0dVSURfJUU1JTg4JTg2JUU1JThDJUJBJUU4JUExJUE4\">GPT</span></p>\n<table>\n<thead>\n<tr>\n<th>挂载点</th>\n<th>分区</th>\n<th>分区类型</th>\n<th>建议大小</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>/mnt/boot</td>\n<td>/dev/<em>efi_system_partition</em></td>\n<td>EFI 系统分区</td>\n<td>至少 300 MiB</td>\n</tr>\n<tr>\n<td>[SWAP]</td>\n<td>/dev/<em>swap_partition</em></td>\n<td>Linux swap (交换空间)</td>\n<td>大于 512 MiB</td>\n</tr>\n<tr>\n<td>/mnt</td>\n<td>/dev/<em>root_partition</em></td>\n<td>Linux x86-64 根目录 (/)</td>\n<td>剩余空间</td>\n</tr>\n</tbody>\n</table>\n</li>\n<li>\n<p><strong>BIOS 与</strong> <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvUGFydGl0aW9uaW5nXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpI01hc3Rlcl9Cb290X1JlY29yZA==\">MBR</span></p>\n<table>\n<thead>\n<tr>\n<th>挂载点</th>\n<th>分区</th>\n<th>分区类型</th>\n<th>建议大小</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[SWAP]</td>\n<td>/dev/<em>swap_partition</em></td>\n<td>Linux swap (交换空间)</td>\n<td>大于 512 MiB</td>\n</tr>\n<tr>\n<td>/mnt</td>\n<td>/dev/<em>root_partition</em></td>\n<td>Linux x86-64 根目录 (/)</td>\n<td>剩余空间</td>\n</tr>\n</tbody>\n</table>\n<p>然后在这里拓展一下  <code>MiB</code>  跟  <code>MB</code>  这两个单位， <code>MB</code>  是国际单位制 SI 制定的十进制标准单位制，这个 M 是 1000K，而  <code>MiB</code>  是国际电工委员会 IEC 制定的二进制标准，这个 M 是 1024K 。参看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9waHlzaWNzLm5pc3QuZ292L2N1dS9Vbml0cy9iaW5hcnkuaHRtbA==\">https://physics.nist.gov/cuu/Units/binary.html</span></p>\n</li>\n<li>\n<p>其它的布局实例可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvUGFydGl0aW9uaW5nXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpIyVFNSVCOCU4MyVFNSVCMSU4MCVFNyVBNCVCQSVFNCVCRSU4Qg==\">https://wiki.archlinux.org/title/Partitioning_(简体中文)# 布局示例</span></p>\n</li>\n</ul>\n<p>在了解上面的布局后，然后我们常用的引导方式有  <code>UEFI 引导 + GPT 分区表</code>  和  <code>BIOS(LEGACY) 引导 + MBR 分区表</code>  这两种，所以下面分开说明：</p>\n<ol>\n<li>\n<p><strong>BIOS/MBR</strong></p>\n<p>这种方式相对于另一种比较简单，所以就先说了。</p>\n<p>首先，先来了解一下  <code>[SWAP]</code>  挂载点和  <code>/mnt</code>  挂载点：</p>\n<ul>\n<li>\n<p><code>[SWAP]</code> ：swap 分区通常被称为交换分区，这是一块特殊的硬盘空间，即当实际内存（物理内存，可以理解为内存条容量）不够用的时候，操作系统会从内存中取出一部分暂时不用的数据，放在交换分区中，从而为当前运行的程序腾出足够的内存空间（有点类似于 windows 系统下的虚拟内存）。也就是说，当内存不够用时，我们使用 swap 分区来临时顶替，等到那些程序要运行时，再从 swap 中恢复保存的数据到内存中。这种 “拆东墙，补西墙” 的方式应用于几乎所有的操作系统中。</p>\n<p>使用 swap 交换分区，显著的优点是，通过操作系统的调度，应用程序实际可以使用的内存空间将远远超过系统的物理内存。</p>\n<p>那么 swap 分区到底设置成多大才最优？少了又觉得不够，多了又感觉浪费，那么我们可以参考 Redhat 官方文档中 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9hY2Nlc3MucmVkaGF0LmNvbS9kb2N1bWVudGF0aW9uL2VuLXVzL3JlZF9oYXRfZW50ZXJwcmlzZV9saW51eC82L2h0bWwvaW5zdGFsbGF0aW9uX2d1aWRlL3MyLWRpc2twYXJ0cmVjb21tZW5kLXBwYyNpZDQzOTQwMDc=\">关于 swap 分区大小设置的建议</span>：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">物理内存</th>\n<th style=\"text-align:center\">建议的交换空间大小</th>\n<th style=\"text-align:center\">如果开启休眠功能建议的交换空间大小</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">⩽ 2GB</td>\n<td style=\"text-align:center\">内存的 2 倍</td>\n<td style=\"text-align:center\">内存的 3 倍</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">&gt; 2GB – 8GB</td>\n<td style=\"text-align:center\">等于内存大小</td>\n<td style=\"text-align:center\">内存的 2 倍</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">&gt; 8GB – 64GB</td>\n<td style=\"text-align:center\">至少 4G</td>\n<td style=\"text-align:center\">内存的 1.5 倍</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">&gt; 64GB</td>\n<td style=\"text-align:center\">至少 4G</td>\n<td style=\"text-align:center\">不建议使用休眠</td>\n</tr>\n</tbody>\n</table>\n<p>最后结合日常使用，一般来说可以按照如下规则设置 swap 大小：</p>\n<ul>\n<li>4G 以内的物理内存，SWAP 设置为内存的 2 倍，不超过 4G。</li>\n<li>4-8G 的物理内存，SWAP 等于内存大小。</li>\n<li>8-64G 的物理内存，SWAP 设置为 8G。</li>\n<li>64-256G 物理内存，SWAP 设置为 16G。</li>\n</ul>\n</li>\n<li>\n<p><code>/mnt</code> ：全称  <code>mount</code>  可直接理解为 “挂载”，用于存放手动挂载的硬件。这部分是根目录 <code>/</code>  下的目录，用来挂载文件系统。</p>\n<p>一般的 Linux 根目录展开如下图：</p>\n<p><img data-src=\"994198-20160908160724832-375737054.png\" alt=\"img\" /></p>\n<p>然后按照官方的说明，是想把将根磁盘卷挂载到  <code>/mnt</code>  目录下，即  <code>/mnt</code>  变成  <code>/</code>  根目录。</p>\n</li>\n</ul>\n<p><strong>好了，了解完后下面正式开始。</strong></p>\n<p>执行命令：</p>\n<pre><code>fdisk /dev/sdx （sdx可以为sda、sdb等，具体以你实际需要挂载的磁盘名称为准）\n</code></pre>\n<p>接着你就进入了  <code>fdisk</code>  操作环境，为了获取该命令下的操作功能，根据提示输入  <code>m</code>  并回车查看各命令的作用：</p>\n<p><img data-src=\"image-20220414144302934.png\" alt=\"image-20220414144302934\" /></p>\n<p>在  <code>fdisk</code>  操作环境下：</p>\n<p>1、对于一个全新的磁盘（格式化了），输入  <code>o</code>  来创建一个全新的  <code>MBR</code>  分区表（因为这里是 BIOS 引导）；如果是旧磁盘（要么原本有  <code>MBR</code>  分区表，要么不是  <code>MBR</code>  属性  <code>DOS</code>  的），那对于非  <code>MBR</code>  分区表可能得更改分区表或者格式化，而已有  <code>MBR</code>  分区表的直接执行第 2 步。</p>\n<p>2、输入  <code>n</code>  创建一个新的分区，首先会让你选择类型分区，输入  <code>p</code>  选择主分区，回车接着选择分区号，这里一般直接回车使用默认数值，这样可以避免自己定义出现冲突；紧接着选择开始起扇区地址，如果不知道原有区域划分情况，那一般直接回车使用默认数值即可；随后，输入结束扇区地址或者容量大小，这里决定了你为该分区创建的容量大小；我们按照表格顺序创建分区，那这第一个就是  <code>swap</code>  交换分区，例如我分配的是 8G 容量，那可以直接输入容量大小： <code>+8G</code>  。</p>\n<p>3、创建完毕后，可以输入  <code>p</code>  来查看创建的分区。</p>\n<p>4、重复第 2 项创建根目录分区和第 3 项确认最后的分区信息，至此就有两个分区（对应表格）。</p>\n<p>5、最后输入  <code>w</code>  将之前所有的操作写入磁盘并生效。</p>\n</li>\n<li>\n<p><strong>UEFI/GPT</strong></p>\n<p>与上一种引导方式相比，根据表格显示，只多了一个 <strong>EFI 系统分区</strong>，然后了解一下这个挂载点：</p>\n<ul>\n<li><code>/mnt/boot</code> ：上面说了官方是想把将根磁盘卷挂载到  <code>/mnt</code>  目录下，那这个 boot 引导自然就挂载到了新的  <code>/mnt</code>  目录下了。</li>\n</ul>\n<p>在该引导模式下的操作就如下。</p>\n<p>执行命令如下进入  <code>fdisk</code>  操作环境：</p>\n<pre><code>fdisk /dev/sdx （sdx可以为sda、sdb等，具体以你实际需要挂载的磁盘名称为准）\n</code></pre>\n<p>在  <code>fdisk</code>  操作环境下：</p>\n<p>1、对于一个全新的磁盘（格式化了），这里则输入  <code>g</code>  来创建一个全新的  <code>GPT</code>  分区表（因为到这里是 UEFI 引导）；同样的如果是旧磁盘那跟上面的 BIOS 引导操作差不多，只不过这里是  <code>GPT</code>  属性了。</p>\n<p>2、输入  <code>n</code>  创建一个新的分区，让你选择分区号 <strong>（UEFI 比 BIOS 少了类型分区选择）</strong> ，这里一般直接回车使用默认数值，这样可以避免自己定义出现冲突；紧接着选择开始起扇区地址，如果不知道原有区域划分情况，那一般直接回车使用默认数值即可；随后，输入结束扇区地址或者容量大小，这里决定了你为该分区创建的容量大小；我们按照表格顺序创建分区，那这第一个就是  <code>/mnt/boot</code>  引导分区，例如我取的是 512MiB 容量，那可以直接输入容量大小： <code>+512M</code>  。</p>\n<p>3、创建完毕后，可以输入  <code>p</code>  来查看创建的分区。</p>\n<p>4、重复第 2 项和第 3 项两次，分别创建  <code>[SWAP]</code>  和  <code>/mnt</code> ，至此就有三个分区（对应表格）。</p>\n<p>5、最后输入  <code>w</code>  将之前所有的操作写入磁盘并生效。</p>\n</li>\n</ol>\n<h2 id=\"格式化分区\"><a class=\"anchor\" href=\"#格式化分区\">#</a> 格式化分区</h2>\n<ul>\n<li>\n<p><strong>EFI 系统分区（仅对于 UEFI/GPT 引导方式）</strong></p>\n<p>使用  <code>mkfs.fat</code>  命令将其格式化为 Fat32：</p>\n<pre><code>mkfs.fat -F 32 /dev/sdxY （sdxY为上面创建的 EFI 系统分区符）\n</code></pre>\n</li>\n<li>\n<p><strong>swap 交换分区</strong></p>\n<p>如果有创建，则请使用  <code>mkswap</code>  命令将其初始化：</p>\n<pre><code>mkswap /dev/sdxY （sdxY为上面创建的交换空间分区符）\n</code></pre>\n</li>\n<li>\n<p><strong> <code>/mnt</code>  根目录分区</strong></p>\n<p>执行以下命令创建一个 Ext4 文件系统：</p>\n<pre><code>mkfs.ext4 /dev/sdxY （sdxY为上面创建的根分区符）\n</code></pre>\n</li>\n</ul>\n<h2 id=\"挂载分区\"><a class=\"anchor\" href=\"#挂载分区\">#</a> 挂载分区</h2>\n<p>1、将根磁盘卷挂载到  <code>/mnt</code> ，执行：</p>\n<pre><code>mount /dev/sdxY /mnt （把 sdxY替换为上面创建根分区符）\n</code></pre>\n<p>2、如果创建了  <code>swap</code>  交换空间卷，执行：</p>\n<pre><code>swapon /dev/sdxY （把 sdxY替换为上面创建的交换空间分区符）\n</code></pre>\n<p>3、对于 UEFI 系统，挂载 EFI 系统分区：</p>\n<pre><code>mkdir /mnt/boot\nmount /dev/sdxY /mnt/boot （把 sdxY替换为上面创建的 EFI 系统分区符）\n</code></pre>\n<h2 id=\"选择镜像\"><a class=\"anchor\" href=\"#选择镜像\">#</a> 选择镜像</h2>\n<p>文件  <code>/etc/pacman.d/mirrorlist</code>  定义了软件包会从哪个镜像源下载。在列表中越前的镜像在下载软件包时有越高的优先权。</p>\n<p>各地区镜像源获取：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNobGludXgub3JnL21pcnJvcmxpc3Qv\">https://archlinux.org/mirrorlist/</span> ，然后点击生成：</p>\n<p><img data-src=\"image-20220415095310180.png\" alt=\"image-20220415095310180\" /></p>\n<p>编辑  <code>/etc/pacman.d/mirrorlist</code>  文件，执行：</p>\n<pre><code>vim /etc/pacman.d/mirrorlist\n</code></pre>\n<p>然后进入 VIM 环境，输入  <code>i</code>  进入编辑状态，然后根据上面生成提供的镜像表，选择几个放到文件最顶端，在这里笔者选择阿里云镜像：</p>\n<p><img data-src=\"image-20220415103048537.png\" alt=\"image-20220415103048537\" /></p>\n<p>如果其速度不佳，可以手动指定其他镜像源，像中科大或者清华的放在最上面即可：</p>\n<pre><code>Server = https://mirrors.ustc.edu.cn/archlinux/$repo/os/$arch\nServer = https://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$arch\n</code></pre>\n<p>然后，按  <code>Esc</code>  键退出编程，最后输入  <code>:wq</code>  保存退出。</p>\n<p>关于 vim 命令的使用，可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS9saW51eC9saW51eC12aW0uaHRtbA==\">https://www.runoob.com/linux/linux-vim.html</span></p>\n<h2 id=\"安装必需的软件包\"><a class=\"anchor\" href=\"#安装必需的软件包\">#</a> 安装必需的软件包</h2>\n<p>使用  <code>pacstrap</code>  脚本，安装 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNobGludXgub3JnL3BhY2thZ2VzLz9uYW1lPWJhc2U=\">base</span> 软件包和 Linux <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvS2VybmVsXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcp\">内核</span>以及常规硬件的固件：</p>\n<pre><code>pacstrap /mnt base base-devel linux linux-headers linux-firmware （base-devel在 AUR包的安装是必须的）\n</code></pre>\n<h2 id=\"fstab配置\"><a class=\"anchor\" href=\"#fstab配置\">#</a> Fstab 配置</h2>\n<p>生成自动挂载分区的  <code>fstab</code>  文件，执行命令：</p>\n<pre><code>genfstab -U /mnt &gt;&gt; /mnt/etc/fstab\n</code></pre>\n<p>然后  <code>cat</code>  一下检查生成的  <code>/mnt/etc/fstab</code>  文件是否正确：</p>\n<pre><code>cat /mnt/etc/fstab\n</code></pre>\n<p>执行后将显示各分区挂载情况及属性信息。</p>\n<h2 id=\"chroot配置\"><a class=\"anchor\" href=\"#chroot配置\">#</a> Chroot 配置</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvQ2hhbmdlX3Jvb3RfKCVFNyVBRSU4MCVFNCVCRCU5MyVFNCVCOCVBRCVFNiU5NiU4Nyk=\">Change root</span> 到新安装的系统：</p>\n<pre><code>arch-chroot /mnt\n</code></pre>\n<p>执行了这步以后，我们的操作都相当于在磁盘上新装的系统中进行。</p>\n<h2 id=\"时区配置\"><a class=\"anchor\" href=\"#时区配置\">#</a> 时区配置</h2>\n<p>设置时区：</p>\n<pre><code>ln -sf /usr/share/zoneinfo/Region（地区名）/City（城市名） /etc/localtime\n</code></pre>\n<p>eg：以上海为例，执行  <code>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</code></p>\n<p>然后运行  <code>hwclock</code>  以生成  <code>/etc/adjtime</code> ：</p>\n<pre><code>hwclock --systohc\n</code></pre>\n<h2 id=\"本地化配置\"><a class=\"anchor\" href=\"#本地化配置\">#</a> 本地化配置</h2>\n<p>程序和库如果需要本地化文本，则需要根据区域设置 Locale，以明确规定地域、货币、时区日期的格式、字符排列方式和其他本地化标准。</p>\n<p>需在这两个文件设置： <code>locale.gen</code>  与  <code>locale.conf</code> 。</p>\n<p>通过前面的 Chroot 配置，我们已经处于 chroot 环境下了，这就意味这现在所在的系统中只有一些最基本的包（组件），而 VIM 组件并未包含在里面，这时候就需要自己安装组件包了。利用 Archlinux 下非常强大的包管理工具  <code>pacman</code> ，其安装包的命令格式为  <code>pacman -S 包名</code> ， <code>pacman</code>  会自动检查这个包所需要的其他包（即为依赖）并一起装上。</p>\n<p>然后我们安装 VIM 组件，执行：</p>\n<pre><code>pacman -S vim\n</code></pre>\n<p>1、利用刚安装的  <code>vim</code>  ，编辑  <code>locale.gen</code>  文件：</p>\n<pre><code>vim /etc/locale.gen\n</code></pre>\n<p>找到  <code>zh_CN.UTF-8 UTF-8</code> 、 <code>en_US.UTF-8 UTF-8</code>  这两行，去掉注释并保存。</p>\n<p>紧接着执行  <code>locale-gen</code>  以生成 locale 信息：</p>\n<pre><code>locale-gen\n</code></pre>\n<p>2、然后创建 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYW4uYXJjaGxpbnV4Lm9yZy9tYW4vbG9jYWxlLmNvbmYuNQ==\">locale.conf</span> 文件，并 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTG9jYWxlXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcpIyVFNyVCMyVCQiVFNyVCQiU5RiVFNSU4QyVCQSVFNSU5RiU5RiVFOCVBRSVCRSVFNyVCRCVBRQ==\">编辑设定 LANG 变量</span>，</p>\n<pre><code>echo LANG=en_US.UTF-8 &gt; /etc/locale.conf\n</code></pre>\n<h2 id=\"网络配置\"><a class=\"anchor\" href=\"#网络配置\">#</a> 网络配置</h2>\n<p>创建  <code>/etc/hostname</code>  文件，并设定的一个  <code>myhostname</code> ：</p>\n<pre><code>echo myhostname &gt; /etc/hostname （myhostname是你想要为该系统设置的名称）\n</code></pre>\n<p>这步在我目前使用的功能里好像没用到。。。</p>\n<p>然后，在官方文档中有一条说明：</p>\n<blockquote>\n<p>请注意，目前的 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNobGludXgub3JnL3BhY2thZ2VzLz9uYW1lPWJhc2U=\">base</span> 不含有任何网络管理工具。对于新安装的系统环境，请接着完成<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvJUU3JUJEJTkxJUU3JUJCJTlDJUU5JTg1JThEJUU3JUJEJUFF\">网络配置</span>，配置过程中可能包括要安装合适的<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvJUU3JUJEJTkxJUU3JUJCJTlDJUU3JUFFJUExJUU3JTkwJTg2\">网络管理</span>软件。</p>\n</blockquote>\n<p>因此，我们需要安装网络配置管理包（<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvRGhjcGNkXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcp\">DHCP</span> 客户端和 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTmV0Y3RsXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcp\">netctl</span> 网络管理器）：</p>\n<pre><code>pacman -S dhcpcd netctl\n</code></pre>\n<h2 id=\"root-密码\"><a class=\"anchor\" href=\"#root-密码\">#</a> Root 密码</h2>\n<p><code>Root</code>  是  <code>Linux</code>  中具有最高权限帐户，有些敏感的操作必须通过  <code>Root</code>  用户进行，比如使用 <code>pacman</code>  命令。</p>\n<p>执行以下命令，然后根据提示输入两次密码即可（注意输入是不显示出来）：</p>\n<pre><code>passwd root\n</code></pre>\n<h2 id=\"安装引导程序\"><a class=\"anchor\" href=\"#安装引导程序\">#</a> 安装引导程序</h2>\n<p>如果是 Intel 或 AMD 的 CPU，启用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTWljcm9jb2RlXyglRTclQUUlODAlRTQlQkQlOTMlRTQlQjglQUQlRTYlOTYlODcp\">微码</span> 更新：</p>\n<ul>\n<li>\n<p>Intel</p>\n<pre><code>pacman -S intel-ucode\n</code></pre>\n</li>\n<li>\n<p>AMD</p>\n<pre><code>pacman -S amd-ucode\n</code></pre>\n</li>\n</ul>\n<p>接着，官方推荐的引导加载是 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvR1JVQl8oJUU3JUFFJTgwJUU0JUJEJTkzJUU0JUI4JUFEJUU2JTk2JTg3KQ==\">GRUB</span> （其他的引导加载可看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvQXJjaF9ib290X3Byb2Nlc3NfKCVFNyVBRSU4MCVFNCVCRCU5MyVFNCVCOCVBRCVFNiU5NiU4NykjJUU1JThBJTlGJUU4JTgzJUJEJUU2JUFGJTk0JUU4JUJFJTgz\">引导功能比较</span>），因此我们对其安装并配置，不同的引导系统，其操作不一样：</p>\n<ul>\n<li>\n<p><strong>BIOS/MBR</strong></p>\n<p>1、安装  <code>grub</code> ：</p>\n<pre><code>pacman -S grub\n</code></pre>\n<p>2、部署  <code>grub</code> ：</p>\n<pre><code>grub-install --target=i386-pc /dev/sdx （sdx为要安装 GRUB 的磁盘，注意不是分区）\n</code></pre>\n</li>\n<li>\n<p><strong>UEFI/GPT</strong></p>\n<p>1、安装  <code>grub</code>  和  <code>efibootmgr</code> ：</p>\n<pre><code>pacman -S grub efibootmgr\n</code></pre>\n<p>2、部署  <code>grub</code> ：</p>\n<pre><code>grub-install --target=x86_64-efi --efi-directory=esp --bootloader-id=GRUB （这里的 esp 替换成挂载点）\n</code></pre>\n<p>像在这里，那就是：</p>\n<pre><code>grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB\n</code></pre>\n</li>\n</ul>\n<p><strong>最后，不管是哪个引导方式，都执行第三步：</strong></p>\n<p>3、生成配置文件：</p>\n<pre><code>grub-mkconfig -o /boot/grub/grub.cfg\n</code></pre>\n<p>执行后，最后显示  <code>done</code>  即完成操作。</p>\n<p><strong>note：这一步是至关重要的一步，请检查是否正确安装好引导加载程序后再重新启动，否则下次重启后将无法正常进入系统。</strong></p>\n<h2 id=\"重启\"><a class=\"anchor\" href=\"#重启\">#</a> 重启</h2>\n<p>最最最后，你需要进行重启来启动已经安装好的系统。</p>\n<p>1、输入以下命令退出 chroot 环境：</p>\n<pre><code>exit\n</code></pre>\n<p>2、手动取消挂载的分区（这有助于发现任何「繁忙」的分区）：</p>\n<p><strong>如果挂载了  <code>/mnt/boot</code> ，先  <code>umount -r /mnt/boot</code> ，再  <code>umount -r /mnt</code> ，否则直接  <code>umount /mnt</code> 。</strong></p>\n<pre><code>umount -r /mnt/boot\numount -r /mnt\n</code></pre>\n<p>3、执行重启：</p>\n<pre><code>reboot\n</code></pre>\n<h2 id=\"other\"><a class=\"anchor\" href=\"#other\">#</a> Other</h2>\n<p>另外一些比较详细的安装教程：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNobGludXhzdHVkaW8uZ2l0aHViLmlvL0FyY2hMaW51eFR1dG9yaWFsLyMvP2lkPWFyY2gtbGludXgtJUU1JUFFJTg5JUU4JUEzJTg1JUU0JUJEJUJGJUU3JTk0JUE4JUU2JTk1JTk5JUU3JUE4JThCLWFyY2h0dXRvcmlhbC1hcmNoLWxpbnV4LXN0dWRpbw==\">Arch Linux 安装使用教程</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudmlzZWF0b3IuY29tLzIwMTcvMDUvMTcvYXJjaF9pbnN0YWxsLw==\">以官方 Wiki 的方式安装 ArchLinux</span></p>\n",
            "tags": [
                "history",
                "Linux"
            ]
        }
    ]
}