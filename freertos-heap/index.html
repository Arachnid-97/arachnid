<!-- build time:Mon Sep 02 2024 22:30:21 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="命运转轮" href="https://arachnid.cc/rss.xml"><link rel="alternate" type="application/atom+xml" title="命运转轮" href="https://arachnid.cc/atom.xml"><link rel="alternate" type="application/json" title="命运转轮" href="https://arachnid.cc/feed.json"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="history,RTOS,FreeRTOS"><link rel="canonical" href="https://arachnid.cc/freertos-heap/"><title>FreeRTOS 篇章之 heap 堆内存分配分析 - FreeRTOS | Arachnid's blog = 命运转轮 = Life is ...the time you did something you're afraid of doing</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="loader-state"><svg viewBox="0 0 178 40" width="178" height="40"><path class="air" d="M 46 16.5 h -20 a 8 8 0 0 1 0 -16" fill="none" stroke="#E85725" stroke-width="1" stroke-linejoin="round" stroke-linecap="round"></path><g id="car"><svg viewBox="0 0 118 28.125" x="30" y="11.725" width="118" height="28.125"><defs><circle id="circle" cx="0" cy="0" r="1"></circle><g id="wheel"><use href="#circle" fill="#1E191A" transform="scale(10)"></use><use href="#circle" fill="#fff" transform="scale(5)"></use><path fill="#1E191A" stroke="#1E191A" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.2" stroke-dashoffset="0" d="M -3.5 0 a 4 4 0 0 1 7 0 a 3.5 3.5 0 0 0 -7 0"></path><use href="#circle" fill="#1E191A" transform="scale(1.5)"></use><path fill="none" stroke="#F9B35C" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="20 14 8 5" d="M 0 -7.5 a 7.5 7.5 0 0 1 0 15 a 7.5 7.5 0 0 1 0 -15"></path><path fill="none" stroke="#fff" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" opacity="0.1" stroke-dashoffset="0" d="M -6.5 -6.25 a 10 10 0 0 1 13 0 a 9 9 0 0 0 -13 0"></path></g></defs><g transform="translate(51.5 11.125)"><path stroke-width="2" stroke="#1E191A" fill="#EF3F33" d="M 0 0 v -2 a 4.5 4.5 0 0 1 9 0 v 2"></path><rect fill="#1E191A" x="3.25" y="-3" width="5" height="3"></rect></g><g transform="translate(10 24.125)"><g transform="translate(59 0)"><path id="shadow" opacity="0.7" fill="#1E191A" d="M -64 0 l -4 4 h 9 l 8 -1.5 h 100 l -3.5 -2.5"></path></g><path fill="#fff" stroke="#1E191A" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round" d="M 0 0 v -10 l 35 -13 v 5 l 4 0.5 l 0.5 4.5 h 35.5 l 30 13"></path><g fill="#fff" stroke="#1E191A" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"><path d="M -6 0 v -22 h 10 z"></path><path d="M 105 0 h -3 l -12 -5.2 v 6.2 h 12"></path></g><g fill="#949699" opacity="0.7"><rect x="16" y="-6" width="55" height="6"></rect><path d="M 24 -14 l 13 -1.85 v 1.85"></path></g><g fill="none" stroke="#1E191A" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"><path stroke-dasharray="30 7 42" d="M 90 0 h -78"></path><path d="M 39.5 -13 h -15"></path></g><path fill="#fff" stroke="#1E191A" stroke-width="2.25" stroke-linejoin="round" d="M 48.125 -6 h -29 v 6 h 29"></path><rect x="48" y="-7.125" width="6.125" height="7.125" fill="#1E191A"></rect><g fill="#1E191A"><rect x="60" y="-15" width="1" height="6"></rect><rect x="56.5" y="-17.5" width="6" height="2.5"></rect></g></g><g class="wheels" transform="translate(0 18.125)"><g transform="translate(10 0)"><use href="#wheel"></use></g><g transform="translate(87 0)"><use href="#wheel" stroke-dashoffset="-22"></use></g></g></svg></g><g fill="none" stroke-width="1" stroke-linejoin="round" stroke-linecap="round"><path class="air" stroke="#E85725" d="M 177.5 34 h -10 q -16 0 -32 -8"></path><path class="air" stroke="#949699" d="M 167 28.5 c -18 -2 -22 -8 -37 -10.75"></path><path class="air" stroke="#949699" d="M 153 20 q -4 -1.7 -8 -3"></path><path class="air" stroke="#E85725" d="M 117 16.85 c -12 0 -12 16 -24 16 h -8"></path><path class="air" stroke="#949699" d="M 65 12 q -5 3 -12 3.8"></path><path class="air" stroke="#949699" stroke-dasharray="9 10" d="M 30 13.5 h -2.5 q -5 0 -5 -5"></path><path class="air" stroke="#949699" d="M 31 33 h -10"></path><path class="air" stroke="#949699" d="M 29.5 23 h -12"></path><path class="air" stroke="#949699" d="M 13.5 23 h -6"></path><path class="air" stroke="#E85725" d="M 28 28 h -27.5"></path></g></svg></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline"><a href="/freertos-heap" class="link external" itemprop="url">FreeRTOS 篇章之 heap 堆内存分配分析<i class="ic i-link-alt"></i></a></h1><div class="meta"><span class="item" title="创建时间：2020-02-15 20:35:03"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2020-02-15T20:35:03+08:00">2020-02-15</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>28k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>29 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Arachnid's blog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://arachnid.cc/picture/(34).webp"></li><li class="item" data-background-image="https://arachnid.cc/picture/(16).webp"></li><li class="item" data-background-image="https://arachnid.cc/picture/(3).webp"></li><li class="item" data-background-image="https://arachnid.cc/picture/(21).webp"></li><li class="item" data-background-image="https://arachnid.cc/picture/(30).webp"></li><li class="item" data-background-image="https://arachnid.cc/picture/(12).webp"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/RTOS/" itemprop="item" rel="index" title="分类于 FreeRTOS"><span itemprop="name">FreeRTOS</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="cn"><link itemprop="mainEntityOfPage" href="https://arachnid.cc/freertos-heap/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.webp"><meta itemprop="name" content="夏沫の浅雨"><meta itemprop="description" content="Life is ...the time you did something you're afraid of doing, 不曾亏欠，不曾辜负，如此足矣"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="命运转轮"></span><div class="body md" itemprop="articleBody"><h1 id="freertos内存分配选择"><a class="anchor" href="#freertos内存分配选择">#</a> FreeRTOS 内存分配选择</h1><p>在 FreeRTOS 中，可以用静态（不使用 FreeRTOS 堆）或动态来分配 RTOS 的对象； 因此 FreeRTOS 中提供了 5 种堆管理方案，这些方案的复杂性和功能使得它的使用范围广泛，当然用户也可以自己实现堆管理；在官方的例程中，动静态的使用选择可以通过使能宏 <code>configSUPPORT_STATIC_ALLOCATION</code> 和宏 <code>configSUPPORT_DYNAMIC_ALLOCATION</code> 来进行决定（官方默认是使用动态内存进行分配的），当然，前提是使用 FreeRTOS 提供的 heap 堆分配的其中一个文件，而不是用自己实现的堆管理；甚至你还可以两种方法都在同一 RTOS 应用程序中使用。</p><h1 id="静态与动态内存分配"><a class="anchor" href="#静态与动态内存分配">#</a> 静态与动态内存分配</h1><p>V9.0.0 之前的 FreeRTOS 版本是从特殊的 FreeRTOS 堆中（也就是这几个 <code>heap</code> 文件）分配下面列出的 RTOS 对象使用的内存。而在 FreeRTOS V9.0.0 及更高版本中，人们可以自己实现堆管理提供内存，从而可以选择创建以下对象，而无需动态分配任何内存：</p><ul><li>任务</li><li>软件计时器</li><li>队列</li><li>事件</li><li>二值信号量</li><li>计数信号量</li><li>递归信号量</li><li>互斥量</li></ul><p><strong>1、使用动态分配的 RAM 创建 RTOS 对象</strong></p><p>动态创建 RTOS 对象的好处是可以更加简单、并有可能尽最大程度地减少应用程序的最大 RAM 使用量</p><p>如果 <code>configSUPPORT_DYNAMIC_ALLOCATION</code> 设置为 1 或未定义，以下 API 函数将使用动态分配的 RAM 创建 RTOS 对象：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDEyNS5odG1s">xTaskCreate()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExNi5odG1s">xQueueCreate()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL0ZyZWVSVE9TLXRpbWVycy14VGltZXJDcmVhdGUuaHRtbA==">xTimerCreate()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hFdmVudEdyb3VwQ3JlYXRlLmh0bWw=">xEventGroupCreate()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVCaW5hcnkuaHRtbA==">xSemaphoreCreateBinary()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL0NyZWF0ZUNvdW50aW5nLmh0bWw=">xSemaphoreCreateCounting()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL0NyZWF0ZU11dGV4Lmh0bWw=">xSemaphoreCreateMutex()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVSZWN1cnNpdmVNdXRleC5odG1s">xSemaphoreCreateRecursiveMutex()</span></li></ul><p><strong>2、使用静态分配的 RAM 创建 RTOS 对象</strong></p><p>使用静态分配的 RAM 创建 RTOS 对象的好处是为应用程序编写者提供了更多控制权</p><p>下列 API 函数（如果 <code>configSUPPORT_STATIC_ALLOCATION</code> 设置为 1 时可用）允许使用应用程序编写者实现的堆管理创建 RTOS 对象。为了提供内存，应用程序编写者只需要声明一个适当对象类型的变量，然后将变量的地址传递给 RTOS API 函数即可。官方也提供了 <span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2Vmb3JnZS5uZXQvcC9mcmVlcnRvcy9jb2RlL0hFQUQvdHJlZS90cnVuay9GcmVlUlRPUy9EZW1vL0NvbW1vbi9NaW5pbWFsL1N0YXRpY0FsbG9jYXRpb24uYw==">StaticAllocation.c</span> 标准的演示 / 测试任务来演示如何使用这些功能：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hUYXNrQ3JlYXRlU3RhdGljLmh0bWw=">xTaskCreateStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hRdWV1ZUNyZWF0ZVN0YXRpYy5odG1s">xQueueCreateStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hUaW1lckNyZWF0ZVN0YXRpYy5odG1s">xTimerCreateStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hFdmVudEdyb3VwQ3JlYXRlU3RhdGljLmh0bWw=">xEventGroupCreateStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVCaW5hcnlTdGF0aWMuaHRtbA==">xSemaphoreCreateBinaryStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVDb3VudGluZ1N0YXRpYy5odG1s">xSemaphoreCreateCountingStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVNdXRleFN0YXRpYy5odG1s">xSemaphoreCreateMutexStatic()</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL3hTZW1hcGhvcmVDcmVhdGVSZWN1cnNpdmVNdXRleFN0YXRpYy5odG1s">xSemaphoreCreateRecursiveMutexStatic()</span></li></ul><h1 id="内存管理"><a class="anchor" href="#内存管理">#</a> 内存管理</h1><p>如果 RTOS 对象是动态创建的，则有时可以使用标准 C 库 <code>malloc()</code> 和 <code>free()</code> 函数来实现此目的，但是 …</p><ol><li>它们并不总是在嵌入式系统上可用；</li><li>他们占用了宝贵的代码空间；</li><li>它们不是线程安全的；</li><li>它们不是确定性的（执行函数所花费的时间因调用而异）。</li></ol><p>因此，通常需要另一种内存分配实现。</p><p>一个嵌入式 / 实时系统可能具有与另一个系统不同的 RAM 和时序要求；因此，单个 RAM 分配算法仅适用于部分应用程序。</p><p>为了解决这个问题，FreeRTOS 将内存分配 API 保留在其可移植层中；当 RTOS 内核需要 RAM 时，它不调用 <code>malloc()</code> ，而是调用 <code>pvPortMalloc()</code> ；当释放 RAM 时，RTOS 内核将调用 <code>vPortFree()</code> 而不是调用 <code>free()</code> 。</p><p>在 <code>FreeRTOSv9.0.0\FreeRTOS\Source\portable\MemMang</code> 文档中，FreeRTOS 提供了五个内存分配实现：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1sI2hlYXBfMQ==">heap_1</span> – 最简单，不允许释放内存。</li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1sI2hlYXBfMg==">heap_2</span> – 允许释放内存，但不合并相邻的空闲块。</li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1sI2hlYXBfMw==">heap_3</span> – 简单包装标准 <code>malloc()</code> 和 <code>free()</code> 以确保线程安全。</li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1sI2hlYXBfNA==">heap_4</span> – 合并相邻的空闲块以避免碎片；包括绝对地址放置选项。</li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1sI2hlYXBfNQ==">heap_5</span> – 参照 <code>heap_4</code> ，能够跨多个不相邻的内存区域扩展堆。</li></ul><h2 id="heap_1c"><a class="anchor" href="#heap_1c">#</a> heap_1.c</h2><p>在这个文件中有这么一项注释： <strong>The simplest possible implementation of pvPortMalloc(). Note that this implementation does NOT allow allocated memory to be freed again.</strong> 也就是表明了 <code>heap_1.c</code> 这个文件的功能只能进行分配，不支持释放内存。</p><p>它的分配函数实现：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> <span class="token class-name">size_t</span> xWantedSize <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span>pvReturn <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">static</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pucAlignedHeap <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token comment">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>			<span class="token comment">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>			xWantedSize <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> pucAlignedHeap <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			<span class="token comment">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num="22"></td><td><pre>			pucAlignedHeap <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> <span class="token operator">&amp;</span>ucHeap<span class="token punctuation">[</span> portBYTE_ALIGNMENT <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>		<span class="token comment">/* Check there is enough room left for the allocation. */</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> xNextFreeByte <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">&lt;</span> configADJUSTED_HEAP_SIZE <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>			<span class="token punctuation">(</span> <span class="token punctuation">(</span> xNextFreeByte <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> xNextFreeByte <span class="token punctuation">)</span>	<span class="token punctuation">)</span><span class="token comment">/* Check for overflow. */</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>			<span class="token comment">/* Return the next free byte then increment the index past this</span></pre></td></tr><tr><td data-num="30"></td><td><pre>			block. */</pre></td></tr><tr><td data-num="31"></td><td><pre>			pvReturn <span class="token operator">=</span> pucAlignedHeap <span class="token operator">+</span> xNextFreeByte<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			xNextFreeByte <span class="token operator">+=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>		<span class="token function">traceMALLOC</span><span class="token punctuation">(</span> pvReturn<span class="token punctuation">,</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_MALLOC_FAILED_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> pvReturn <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>			<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>			<span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>	<span class="token keyword">return</span> pvReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>既然这么简单，就稍微分析一下吧！</p><p>1、首先是对内存对齐的判断，这里，如果内存对齐有效，则执行；如果要分配的内存不是对齐字节 (通常是 8，根据 <code>portBYTE_ALIGNMENT</code> 来确定对齐字节) 的整数倍，则补齐，所以 <code>xWantedSize</code> 要加上要补齐的长度。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token comment">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		xWantedSize <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr></table></figure><p>2、接着挂起所有的调度器，防止在分配内存的过程中被打断。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>3、判断是否为第一次分配，若是，则检查初分配的内存是否有对齐，这里 <code>uheap</code> 是一个静态数组（是 FreeRTOS 为我们申请的一个内存堆，大小由宏 <code>configTOTAL_HEAP_SIZE</code> 决定），首先要确保它是否对齐，因为 <code>uheap</code> 的首地址可能不是 8 的倍数，若是没有对齐，那么进行对齐处理，以确保实际开始分配的地址是对齐的，值得留意的是，这个对齐处理只做一次。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pucAlignedHeap <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token comment">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	pucAlignedHeap <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> <span class="token operator">&amp;</span>ucHeap<span class="token punctuation">[</span> portBYTE_ALIGNMENT <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>4、在正式分配前进行溢出检查，如果空间够用，则记录新分配空间的首地址到 <code>pvReturn</code> ，并重新记录新的空闲空间的首地址到 <code>NextFreeByte</code> 。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Check there is enough room left for the allocation. */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> xNextFreeByte <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">&lt;</span> configADJUSTED_HEAP_SIZE <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token punctuation">(</span> <span class="token punctuation">(</span> xNextFreeByte <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> xNextFreeByte <span class="token punctuation">)</span>	<span class="token punctuation">)</span><span class="token comment">/* Check for overflow. */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token comment">/* Return the next free byte then increment the index past this	block. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	pvReturn <span class="token operator">=</span> pucAlignedHeap <span class="token operator">+</span> xNextFreeByte<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	xNextFreeByte <span class="token operator">+=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>5、 <code>traceMALLOC( pvReturn, xWantedSize )</code> 是一个宏，用于输出内存分配的调试信息，这个宏定义在 <code>FreeRTOS.h</code> 中，默认为空，如果需要将这些调试信息输出到串口或其它东西，就可以修改这个宏将信息输出到所需要的地方。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">traceMALLOC</span><span class="token punctuation">(</span> pvReturn<span class="token punctuation">,</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>6、最后，恢复之前挂起的调度器</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>7、这个取决于宏 <code>configUSE_MALLOC_FAILED_HOOK</code> 是否使能，如果开启了分配失败 <code>hook</code> 函数，就调用该 <code>hook</code> 。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_MALLOC_FAILED_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> pvReturn <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr></table></figure><p>适用环境以及功能简介：</p><ul><li>如果您的应用程序从不删除任务，队列，信号量，互斥锁等，则可以使用它（实际上涵盖了使用 FreeRTOS 的大多数应用程序）。</li><li>始终是确定性的（总是花费相同的时间来执行），并且不会导致内存碎片。</li><li>它是非常简单的，可以从静态分配的数组中分配内存，这意味着它通常适用于不允许真正的动态内存分配的应用程序。</li></ul><h2 id="heap_2c"><a class="anchor" href="#heap_2c">#</a> heap_2.c</h2><p>此方案使用了最佳适应算法（best fit algorithm），并且与<strong>方案 1</strong> 不同，它允许释放以前分配的块；它不会将相邻的空闲块合并成一个大块。</p><p>同样的，文件里的注释： <strong>A sample implementation of pvPortMalloc() and vPortFree() that permits allocated blocks to be freed, but does not combine adjacent free blocks into a single larger block (and so will fragment memory).</strong> 也就是说现在支持分配和释放内存，但对内存碎片不做处理。</p><p>1、在实现堆分配之前，有一个堆初始化的过程 <code>prvHeapInit()</code> ，并且只调用一次（就是第一次进入该函数的时候）</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvHeapInit</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxFirstFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">uint8_t</span> <span class="token operator">*</span>pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token comment">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	pucAlignedHeap <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> <span class="token operator">&amp;</span>ucHeap<span class="token punctuation">[</span> portBYTE_ALIGNMENT <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> portPOINTER_SIZE_TYPE <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token comment">/* xStart is used to hold a pointer to the first item in the list of free</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	blocks.  The void cast is used to prevent compiler warnings. */</pre></td></tr><tr><td data-num="11"></td><td><pre>	xStart<span class="token punctuation">.</span>pxNextFreeBlock <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	xStart<span class="token punctuation">.</span>xBlockSize <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token comment">/* xEnd is used to mark the end of the list of free blocks. */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	xEnd<span class="token punctuation">.</span>xBlockSize <span class="token operator">=</span> configADJUSTED_HEAP_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	xEnd<span class="token punctuation">.</span>pxNextFreeBlock <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token comment">/* To start with there is a single free block that is sized to take up the</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	entire heap space. */</pre></td></tr><tr><td data-num="20"></td><td><pre>	pxFirstFreeBlock <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	pxFirstFreeBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> configADJUSTED_HEAP_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	pxFirstFreeBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> <span class="token operator">&amp;</span>xEnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里用到了 <code>BlockLink_t</code> 结构体，这个结构有两个成员，第一个是节点 Next 指针 <code>pxNextFreeBlock</code> ，第二个是空闲块大小。结构体成员如下：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Define the linked list structure.  This is used to link free blocks in order</span></pre></td></tr><tr><td data-num="2"></td><td><pre>of their size. */</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">A_BLOCK_LINK</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">A_BLOCK_LINK</span> <span class="token operator">*</span>pxNextFreeBlock<span class="token punctuation">;</span>	<span class="token comment">/*&lt;&lt; The next free block in the list. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token class-name">size_t</span> xBlockSize<span class="token punctuation">;</span>			<span class="token comment">/*&lt;&lt; The size of the free block. */</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span> BlockLink_t<span class="token punctuation">;</span></pre></td></tr></table></figure><p>首先，对开辟的堆进行地址对齐工作，对齐的原因的原理与 <code>heap_1</code> 一样，在获取堆的首地址后，对 <code>xStart</code> 链表头和 <code>xEnd</code> 链表尾进行初始化赋值；在 <code>heap_2</code> 中，与 <code>heap_1</code> 不同的是，由于 FreeRTOS 用空闲块对内存堆进行管理，于是用 <code>BlockLink_t</code> 这一个结构来形成一条空闲块链表对空闲块进行组织和管理。</p><p>2、好了，现在回到 <code>pvPortMalloc()</code> 函数中。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> <span class="token class-name">size_t</span> xWantedSize <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxBlock<span class="token punctuation">,</span> <span class="token operator">*</span>pxPreviousBlock<span class="token punctuation">,</span> <span class="token operator">*</span>pxNewBlockLink<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">static</span> BaseType_t xHeapHasBeenInitialised <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span>pvReturn <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token comment">/* If this is the first call to malloc then the heap will require</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		initialisation to setup the list of free blocks. */</pre></td></tr><tr><td data-num="11"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> xHeapHasBeenInitialised <span class="token operator">==</span> pdFALSE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token function">prvHeapInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>			xHeapHasBeenInitialised <span class="token operator">=</span> pdTRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token comment">/* The wanted size is increased so it can contain a BlockLink_t</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		structure in addition to the requested amount of bytes. */</pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			xWantedSize <span class="token operator">+=</span> heapSTRUCT_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>			<span class="token comment">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num="24"></td><td><pre>			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>			<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>				<span class="token comment">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num="27"></td><td><pre>				xWantedSize <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&lt;</span> configADJUSTED_HEAP_SIZE <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>			<span class="token comment">/* Blocks are stored in byte order - traverse the list from the start</span></pre></td></tr><tr><td data-num="34"></td><td><pre>			(smallest) block until one of adequate size is found. */</pre></td></tr><tr><td data-num="35"></td><td><pre>			pxPreviousBlock <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>			pxBlock <span class="token operator">=</span> xStart<span class="token punctuation">.</span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>			<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">&lt;</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>			<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>				pxPreviousBlock <span class="token operator">=</span> pxBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>				pxBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>			<span class="token comment">/* If we found the end marker then a block of adequate size was not found. */</span></pre></td></tr><tr><td data-num="44"></td><td><pre>			<span class="token keyword">if</span><span class="token punctuation">(</span> pxBlock <span class="token operator">!=</span> <span class="token operator">&amp;</span>xEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>			<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>				<span class="token comment">/* Return the memory space - jumping over the BlockLink_t structure</span></pre></td></tr><tr><td data-num="47"></td><td><pre>				at its start. */</pre></td></tr><tr><td data-num="48"></td><td><pre>				pvReturn <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span> <span class="token operator">+</span> heapSTRUCT_SIZE <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>				<span class="token comment">/* This block is being returned for use so must be taken out of the</span></pre></td></tr><tr><td data-num="51"></td><td><pre>				list of free blocks. */</pre></td></tr><tr><td data-num="52"></td><td><pre>				pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>				<span class="token comment">/* If the block is larger than required it can be split into two. */</span></pre></td></tr><tr><td data-num="55"></td><td><pre>				<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> heapMINIMUM_BLOCK_SIZE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>					<span class="token comment">/* This block is to be split into two.  Create a new block</span></pre></td></tr><tr><td data-num="58"></td><td><pre>					following the number of bytes requested. The void cast is</pre></td></tr><tr><td data-num="59"></td><td><pre>					used to prevent byte alignment warnings from the compiler. */</pre></td></tr><tr><td data-num="60"></td><td><pre>					pxNewBlockLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlock <span class="token punctuation">)</span> <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>					<span class="token comment">/* Calculate the sizes of two blocks split from the single</span></pre></td></tr><tr><td data-num="63"></td><td><pre>					block. */</pre></td></tr><tr><td data-num="64"></td><td><pre>					pxNewBlockLink<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>					pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>					<span class="token comment">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num="68"></td><td><pre>					<span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxNewBlockLink <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>				xFreeBytesRemaining <span class="token operator">-=</span> pxBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>		<span class="token function">traceMALLOC</span><span class="token punctuation">(</span> pvReturn<span class="token punctuation">,</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>	<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_MALLOC_FAILED_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="80"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> pvReturn <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="82"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>			<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>			<span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>	<span class="token keyword">return</span> pvReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>同样的，在每次分配空间之前，先挂起调度器，这是没得说的，然后如果是第一次调用 <code>pvPortMalloc()</code> ，则调用 <code>prvHeapInit()</code> 对内存堆和空闲块链表进行初始化；而下面这段 code：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* The wanted size is increased so it can contain a BlockLink_t</span></pre></td></tr><tr><td data-num="2"></td><td><pre>structure in addition to the requested amount of bytes. */</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	xWantedSize <span class="token operator">+=</span> heapSTRUCT_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">/* Ensure that blocks are always aligned to the required number of bytes. */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token comment">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		xWantedSize <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在用户每申请一次内存，FreeRTOS 都会在申请的空间前加上空闲块头部 <code>BlockLink_t</code> ，用于记录分配出去的空间的大小，因此，实际分配的内存空间大小就等于用户申请的内存空间大小加上空闲块头部的大小；最后再加上头部之后，还要对整个大小进行对齐。</p><p>下一个 <code>if</code> 判断：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&lt;</span> configADJUSTED_HEAP_SIZE <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token comment">/* Blocks are stored in byte order - traverse the list from the start</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	(smallest) block until one of adequate size is found. */</pre></td></tr><tr><td data-num="5"></td><td><pre>	pxPreviousBlock <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	pxBlock <span class="token operator">=</span> xStart<span class="token punctuation">.</span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">&lt;</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		pxPreviousBlock <span class="token operator">=</span> pxBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		pxBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token comment">/* If we found the end marker then a block of adequate size was not found. */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> pxBlock <span class="token operator">!=</span> <span class="token operator">&amp;</span>xEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token comment">/* Return the memory space - jumping over the BlockLink_t structure</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		at its start. */</pre></td></tr><tr><td data-num="18"></td><td><pre>		pvReturn <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span> <span class="token operator">+</span> heapSTRUCT_SIZE <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token comment">/* This block is being returned for use so must be taken out of the</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		list of free blocks. */</pre></td></tr><tr><td data-num="22"></td><td><pre>		pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>		<span class="token comment">/* If the block is larger than required it can be split into two. */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> heapMINIMUM_BLOCK_SIZE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>			<span class="token comment">/* This block is to be split into two.  Create a new block</span></pre></td></tr><tr><td data-num="28"></td><td><pre>			following the number of bytes requested. The void cast is</pre></td></tr><tr><td data-num="29"></td><td><pre>			used to prevent byte alignment warnings from the compiler. */</pre></td></tr><tr><td data-num="30"></td><td><pre>			pxNewBlockLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlock <span class="token punctuation">)</span> <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>			<span class="token comment">/* Calculate the sizes of two blocks split from the single</span></pre></td></tr><tr><td data-num="33"></td><td><pre>			block. */</pre></td></tr><tr><td data-num="34"></td><td><pre>			pxNewBlockLink<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>			pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>			<span class="token comment">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num="38"></td><td><pre>			<span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxNewBlockLink <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>		xFreeBytesRemaining <span class="token operator">-=</span> pxBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>先是判断用户申请的空间大小是否存在（不等于零）以及是否已经超过堆空间大小，若是不符合那就直接 pass 掉了；在这里，块的大小是按从小到大的顺序排列的，因此从一开始遍历列表 (最小的) 块，直到找到一个合适的大小，最后把位置记录下来。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* If we found the end marker then a block of adequate size was not found. */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxBlock <span class="token operator">!=</span> <span class="token operator">&amp;</span>xEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">/* Return the memory space - jumping over the BlockLink_t structure</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	at its start. */</pre></td></tr><tr><td data-num="6"></td><td><pre>	pvReturn <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span> <span class="token operator">+</span> heapSTRUCT_SIZE <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token comment">/* This block is being returned for use so must be taken out of the</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	list of free blocks. */</pre></td></tr><tr><td data-num="10"></td><td><pre>	pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token comment">/* If the block is larger than required it can be split into two. */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> heapMINIMUM_BLOCK_SIZE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token comment">/* This block is to be split into two.  Create a new block</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		following the number of bytes requested. The void cast is</pre></td></tr><tr><td data-num="17"></td><td><pre>		used to prevent byte alignment warnings from the compiler. */</pre></td></tr><tr><td data-num="18"></td><td><pre>		pxNewBlockLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlock <span class="token punctuation">)</span> <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token comment">/* Calculate the sizes of two blocks split from the single</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		block. */</pre></td></tr><tr><td data-num="22"></td><td><pre>		pxNewBlockLink<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>		<span class="token comment">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		<span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxNewBlockLink <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>	xFreeBytesRemaining <span class="token operator">-=</span> pxBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>紧接着，在上面的一段代码里，先是把返回的空间地址值修改（跳过 <code>BlockLink_t</code> 结构），然后把上一个的下一个的节点指向当前下一个的空闲块；后面，若果分配出去的空闲块的剩余空间是比两倍的空闲块头部结构体大小还要大，则将分配出去的这个空闲块分割剩余的空间出来，重新放到空闲块链表中。</p><p>值得注意的是 <code>prvInsertBlockIntoFreeList</code> 这个是个宏，具体实现如下：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * Insert a block into the list of free blocks - which is ordered by size of</pre></td></tr><tr><td data-num="3"></td><td><pre> * the block.  Small blocks at the start of the list and large blocks at the end</pre></td></tr><tr><td data-num="4"></td><td><pre> * of the list.</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">prvInsertBlockIntoFreeList</span><span class="token expression"><span class="token punctuation">(</span> pxBlockToInsert <span class="token punctuation">)</span>								</span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token expression"><span class="token punctuation">&#123;</span>																					</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token expression">BlockLink_t <span class="token operator">*</span>pxIterator<span class="token punctuation">;</span>															</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token expression"><span class="token class-name">size_t</span> xBlockSize<span class="token punctuation">;</span>																	</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>																					<span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token expression">xBlockSize <span class="token operator">=</span> pxBlockToInsert<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span>										</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>																					<span class="token punctuation">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token comment">/* Iterate through the list until a block is found that has a larger size */</span>	<span class="token punctuation">\</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token comment">/* than the block we are inserting. */</span>											<span class="token punctuation">\</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token expression"><span class="token keyword">for</span><span class="token punctuation">(</span> pxIterator <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token operator">-></span>xBlockSize <span class="token operator">&lt;</span> xBlockSize<span class="token punctuation">;</span> pxIterator <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span>	</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token expression"><span class="token punctuation">&#123;</span>																				</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token comment">/* There is nothing to do here - just iterate to the correct position. */</span>	<span class="token punctuation">\</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token expression"><span class="token punctuation">&#125;</span>																				</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="19"></td><td><pre>																					<span class="token punctuation">\</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token comment">/* Update the list to include the block being inserted in the correct */</span>		<span class="token punctuation">\</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token comment">/* position. */</span>																	<span class="token punctuation">\</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token expression">pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span>					</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token expression">pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlockToInsert<span class="token punctuation">;</span>									</span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token expression"><span class="token punctuation">&#125;</span></span></pre></td></tr></table></figure><p>这个宏的作用就是将新空闲块插入到合适的链表位置中。</p><p>后面的代码执行就跟 <code>heap_1</code> 一样了，修改剩余空闲块空闲大小 <code>xFreeBytesRemaining</code> 、恢复所有挂起的任务等等。</p><p>3、最后剩下的就是 <code>heap_1</code> 中不支持的 <code>vPortFree()</code> 释放函数了。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vPortFree</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pv <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name">uint8_t</span> <span class="token operator">*</span>puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pv<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxLink<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> pv <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token comment">/* The memory being freed will have an BlockLink_t structure immediately</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		before it. */</pre></td></tr><tr><td data-num="10"></td><td><pre>		puc <span class="token operator">-=</span> heapSTRUCT_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token comment">/* This unexpected casting is to keep some compilers from issuing</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		byte alignment warnings. */</pre></td></tr><tr><td data-num="14"></td><td><pre>		pxLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> puc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>			<span class="token comment">/* Add this block to the list of free blocks. */</span></pre></td></tr><tr><td data-num="19"></td><td><pre>			<span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> BlockLink_t <span class="token operator">*</span> <span class="token punctuation">)</span> pxLink <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>			xFreeBytesRemaining <span class="token operator">+=</span> pxLink<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			<span class="token function">traceFREE</span><span class="token punctuation">(</span> pv<span class="token punctuation">,</span> pxLink<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这一个函数炒鸡简单，而且非常短，首先判断要释放的内存是否为空；若是不为空，则获取这个内存空间真正的的空闲块（剔除头部的 <code>BlockLink_t</code> 结构），然后挂起所有任务，把释放的内存重新插入到空闲块链表中，最后调用调试信息宏，恢复挂起的任务就结束了。</p><p>特点：</p><p>即使应用程序反复删除任务，队列，信号量，互斥量等对象，也可以使用，有关内存碎片的警告如下：</p><ul><li>如果不是，如果被分配和释放内存使用是随机的大小。例如：<ul><li>如果应用程序以动态创建和删除任务，并且分配给正在创建的任务的堆栈大小始终相同，则在大多数情况下可以使用 <code>heap_2.c</code> ；但是，如果分配给正在创建的任务的堆栈大小并不总是相同，则可用的空闲内存可能会分成许多小块，最终导致分配失败；在这种情况下， <code>heap_4.c</code> 会更好</li><li>如果应用程序以动态创建和删除队列，并且每种情况下队列存储区域都相同（队列存储区域指队列项数目乘以每个队列长度），则在大多数情况下都可以使用 <code>heap_2.c</code> ；但是，如果队列存储区域在每种情况下都不相同，则可用的空闲内存可能会分成许多小块，最终导致分配失败；在这种情况下， <code>heap_4.c</code> 会更好</li><li>该应用程序直接调用 <code>pvPortMalloc()</code> 和 <code>vPortFree()</code> ，而不仅仅是通过其他 FreeRTOS API 函数间接调用。</li></ul></li><li>如果您的应用程序的队列，任务，信号量，互斥量等处于以不可预测的顺序，则可能会导致内存碎片问题；虽然这是小概率事件，但应牢记。</li><li>不确定型，但比大多数标准 C 库 <code>malloc</code> 实现要有效得多。</li></ul><h2 id="heap_3c"><a class="anchor" href="#heap_3c">#</a> heap_3.c</h2><p>heap_3.c 就更简单了，只是简单的包装一下标准函数 <code>malloc()</code> 和 <code>free()</code> 以确保线程安全，在大多数情况下，这些包装器将需要你的编译器提供，它们依赖于编译器自己的 <code>malloc()</code> 和 <code>free()</code> 实现；文件说明如下： <strong>Implementation of pvPortMalloc() and vPortFree() that relies on the compilers own malloc() and free() implementations.This file can only be used if the linker is configured to to generate a heap memory area.</strong></p><p>1、封装 <code>malloc()</code></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> <span class="token class-name">size_t</span> xWantedSize <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span>pvReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		pvReturn <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token function">traceMALLOC</span><span class="token punctuation">(</span> pvReturn<span class="token punctuation">,</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_MALLOC_FAILED_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> pvReturn <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">return</span> pvReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>和 <code>heap_1</code> 、 <code>heap_2</code> 一样，用 <code>vTaskSuspendAll()</code> 挂起所有的任务，以确保分配内存的过程是线程安全的；随后才使用 <code>malloc()</code> 进行内存分配，记录内存地址；然后就是调用调试信息宏 <code>traceMALLOC()</code> ，最后调用 <code>xTaskResumeAll()</code> 恢复所有被挂起的任务；如果在 <code>FreeRTOS.h</code> 中使能了勾子函数宏 <code>configUSE_MALLOC_FAILED_HOOK</code> ，则在调用勾子函数 <code>vApplicationMallocFailedHook()</code> 之后再向用户返回分配内存的首地址。</p><p>2、封装 <code>free()</code></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vPortFree</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pv <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> pv <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token function">free</span><span class="token punctuation">(</span> pv <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token function">traceFREE</span><span class="token punctuation">(</span> pv<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>一样的，检查指针的有效性、挂起全部任务、调用 <code>free()</code> 接口将内存回收、调用调试信息宏、恢复挂起的任务，然后就没了。</p><p>此实现方法及特点：</p><ul><li>需要链接器设置堆，并且需要编译器库提供 <code>malloc()</code> 和 <code>free()</code> 实现。</li><li>具有不确定性。</li><li>可能会大大增加 RTOS 内核代码的大小。</li></ul><p>注意，当使用 <code>heap_3</code> 时， <code>FreeRTOSConfig.h</code> 中的宏 <code>configTOTAL_HEAP_SIZE</code> 设置无效。</p><h2 id="heap_4c"><a class="anchor" href="#heap_4c">#</a> heap_4.c</h2><p>跟<strong>方案 2</strong> 不一样的是，这个方案使用了首次适应算法（first fit algorithm）；它会将相邻的空闲内存块合并成一个更大的块（包含一个合并算法）。</p><p>具体是它们会在释放时合并相邻的内存块，从而限制内存碎片，文件中的注释也有说： <strong>A sample implementation of pvPortMalloc() and vPortFree() that combines (coalescences) adjacent memory blocks as they are freed, and in so doing limits memory fragmentation.</strong></p><p>其实， <code>heap_4</code> 的代码基本跟 <code>heap_2</code> 的代码实现差不多，只不过增加了些功能（合并算法），而且你别看他代码太长，其实有很多东西都没用到的，就像这个函数 <code>mtCOVERAGE_TEST_MARKER()</code> ，其实他是个宏，但是他并没有实现什么，根据他的命名可以认定为只是作者预留的一个调试输出窗口而已；还有 <code>configASSERT()</code> 这个也是一个宏，也只是用来调试输出而已，具体配置修改看下一篇。</p><p>1、没错，还是我们首要分析的初始化函数。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvHeapInit</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxFirstFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">uint8_t</span> <span class="token operator">*</span>pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token class-name">size_t</span> uxAddress<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token class-name">size_t</span> xTotalHeapSize <span class="token operator">=</span> configTOTAL_HEAP_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token comment">/* Ensure the heap starts on a correctly aligned boundary. */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	uxAddress <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> ucHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> uxAddress <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		uxAddress <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		uxAddress <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		xTotalHeapSize <span class="token operator">-=</span> uxAddress <span class="token operator">-</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> ucHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>	pucAlignedHeap <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> uxAddress<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token comment">/* xStart is used to hold a pointer to the first item in the list of free</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	blocks.  The void cast is used to prevent compiler warnings. */</pre></td></tr><tr><td data-num="22"></td><td><pre>	xStart<span class="token punctuation">.</span>pxNextFreeBlock <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	xStart<span class="token punctuation">.</span>xBlockSize <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token comment">/* pxEnd is used to mark the end of the list of free blocks and is inserted</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	at the end of the heap space. */</pre></td></tr><tr><td data-num="27"></td><td><pre>	uxAddress <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> pucAlignedHeap <span class="token punctuation">)</span> <span class="token operator">+</span> xTotalHeapSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	uxAddress <span class="token operator">-=</span> xHeapStructSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	uxAddress <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	pxEnd <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> uxAddress<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	pxEnd<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	pxEnd<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token comment">/* To start with there is a single free block that is sized to take up the</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	entire heap space, minus the space taken by pxEnd. */</pre></td></tr><tr><td data-num="36"></td><td><pre>	pxFirstFreeBlock <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pucAlignedHeap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	pxFirstFreeBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> uxAddress <span class="token operator">-</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> pxFirstFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	pxFirstFreeBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxEnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>	<span class="token comment">/* Only one block exists - and it covers the entire usable heap space. */</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	xMinimumEverFreeBytesRemaining <span class="token operator">=</span> pxFirstFreeBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	xFreeBytesRemaining <span class="token operator">=</span> pxFirstFreeBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>	<span class="token comment">/* Work out the position of the top bit in a size_t variable. */</span></pre></td></tr><tr><td data-num="45"></td><td><pre>	xBlockAllocatedBit <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> <span class="token operator">*</span> heapBITS_PER_BYTE <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/freertos-heap/20200215165421587.png" alt="img"></p><p>根据上图现在来对比一下 <code>head_2</code> 的，这里对起始地址做字节对齐处理是跟 <code>head_2</code> 有点不同，他不止对内存堆进行首地址对齐保存 <code>pucAlignedHeap</code> ，并且还算出可用空间大小为 <code>xTotalHeapSize</code> ；</p><p>然后， <code>xStart</code> 的初始化是一样的，没什么好说的，注意 <code>xStart</code> 是 <code>BlockLink_t</code> 的一个实体变量，存储在静态存储区；</p><p>接着是 <code>pxEnd</code> ，他是一个 <code>BlockLink_t</code> 的指针，存储在静态存储区中，却指向了内存堆的最后一个 <code>BlockLink_t</code> 大小的位置上。也就是说，内存堆最后的空间是存储着一个 <code>BlockLink_t</code> ，用来指示空闲块链表的最后位置，这是和 <code>heap_2</code> 所不同的地方：</p><p><img data-src="/freertos-heap/20200215172529594.png" alt="img"></p><p>因为 <code>pxEnd</code> 占用了一个 <code>BlockLink_t</code> 大小的空间，所以在整个堆空间，减去 <code>pxEnd</code> 占用的空间；</p><p>另外，为了安全， <code>heap_4</code> 增加一个位（ <code>BlockLink_t</code> 中 <code>xBlockSize</code> 的最高位）标记某个内存块是否处于空闲状态，因此在初始化的时候设置 <code>xBlockAllocatedBit</code> 的值。</p><p>2、在对比分析 <code>pvPortMalloc()</code> 内存分布的实现之前，我们先分析一下 <code>prvInsertBlockIntoFreeList()</code> 函数。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> BlockLink_t <span class="token operator">*</span>pxBlockToInsert <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxIterator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">uint8_t</span> <span class="token operator">*</span>puc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token comment">/* Iterate through the list until a block is found that has a higher address</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	than the block being inserted. */</pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">for</span><span class="token punctuation">(</span> pxIterator <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">&lt;</span> pxBlockToInsert<span class="token punctuation">;</span> pxIterator <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token comment">/* Nothing to do here, just iterate to the right position. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token comment">/* Do the block being inserted, and the block it is being inserted after</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	make a contiguous block of memory? */</pre></td></tr><tr><td data-num="15"></td><td><pre>	puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxIterator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> puc <span class="token operator">+</span> pxIterator<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlockToInsert <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		pxIterator<span class="token operator">-></span>xBlockSize <span class="token operator">+=</span> pxBlockToInsert<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		pxBlockToInsert <span class="token operator">=</span> pxIterator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>	<span class="token comment">/* Do the block being inserted, and the block it is being inserted before</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	make a contiguous block of memory? */</pre></td></tr><tr><td data-num="28"></td><td><pre>	puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlockToInsert<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> puc <span class="token operator">+</span> pxBlockToInsert<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">!=</span> pxEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>			<span class="token comment">/* Form one big block from the two blocks. */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>			pxBlockToInsert<span class="token operator">-></span>xBlockSize <span class="token operator">+=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>			pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		<span class="token keyword">else</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>			pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxEnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="43"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>		pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token comment">/* If the block being inserted plugged a gab, so was merged with the block</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	before and the block after, then it's pxNextFreeBlock pointer will have</pre></td></tr><tr><td data-num="49"></td><td><pre>	already been set, and should not be set here as that would make it point</pre></td></tr><tr><td data-num="50"></td><td><pre>	to itself. */</pre></td></tr><tr><td data-num="51"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> pxIterator <span class="token operator">!=</span> pxBlockToInsert <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>		pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlockToInsert<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="56"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>		<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个函数就是合并实现的主要环节了；在 <code>heap_2</code> 中的链表插入是通过宏实现的，并且是按内存块大小进行插入；而 <code>heap_4</code> 的插入操作是写成了一个函数，该函数按内存块地址进行插入（低位前），实际上是将这个空闲块链表里的所有空闲块按地址顺序排列，这么做是为了实现内存块合并；前面也说了，相对于 <code>heap_2</code> ， <code>heap_4</code> 会将相邻的空闲内存块合并成一个更大的块，若果不这么排列，那么就不能将相邻的空闲块进行合并了。</p><p>首先，通过一次链表的遍历，找出内存块插入点（把 <code>pxIterator</code> 找出来）；然后判断，正在插入的块（ <code>pxBlockToInsert</code> ）和内存块插入点（ <code>pxIterator</code> ）是否构成一个连续的内存块；其标准为 <code>pxIterator</code> 的首地址加上 <code>pxIterator</code> 的块大小之后等于 <code>pxBlockToInsert</code> 的首地址，相等就说明两个块是相邻的，把这个待插入的空闲块插到 <code>pxIterator</code> 的后面，否则就什么事都不做。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Iterate through the list until a block is found that has a higher address</span></pre></td></tr><tr><td data-num="2"></td><td><pre>than the block being inserted. */</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">for</span><span class="token punctuation">(</span> pxIterator <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">&lt;</span> pxBlockToInsert<span class="token punctuation">;</span> pxIterator <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token comment">/* Nothing to do here, just iterate to the right position. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/* Do the block being inserted, and the block it is being inserted after</span></pre></td></tr><tr><td data-num="9"></td><td><pre>make a contiguous block of memory? */</pre></td></tr><tr><td data-num="10"></td><td><pre>puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxIterator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> puc <span class="token operator">+</span> pxIterator<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlockToInsert <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	pxIterator<span class="token operator">-></span>xBlockSize <span class="token operator">+=</span> pxBlockToInsert<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	pxBlockToInsert <span class="token operator">=</span> pxIterator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后，再试着将 <code>pxBlockToInsert</code> 和 <code>pxIterator</code> 指向的下一个空闲块进行合并；这次用 <code>pxBlockToInsert</code> 的首地址加上 <code>pxBlockToInsert</code> 的块大小与 <code>pxIterator</code> 指向的下一个块地址比较，不符合，则要修改 <code>pxBlockToInsert</code> 的 Next 指针，指向 <code>pxIterator</code> 的下一个空闲块；如果符合条件，则再判断 <code>pxIterator</code> 指向的下一个块地址是否已经到了空闲块链表的最后位置了，如果已经到了空闲块链表的最后位置，那么就把 <code>pxIterator</code> 指向的下一个块地址更改为空闲块链表的最后位置的地址，否则就合并内存并且更新链表的数据。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Do the block being inserted, and the block it is being inserted before</span></pre></td></tr><tr><td data-num="2"></td><td><pre>make a contiguous block of memory? */</pre></td></tr><tr><td data-num="3"></td><td><pre>puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlockToInsert<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> puc <span class="token operator">+</span> pxBlockToInsert<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">!=</span> pxEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token comment">/* Form one big block from the two blocks. */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		pxBlockToInsert<span class="token operator">-></span>xBlockSize <span class="token operator">+=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxEnd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	pxBlockToInsert<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxIterator<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>最后，要是 <code>pxBlockToInsert</code> 没有和 <code>pxIterator</code> 合并，则还要修改 <code>pxIterator</code> 的 Next 指针。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* If the block being inserted plugged a gab, so was merged with the block</span></pre></td></tr><tr><td data-num="2"></td><td><pre>before and the block after, then it's pxNextFreeBlock pointer will have</pre></td></tr><tr><td data-num="3"></td><td><pre>already been set, and should not be set here as that would make it point</pre></td></tr><tr><td data-num="4"></td><td><pre>to itself. */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> pxIterator <span class="token operator">!=</span> pxBlockToInsert <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	pxIterator<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlockToInsert<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>3、讲了这么多，现在终于到分析 <code>pvPortMalloc()</code> 了。</p><p>先看总代码：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pvPortMalloc</span><span class="token punctuation">(</span> <span class="token class-name">size_t</span> xWantedSize <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxBlock<span class="token punctuation">,</span> <span class="token operator">*</span>pxPreviousBlock<span class="token punctuation">,</span> <span class="token operator">*</span>pxNewBlockLink<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span>pvReturn <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token comment">/* If this is the first call to malloc then the heap will require</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		initialisation to setup the list of free blocks. */</pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> pxEnd <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>			<span class="token function">prvHeapInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token keyword">else</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token comment">/* Check the requested block size is not so large that the top bit is</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		set.  The top bit of the block size member of the BlockLink_t structure</pre></td></tr><tr><td data-num="21"></td><td><pre>		is used to determine who owns the block - the application or the</pre></td></tr><tr><td data-num="22"></td><td><pre>		kernel, so it must be free. */</pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> xBlockAllocatedBit <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>			<span class="token comment">/* The wanted size is increased so it can contain a BlockLink_t</span></pre></td></tr><tr><td data-num="26"></td><td><pre>			structure in addition to the requested amount of bytes. */</pre></td></tr><tr><td data-num="27"></td><td><pre>			<span class="token keyword">if</span><span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>			<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>				xWantedSize <span class="token operator">+=</span> xHeapStructSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>				<span class="token comment">/* Ensure that blocks are always aligned to the required number</span></pre></td></tr><tr><td data-num="32"></td><td><pre>				of bytes. */</pre></td></tr><tr><td data-num="33"></td><td><pre>				<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x00</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>					<span class="token comment">/* Byte alignment required. */</span></pre></td></tr><tr><td data-num="36"></td><td><pre>					xWantedSize <span class="token operator">+=</span> <span class="token punctuation">(</span> portBYTE_ALIGNMENT <span class="token operator">-</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>					<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>				<span class="token keyword">else</span></pre></td></tr><tr><td data-num="40"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>					<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>			<span class="token keyword">else</span></pre></td></tr><tr><td data-num="45"></td><td><pre>			<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>			<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> xWantedSize <span class="token operator">&lt;=</span> xFreeBytesRemaining <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>			<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>				<span class="token comment">/* Traverse the list from the start	(lowest address) block until</span></pre></td></tr><tr><td data-num="52"></td><td><pre>				one	of adequate size is found. */</pre></td></tr><tr><td data-num="53"></td><td><pre>				pxPreviousBlock <span class="token operator">=</span> <span class="token operator">&amp;</span>xStart<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>				pxBlock <span class="token operator">=</span> xStart<span class="token punctuation">.</span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>				<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">&lt;</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>					pxPreviousBlock <span class="token operator">=</span> pxBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>					pxBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>				<span class="token comment">/* If the end marker was reached then a block of adequate size</span></pre></td></tr><tr><td data-num="62"></td><td><pre>				was	not found. */</pre></td></tr><tr><td data-num="63"></td><td><pre>				<span class="token keyword">if</span><span class="token punctuation">(</span> pxBlock <span class="token operator">!=</span> pxEnd <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>					<span class="token comment">/* Return the memory space pointed to - jumping over the</span></pre></td></tr><tr><td data-num="66"></td><td><pre>					BlockLink_t structure at its start. */</pre></td></tr><tr><td data-num="67"></td><td><pre>					pvReturn <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token punctuation">)</span> <span class="token operator">+</span> xHeapStructSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>					<span class="token comment">/* This block is being returned for use so must be taken out</span></pre></td></tr><tr><td data-num="70"></td><td><pre>					of the list of free blocks. */</pre></td></tr><tr><td data-num="71"></td><td><pre>					pxPreviousBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> pxBlock<span class="token operator">-></span>pxNextFreeBlock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>					<span class="token comment">/* If the block is larger than required it can be split into</span></pre></td></tr><tr><td data-num="74"></td><td><pre>					two. */</pre></td></tr><tr><td data-num="75"></td><td><pre>					<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize <span class="token punctuation">)</span> <span class="token operator">></span> heapMINIMUM_BLOCK_SIZE <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="76"></td><td><pre>					<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>						<span class="token comment">/* This block is to be split into two.  Create a new</span></pre></td></tr><tr><td data-num="78"></td><td><pre>						block following the number of bytes requested. The void</pre></td></tr><tr><td data-num="79"></td><td><pre>						cast is used to prevent byte alignment warnings from the</pre></td></tr><tr><td data-num="80"></td><td><pre>						compiler. */</pre></td></tr><tr><td data-num="81"></td><td><pre>						pxNewBlockLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pxBlock <span class="token punctuation">)</span> <span class="token operator">+</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>						<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> pxNewBlockLink <span class="token punctuation">)</span> <span class="token operator">&amp;</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>						<span class="token comment">/* Calculate the sizes of two blocks split from the</span></pre></td></tr><tr><td data-num="85"></td><td><pre>						single block. */</pre></td></tr><tr><td data-num="86"></td><td><pre>						pxNewBlockLink<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">-</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>						pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">=</span> xWantedSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>						<span class="token comment">/* Insert the new block into the list of free blocks. */</span></pre></td></tr><tr><td data-num="90"></td><td><pre>						<span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> pxNewBlockLink <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>					<span class="token keyword">else</span></pre></td></tr><tr><td data-num="93"></td><td><pre>					<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>						<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre>					xFreeBytesRemaining <span class="token operator">-=</span> pxBlock<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>					<span class="token keyword">if</span><span class="token punctuation">(</span> xFreeBytesRemaining <span class="token operator">&lt;</span> xMinimumEverFreeBytesRemaining <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="100"></td><td><pre>					<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>						xMinimumEverFreeBytesRemaining <span class="token operator">=</span> xFreeBytesRemaining<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>					<span class="token keyword">else</span></pre></td></tr><tr><td data-num="104"></td><td><pre>					<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>						<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre></pre></td></tr><tr><td data-num="108"></td><td><pre>					<span class="token comment">/* The block is being returned - it is allocated and owned</span></pre></td></tr><tr><td data-num="109"></td><td><pre>					by the application and has no "next" block. */</pre></td></tr><tr><td data-num="110"></td><td><pre>					pxBlock<span class="token operator">-></span>xBlockSize <span class="token operator">|=</span> xBlockAllocatedBit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>					pxBlock<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>				<span class="token keyword">else</span></pre></td></tr><tr><td data-num="114"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>					<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>			<span class="token keyword">else</span></pre></td></tr><tr><td data-num="119"></td><td><pre>			<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>		<span class="token keyword">else</span></pre></td></tr><tr><td data-num="124"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="127"></td><td><pre></pre></td></tr><tr><td data-num="128"></td><td><pre>		<span class="token function">traceMALLOC</span><span class="token punctuation">(</span> pvReturn<span class="token punctuation">,</span> xWantedSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>	<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre></pre></td></tr><tr><td data-num="132"></td><td><pre>	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span> configUSE_MALLOC_FAILED_HOOK <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="133"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> pvReturn <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="135"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>			<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>			<span class="token function">vApplicationMallocFailedHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>		<span class="token keyword">else</span></pre></td></tr><tr><td data-num="140"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="145"></td><td><pre></pre></td></tr><tr><td data-num="146"></td><td><pre>	<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> pvReturn <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token class-name">size_t</span> <span class="token punctuation">)</span> portBYTE_ALIGNMENT_MASK <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>	<span class="token keyword">return</span> pvReturn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其实相对于 <code>heap_2</code> 的变动不大，可以看一下它们的对比图：</p><p><img data-src="/freertos-heap/20200215194716241.png" alt="img"></p><p>同样的，只在第一次调用该函数的时候才初始化堆管理，看上图。</p><p><img data-src="/freertos-heap/2020021519500019.png" alt="img"></p><p>接着在这里只是相对于 <code>heap_2</code> 多了个标志位 <code>xBlockAllocatedBit</code> 的判断来是否执行以下的操作，若是符合，则像 <code>heap_2</code> 一样进行块字节对齐，看上图。</p><p>而剩下的，主要的不同也就是因为多了个 <code>xBlockAllocatedBit</code> 操作，所以使用了 <code>xBlockSize</code> 的最高位做标记，因此就添加了相应的操作，如下图：</p><p><img data-src="/freertos-heap/2020021520080137.png" alt="img"></p><p>至于其他差别不大，此处不做赘述。</p><p>4、 <code>vPortFree()</code> 实现</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">vPortFree</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>pv <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name">uint8_t</span> <span class="token operator">*</span>puc <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span> <span class="token punctuation">)</span> pv<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>BlockLink_t <span class="token operator">*</span>pxLink<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span> pv <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token comment">/* The memory being freed will have an BlockLink_t structure immediately</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		before it. */</pre></td></tr><tr><td data-num="10"></td><td><pre>		puc <span class="token operator">-=</span> xHeapStructSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token comment">/* This casting is to keep the compiler from issuing warnings. */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		pxLink <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">)</span> puc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token comment">/* Check the block is actually allocated. */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token function">configASSERT</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxLink<span class="token operator">-></span>xBlockSize <span class="token operator">&amp;</span> xBlockAllocatedBit <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token function">configASSERT</span><span class="token punctuation">(</span> pxLink<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> pxLink<span class="token operator">-></span>xBlockSize <span class="token operator">&amp;</span> xBlockAllocatedBit <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			<span class="token keyword">if</span><span class="token punctuation">(</span> pxLink<span class="token operator">-></span>pxNextFreeBlock <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>			<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>				<span class="token comment">/* The block is being returned to the heap - it is no longer</span></pre></td></tr><tr><td data-num="24"></td><td><pre>				allocated. */</pre></td></tr><tr><td data-num="25"></td><td><pre>				pxLink<span class="token operator">-></span>xBlockSize <span class="token operator">&amp;=</span> <span class="token operator">~</span>xBlockAllocatedBit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>				<span class="token function">vTaskSuspendAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>					<span class="token comment">/* Add this block to the list of free blocks. */</span></pre></td></tr><tr><td data-num="30"></td><td><pre>					xFreeBytesRemaining <span class="token operator">+=</span> pxLink<span class="token operator">-></span>xBlockSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>					<span class="token function">traceFREE</span><span class="token punctuation">(</span> pv<span class="token punctuation">,</span> pxLink<span class="token operator">-></span>xBlockSize <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>					<span class="token function">prvInsertBlockIntoFreeList</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> BlockLink_t <span class="token operator">*</span> <span class="token punctuation">)</span> pxLink <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>				<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token function">xTaskResumeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>			<span class="token keyword">else</span></pre></td></tr><tr><td data-num="37"></td><td><pre>			<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>				<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>		<span class="token keyword">else</span></pre></td></tr><tr><td data-num="42"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>			<span class="token function">mtCOVERAGE_TEST_MARKER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>相比 <code>heap_2</code> ， <code>heap_4</code> 只是多了一些检查，使之更加安全，看下图比较：</p><p><img data-src="/freertos-heap/20200215201418626.png" alt="img"></p><p>应用场景及特点：</p><ul><li>即使应用程序反复删除任务，队列，信号量，互斥量等也可以使用。</li><li>与 <code>heap_2</code> 实现相比，即使将要分配和释放的内存具有随机大小，也很难将堆空间严重分割成多个小块。</li><li>不确定性，但比大多数标准 C 库 <code>malloc</code> 实现要有效得多。</li></ul><p>对于希望直接在应用程序代码中使用便携式层内存分配方案的应用程序， <code>heap_4.c</code> 尤其有用（而不是仅通过调用本身调用 <code>pvPortMalloc()</code> 和 <code>vPortFree()</code> 的 API 函数来间接使用）。</p><h2 id="heap_5c"><a class="anchor" href="#heap_5c">#</a> heap_5.c</h2><p>该方案使用与 <code>heap_4</code> 相同，使用首次适应算法和内存合并算法，并允许堆跨越多个不相邻（不连续）的内存区域。</p><p>这个就不说了，跟 <code>heap_4</code> 大同小异，有兴趣可以看看，就只发一下它的文件注释说明吧</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * A sample implementation of pvPortMalloc() that allows the heap to be defined</pre></td></tr><tr><td data-num="3"></td><td><pre> * across multiple non-contigous blocks and combines (coalescences) adjacent</pre></td></tr><tr><td data-num="4"></td><td><pre> * memory blocks as they are freed.</pre></td></tr><tr><td data-num="5"></td><td><pre> *</pre></td></tr><tr><td data-num="6"></td><td><pre> * See heap_1.c, heap_2.c, heap_3.c and heap_4.c for alternative</pre></td></tr><tr><td data-num="7"></td><td><pre> * implementations, and the memory management pages of http://www.FreeRTOS.org</pre></td></tr><tr><td data-num="8"></td><td><pre> * for more information.</pre></td></tr><tr><td data-num="9"></td><td><pre> *</pre></td></tr><tr><td data-num="10"></td><td><pre> * Usage notes:</pre></td></tr><tr><td data-num="11"></td><td><pre> *</pre></td></tr><tr><td data-num="12"></td><td><pre> * vPortDefineHeapRegions() ***must*** be called before pvPortMalloc().</pre></td></tr><tr><td data-num="13"></td><td><pre> * pvPortMalloc() will be called if any task objects (tasks, queues, event</pre></td></tr><tr><td data-num="14"></td><td><pre> * groups, etc.) are created, therefore vPortDefineHeapRegions() ***must*** be</pre></td></tr><tr><td data-num="15"></td><td><pre> * called before any other objects are defined.</pre></td></tr><tr><td data-num="16"></td><td><pre> *</pre></td></tr><tr><td data-num="17"></td><td><pre> * vPortDefineHeapRegions() takes a single parameter.  The parameter is an array</pre></td></tr><tr><td data-num="18"></td><td><pre> * of HeapRegion_t structures.  HeapRegion_t is defined in portable.h as</pre></td></tr><tr><td data-num="19"></td><td><pre> *</pre></td></tr><tr><td data-num="20"></td><td><pre> * typedef struct HeapRegion</pre></td></tr><tr><td data-num="21"></td><td><pre> * &#123;</pre></td></tr><tr><td data-num="22"></td><td><pre> *	uint8_t *pucStartAddress; &lt;&lt; Start address of a block of memory that will be part of the heap.</pre></td></tr><tr><td data-num="23"></td><td><pre> *	size_t xSizeInBytes;	  &lt;&lt; Size of the block of memory.</pre></td></tr><tr><td data-num="24"></td><td><pre> * &#125; HeapRegion_t;</pre></td></tr><tr><td data-num="25"></td><td><pre> *</pre></td></tr><tr><td data-num="26"></td><td><pre> * The array is terminated using a NULL zero sized region definition, and the</pre></td></tr><tr><td data-num="27"></td><td><pre> * memory regions defined in the array ***must*** appear in address order from</pre></td></tr><tr><td data-num="28"></td><td><pre> * low address to high address.  So the following is a valid example of how</pre></td></tr><tr><td data-num="29"></td><td><pre> * to use the function.</pre></td></tr><tr><td data-num="30"></td><td><pre> *</pre></td></tr><tr><td data-num="31"></td><td><pre> * HeapRegion_t xHeapRegions[] =</pre></td></tr><tr><td data-num="32"></td><td><pre> * &#123;</pre></td></tr><tr><td data-num="33"></td><td><pre> * 	&#123; ( uint8_t * ) 0x80000000UL, 0x10000 &#125;, &lt;&lt; Defines a block of 0x10000 bytes starting at address 0x80000000</pre></td></tr><tr><td data-num="34"></td><td><pre> * 	&#123; ( uint8_t * ) 0x90000000UL, 0xa0000 &#125;, &lt;&lt; Defines a block of 0xa0000 bytes starting at address of 0x90000000</pre></td></tr><tr><td data-num="35"></td><td><pre> * 	&#123; NULL, 0 &#125;                &lt;&lt; Terminates the array.</pre></td></tr><tr><td data-num="36"></td><td><pre> * &#125;;</pre></td></tr><tr><td data-num="37"></td><td><pre> *</pre></td></tr><tr><td data-num="38"></td><td><pre> * vPortDefineHeapRegions( xHeapRegions ); &lt;&lt; Pass the array into vPortDefineHeapRegions().</pre></td></tr><tr><td data-num="39"></td><td><pre> *</pre></td></tr><tr><td data-num="40"></td><td><pre> * Note 0x80000000 is the lower address so appears in the array first.</pre></td></tr><tr><td data-num="41"></td><td><pre> *</pre></td></tr><tr><td data-num="42"></td><td><pre> */</pre></td></tr></table></figure><p>注意： <code>heap_5</code> 通过调用 <code>vPortDefineHeapRegions()</code> 函数实现初始化，只有在 <code>vPortDefineHeapRegions()</code> 执行后才允许使用内存分配和释放。创建 RTOS 对象（任务、队列、信号量等等）会隐含的调用 <code>pvPortMalloc()</code> ，因此必须注意：使用 <code>heap_5</code> 创建任何对象前，要先执行 <code>vPortDefineHeapRegions()</code> 函数。</p><h1 id="其他"><a class="anchor" href="#其他">#</a> 其他</h1><p>必须吐槽一下，终于结束了。</p><p>官方的这个地址有详细说 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZXJ0b3Mub3JnL2EwMDExMS5odG1s">heap 堆内存管理</span></p><p>然后想要了解 heap 所用到的算法可以查看 -&gt;<a href="https://arachnid.cc/partitioning-placement-algorithm/"> 分区分配算法（Partitioning Placement Algorithm）</a></p><div class="tags"><a href="/tags/history/" rel="tag"><i class="ic i-tag"></i> history</a> <a href="/tags/RTOS/" rel="tag"><i class="ic i-tag"></i> RTOS</a> <a href="/tags/FreeRTOS/" rel="tag"><i class="ic i-tag"></i> FreeRTOS</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-08-14 21:19:34" itemprop="dateModified" datetime="2024-08-14T21:19:34+08:00">2024-08-14</time></span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="freertos-heap/" class="item leancloud_visitors" data-flag-title="FreeRTOS 篇章之 heap 堆内存分配分析" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span id="busuanzi_value_page_pv"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 投喂</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.webp" alt="夏沫の浅雨 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.webp" alt="夏沫の浅雨 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>夏沫の浅雨 <i class="ic i-at"><em>@</em></i>命运转轮</li><li class="link"><strong>本文链接：</strong> <a href="https://arachnid.cc/freertos-heap/" title="FreeRTOS 篇章之 heap 堆内存分配分析">https://arachnid.cc/freertos-heap/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/freertos-system-transplant/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;arachnid.cc&#x2F;picture&#x2F;(10).webp" title="FreeRTOS 篇章之系统移植"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> FreeRTOS</span><h3>FreeRTOS 篇章之系统移植</h3></a></div><div class="item right"><a href="/freertos-config/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;arachnid.cc&#x2F;picture&#x2F;(31).webp" title="FreeRTOS 篇章之 FreeRTOSConfig.h 分析"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> FreeRTOS</span><h3>FreeRTOS 篇章之 FreeRTOSConfig.h 分析</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#freertos%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E9%80%89%E6%8B%A9"><span class="toc-number">1.</span> <span class="toc-text">FreeRTOS 内存分配选择</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E4%B8%8E%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D"><span class="toc-number">2.</span> <span class="toc-text">静态与动态内存分配</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#heap_1c"><span class="toc-number">3.1.</span> <span class="toc-text">heap_1.c</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#heap_2c"><span class="toc-number">3.2.</span> <span class="toc-text">heap_2.c</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#heap_3c"><span class="toc-number">3.3.</span> <span class="toc-text">heap_3.c</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#heap_4c"><span class="toc-number">3.4.</span> <span class="toc-text">heap_4.c</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#heap_5c"><span class="toc-number">3.5.</span> <span class="toc-text">heap_5.c</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">4.</span> <span class="toc-text">其他</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/freertos-file-analyse/" rel="bookmark" title="FreeRTOS 篇章之官方源码文档分析">FreeRTOS 篇章之官方源码文档分析</a></li><li><a href="/freertos-system-transplant/" rel="bookmark" title="FreeRTOS 篇章之系统移植">FreeRTOS 篇章之系统移植</a></li><li class="active"><a href="/freertos-heap/" rel="bookmark" title="FreeRTOS 篇章之 heap 堆内存分配分析">FreeRTOS 篇章之 heap 堆内存分配分析</a></li><li><a href="/freertos-config/" rel="bookmark" title="FreeRTOS 篇章之 FreeRTOSConfig.h 分析">FreeRTOS 篇章之 FreeRTOSConfig.h 分析</a></li><li><a href="/freertos-task/" rel="bookmark" title="FreeRTOS 篇章之任务管理">FreeRTOS 篇章之任务管理</a></li><li><a href="/freertos-queue/" rel="bookmark" title="FreeRTOS 篇章之队列管理">FreeRTOS 篇章之队列管理</a></li><li><a href="/freertos-binary-semaphore/" rel="bookmark" title="FreeRTOS 篇章之二值信号量">FreeRTOS 篇章之二值信号量</a></li><li><a href="/freertos-mutex-semaphore/" rel="bookmark" title="FreeRTOS 篇章之互斥量">FreeRTOS 篇章之互斥量</a></li><li><a href="/freertos-critical-scheduler/" rel="bookmark" title="FreeRTOS 篇章之临界区与调度器">FreeRTOS 篇章之临界区与调度器</a></li><li><a href="/freertos-event/" rel="bookmark" title="FreeRTOS 篇章之事件位和事件组">FreeRTOS 篇章之事件位和事件组</a></li><li><a href="/freertos-task-notify/" rel="bookmark" title="FreeRTOS 篇章之任务通知">FreeRTOS 篇章之任务通知</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="夏沫の浅雨" data-src="/images/avatar.webp"><p class="name" itemprop="name">夏沫の浅雨</p><div class="description" itemprop="description">不曾亏欠，不曾辜负，如此足矣</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">82</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">5</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">24</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FyYWNobmlkLTk3" title="https:&#x2F;&#x2F;github.com&#x2F;Arachnid-97"><i class="ic i-github"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjM2MTA4MzU=" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;23610835"><i class="ic i-bilibili"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友人帐</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-info-circle"></i>关于</a></li><li class="item"><a href="/atom.xml" rel="section"><i class="ic i-rss"></i>RSS</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/freertos-system-transplant/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/freertos-config/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/RTOS/" title="分类于 FreeRTOS">FreeRTOS</a></div><span><a href="/freertos-heap" title="FreeRTOS 篇章之 heap 堆内存分配分析">FreeRTOS 篇章之 heap 堆内存分配分析<i class="ic i-link-alt"></i></a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/ubuntu-tftp-nfs-create" title="Ubuntu 搭建 tftp 及 NFS 服务">Ubuntu 搭建 tftp 及 NFS 服务<i class="ic i-link-alt"></i></a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/rt-thread-summarize" title="RT-Thread 应用总结">RT-Thread 应用总结<i class="ic i-link-alt"></i></a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/RTOS/" title="分类于 FreeRTOS">FreeRTOS</a></div><span><a href="/freertos-binary-semaphore" title="FreeRTOS 篇章之二值信号量">FreeRTOS 篇章之二值信号量<i class="ic i-link-alt"></i></a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/diode-parameter-design" title="二极管常见参数">二极管常见参数<i class="ic i-link-alt"></i></a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/linux-routing-table" title="Linux 路由表说明">Linux 路由表说明<i class="ic i-link-alt"></i></a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/RTOS/" title="分类于 FreeRTOS">FreeRTOS</a></div><span><a href="/freertos-event" title="FreeRTOS 篇章之事件位和事件组">FreeRTOS 篇章之事件位和事件组<i class="ic i-link-alt"></i></a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/linux_c-time-configuration" title="Linux c 时间时区配置">Linux c 时间时区配置<i class="ic i-link-alt"></i></a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/RTOS/" title="分类于 FreeRTOS">FreeRTOS</a></div><span><a href="/freertos-file-analyse" title="FreeRTOS 篇章之官方源码文档分析">FreeRTOS 篇章之官方源码文档分析<i class="ic i-link-alt"></i></a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/linux-system-constitute" title="Linux 系统构成：bootloader、kernel、rootfs">Linux 系统构成：bootloader、kernel、rootfs<i class="ic i-link-alt"></i></a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">夏沫の浅雨 @ Arachnid's blog</span></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="count"><span class="icon"><i class="ic i-person"></i> <span id="busuanzi_value_site_uv"></span>人 <span class="post-meta-divider">|</span> <span class="icon"><i class="ic i-eye"></i> <span id="busuanzi_value_site_pv"></span>次 <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">626k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">10:38</span></span></span></div><div class="create_time"><span class="icon"><i class="ic i-clock"></i> <span id="timeDate">正在加载</span> <span id="times">...</span><script>function createtime(){var n=new Date("04/28/2022 15:45:50");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML=" 本站存活 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}var now=new Date;setInterval("createtime()",250)</script></span></div><div class="powered-by">Powered-by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"freertos-heap/",favicon:{show:"ψ(｀∇´)ψ 欢迎回来!",hide:"《原子弹入门及制造》"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',isOutdated:!0,format_year_as_prefix:"{{year}}年",format_month_as_prefix:"{{month}}个月",format_month_as_suffix:"零{{month}}个月",format_day_as_prefix:"{{day}}天",format_day_as_suffix:"零{{day}}天",template:"<div class='note warning'><p><span class='label primary'><strong>文章时效性提示</strong></span><br>这是一篇发布于 <span class='pink'>{{publish}}</span> 前，最后一次更新距今已经 <span class='pink'>{{updated}}</span> 的文章，部分内容可能已经过时，请注意甄别。</p></div>",ignores:[function(a){return a.includes("#")},function(a){return new RegExp(LOCAL.path+"$").test(a)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="/js/combined-file.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->